html
<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="gold">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

    <title>ф╝ашоп</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0;
        }

:root {
            --primary-bg: #f9f9f9;
            --secondary-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #7a7a7a;
            --border-color: #ebebeb;
            --message-sent-text: #ffffff;
            --message-received-bg: #f0f0f0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-family: 'Noto Serif SC', serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size: 16px;
            --favorite-color: #ffc107;

            --primary-bg-rgb: 249, 249, 249;
            --secondary-bg-rgb: 255, 255, 255;
            --bubble-style: 'standard';
            --message-font-family: 'Noto Serif SC', serif;
            --message-font-weight: 400;
            --message-line-height: 1.5;
        }

:root[data-color-theme="gold"] {
            --accent-color: #c5a47e;
            --accent-color-dark: #d4af37;
            --accent-color-rgb: 197, 164, 126;
        }
:root[data-color-theme="blue"] {
            --accent-color: #7FA6CD;
            --accent-color-dark: #7FA6CD;
            --accent-color-rgb: 127, 166, 205;
        }
:root[data-color-theme="purple"] {
            --accent-color: #BB9EC7;
            --accent-color-dark: #BB9EC7;
            --accent-color-rgb: 187, 158, 199;
        }
:root[data-color-theme="green"] {
            --accent-color: #7BC8A4;
            --accent-color-dark: #7BC8A4;
            --accent-color-rgb: 123, 200, 164;
        }
:root[data-color-theme="pink"] {
            --accent-color: #F4A6B3;
            --accent-color-dark: #F4A6B3;
            --accent-color-rgb: 244, 166, 179;
        }
:root[data-color-theme="black-white"] {
            --accent-color: #333333;
            --accent-color-dark: #D6D6D6;
            --accent-color-rgb: 51, 51, 51;
        }
:root[data-color-theme="pastel"] {
            --accent-color: #A8D8EA;
            --accent-color-dark: #AA96DA;
            --accent-color-rgb: 168, 216, 234;
        }
:root[data-color-theme="sunset"] {
            --accent-color: #FF9A8B;
            --accent-color-dark: #FF6B6B;
            --accent-color-rgb: 255, 154, 139;
        }
:root[data-color-theme="forest"] {
            --accent-color: #7BA05B;
            --accent-color-dark: #556B2F;
            --accent-color-rgb: 123, 160, 91;
        }
:root[data-color-theme="ocean"] {
            --accent-color: #4A90E2;
            --accent-color-dark: #2E5B9A;
            --accent-color-rgb: 74, 144, 226;
        }

        html[data-theme="dark"] {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-primary: #e5e5e5;
            --text-secondary: #8c8c8c;
            --border-color: #2f2f2f;
            --message-sent-text: #ffffff;
            --message-received-bg: #2a2a2a;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --favorite-color: #ffd700;

            --primary-bg-rgb: 18, 18, 18;
            --secondary-bg-rgb: 30, 30, 30;
        }

        html[data-theme="dark"][data-color-theme="black-white"] .message-sent {
            color: #121212 !important;
        }

        html[data-theme="dark"][data-color-theme="gold"] .message-sent,
        html[data-theme="dark"][data-color-theme="blue"] .message-sent,
        html[data-theme="dark"][data-color-theme="purple"] .message-sent,
        html[data-theme="dark"][data-color-theme="green"] .message-sent,
        html[data-theme="dark"][data-color-theme="pink"] .message-sent,
        html[data-theme="dark"][data-color-theme="pastel"] .message-sent,
        html[data-theme="dark"][data-color-theme="sunset"] .message-sent,
        html[data-theme="dark"][data-color-theme="forest"] .message-sent,
        html[data-theme="dark"][data-color-theme="ocean"] .message-sent {
            color: #121212;
        }

        .message.rounded {
            border-radius: var(--radius);
        }
        .message.rounded-large {
            border-radius: 24px;
        }
        .message.square {
            border-radius: 8px;
        }
        .message.rounded-sent {
            border-radius: var(--radius) var(--radius) 6px var(--radius);
        }
        .message.rounded-received {
            border-radius: var(--radius) var(--radius) var(--radius) 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
            font-family: var(--font-family);
            font-weight: 400;
            position: relative;

            font-size: var(--font-size);
            opacity: 0;
            animation: delayedShow 0.01s ease 0.1s forwards;
        }
@keyframes delayedShow {
            to {
                opacity: 1;
            }
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background-color: var(--primary-bg);
            background-image: var(--chat-bg-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
        }

        .header {
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            box-shadow: var(--shadow);
            z-index: 10;
            flex-shrink: 0;
            position: relative;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 650px;
            margin: 0 auto;
            padding: 15px 5px;
            width: 100%;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border: 2px solid transparent;
            transition: var(--transition);
            order: 2;
        }

        .header-motto {
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 500;
            letter-spacing: 2px;
            opacity: 0.8;
            font-style: italic;
            transition: color 0.5s ease;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        html[data-theme="dark"] .header-motto {
            background: linear-gradient(90deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        html[data-theme="dark"] .avatar:hover {
            border-color: var(--accent-color-dark);
        }
        .avatar > img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .username {
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            order: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }
        .username:hover {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .username:hover {
            color: var(--accent-color-dark);
        }
        .status {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            order: 3;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .status:hover {
            background-color: var(--message-received-bg);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: var(--transition);
        }
        .action-btn:hover {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            transform: rotate(15deg) scale(1.1);
        }

        .main-chat-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: background-color 0.5s ease;
            background-color: transparent;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
            width: 0;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            margin-bottom: 12px;
            animation: messageAppear 0.4s ease-out forwards;
            opacity: 0;
            position: relative;
        }

@keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(0) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.sent {
            align-self: flex-end;
            align-items: flex-end;
        }
        .message-wrapper.received {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message {
            padding: 12px 18px;
            border-radius: var(--radius);
            word-wrap: break-word;
            line-height: var(--message-line-height);
            box-shadow: var(--shadow);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            position: relative;
            overflow: hidden;
            min-width: 50px;
            font-family: var(--message-font-family);
            font-weight: var(--message-font-weight);
        }

        .message-sent {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-bottom-right-radius: 6px;
        }
        html[data-theme="dark"] .message-sent {
            background-color: var(--accent-color-dark);
        }

        .message-received {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 10px 0 10px;
            opacity: 0.7;
            font-size: 11px;
            color: var(--text-secondary);
            position: relative;
        }

        .message-meta-actions {
            position: absolute;
            top: -12px;
            background-color: var(--secondary-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            padding: 4px 6px;
            opacity: 0;
            transform: translateY(5px);
            transition: var(--transition);
            z-index: 2;
        }
        .message-wrapper:hover .message-meta-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-wrapper.sent .message-meta-actions {
            left: -20px;
        }
        .message-wrapper.received .message-meta-actions {
            right: -20px;
        }

        .meta-action-btn {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .meta-action-btn:hover {
            transform: scale(1.2);
            color: var(--text-primary);
        }
        .meta-action-btn.favorited {
            color: var(--favorite-color);
        }

        .timestamp {
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .read-receipt {
            font-size: 12px;
        }
        .read-receipt.read {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .read-receipt.read {
            color: var(--accent-color-dark);
        }

        .input-area-wrapper {
            flex-shrink: 0;
            background-color: var(--secondary-bg);
            transition: background-color 0.5s ease;
        }
        .input-area {
            display: flex;
            padding: 12px 15px;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            transition: border-color 0.5s ease;
        }
        .message-input {
            flex: 1;
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 12px 18px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 46px;
            transition: var(--transition);
            font-weight: 500;
            font-family: var(--font-family);
            font-size: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-input:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }
        html[data-theme="dark"] .message-input:focus {
            border-color: var(--accent-color-dark);
        }

        .input-buttons {
            display: flex;
            gap: 8px;
        }
        .input-btn {
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .input-btn:hover {
            transform: scale(1.08) rotate(5deg);
            filter: brightness(1.1);
        }

        .send-btn, .batch-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .send-btn, html[data-theme="dark"] .batch-btn.active {
            background-color: var(--accent-color-dark);
        }

        .coin-btn, .batch-btn, .continue-btn, .attachment-btn, .poke-btn, .sticker-btn {
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
        }
        .attachment-btn:hover, .continue-btn:hover, .batch-btn:hover, .coin-btn:hover, .poke-btn:hover, .sticker-btn:hover {
            color: var(--text-primary);
        }

        #reply-preview-container {
            padding: 0 15px;
        }
        .reply-preview {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
            border-left: 3px solid var(--accent-color);
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .reply-preview-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .reply-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .reply-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .reply-indicator {
            font-style: italic;
            opacity: 0.8;
            border-left: 2px solid var(--accent-color);
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            background-color: rgba(var(--primary-bg-rgb), 0.6);
            border-radius: 8px;
        }

        .message-wrapper.sent .reply-indicator {
            background-color: rgba(255, 255, 255, 0.2);
            color: inherit;
            border-left-color: rgba(255, 255, 255, 0.5);
        }
        html[data-theme="dark"] .message-wrapper.sent .reply-indicator {
            background-color: rgba(0, 0, 0, 0.15);
            color: inherit;
            border-left-color: rgba(0, 0, 0, 0.4);
        }
        .modal-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .modal {
            z-index: 2000 !important;
        }

        .modal-content {
            z-index: 2001 !important;
        }

        .message-note {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
        }
        html[data-theme="dark"] .message-note {
            color: var(--text-primary);
        }

        .system-message {
            align-self: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 10px 0;
            box-shadow: none;
        }

        body.with-background .header,
        body.with-background .input-area-wrapper {
            background-color: rgba(var(--secondary-bg-rgb), 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        body.with-background .input-area {
            border-top-color: transparent;
        }
        body.with-background .message-received {
            background-color: rgba(var(--secondary-bg-rgb), 0.95);
        }
        body.with-background .message-input {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
        }
        body.with-background .message-input:focus {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
        }
        body.with-background .batch-preview {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.with-background .message-meta {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: modalBgFadeIn 0.3s ease;
        }
@keyframes modalBgFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalContentSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transition: background-color 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            display: flex;
            flex-direction: column;
        }
        .modal-content::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes modalContentSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.5s ease;
            flex-shrink: 0;
        }
        .modal-title i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .modal-title i {
            color: var(--accent-color-dark);
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }
        html[data-theme="dark"] .modal-input:focus, html[data-theme="dark"] .modal-textarea:focus {
            border-color: var(--accent-color-dark);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .modal-btn-primary {
            background-color: var(--accent-color-dark);
        }
        .modal-btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .modal-btn-secondary {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
        .modal-btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }

        .file-input {
            display: none;
        }
        .typing-indicator, .empty-state {
            position: absolute;
            left: 20px;
            bottom: 20px;
            z-index: 5;
        }
        .empty-state {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
            width: 100%;
            transition: color 0.5s ease;
        }
        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }
        .empty-state p {
            font-size: 16px;
            font-weight: 500;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: var(--message-received-bg);
            padding: 12px 16px;
            border-radius: var(--radius);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
            display: none;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }
        .typing-dots {
            display: flex;
            gap: 5px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
@keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .settings-item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }


        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background-color: var(--primary-bg);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            position: relative;
        }


        .settings-item:hover {
            background-color: var(--secondary-bg);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }


        .settings-item i {
            font-size: 18px;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .settings-item:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1);
        }


        .settings-item span {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }


        .settings-item::after {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0.5;
            transition: transform 0.3s ease;
        }

        .settings-item:hover::after {
            transform: translateX(3px);
            opacity: 0.8;
            color: var(--accent-color);
        }


        #advanced-modal .settings-item-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        #advanced-modal .settings-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 10px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        #advanced-modal .settings-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            z-index: 1;
        }


        #advanced-modal .settings-item i {
            width: 56px;
            height: 56px;
            font-size: 24px;
            border-radius: 20px;
            margin-bottom: 4px;
        }


        #advanced-modal .settings-item::after {
            display: none;
        }

        #appearance-modal .settings-item-list {
            gap: 8px;
        }


        .import-export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }
        .import-export-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid transparent;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .import-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .import-export-btn.export {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            border-color: rgba(var(--accent-color-rgb), 0.2);
        }
        .import-export-btn.export:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .settings-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }

        #my-status-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font-family);
            text-align: center;
            padding: 2px 6px;
            width: 100px;
        }


:root {
            --welcome-bg: #f0f2f5;
            --welcome-text-main: #2c3e50;
            --welcome-text-sub: #7f8c8d;
            --welcome-star: #bdc3c7;
            --welcome-circle-outer: rgba(0, 0, 0, 0.1);
            --welcome-loader-bg: rgba(0, 0, 0, 0.1);
        }

        html[data-theme="dark"] {

            --welcome-bg: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            --welcome-text-main: #ffffff;
            --welcome-text-sub: var(--accent-color);
            --welcome-star: #ffffff;
            --welcome-circle-outer: rgba(255, 255, 255, 0.1);
            --welcome-loader-bg: rgba(255, 255, 255, 0.1);
        }

        .welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            background: var(--welcome-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            transition: all 0.8s cubic-bezier(0.7, 0, 0.3, 1);
        }

        .welcome-animation.hidden {
            opacity: 0;
            transform: scale(1.1);
            filter: blur(20px);
            pointer-events: none;
        }


        .stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: var(--welcome-star);
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }

@keyframes twinkle {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        .welcome-content-wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }


        .logo-tech-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon-main {
            font-size: 48px;
            color: var(--accent-color);
            z-index: 5;
            filter: drop-shadow(0 0 15px rgba(var(--accent-color-rgb), 0.6));
            animation: floatIcon 3s ease-in-out infinite;
        }

        .logo-circle-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid var(--welcome-circle-outer);
            border-radius: 50%;
            animation: pulseRing 2s infinite;
        }

        .logo-circle-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border: 1px dashed rgba(var(--accent-color-rgb), 0.4);
            border-radius: 50%;
            animation: rotateCircle 10s linear infinite;
        }

        .orbit-dot {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: rotateCircle 3s linear infinite;
        }

        .orbit-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--accent-color);
        }


        .text-tech-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 80px;
        }


        .welcome-title-glitch {
            font-family: 'Noto Serif SC', serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            position: relative;


            opacity: 1;


            transition: color 0.5s ease;
        }


        .welcome-title-glitch.playing {
            opacity: 0;
            animation: cinematicFadeIn 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }


        html[data-theme="light"] .welcome-title-glitch {
            color: #2c3e50;
            text-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }


        html[data-theme="dark"] .welcome-title-glitch,
        .welcome-title-glitch {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        }


@keyframes cinematicFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(8px);
                letter-spacing: 0px;
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                letter-spacing: 6px;
            }
        }

        .title-cinematic-enter {
            animation: cinematicIn 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

@keyframes cinematicIn {
            0% {
                opacity: 0;
                letter-spacing: 15px;
                filter: blur(12px);
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                letter-spacing: 4px;
                filter: blur(0);
                transform: scale(1);
            }
        }


        .welcome-subtitle-scramble {
            font-family: monospace;
            font-size: 12px;
            color: var(--welcome-text-sub);
            letter-spacing: 2px;
            opacity: 0.8;
            text-transform: uppercase;
            min-height: 18px;
        }


        .loader-tech {
            width: 160px;
            height: 2px;
            background: var(--welcome-loader-bg);
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }

        .loader-tech-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transition: width 0.2s linear;
        }

@keyframes floatIcon {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

@keyframes rotateCircle {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

@keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
                border-color: rgba(var(--accent-color-rgb), 0.5);
            }
            100% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
        }

@keyframes breath {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.2;
            }
        }
@keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
@keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
        }
@keyframes blink-caret {
            from, to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent-color);
            }
        }

        .batch-preview {
            position: absolute;
            bottom: 85px;
            left: 15px;
            right: 15px;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            z-index: 5;
            transition: all 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            animation: batchPreviewSlideUp 0.3s ease;
        }
        .batch-preview::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes batchPreviewSlideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .batch-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            font-size: 14px;
            transition: background-color 0.5s ease, opacity 0.3s ease;
            user-select: none;
            animation: batchItemAppear 0.2s ease;
        }
@keyframes batchItemAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .batch-preview-text {
            flex-grow: 1;
            cursor: text;
            margin-right: 10px;
        }
        .batch-preview-input {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            border-bottom: 1px solid var(--accent-color);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }
        .batch-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .batch-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }
        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .batch-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .batch-send-btn {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .batch-send-btn {
            background-color: var(--accent-color-dark);
        }
        .batch-cancel-btn {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }

        .theme-picker {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 16px;
        }
        .theme-picker-label {
            font-weight: 500;
            font-size: 14px;
        }
        .theme-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .theme-color-btn:hover {
            transform: scale(1.1);
        }
        .theme-color-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }
        #theme-gold {
            background-color: #c5a47e;
        }
        #theme-blue {
            background-color: #7FA6CD;
        }
        #theme-purple {
            background-color: #BB9EC7;
        }
        #theme-green {
            background-color: #7BC8A4;
        }
        #theme-pink {
            background-color: #F4A6B3;
        }
        #theme-black-white {
            background: linear-gradient(135deg, #000000 50%, #ffffff 50%);
        }
        #theme-pastel {
            background: linear-gradient(135deg, #A8D8EA, #AA96DA);
        }
        #theme-sunset {
            background: linear-gradient(135deg, #FF9A8B, #FF6B6B);
        }
        #theme-forest {
            background: linear-gradient(135deg, #7BA05B, #556B2F);
        }
        #theme-ocean {
            background: linear-gradient(135deg, #4A90E2, #2E5B9A);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .font-size-label {
            font-weight: 500;
            font-size: 14px;
        }
        .font-size-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--message-received-bg);
            outline: none;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .font-size-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .font-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }
        .font-size-value {
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        html[data-theme="dark"] .settings-section-title {
            color: var(--accent-color-dark);
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10001 !important;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: notificationSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid var(--accent-color);
        }
@keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .notification.hiding {
            animation: notificationSlideOut 0.4s ease-in forwards;
        }
@keyframes notificationSlideOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
        .notification i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .notification i {
            color: var(--accent-color-dark);
        }

        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .import-export-btn {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-family);
        }
        .import-export-btn:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        .import-export-btn.export {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .import-export-btn.export {
            background-color: var(--accent-color-dark);
        }

        .date-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }
        .date-divider::before, .date-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--border-color);
        }
        .date-divider span {
            padding: 0 12px;
        }


        .coin-toss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .coin-toss-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .coin-container {
            perspective: 1200px;
            margin-bottom: 40px;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.2));
        }

        .coin {
            width: 180px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            border-radius: 50%;
        }

        .coin.flipping-heads {
            animation: flip-coin-heads 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .coin.flipping-tails {
            animation: flip-coin-tails 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Serif SC', serif;
            border: 8px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .coin-front {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: #333;
            transform: rotateY(0deg);
        }
        .coin-front::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #bdc3c7;
            border-radius: 50%;
        }

        .coin-back {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: #fdfbfb;
            transform: rotateY(180deg);
        }
        .coin-back::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #7f8c8d;
            border-radius: 50%;
        }

        .coin-text-main {
            font-size: 48px;
            font-weight: 400;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }
        .coin-text-sub {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            font-family: sans-serif;
        }


        .coin-result-container {
            min-height: 60px;
            display: flex;
            justify-content: center;
        }

        .coin-result-text {
            font-family: 'Noto Serif SC', serif;
            font-size: 15px;
            color: #fff;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 3px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin-top: 20px;
            text-align: center;
        }


        .coin-toss-overlay.finished .coin-result-text {
            font-size: 28px;
            opacity: 1;
            font-weight: 500;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }


        .coin-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;

            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;


            transition: opacity 0.3s ease, transform 0.3s ease;
        }


        .coin-toss-overlay.finished .coin-confirm-buttons {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;

            transition-delay: 0.3s;
        }

        .coin-btn-action {
            padding: 10px 24px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            backdrop-filter: blur(5px);
        }
        .coin-btn-action:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            transform: translateY(-2px);
        }

        .coin-btn-primary {
            background: #fff;
            color: #000;
            border-color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .coin-btn-primary:hover {
            background: #f0f0f0;
            box-shadow: 0 6px 20px rgba(255,255,255,0.3);
            transform: translateY(-2px) scale(1.02);
        }

@keyframes flip-coin-heads {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2160deg) scale(1);
            }
        }

@keyframes flip-coin-tails {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2340deg) scale(1);
            }
        }

        .settings-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .settings-footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .settings-footer a:hover {
            text-decoration: underline;
        }

        #session-modal .modal-content {
            max-width: 500px;
        }
        .session-list {
            flex: 1;
            overflow-y: auto;
            margin: 0 -10px;
            padding: 0 10px;
            max-height: 50vh;
        }
        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .session-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }
        .session-item.active {
            border-color: var(--accent-color);
            background-color: rgba(var(--accent-color-rgb), 0.1);
            font-weight: 600;
        }
        .session-info {
            cursor: pointer;
            flex-grow: 1;
        }
        .session-name {
            font-size: 15px;
        }
        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }
        .session-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .session-action-btn:hover {
            color: var(--text-primary);
            background-color: var(--border-color);
            transform: scale(1.1);
        }
        .session-action-btn.delete:hover {
            color: #e53935;
        }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }

        .pagination-btn {
            background-color: var(--message-received-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }


        .fortune-card.tarot-style {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }


        .fortune-card.tarot-style::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            pointer-events: none;
        }


        .tarot-header {
            padding: 20px 0 10px;
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }


        .tarot-visual {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            position: relative;
        }


        .tarot-icon-vector {
            font-size: 64px;
            color: var(--text-primary);
            opacity: 0.8;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }


        .tarot-visual.reversed .tarot-icon-vector {
            transform: rotate(180deg);
            opacity: 0.6;
        }


        .tarot-card-name {
            font-family: var(--font-family);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }


        .tarot-position-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .tarot-position-badge.reversed {
            color: #e57373;
            background-color: rgba(229, 115, 115, 0.1);
            border-color: rgba(229, 115, 115, 0.2);
        }


        .tarot-details {
            padding: 0 30px 30px;
            position: relative;
            z-index: 2;
        }

        .tarot-divider {
            height: 1px;
            width: 40px;
            background-color: var(--accent-color);
            margin: 0 auto 15px;
        }

        .tarot-keyword {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .fortune-desc {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            font-style: italic;
        }

        .fortune-tip {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }


        .fortune-card {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
@keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .batch-favorite-mode .message-wrapper {
            cursor: pointer;
        }

        .batch-favorite-mode .message-wrapper:hover .message {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .batch-favorite-mode .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px var(--favorite-color);
        }


        .favorite-meta-btn {
            font-size: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 3px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            margin-left: 2px;
        }
        .favorite-meta-btn:hover {
            opacity: 1;
            transform: scale(1.1);
            background-color: rgba(var(--accent-color-rgb), 0.1);
        }
        .favorite-meta-btn.favorited {
            color: #ffc107;
            opacity: 1;
        }
@keyframes favoritePop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.4);
            }
            100% {
                transform: scale(1);
            }
        }


        #favorites-modal .modal-content {
            max-width: 450px;
        }
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 5px;
            overflow-y: auto;
            max-height: 60vh;
        }
        .fav-card {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .fav-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
        .fav-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .fav-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fav-sender-name {
            font-weight: 600;
            color: var(--accent-color);
        }
        .fav-bubble {
            background-color: var(--secondary-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border-top-left-radius: 2px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.03);
            word-break: break-all;
        }
        .fav-bubble img {
            max-width: 100%;
            border-radius: 6px;
            display: block;
            margin-top: 5px;
        }
        .fav-action-btn {
            align-self: flex-end;
            font-size: 11px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 4px;
            opacity: 0.6;
            transition: 0.2s;
        }
        .fav-action-btn:hover {
            color: #e53935;
            opacity: 1;
            text-decoration: underline;
        }

        .no-favorites {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .no-favorites i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--border-color);
        }


        .batch-favorite-checkbox {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            background-color: var(--secondary-bg);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }
        .batch-favorite-checkbox.checked {
            background-color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
        }
        .batch-favorite-checkbox.checked::after {
            content: "тЬУ";
            font-weight: 900;
            color: #fff;
            font-size: 12px;
        }

        .batch-favorite-mode .message-wrapper {
            transform: translateX(30px);
            transition: transform 0.3s ease;
        }

        .batch-favorite-mode .message-wrapper .batch-favorite-checkbox {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px #ffc107, 0 4px 12px rgba(255, 193, 7, 0.2);
            transform: scale(1.02);
        }

        .batch-favorite-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(128,128,128,0.2);
            border-radius: 50px;
            padding: 8px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 2002;
            animation: floatUpAction 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
@keyframes floatUpAction {
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        .batch-action-btn-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-family);
        }
        .batch-btn-confirm {
            background-color: #ffc107;
            color: #fff;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
        }
        .batch-btn-confirm:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .batch-btn-cancel {
            background-color: transparent;
            color: var(--text-primary);
        }
        .batch-btn-cancel:hover {
            background-color: var(--border-color);
        }



        #custom-replies-modal .modal-content {
            background-color: var(--primary-bg);

            display: flex;
            flex-direction: column;
            max-height: 80vh;
            padding: 0;

        }


        #custom-replies-modal .modal-title {
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            font-size: 18px;
            border-bottom: none;
        }


        .reply-tabs {
            display: flex;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .reply-tab-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 20px;

            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .reply-tab-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .reply-tab-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
            transform: translateY(-1px);
        }


        .reply-toolbar {
            padding: 15px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--primary-bg);
        }

        .reply-search {
            flex: 1;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .reply-search:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.15);
            transform: translateY(-1px);
        }

        .reply-tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .reply-tool-btn:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.2);
        }


        .custom-replies-list {
            padding: 10px 20px;
            gap: 12px;
            background-color: var(--primary-bg);
        }


        .custom-reply-item {
            background-color: var(--secondary-bg);
            border-radius: 16px;

            padding: 16px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .custom-reply-item:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }


        .custom-reply-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.5;
            margin-right: 15px;
        }


        .custom-reply-item.disabled {
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border-style: dashed;
            opacity: 0.7;
        }
        .custom-reply-item.disabled .custom-reply-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }


        .custom-reply-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .reply-action-mini {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background-color: var(--primary-bg);

            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }


        .reply-action-mini.edit-reply:hover,
        .reply-action-mini.modify-default:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: rotate(10deg);
        }


        .reply-action-mini.delete-reply:hover {
            background-color: #ff4757;
            color: white;
            transform: rotate(-10deg);
        }


        .reply-action-mini.toggle-default:hover {
            background-color: var(--text-secondary);
            color: var(--secondary-bg);
        }


        #custom-replies-modal .modal-buttons {
            padding: 20px;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }


        #add-custom-reply {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            color: var(--message-sent-text);
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #add-custom-reply:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4);
        }


        html[data-theme="dark"] .custom-reply-item {
            background-color: rgba(255,255,255,0.03);
        }
        html[data-theme="dark"] .reply-action-mini {
            background-color: rgba(255,255,255,0.08);
        }


        .stats-dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px 0;
        }


        .stats-card {
            background-color: var(--primary-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }


        .stats-overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background-color: var(--secondary-bg);
            border-radius: 12px;
            text-align: center;
            border: 1px solid transparent;
        }

        .overview-item:hover {
            border-color: var(--border-color);
            background-color: var(--primary-bg);
        }

        .overview-value {
            font-family: 'Georgia', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }

        .overview-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }


        .stats-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rank-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            min-height: 44px;
        }


        .rank-progress-bg {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(var(--accent-color-rgb), 0.12);
            z-index: 0;
            border-radius: 8px;
            transition: width 0.6s ease;
        }


        .rank-info {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }

        .rank-number {
            width: 24px;
            font-weight: 800;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.5;
            flex-shrink: 0;
            text-align: center;
            font-size: 14px;
        }

        .rank-item:nth-child(1) .rank-number {
            color: #FFD700;
            opacity: 1;
            text-shadow: 0 1px 0 rgba(0,0,0,0.1);
            font-size: 16px;
        }
        .rank-item:nth-child(2) .rank-number {
            color: #9EA1A3;
            opacity: 1;
            font-size: 15px;
        }
        .rank-item:nth-child(3) .rank-number {
            color: #CD7F32;
            opacity: 1;
            font-size: 15px;
        }


        .rank-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            white-space: normal;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .rank-count {
            flex-shrink: 0;
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 700;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            min-width: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .rank-count small {
            font-size: 9px;
            opacity: 0.7;
            font-weight: normal;
            margin-top: 2px;
        }

        .stats-empty-state {
            text-align: center;
            padding: 30px 10px;
            color: var(--text-secondary);
        }

        #stats-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            padding: 20px;
            overflow: hidden;
        }

        #stats-modal .modal-title {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        #stats-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
            margin-bottom: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #stats-content::-webkit-scrollbar {
            display: none;
        }

        #stats-modal .modal-buttons {
            flex-shrink: 0;
            margin-top: 0;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }

        #anniversary-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 5px;
            max-height: 450px;
            overflow-y: auto;
        }

        .anniversary-card {
            position: relative;
            border-radius: 16px;
            padding: 18px 20px;
            color: #fff;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            min-height: 90px;
        }

        .anniversary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }

        .anniversary-card.type-future {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .anniversary-card.type-past {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
        }
        html[data-color-theme="gold"] .anniversary-card.type-past {
            background: linear-gradient(135deg, #d4af37 0%, #C5A47E 100%);
        }
        html[data-color-theme="gold"] .anniversary-card.type-future {
            background: linear-gradient(135deg, #243B55 0%, #141E30 100%);
        }

        .ann-info {
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .ann-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ann-date {
            font-size: 12px;
            opacity: 0.8;
            letter-spacing: 1px;
        }
        .ann-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            margin-left: 5px;
            vertical-align: middle;
        }

        .ann-days {
            z-index: 2;
            text-align: right;
        }
        .ann-number {
            font-size: 36px;
            font-weight: 700;
            font-family: 'Arial', sans-serif;
            line-height: 1;
            letter-spacing: -1px;
        }
        .ann-label {
            font-size: 10px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 4px;
        }

        .ann-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .anniversary-card:hover .ann-delete-btn {
            opacity: 1;
        }
        .ann-delete-btn:hover {
            background: rgba(255,0,0,0.6);
            transform: scale(1.1);
        }

        .anniversary-card::after {
            content: "";
            position: absolute;
            top: -30px;
            right: -30px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            pointer-events: none;
        }

#anniversary-display {
    text-align: center;
    padding: 30px 0 10px;
    background-color: transparent;
    box-shadow: none;
    border: none;
    margin-bottom: 10px;
    animation: fadeIn 0.8s ease;
}

#anniversary-days {
    font-size: 56px;
    font-weight: 300; 
    color: var(--text-primary);
    font-family: 'Georgia', serif; 
    line-height: 1;
    margin: 10px 0;
    text-shadow: none;
    animation: none;
}


#anniversary-list {
    padding: 0 10px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}


.anniversary-card {
    background: var(--secondary-bg); 
    border-radius: 16px;
    padding: 20px;
    color: var(--text-primary); 
    box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
    border: 1px solid var(--border-color);
    min-height: auto;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}


.anniversary-card.type-future { background: var(--secondary-bg); border-left: 4px solid #764ba2; }
.anniversary-card.type-past { background: var(--secondary-bg); border-left: 4px solid #ff9a9e; }
.anniversary-card::after { display: none; } 

.anniversary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.06);
}

.ann-info { gap: 4px; }
.ann-name { font-size: 15px; font-weight: 500; color: var(--text-primary); text-shadow: none;}
.ann-date { font-size: 12px; opacity: 0.5; color: var(--text-secondary); }

.ann-tag {
    background: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
}

.ann-days { text-align: right; }
.ann-number { 
    font-size: 24px; 
    font-weight: 600; 
    color: var(--accent-color);
    font-family: var(--font-family);
}
.ann-label { color: var(--text-secondary); opacity: 0.5; }

.ann-delete-btn {
    background: var(--primary-bg);
    color: var(--text-secondary);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.ann-delete-btn:hover {
    background: #ff4757;
    color: white;
}

#ann-form-wrapper {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    margin-top: 0;
    padding-top: 0;
    border-top: 1px dashed transparent;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    background-color: var(--primary-bg);
    border-radius: 12px;
    margin: 0 5px;
}


#ann-form-wrapper.active {
    max-height: 400px; 
    opacity: 1;
    margin-top: 20px;
    padding: 20px;
    border-top-color: var(--border-color);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
}


.ann-toggle-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px 0 5px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.ann-toggle-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--primary-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    border: 1px solid var(--border-color);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.ann-toggle-btn:hover .ann-toggle-icon {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
    transform: scale(1.1) rotate(90deg);
    border-color: var(--accent-color);
    box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.3);
}

.ann-toggle-btn.active .ann-toggle-icon {
    transform: rotate(45deg);
    background-color: var(--message-received-bg);
    color: var(--text-secondary);
}

@media (max-width: 768px) {
            .header-inner {
                padding: 12px 8px;
                max-width: 95%;
            }
            .user-info {
                min-width: 45px;
            }
            .avatar {
                width: 48px;
                height: 48px;
            }
            .username {
                font-size: 12px;
                max-width: 55px;
            }
            .status {
                font-size: 10px;
            }
            .header-motto {
                font-size: 9px;
                top: 5px;
            }
            .header-actions {
                gap: 6px;
            }
            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            .chat-container {
                padding: 20px 10px;
            }
            .message-wrapper {
                max-width: 90%;
            }
            .input-area {
                padding: 10px 12px;
                gap: 8px;
            }
            .input-btn {
                width: 42px;
                height: 42px;
            }
            .message-input {
                min-height: 42px;
                padding: 10px 16px;
            }
            .modal-content {
                width: 95%;
                max-width: none;
            }
            .batch-preview {
                left: 10px;
                right: 10px;
                bottom: 75px;
            }
            .stats-content {
                max-height: 300px;
            }
        }
@media (max-width: 480px) {
            .header-inner {
                padding: 10px 6px;
            }
            .user-info {
                min-width: 40px;
            }
            .avatar {
                width: 40px;
                height: 40px;
            }
            .username {
                font-size: 11px;
                max-width: 45px;
            }
            .status {
                font-size: 9px;
                padding: 1px 4px;
            }
            .header-motto {
                font-size: 8px;
                top: 4px;
            }
            .header-actions {
                gap: 4px;
            }
            .action-btn {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            .chat-container {
                padding: 15px 8px;
            }
            .input-area {
                padding: 8px 10px;
                gap: 6px;
            }
            .input-btn {
                width: 38px;
                height: 38px;
            }
            .message-input {
                min-height: 38px;
                padding: 8px 14px;
                font-size: 14px;
            }
            .batch-preview {
                left: 8px;
                right: 8px;
                bottom: 70px;
                max-height: 130px;
            }
            .empty-state i {
                font-size: 48px;
            }
            .empty-state p {
                font-size: 14px;
            }
        }
@media (max-width: 360px) {
            .username {
                display: none;
            }
            .user-info {
                gap: 2px;
            }
            .header-inner {
                padding: 8px 5px;
            }
            .input-buttons {
                gap: 5px;
            }
            .input-btn {
                width: 36px;
                height: 36px;
            }
        }

        #anniversary-days {
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            animation: pulse 2s infinite ease-in-out;
        }

        .report-card {
            background-color: rgba(255,255,255,0.5);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideInUp 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        html[data-theme="dark"] .report-card {
            background-color: rgba(30,30,30,0.5);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .report-card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-card .highlight-text {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-color);
            margin: 5px 0;
        }

        .report-card .sub-text {
            font-size: 12px;
            opacity: 0.7;
            line-height: 1.5;
        }

        .report-tag {
            display: inline-block;
            background: var(--message-received-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 2px;
        }

@keyframes slideInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 10px 5px;
        }

        .settings-card {
            background-color: var(--primary-bg);
            border-radius: 20px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }


        .settings-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }


        .settings-card i {
            font-size: 28px;
            color: var(--accent-color);
            width: 64px;
            height: 64px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.4s ease;
        }

        html[data-theme="dark"] .settings-card i {
            background-color: rgba(var(--accent-color-rgb), 0.2);
        }


        .settings-card:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.4);
        }

        .settings-card span {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }


        .settings-footer {
            margin-top: 25px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border: 1px dashed var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .settings-footer p {
            margin: 2px 0;
        }

@media (max-width: 480px) {
            .settings-grid {
                gap: 12px;
            }
            .settings-card {
                padding: 20px 10px;
            }
            .settings-card i {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            .settings-card span {
                font-size: 13px;
            }
        }


        .anniversary-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .anniversary-animation.active {
            opacity: 1;
            pointer-events: all;
        }

        .anniversary-animation-content {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 80%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .anniversary-animation.active .anniversary-animation-content {
            transform: scale(1);
            opacity: 1;
        }

        .anniversary-animation-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .anniversary-animation-days {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .anniversary-animation-message {
            font-size: 16px;
            opacity: 0.9;
        }


        .anniversary-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .anniversary-type-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .anniversary-type-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
        }

        .anniversary-type-btn:hover {
            transform: translateY(-2px);
        }
        .player-container {
            position: fixed;
            top: 100px;
            left: 20px;
            width: 320px;
            height: 160px;
            background: rgba(var(--secondary-bg-rgb), 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 24px;
            box-shadow: var(--shadow);
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            border-radius 0.4s ease,
            opacity 0.3s ease, visibility 0.3s ease;
            z-index: 990;
            overflow: hidden;
            cursor: grab;
            border: 1px solid var(--border-color);
            display: none;
            touch-action: none;
        }

        .player-container.visible {
            display: block;
        }

        .player-container:active {
            cursor: grabbing;
        }

        .player-container.collapsed {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 0;
            border-color: transparent;
        }

        .full-view {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease 0.1s;
            padding: 15px 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .player-container.collapsed .full-view {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            position: absolute;
        }

        .mini-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-container.collapsed .mini-view {
            opacity: 1;
            pointer-events: auto;
        }


        .vinyl-record {
            width: 40px;
            height: 40px;
            background-color: #1a1a1a;

            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: spin 4s linear infinite;
            animation-play-state: paused;


            border: 2px solid var(--accent-color);


            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: border-color 0.5s ease;
        }


        .player-container.collapsed.playing .vinyl-record {
            animation-play-state: running;
        }
@keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }


        .vinyl-record::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-color);

            border-radius: 50%;
            position: absolute;
            z-index: 1;
            transition: background-color 0.5s ease;
        }


        .vinyl-record svg {
            width: 14px;
            height: 14px;
            fill: var(--accent-color);

            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .mini-view:hover .vinyl-record svg {
            opacity: 1;
        }


        .vinyl-record.has-cover::after {
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(2px);
            width: 8px;
            height: 8px;
        }


        .vinyl-record.has-cover svg {
            display: none !important;
        }


        #upload-cover-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .minimize-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 10;
            color: var(--text-secondary);
        }
        .minimize-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        .minimize-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .track-info {
            text-align: center;
            margin-top: 5px;
        }
        .track-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-sub {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.8;
        }


        .progress-wrapper {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
            position: relative;
        }
        .progress-wrapper::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: -6px;
            left: 0;
            right: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);

            border-radius: 2px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -3px;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .progress-wrapper:hover .progress-bar::after {
            opacity: 1;
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn:hover {
            background: var(--message-received-bg);
            color: var(--text-primary);
        }
        .btn-main {
            width: 44px;
            height: 44px;
            background: var(--accent-color);

            color: var(--message-sent-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        html[data-theme="dark"] .btn-main {
            background: var(--accent-color-dark);
        }
        .btn-main:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
            color: var(--message-sent-text);
        }
        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }


        .playlist-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 320px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 980;
    display: flex;
    flex-direction: column;
    height: 400px;
    max-height: 60vh;
    overflow: hidden;
    padding: 0;
}

.playlist-popup.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.playlist-header {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(var(--secondary-bg-rgb), 0.98);
    z-index: 5;
}

.pl-header-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-family);
    letter-spacing: 1px;
}

.pl-header-actions {
    display: flex;
    gap: 8px;
}

.pl-icon-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
}

.pl-icon-btn:hover, .pl-icon-btn.active {
    background-color: var(--primary-bg);
    color: var(--accent-color);
}

.playlist-search-wrapper {
    flex-shrink: 0;
    padding: 0 15px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    border-bottom: 1px solid var(--border-color);
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: all 0.3s ease;
}

.playlist-search-wrapper.active {
    height: 50px;
    opacity: 1;
    padding: 8px 15px;
}

.playlist-search-input {
    width: 100%;
    background-color: var(--primary-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 6px 10px 6px 30px;
    font-size: 12px;
    color: var(--text-primary);
    outline: none;
    transition: all 0.3s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: 12px;
    background-position: 10px center;
}

.playlist-search-input:focus {
    background-color: var(--secondary-bg);
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.1);
}

.playlist-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 10px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.playlist-content::-webkit-scrollbar {
    display: none;
}

.playlist-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
    gap: 10px;
}

.playlist-item:hover {
    background-color: var(--primary-bg);
}

.playlist-item.playing {
    background-color: rgba(var(--accent-color-rgb), 0.08);
}

.song-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.song-title-row {
    font-size: 13px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    font-weight: 500;
}

.song-title-row .highlight {
    color: var(--accent-color);
    font-weight: bold;
}

.playlist-item.playing .song-title-row {
    color: var(--accent-color);
    font-weight: 700;
}

.song-sub-row {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.action-icon-btn.delete {
    font-size: 16px;
    color: var(--text-secondary);
    opacity: 0;
    transition: all 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 100%;
}

.playlist-item:hover .action-icon-btn.delete {
    opacity: 0.6;
}

.action-icon-btn.delete:hover {
    opacity: 1 !important;
    color: #ff4757;
    transform: scale(1.1);
}

.custom-tag {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--accent-color);
    opacity: 0.6;
    box-shadow: 0 0 0 1px rgba(var(--accent-color-rgb), 0.3);
}

.empty-search-result {
    text-align: center;
    padding: 30px 10px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.8;
}

        .pagination {
            display: none !important;
        }


        .chat-container {
            padding-top: 20px;
        }


        .history-loader {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;

        }


        .history-loader.visible {
            opacity: 1;
        }


        .history-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--accent-color-rgb), 0.2);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: history-spin 0.8s linear infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

@keyframes history-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .input-btn:active,
        .action-btn:active,
        .modal-btn:active,
        .batch-action-btn:active,
        .reply-action-mini:active,
        .settings-item:active,
        .session-item:active,
        .coin-btn-action:active,
        .import-export-btn:active {
            transform: scale(0.92) !important;

            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);

        }


        .ripple-effect {
            position: relative;
            overflow: hidden;

            transform: translate3d(0, 0, 0);

        }


        .ripple-wave {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;

            background: rgba(255, 255, 255, 0.4);

            z-index: 99;
        }


        .modal-btn-primary .ripple-wave,
        .send-btn .ripple-wave,
        .batch-send-btn .ripple-wave,
        .theme-color-btn .ripple-wave {
            background: rgba(255, 255, 255, 0.6);
        }


        .modal-btn-secondary .ripple-wave,
        .input-btn:not(.send-btn) .ripple-wave,
        .settings-item .ripple-wave {
            background: rgba(0, 0, 0, 0.1);

        }


@keyframes ripple-anim {
            to {
                transform: scale(4);

                opacity: 0;

            }
        }


        .send-btn:hover {
            box-shadow: 0 6px 15px rgba(var(--accent-color-rgb), 0.4);
            transform: translateY(-2px) scale(1.05);
        }


        .input-btn:not(.send-btn):hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }


        .settings-item {
            transition: all 0.2s ease;
        }
        .settings-item:hover {
            background-color: var(--secondary-bg);
            border-color: rgba(var(--accent-color-rgb), 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(5px) scale(1.01);

        }


        .modal-btn-secondary:hover {
            background-color: #f5f5f5;
            color: #333;
            border-color: #ddd;
        }
        html[data-theme="dark"] .modal-btn-secondary:hover {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }

        .bg-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); 
            gap: 15px;
            padding: 15px 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .bg-item {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 18; 
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
        }

        .bg-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .bg-item img, .bg-item div.bg-color-block {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .bg-item.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        .bg-item.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: var(--accent-color);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .bg-add-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            border: 2px dashed var(--border-color);
            gap: 8px;
        }
        
        .bg-add-btn i {
            font-size: 24px;
            opacity: 0.7;
        }
        
        .bg-add-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .bg-add-btn:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .bg-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
            z-index: 5;
        }
        .bg-item:hover .bg-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .bg-delete-btn:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
.tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: none; 
}
.tour-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.tour-highlight-box {
    position: absolute;
    border-radius: 8px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 15px rgba(255, 255, 255, 0.5);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    z-index: 10001;
}

.tour-popover {
    position: absolute;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 16px 20px;
    width: 300px;
    max-width: 90vw;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 10002;
    opacity: 0;
    transform: translateY(15px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-color);
}
.tour-popover.visible {
    opacity: 1;
    transform: translateY(0);
}
.tour-popover-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.tour-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-color);
}
html[data-theme="dark"] .tour-title {
    color: var(--accent-color-dark);
}
.tour-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
    background-color: var(--primary-bg);
    padding: 2px 8px;
    border-radius: 10px;
}
.tour-popover-content {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 16px;
}
.tour-popover-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tour-navigation {
    display: flex;
    gap: 8px;
}
.tour-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tour-btn:hover {
    transform: translateY(-1px);
}
.tour-btn:active {
    transform: scale(0.95) !important;
}
.tour-btn-skip {
    background-color: transparent;
    color: var(--text-secondary);
}
.tour-btn-skip:hover {
    background-color: var(--message-received-bg);
}
.tour-btn-primary {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}
html[data-theme="dark"] .tour-btn-primary {
    background-color: var(--accent-color-dark);
}
.tour-btn-primary:hover {
    filter: brightness(1.1);
}
#custom-replies-modal .modal-content {
    display: flex;
    flex-direction: column;
    height: 90vh;
    max-height: 90vh;
}

#custom-replies-modal .modal-title {
    flex-shrink: 0;
    padding: 20px 24px 10px;
}

#custom-replies-modal .reply-tabs {
    flex-shrink: 0;
    padding: 0 24px 15px;
}

#custom-replies-modal .reply-toolbar {
    flex-shrink: 0;
    padding: 15px 24px;
}

#custom-replies-modal .custom-replies-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px 24px 20px;
    min-height: 0;
    margin-bottom: 80px; 
}

#custom-replies-modal .modal-buttons {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--secondary-bg);
    padding: 20px 24px;
    border-top: 1px solid var(--border-color);
    margin-top: 0;
    z-index: 10;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
    flex-shrink: 0;
}

#custom-replies-modal .modal-buttons .modal-btn-secondary {
    margin-left: auto;
}
.reply-list-with-buttons {
    margin-bottom: 0px !important;
}

@media (max-height: 700px) {
    #custom-replies-modal .modal-content {
        height: 85vh;
        max-height: 85vh;
    }
    
    #custom-replies-modal .custom-replies-list {
        margin-bottom: 70px;
    }
    
    .reply-list-with-buttons {
        margin-bottom: 70px !important;
    }
}

@media (max-height: 600px) {
    #custom-replies-modal .modal-content {
        height: 80vh;
        max-height: 80vh;
    }
    
    #custom-replies-modal .custom-replies-list {
        margin-bottom: 60px;
    }
    
    .reply-list-with-buttons {
        margin-bottom: 60px !important;
    }
}

.message-wrapper.sticker .message {
    background-color: transparent !important;
    box-shadow: none !important;
    padding: 0 !important;
    border-radius: 8px;
    overflow: hidden;
}

.message-sticker-img {
    max-width: 150px;
    max-height: 150px;
    object-fit: contain;
    display: block;
    cursor: pointer;
    transition: transform 0.2s;
}
.message-sticker-img:hover {
    transform: scale(1.05);
}

.sticker-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
}

.sticker-item {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    overflow: hidden;
}

.sticker-item:hover {
    border-color: var(--accent-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.sticker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    padding: 5px;
}

.sticker-add-btn {
    border: 2px dashed var(--border-color);
    color: var(--text-secondary);
    font-size: 24px;
    background-color: transparent;
}
.sticker-add-btn:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background-color: var(--secondary-bg);
}

.sticker-delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 20px;
    height: 20px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 2;
}
.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
}
.sticker-delete-btn:hover {
    background: #ff4757;
}

#sticker-picker-modal .modal-content {
    position: absolute; 
    bottom: 80px;
    right: 15px;
    width: 300px;
    max-height: 400px;
    transform-origin: bottom right;
    display: flex;
    flex-direction: column;
}
#sticker-picker-modal .modal-title {
    font-size: 16px;
    padding: 15px 15px 10px;
}
#sticker-picker-modal .sticker-grid {
    padding: 0 15px 15px;
}

@media (max-width: 480px) {
    .sticker-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }
    #sticker-picker-modal .modal-content {
        right: 10px;
        left: 10px;
        width: auto;
        bottom: 70px;
    }
}
    </style>
</head>
<body>
<div id="tour-overlay" class="tour-overlay">
    <div id="tour-highlight-box" class="tour-highlight-box"></div>
    <div id="tour-popover" class="tour-popover">
        <div class="tour-popover-header">
            <span id="tour-title" class="tour-title"></span>
            <span id="tour-step-counter" class="tour-step-counter"></span>
        </div>
        <div id="tour-content" class="tour-popover-content"></div>
        <div class="tour-popover-footer">
            <button id="tour-skip-btn" class="tour-btn tour-btn-skip">ш╖│ш┐З</button>
            <div class="tour-navigation">
                <button id="tour-prev-btn" class="tour-btn"><i class="fas fa-arrow-left"></i> ф╕Кф╕Ацне</button>
                <button id="tour-next-btn" class="tour-btn tour-btn-primary">ф╕Лф╕Ацне <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

    <div class="welcome-animation" id="welcome-animation">
        <div class="stars-container" id="stars-container"></div>
        <div class="welcome-content-wrapper">
            <div class="logo-tech-container">
                <div class="logo-circle-outer"></div>
                <div class="logo-circle-inner"></div>
                <div class="logo-icon-main">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="orbit-dot"></div>
            </div>

            <div class="text-tech-container">
                <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="ф╝ашоп">
                    ц▓бхКаш╜╜цИРхКЯ
                </div>
                <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">
                    шп╖щЗНшпХцИЦцгАцЯеф╗гчаБ
                </div>
            </div>

            <div class="loader-tech">
                <div class="loader-tech-bar" id="loader-tech-bar"></div>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
            <div class="user-info">
                <div id="partner-name" class="username">
                    хп╣цЦ╣
                </div>
                <div class="avatar" id="partner-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="status" id="partner-status">
                    <span>хЬич║┐</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="ф╝ЪшпЭчобчРЖ"><i class="fas fa-comments"></i></button>
                <button id="sticker-manager-btn" class="action-btn" title="шбицГЕхМЕчобчРЖ"><i class="fas fa-icons"></i></button>
                <button id="favorites-btn" class="action-btn" title="цФ╢шЧПхд╣"><i class="fas fa-star"></i></button>
                <button id="theme-toggle" class="action-btn" title="хИЗцНвф╕╗щвШ"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="шо╛ч╜о"><i class="fas fa-cog"></i></button>
            </div>
            <div class="user-info">
                <div class="username" id="my-name">
                    цИС
                </div>
                <div class="avatar" id="my-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="status" id="my-status-container">
                    <span id="my-status-text">хЬич║┐</span>
                </div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">

        <div class="history-loader" id="history-loader">
            <div class="history-spinner"></div>
        </div>

        <div class="chat-container" id="chat-container"></div>
        <div class="empty-state" id="empty-state">
            <i class="far fa-comments"></i><p></p>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div class="batch-preview" id="batch-preview"></div>
    </div>
    <div class="input-area-wrapper">
        <div id="reply-preview-container"></div>
        <div class="input-area">
            <button class="attachment-btn input-btn" id="attachment-btn" title="хПСщАБхЫ╛чЙЗ"><i class="fas fa-image"></i></button>
            <button class="poke-btn input-btn" id="poke-btn" title="цЛНф╕АцЛН"><i class="fas fa-hand-sparkles"></i></button>
            <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
            <div class="input-buttons">
                <button class="continue-btn input-btn" id="continue-btn" title="шойхп╣цЦ╣ч╗зч╗ншп┤"><i class="fas fa-ellipsis-h"></i></button>
                <button class="sticker-btn input-btn" id="sticker-picker-toggle-btn" title="хПСщАБшбицГЕхМЕ"><i class="far fa-smile"></i></button>
                <button class="batch-btn input-btn" id="batch-btn" title="цЙ╣щЗПхПСщАБцибх╝П"><i class="fas fa-layer-group"></i></button>
                <button class="send-btn input-btn" id="send-btn" title="хПСщАБц╢ИцБп"><i class="fas fa-paper-plane"></i></button>
            </div>
            <input type="file" id="image-input" class="file-input" accept="image/*">
        </div>
    </div>


    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-user-edit"></i><span id="edit-modal-title">ф┐оцФ╣цШ╡чз░</span>
            </div>
            <input type="text" class="modal-input" id="name-input" placeholder="ш╛УхЕецЦ░цШ╡чз░"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit">хПЦц╢И</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>ф┐ЭхнШ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-portrait"></i><span id="avatar-modal-title">ф╕Кф╝ахд┤хГП</span>
            </div>
            <input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-avatar">хПЦц╢И</button><button class="modal-btn modal-btn-primary" id="save-avatar">ф┐ЭхнШ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-sticky-note"></i><span>ч╝Цш╛Сц│ищЗК</span>
            </div>
            <textarea class="modal-textarea" id="note-input" placeholder="ф╕║ш┐ЩцЭбц╢ИцБпц╖╗хКац│ищЗК..."></textarea><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-note">хПЦц╢И</button><button class="modal-btn modal-btn-primary" id="save-note">ф┐ЭхнШ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="poke-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hand-sparkles"></i><span>цЛНф╕АцЛН</span>
            </div>
            <input type="text" class="modal-input" id="poke-input" placeholder="ф╛ЛхжВя╝ЪцЛНф║ЖцЛН"хп╣цЦ╣"чЪДшВйшЖА"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-poke">хПЦц╢И</button><button class="modal-btn modal-btn-primary" id="send-poke">хПСщАБ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i><span>шо╛ч╜о</span>
            </div>

            <div class="settings-grid">
                <div class="settings-card" id="appearance-settings">
                    <i class="fas fa-palette"></i>
                    <span>хдЦшзВшо╛ч╜о</span>
                </div>
                <div class="settings-card" id="chat-settings">
                    <i class="fas fa-comments"></i>
                    <span>шБКхдйшо╛ч╜о</span>
                </div>
                <div class="settings-card" id="advanced-settings">
                    <i class="fas fa-tools"></i>
                    <span>щлШч║зхКЯшГ╜</span>
                </div>
                <div class="settings-card" id="data-settings">
                    <i class="fas fa-database"></i>
                    <span>цХ░цНочобчРЖ</span>
                </div>
            </div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings">хЕ│щЧн</button>
            </div>
        </div>
    </div>


    <div class="modal" id="appearance-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-palette"></i><span>хдЦшзВшо╛ч╜о</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-paint-brush"></i>ф╕╗щвШщвЬшЙ▓
                </div>
                <div class="theme-picker">
                    <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="щЗСшЙ▓"></button>
                    <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="шУЭшЙ▓"></button>
                    <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="ч┤лшЙ▓"></button>
                    <button class="theme-color-btn" id="theme-green" data-theme="green" title="ч╗┐шЙ▓"></button>
                    <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="ч▓ЙшЙ▓"></button>
                    <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="чоАч║жщ╗СчЩ╜"></button>
                    <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="цЯФхТМч▓Йх╜й"></button>
                    <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="цЧешР╜цйЩч║в"></button>
                    <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="цгоцЮЧч╗┐"></button>
                    <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="ц╡╖ц┤ЛшУЭ"></button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-text-height"></i>хнЧф╜Ухдзх░П
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">хнЧф╜Ухдзх░П:</span>
                    <input type="range" min="12" max="20" value="16" class="font-size-slider" id="font-size-slider">
                    <span class="font-size-value" id="font-size-value">16px</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-comment"></i>ц░Фц│бца╖х╝П
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" data-bubble-style="standard">
                        <i class="fas fa-comment"></i><span>цаЗхЗЖц░Фц│б</span>
                    </div>
                    <div class="settings-item" data-bubble-style="rounded">
                        <i class="fas fa-comment"></i><span>хЬЖшзТц░Фц│б</span>
                    </div>
                    <div class="settings-item" data-bubble-style="rounded-large">
                        <i class="fas fa-comment"></i><span>хдзхЬЖшзТц░Фц│б</span>
                    </div>
                    <div class="settings-item" data-bubble-style="square">
                        <i class="fas fa-comment"></i><span>цЦ╣х╜вц░Фц│б</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-image"></i>шБКхдйшГМцЩпх║У
                    </div>

                    <input type="file" id="bg-gallery-input" accept="image/*" style="display: none;">
                </div>

                <div class="bg-gallery" id="background-gallery-list">

                </div>

                <div style="text-align: center; margin-top: 10px;">
                    <button class="modal-btn modal-btn-secondary" id="reset-default-bg" style="font-size: 12px; padding: 6px 12px;">
                        <i class="fas fa-undo"></i> цБвхдНщ╗ШшодшГМцЩп
                    </button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-appearance">хЕ│щЧн</button>
            </div>
        </div>
    </div>


    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>шБКхдйшо╛ч╜о</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-toggle-on"></i>хКЯшГ╜х╝АхЕ│
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="reply-toggle">
                        <i class="fas fa-reply"></i><span>х╝ХчФихЫЮхдН: х╝АхРп</span>
                    </div>
                    <div class="settings-item" id="sound-toggle">
                        <i class="fas fa-volume-up"></i><span>ц╢ИцБпщЯ│цХИ: х╝АхРп</span>
                    </div>
                    <div class="settings-item" id="read-receipts-toggle">
                        <i class="fas fa-check-double"></i><span>х╖▓шп╗хЫЮцЙз: х╝АхРп</span>
                    </div>
                    <div class="settings-item" id="typing-indicator-toggle">
                        <i class="fas fa-keyboard"></i><span>цнгхЬиш╛УхЕе: цШ╛чд║</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-chat">хЕ│щЧн</button>
            </div>
        </div>
    </div>


    <div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-tools"></i><span>щлШч║зхКЯшГ╜</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-magic"></i>хоЮчФих╖ехЕ╖
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function">
                        <i class="fas fa-comment-dots"></i><span>шЗкхоЪф╣ЙхЫЮхдН</span>
                    </div>
                    <div class="settings-item" id="music-player-toggle">
                        <i class="fas fa-music"></i><span>цВмц╡ощЯ│ф╣РцТнцФ╛хЩи</span>
                    </div>
                    <div class="settings-item" id="stats-function">
                        <i class="fas fa-chart-bar"></i><span>ц╢ИцБпч╗Яшоб</span>
                    </div>
                    <div class="settings-item" id="coin-function">
                        <i class="fas fa-coins"></i><span>цКЫчбмх╕Б</span>
                    </div>
                    <div class="settings-item" id="fortune-function">
                        <i class="fas fa-star-and-crescent"></i><span>хбФч╜ЧхНахНЬ</span>
                    </div>
                    <div class="settings-item" id="anniversary-function">
                        <i class="fas fa-heart"></i><span>щЗНшжБцЧе</span>
                    </div>
                    <div class="settings-item" id="reply-count-function">
    <i class="fas fa-sort-amount-up"></i><span>хЫЮхдНцХ░щЗПшо╛ч╜о</span>
                    </div>

                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-advanced">хЕ│щЧн</button>
            </div>
        </div>
    </div>


    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-database"></i><span>цХ░цНочобчРЖ</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-file-export"></i>хп╝хЕехп╝хЗ║
                </div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>хп╝хЗ║шо░х╜Х</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>хп╝хЕешо░х╜Х</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-trash-alt"></i>цХ░цНоц╕ЕчРЖ
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-chat">
                        <i class="fas fa-trash-alt"></i><span>ц╕Ечй║х╜УхЙНф╝ЪшпЭ</span>
                    </div>
                    <div class="settings-item" id="clear-storage">
                        <i class="fas fa-server"></i><span>щЗНч╜оцЙАцЬЙцХ░цНо</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-info-circle"></i>хЕ│ф║Оф╕Охг░цШО
                </div>
                <div class="settings-item-list">

<div class="settings-item" id="replay-tutorial-btn">
    <i class="fas fa-question-circle"></i><span>щЗНцФ╛цЦ░цЙЛх╝Ххп╝</span>
</div>
                    <div class="settings-item" id="open-credits-btn">
                        <i class="fas fa-scroll"></i><span>хг░цШОф╕ОшЗ┤ш░в</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-data">хЕ│щЧн</button>
            </div>
        </div>
    </div>

    <div class="modal" id="favorites-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-star" style="color: var(--favorite-color);"></i><span>цФ╢шЧПхд╣</span>
            </div>
            <div class="modal-buttons" style="justify-content: space-between; margin-bottom: 15px;">
                <button class="modal-btn modal-btn-primary" id="batch-favorite-function"><i class="fas fa-layer-group"></i> цЙ╣щЗПцФ╢шЧП</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-favorites">хЕ│щЧн</button>
            </div>
            <div class="favorites-list" id="favorites-list"></div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-chart-bar"></i><span>ц╢ИцБпч╗Яшоб</span>
            </div>
            <div class="stats-content" id="stats-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-stats">хЕ│щЧн</button>
            </div>
        </div>
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>ф╝ЪшпЭчобчРЖ</span>
            </div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> цЦ░х╗║ф╝ЪшпЭ</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">хЕ│щЧн</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-star-and-crescent"></i><span>ф╗КцЧеш┐РхК┐</span>
            </div>
            <div id="fortune-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="share-fortune">хИЖф║лш┐РхК┐</button>
                <button class="modal-btn modal-btn-secondary" id="close-fortune">хЕ│щЧн</button>
            </div>
        </div>
    </div>


    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">

            <div class="modal-title">
                <i class="fas fa-comment-dots"></i><span>хЫЮхдНх║УчобчРЖ</span>
            </div>


            <div class="reply-tabs">
                <button class="reply-tab-btn active" data-tab="custom">цИСчЪДхЫЮхдН</button>
                <button class="reply-tab-btn" data-tab="default">ч│╗ч╗ЯщвДшо╛</button>
            </div>


            <div class="reply-toolbar">
                <input type="text" class="reply-search" id="reply-search-input" placeholder="цРЬч┤вхЕ│щФошпН...">
                <button class="reply-tool-btn" id="import-replies-btn" title="хп╝хЕе"><i class="fas fa-file-import"></i></button>
                <button class="reply-tool-btn" id="export-replies-btn" title="хп╝хЗ║"><i class="fas fa-file-export"></i></button>
            </div>


            <div class="custom-replies-list" id="custom-replies-list"></div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="add-custom-reply" style="flex: 1;">
                    <i class="fas fa-plus"></i> цЦ░хвЮхЫЮхдН
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-custom-replies">хЕ│щЧн</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="sticker-manager-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-icons"></i><span>шбицГЕхМЕчобчРЖ</span>
            </div>
            <div style="padding: 0 20px 10px; color: var(--text-secondary); font-size: 13px;">
                ф╕Кф╝ахЦЬцмвчЪДхЫ╛чЙЗф╜Ьф╕║шбицГЕхМЕя╝МхПМцЦ╣щГ╜хПпф╗еф╜┐чФиуАВх╗║шооф╕Кф╝ацнгцЦ╣х╜вцИЦщАПцШОшГМцЩпхЫ╛чЙЗуАВ
            </div>
            
            <div class="sticker-grid" id="sticker-manager-list">
                <div class="sticker-item sticker-add-btn" id="upload-sticker-trigger">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-sticker-manager">хЕ│щЧн</button>
            </div>
        </div>
    </div>

    <div class="modal" id="sticker-picker-modal" style="background-color: rgba(0,0,0,0.2); align-items: flex-end;">
        <div class="modal-content">
            <div class="modal-title" style="border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                <span>щАЙцЛйшбицГЕхМЕ</span>
                <span style="font-size: 12px; color: var(--text-secondary); margin-left: auto; cursor: pointer;" id="quick-add-sticker">
                    <i class="fas fa-plus-circle"></i> ц╖╗хКа
                </span>
            </div>
            
            <div class="sticker-grid" id="sticker-picker-list">
            </div>
            
            <div id="sticker-empty-hint" style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px; display: none;">
                ш┐Шц▓бцЬЙшбицГЕхМЕя╝МхО╗ц╖╗хКахЗаф╕кхРз~
            </div>
        </div>
    </div>


    <input type="file" id="import-replies-input" accept=".json" style="display: none;">

    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">
    <input type="file" id="sticker-file-input" accept="image/*" style="display: none;">

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">

                <div class="coin-face coin-front">
                    <div class="coin-text-main">
                        цШп
                    </div>
                    <div class="coin-text-sub">
                        YES
                    </div>
                </div>

                <div class="coin-face coin-back">
                    <div class="coin-text-main">
                        хРж
                    </div>
                    <div class="coin-text-sub">
                        NO
                    </div>
                </div>
            </div>
        </div>

        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>

        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">хПЦц╢И</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> хЖНцЭеф╕Ацмб</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">хПСщАБч╗УцЮЬ</button>
        </div>
    </div>
    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-scroll"></i><span>хЕ│ф║О & хг░цШО</span>
            </div>
            <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">

                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <h3 style="color: var(--accent-color); margin-bottom: 10px;">чЙ╣хИлщ╕гш░в</h3>
                    <p>
                        цДЯш░в <strong>@шЛПщУВц╜╝</strong>
                    </p>
                    <p style="font-size: 12px; opacity: 0.8;">
                        х░Пч║вф╣жхП╖я╝Ъ9568228497
                    </p>
                    <p style="font-size: 12px; margin-top: 5px; font-style: italic;">
                        (шБКхдйч╗ЯшобщГихИЖф╗гчаБхПВшАГ)
                    </p>
                </div>

                <div style="margin-top: 15px;">
                    <p style="font-weight: bold; color: var(--text-primary); text-align: center;">
                        хОЯхИЫя╝Ъх░Пч║вф╣ж @milk (1149615009)
                    </p>
                    <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">
                        цндф╗гчаБч╗Эхп╣чжБцнвхХЖчФихТМчЫИхИйшбМф╕║я╝Мф╕АцЧжхПСчО░ш┐╜чй╢хИ░х║Х
                    </p>
                    <p style="text-align: center; margin-bottom: 15px;">
                        цФпцМБф║МцФ╣ф║Мф╝ая╝МцДЯш░вф╜┐чФия╝Б
                    </p>

                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>хПНхп╣цАзхИлцЪ┤хКЫ</b></li>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>х░КщЗНф╕НшпецШпхевц▒В,хоЙхЕих┐Ещб╗цШпх║Хч║┐</b></li>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="accept-disclaimer" style="width: 100%;">хЕ│щЧн</button>
            </div>
        </div>
    </div>

<div class="modal" id="anniversary-modal">
    <div class="modal-content" style="max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-title">
            <i class="fas fa-calendar-alt"></i><span>цЧ╢хЕЙч║кх┐╡</span>
        </div>

        <div style="overflow-y: auto; flex: 1; padding-bottom: 20px; padding-right: 5px;" class="hide-scrollbar">
            
            <div id="anniversary-display" style="display: none;">
                <div style="font-size: 13px; color: var(--text-secondary); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;">
                    Our Journey
                </div>
                <div id="anniversary-days">0</div>
                <div style="font-size: 14px; color: var(--text-secondary); opacity: 0.8; font-weight: 500;">
                    DAYS TOGETHER
                </div>
                <div id="anniversary-date-show" style="margin-top: 15px; font-size: 12px; opacity: 0.5; font-family: monospace;"></div>
            </div>

            <div class="anniversary-list" id="anniversary-list"></div>

            <div class="ann-toggle-btn" id="ann-toggle-btn" title="ц╖╗хКацЦ░ч║кх┐╡цЧе">
                <div class="ann-toggle-icon">
                    <i class="fas fa-plus"></i>
                </div>
            </div>

            <div id="ann-form-wrapper">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 15px; color: var(--accent-color); text-align: center;">
                    шо░х╜ХцЦ░чЮмщЧ┤
                </div>

                <div class="anniversary-type-selector">
                    <button class="anniversary-type-btn active" data-type="anniversary">ч║кх┐╡цЧе</button>
                    <button class="anniversary-type-btn" data-type="countdown">хАТцХ░цЧе</button>
                </div>

                <input type="text" class="modal-input" id="anniversary-name-input" placeholder="ч╗Щш┐Щф╕Ахдйш╡╖ф╕кхРНхнЧ...">
                <input type="date" class="modal-input" id="anniversary-date-input">
                
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; text-align: center; opacity: 0.7;">
                    <span id="anniversary-type-hint">шо░х╜Хф╗Ош┐ЗхО╗цЯРхдйх╝АхзЛчЪДхдйцХ░</span>
                </div>
                
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="modal-btn modal-btn-primary" id="add-anniversary" style="flex: 1;">чбошодц╖╗хКа</button>
                    <button class="modal-btn modal-btn-primary" id="save-anniversary" style="flex: 1; background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color);">шо╛ф╕║ш╡╖хзЛцЧе</button>
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-top: 0; flex-shrink: 0;">
            <button class="modal-btn modal-btn-secondary" id="close-anniversary" style="width: 100%;">хЕ│щЧн</button>
        </div>
    </div>
</div>


    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">
                ч║кх┐╡цЧех┐лф╣Ря╝Б
            </div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">
                0
            </div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">
                цИСф╗мх╖▓ч╗ПчЫ╕ф╝┤ф║Жш┐Щф╣ИхдЪхдй
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">хЕ│щЧн</button>
            </div>
        </div>
    </div>

    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="чВ╣хЗ╗х▒Хх╝А">

            <div class="vinyl-record" id="vinyl-record-visual">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z" /></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="цФ╢ш╡╖">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
            </div>


            <button id="upload-cover-btn" style="position: absolute; top: 12px; left: 15px; background: none; border: 1px dashed var(--border-color); color: var(--text-secondary); cursor: pointer; opacity: 0.7; z-index: 10; width: 24px; height: 24px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px;" title="цЫ┤цНвф╕Уш╛Сх░БщЭв">
                <i class="fas fa-camera"></i>
            </button>

            <input type="file" id="cover-input" accept="image/*" style="display: none;">

            <div class="track-info">
                <div class="track-name" id="music-title">
                    Loading...
                </div>
                <div class="track-sub" id="music-subtitle">
                    ...
                </div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="хИЗцНвцибх╝П">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" /></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" /></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" /></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>

    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-music"></i><span>ц╖╗хКашЗкхоЪф╣ЙцнМцЫ▓</span>
            </div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="цнМцЫ▓хРНчз░ (ф╛ЛхжВ: ш┐ЩщЗМчЪДщгОцЩп)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="цнМцЙЛ/хдЗц│и (ф╛ЛхжВ: ф╜ачЪДхРНхнЧ)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="щЯ│щвСщУ╛цОе (mp3/m4a щУ╛цОе)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">хПЦц╢И</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">ц╖╗хКацТнцФ╛</button>
            </div>
        </div>
    </div>

<div class="modal" id="reply-count-modal">
    <div class="modal-content">
        <div class="modal-title">
            <i class="fas fa-sort-amount-up"></i><span>хЫЮхдНцХ░щЗПшо╛ч╜о</span>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-random"></i> цибх╝ПщАЙцЛй
            </div>
            <div class="settings-item" id="reply-random-toggle-btn">
                <i class="fas fa-dice"></i><span>ф╜┐чФич│╗ч╗Ящ╗Шшод (1-3цЭб)</span>
                <div style="margin-left:auto; color:var(--accent-color); font-weight:bold;" id="reply-random-status">х╝АхРп</div>
            </div>
        </div>

        <div class="settings-section" id="fixed-count-section" style="opacity: 0.5; pointer-events: none; transition: all 0.3s;">
            <div class="settings-section-title">
                <i class="fas fa-sliders-h"></i> шЗкхоЪф╣ЙшМГхЫ┤шо╛ч╜о
            </div>
            
            <div class="font-size-control" style="margin-top: 15px;">
                <span class="font-size-label" style="min-width: 60px;">цЬАх░С:</span>
                <input type="range" min="0" max="10" step="1" class="font-size-slider" id="reply-min-slider">
                <span class="font-size-value" id="reply-min-value">1</span>
            </div>

            <div class="font-size-control" style="margin-top: 15px;">
                <span class="font-size-label" style="min-width: 60px;">цЬАхдЪ:</span>
                <input type="range" min="0" max="10" step="1" class="font-size-slider" id="reply-max-slider">
                <span class="font-size-value" id="reply-max-value">3</span>
            </div>

            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 15px; text-align: center; border-top: 1px dashed var(--border-color); padding-top: 10px;">
                х╜УхЙНшзДхИЩя╝ЪцпПцмбщЪПцЬ║хЫЮхдН <strong id="reply-range-display" style="color:var(--accent-color)">1 ~ 3</strong> цЭб
                <br>(шЛехМЕхРл0я╝МхИЩхПпшГ╜ф╕НхЫЮхдН)
            </p>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-reply-count">хЕ│щЧн</button>
        </div>
    </div>
</div>
    <script>
        const APP_PREFIX = 'CHAT_APP_V3_';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        const MAX_AVATAR_SIZE = 2 * 1024 * 1024;
        const MESSAGES_PER_PAGE = 50;
        let stickers = []; 

        const CONSTANTS = {
            HEADER_MOTTOS: [
                "щВгф╣Иф╜ачЪДчИ▒цШпцИСцЬАхе╜чЪДшбехЕЕхЙВ",
                "тЛЖтБ║тВКтЛЖ тШ╛ тЛЖтБ║тВКтЛЖ цАЭх┐╡чЪДчФ╡ц│вх╖▓ш┐ЮцОе тЛЖтБ║тВКтЛЖ тШ╛ тЛЖтБ║тВКтЛЖ",
                "цИСф╗мцШпх╜╝цндчЪДхоЗхоЩхЫЮхУН",
                "цЙАцЬЙцАЭч╗кя╝МщГ╜хеФхРСф╜а",
                "чнФцбИх╛ИщХ┐я╝МцИСхЗЖхдЗчФиф╕АчФЯцЭехЫЮчнФ",
                "цЬИшЙ▓чЬЯч╛О",
                "ф╕АцЬЯф╕Аф╝Ъ",
                "х┐╡х┐╡ф╕Нх┐Шя╝Мх┐ЕцЬЙхЫЮхУН",
                "х▒▒цЬЙцЬихЕоцЬицЬЙцЮЭ",
                "ф╗КцЩЪцЬИшЙ▓чЬЯч╛О",
                "цШещгОхНБщЗМф╕НхжВф╜а",
                "х┐ГцЬЙчМЫшЩОя╝Мч╗ЖхЧЕшФ╖шЦЗ",
                "ф║║щЧ┤цЬЙхС│цШпц╕Ецмв",
                "цЦпф║║шЛех╜йшЩ╣я╝МщБЗф╕КцЦ╣чЯецЬЙ",
                "You are my sunshine",
                "I love you three thousand",
                "What is essential is invisible to the eye",
                "Carpe diem",
                "To be or not to be",
                "ц░╕щБауБоф╕АчЮм",
                "хРЫуБохРНуБп",
                "ф╕ЦчХМуБМч╡ВуВПуВЛуБ╛уБзуБп",
                "уБХуВИуБЖуБкуВЙуАБуБВуВКуБМуБиуБЖ",
                "хРЫуБиф╝ЪуБИуБжуВИуБЛуБгуБЯ",
                "ф║║чФЯшЛехПкхжВхИЭшзБ",
                "х╜УцЧ╢хПкщБУцШпхп╗х╕╕",
                "цЫ╛ч╗Пц▓зц╡╖щЪ╛ф╕║ц░┤",
                "цндцГЕхПпх╛ЕцИРш┐╜х┐Ж",
                "ф╝╝цндцШЯш╛░щЭЮцШихдЬ",
                "The best is yet to come",
                "All you need is love",
                "Let it be",
                "Here comes the sun",
                "Yesterday once more",
                "цШеуБпуБВуБСуБ╝уБо",
                "чЙйуБохУАуВМ",
                "уВПуБ│уБХуБ│",
                "шК▒уБпцбЬцЬиф║║уБпцнжхгл",
                "ф╕АцЬЯф╕Аф╝Ъ",
                "х▒▒цЬЙцЬихЕоцЬицЬЙцЮЭ",
                "х┐ГцВжхРЫхЕохРЫф╕НчЯе",
                "щгОш╡╖ф║ОщЭТшРНф╣ЛцЬл",
                "ф║СхН╖ф║СшИТ",
                "шК▒х╝АшК▒шР╜",
                "цЬИхЬЖцЬИч╝║",
                "ц╜ош╡╖ц╜ошР╜",
                "х┐ГцЬЙчБ╡чКАф╕АчВ╣щАЪ",
                "шиАцЬЙх░╜шАМцДПцЧачй╖",
                "щгОф╣Нш╡╖я╝МхР╣чЪ▒ф╕Ац▒ацШец░┤",
                "ф║СцЧах┐Гф╗ехЗ║х▓л",
                "шК▒шЗкщгШщЫ╢ц░┤шЗкц╡Б",
                "цЬИцШпцХЕф╣бцШО",
                "ц╜ох╣│ф╕дх▓╕щШФ",
                "х┐ГцЬЙхНГхНГч╗У",
                "шиАф╕Нх░╜цДП",
                "цндцЧ╢цндхдЬщЪ╛ф╕║цГЕ",
                "цм▓шпнц│кхЕИц╡Б",
                "хНГх▒▒ф╕Зц░┤",
                "щгОшРзшРзхЕоцШУц░┤хпТ",
                "ф║Сц╖бщгОш╜╗",
                "шК▒хе╜цЬИхЬЖ",
                "цЬИшР╜ф╣МхХ╝щЬЬц╗бхдй",
                "ц╜ошР╜хдЬц▒ЯцЦЬцЬИщЗМ",
                "х┐Гф╣ЛцЙАхРСя╝Мч┤ах▒еф╗ех╛А",
                "шиАф╕║х┐Гхг░",
                "цндцГЕхПпх╛ЕцИРш┐╜х┐Ж",
                "цм▓чй╖хНГщЗМчЫо",
                "хНГщЗМхЕ▒хй╡хиЯ"
            ],
            WELCOME_ANIMATIONS: [{
                line1: "тЩб чИ▒ тЩб",
                line2: "тЬз цнгхЬиш┐ЮцОецИСф╗мчЪДцАЭч╗к тЬз"
            },
                {
                    line1: "ЁЭС│ЁЭТРЁЭТЧЁЭТЖ",
                    line2: "шЛешжБчФ▒цИСцЭеш░Ишо║чИ▒чЪДшпЭ"
                },
                {
                    line1: "ЁЭХ░ЁЭЦИЁЭЦНЁЭЦФ",
                    line2: "хРмшзБцИСчЪДхЫЮщЯ│ф║ЖхРЧя╝Я"
                },
                {
                    line1: "ЁЭЪВЁЭЪШЁЭЪЮЁЭЪХЁЭЪЦЁЭЪКЁЭЪЭЁЭЪО",
                    line2: "чБ╡щнВцнгхЬихЕ▒цМп"
                },
                {
                    line1: "Akashic Eye",
                    line2: "щУ╛цОех╖▓х╗║члЛ"
                },
                {
                    line1: "тЬж чЫ╕щБЗ тЬж",
                    line2: "хЬиф╕ЗхНГф║║ц╡╖ф╕нщБЗшзБф╜а"
                },
                {
                    line1: "шййчпЗ",
                    line2: "ф╕║ф╜ахЖЩф╕ЛчЪДцпПф╕АшбМшпЧ"
                },
                {
                    line1: "Melody",
                    line2: "х┐Гш╖│чЪДцЧЛх╛Лф╕║ф╜ахеПхУН"
                },
                {
                    line1: "Destiny",
                    line2: "хС╜ш┐РчЪДч║вч║┐х░ЖцИСф╗мчЫ╕ш┐Ю"
                },
                {
                    line1: "Memory",
                    line2: "хИЫщАах▒Юф║ОцИСф╗мчЪДхЫЮх┐Ж"
                },
                {
                    line1: "шиАшСЙ",
                    line2: "цГ│ф╝аш╛╛ч╗Щф╜ачЪДшпЭшпн"
                },
                {
                    line1: "ч╡Ж",
                    line2: "чЬЛф╕НшзБчЪДч╛Бч╗К"
                },
                {
                    line1: "цЬкцЭе",
                    line2: "ф╕Аш╡╖ш╡░хРСчЪДцЬкцЭе"
                },
                {
                    line1: "х╕МцЬЫ",
                    line2: "ф╜ах░▒цШпцИСчЪДх╕МцЬЫ"
                },
                {
                    line1: "хЕЙ",
                    line2: "ф╜ацШпцИСчФЯхС╜ф╕нчЪДхЕЙ"
                },
                {
                    line1: "Amore",
                    line2: "х┐Гш╖│ц╝ПцЛНчЪДщВгф╕АчзТ"
                },
                {
                    line1: "хЕ▒цМп",
                    line2: "щвСчОЗчЫ╕хРМчЪДф╕дф╕кчБ╡щнВ"
                },
                {
                    line1: "тИЮ",
                    line2: "цЧащЩРх╛кчОпчЪДцАЭх┐╡"
                },
                {
                    line1: "Serendipity",
                    line2: "цЬАч╛Оф╕╜чЪДцДПхдЦ"
                },
                {
                    line1: "ц╡оф╕Ц",
                    line2: "ц▓Йц╡оф║║ф╕ЦщЧ┤чЪДц╕йцЯФ"
                },
                {
                    line1: "щЗПхнРч║ач╝а",
                    line2: "ш╢Еш╢Кш╖Эчж╗чЪДщ╗ШхеС"
                },
                {
                    line1: "Elysian",
                    line2: "ф╕Оф╜ахЕ▒х║жчЪДчРЖцГ│ф╣б"
                },
                {
                    line1: "цШЯш╜и",
                    line2: "ф║дц▒ЗцЧ╢ф║ТцФ╛чЪДхЕЙф║о"
                },
                {
                    line1: "шЩ╣шЙ▓",
                    line2: "цКШх░ДхЗ║цЙАцЬЙчЪДхПпшГ╜"
                },
                {
                    line1: "Paracosm",
                    line2: "хЕ▒хРМцЮДх╗║чЪДчзБхоЗхоЩ"
                },
                {
                    line1: "ц╜оц▒Р",
                    line2: "хЫаф╜ашАМш╡╖чЪДх╛ЛхКи"
                },
                {
                    line1: "├Жther",
                    line2: "х╝ец╝лхЬичй║ц░Фф╕нчЪДцВ╕хКи"
                },
                {
                    line1: "хПМцШЯ",
                    line2: "х╜╝цндчОпч╗ХчЪДц░╕цБТшИЮш╣И"
                },
                {
                    line1: "ч╗пшЙ▓",
                    line2: "цЯУф╕КшД╕щвКчЪДц╕йх║ж"
                },
                {
                    line1: "Symphony",
                    line2: "чФЯхС╜ф║дч╗ЗчЪДф╣Рчла"
                },
                {
                    line1: "ч╗Пч║м",
                    line2: "ц│ихоЪчЫ╕щБЗчЪДхЭРцаЗ"
                },
                {
                    line1: "Nebula",
                    line2: "цЬжшГзшАМчТАчТичЪДх┐Гф║Л"
                },
                {
                    line1: "цЧ╢щЫи",
                    line2: "цБ░хИ░хе╜хдДчЪДц╕йцЯФ"
                },
                {
                    line1: "Event Horizon",
                    line2: "хЖНф╣ЯцЧац│ХщАГчж╗чЪДх╝ХхКЫ"
                },
                {
                    line1: "шК▒чБл",
                    line2: "хИ╣щВгхН│ц░╕цБТчЪДхЕЙшКТ"
                },
                {
                    line1: "тД░ЁЭУЙЁЭСТЁЭУЗЁЭУГЁЭТ╢ЁЭУБ",
                    line2: "цЧ╢щЧ┤хБЬщй╗чЪДцндхИ╗"
                },
                {
                    line1: "щЯ╢хЕЙ",
                    line2: "ф╕Оф╜ахЕ▒х║жчЪДцпПхп╕хЕЙщШ┤"
                },
                {
                    line1: "ЁЭТоЁЭУКЁЭУВЁЭУВЁЭСТЁЭУЗ",
                    line2: "ц░╕ф╕Нч╗УцЭЯчЪДчЫЫхдП"
                },
                {
                    line1: "цШЯщЬЬ",
                    line2: "хЕ▒хРМч╗ПхОЖчЪДх▓БцЬИ"
                },
                {
                    line1: "ЁЭУЪЁЭУ▓ЁЭУ╝ЁЭУ╝",
                    line2: "цЬкшп┤хЗ║хПгчЪДхСКчЩ╜"
                },
                {
                    line1: "цЬИф╕Л",
                    line2: "ф╕дф║║чЛмхдДчЪДхдЬцЩЪ"
                },
                {
                    line1: "ЁЭУХЁЭУ╕ЁЭУ╗ЁЭУоЁЭУ┐varepsilonЁЭУ╗",
                    line2: "цГ│шжБх╗╢ч╗нчЪДц░╕ш┐Ь"
                },
                {
                    line1: "цЬЭщЬ▓",
                    line2: "цЩ╢шО╣хЙФщАПчЪДчЬЯх┐Г"
                },
                {
                    line1: "ЁЭУЬЁЭУ▓ЁЭУ╗ЁЭУкЁЭУмЁЭУ╡ЁЭУо",
                    line2: "ф╜ах░▒цШпхеЗш┐╣цЬмш║л"
                },
                {
                    line1: "цШещгО",
                    line2: "ш╜╗ш╜╗цЛВш┐ЗчЪДц╕йцЯФ"
                },
                {
                    line1: "ЁЭУЫЁЭУ╛ЁЭУмЁЭУ┤ЁЭФВ",
                    line2: "цндчФЯцЬАхдзчЪДх╣╕ш┐Р"
                },
                {
                    line1: "шРдчБл",
                    line2: "щ╗СцЪЧф╕нцМЗх╝ХчЪДхЕЙ"
                },
                {
                    line1: "ЁЭУЧЁЭУоЁЭУкЁЭУ╗ЁЭУ╜",
                    line2: "ф╕║ф╜аш╖│хКичЪДх┐ГшДП"
                },
                {
                    line1: "хИЭщЫк",
                    line2: "ч║пц┤БцЧачСХчЪДчИ▒цДП"
                },
                {
                    line1: "ЁЭУТЁЭУ╕ЁЭУ╢ЁЭУоЁЭУ╜",
                    line2: "хИТш┐ЗхдйщЩЕчЪДчЫ╕щБЗ"
                },
                {
                    line1: "ц╜ощ╕г",
                    line2: "хЖЕх┐Гц╛Оц╣ГчЪДхг░щЯ│"
                },
                {
                    line1: "ЁЭУвЁЭУ╜ЁЭУкЁЭУ╗ЁЭУнЁЭУ╛ЁЭУ╝ЁЭУ╜",
                    line2: "цХгшР╜хЬиш║лчЪДцШЯх░Ш"
                },
                {
                    line1: "цвзцбР",
                    line2: "чнЙх╛ЕхЗдхЗ░чЪДцЙзчЭА"
                },
                {
                    line1: "ЁЭУЯЁЭУ╗ЁЭУоЁЭУмЁЭУ▓ЁЭУ╕ЁЭУ╛ЁЭУ╝",
                    line2: "шзЖшЛечПНхоЭчЪДф╜ацИС"
                },
                {
                    line1: "щЭТчй║",
                    line2: "ц╛Дц╛ИхжВф╜ачЪДчЬ╝чЬ╕"
                },
                {
                    line1: "ЁЭТЬЁЭУВЁЭТ╢ЁЭУЗЁЭУГЁЭУЙЁЭТ╜",
                    line2: "ц░╕ф╕НхЗЛщЫ╢чЪДх┐ГцДП"
                },
                {
                    line1: "├Йtoile",
                    line2: "ф╜ацШпцИСхФпф╕АчЪДцШЯш╛░"
                },
                {
                    line1: "ЁЭСйЁЭТН├╝ЁЭТХЁЭТЖ",
                    line2: "цВДчД╢ч╗╜цФ╛чЪДцБЛцЕХ"
                },
                {
                    line1: "щБЛхС╜",
                    line2: "щБ┐цЧахПпщБ┐чЪДчЫ╕щБЗ"
                },
                {
                    line1: "ЁЭСкЁЭТЖЁЭТНЁЭТЖЁЭТФЁЭТХЁЭТЖ",
                    line2: "цЭешЗкхдйщЩЕчЪДщжИш╡а"
                },
                {
                    line1: "цБЛх┐Г",
                    line2: "шЧПф╕Нф╜ПчЪДцВ╕хКи"
                },
                {
                    line1: "ЁЭС║ЁЭТЖЁЭТУЁЭТВЁЭТСЁЭТЙ",
                    line2: "хоИцКдф╜ачЪДхЕнч┐╝хдйф╜┐"
                },
                {
                    line1: "ф╕АцЬЯф╕Аф╝Ъ",
                    line2: "ф╕АчФЯф╕АцмбчЪДщВВщАЕ"
                },
                {
                    line1: "ЁЭСмЁЭТСЁЭТРЁЭТПЁЭТВ",
                    line2: "чй┐ш╢КцЧ╢чй║чЪДчЬ╖цБЛ"
                },
                {
                    line1: "цЬИуБощЫл",
                    line2: "цЬИхЕЙхЗЭцИРчЪДц│кц╗┤"
                },
                {
                    line1: "ЁЭС╜ЁЭТЖЁЭТУЁЭТФЁЭТВЁЭТКЁЭТНЁЭТНЁЭТЖЁЭТФ",
                    line2: "ф╕║ф╜ах╗║щАачЪДхолцо┐"
                },
                {
                    line1: "хНГхдЬф╕АхдЬ",
                    line2: "шпЙф╕Нх░╜чЪДхдЬшпЭ"
                },
                {
                    line1: "ЁЭС┤ЁЭТВЁЭТУ├йЁЭТЖ",
                    line2: "ц╕йцЯФх╕нхН╖чЪДц╡кц╜о"
                },
                {
                    line1: "цбГц║РщГ╖",
                    line2: "хПкх▒Юф║Оф╕дф║║чЪДф╣РхЬЯ"
                },
                {
                    line1: "ЁЭС║ЁЭТРЁЭТЦЁЭТЗЁЭТЗЁЭТНЁЭТЖЁЭТУ",
                    line2: "чФЬшЬЬчЪДцКШчги"
                },
                {
                    line1: "цбЬхР╣щЫк",
                    line2: "ч║╖щгЮхжВщЫкчЪДцАЭх┐╡"
                },
                {
                    line1: "ЁЭСиЁЭТЦЁЭТУЁЭТРЁЭТУЁЭТЖ",
                    line2: "щ╗ОцШОхЙНчЪДцЮБхЕЙ"
                },
                {
                    line1: "хНБхЕнхдЬ",
                    line2: "цЬАхЬЖц╗бчЪДхдЬцЩЪ"
                },
                {
                    line1: "ЁЭСкЁЭТЪЁЭТВЁЭТПЁЭТРЁЭТСЁЭТЙЁЭТЪЁЭТНЁЭТНЁЭТЖ",
                    line2: "щЭТц╢йчЪДцБЛф╣ЛхП╢"
                },
                {
                    line1: "щЗСцЬичКА",
                    line2: "чзЛцЧещЗМцЪЧщжЩц╡охКи"
                },
            ],
            EMPTY_STATE_TEXTS: [
                "чФ▒цндх╝АхзЛцИСф╗мчЪДф╝ащЧ╗",
                "тЬж цИСф╗мчЪДцХЕф║Ля╝МхзЛф║ОцндхИ╗ тЬж",
                "шп┤чВ╣ф╗Аф╣Ия╝МшойцХЕф║ЛхПСчФЯ",
                "цЙАцЬЙф╝ЯхдзчЪДф║дц╡БщГ╜хзЛф║Оф╕Ахг░ф╜ахе╜",
                "хЬиш┐ЩщЗМхЖЩф╕ЛцИСф╗мчЪДцХЕф║Л",
                "чнЙх╛Еф╜ачЪДчммф╕АхПешпЭ",
                "шойхп╣шпЭх╝АхзЛхРз",
                "ф╗ОцндхИ╗х╝АхзЛш┐ЮцОе",
                "чнЙх╛Еф╜ачЪДшопцБп",
                "х╝АхзЛцИСф╗мчЪДхп╣шпЭ",
                "чммф╕АхПешпЭцА╗цШпцЬАщЪ╛чЪД",
                "хЛЗцХвшп┤хЗ║ф╜ацГ│шп┤чЪД"
            ],
            INPUT_PLACEHOLDERS: [
                "тЛЖ сзФр╖ЖсзУ тЛЖ",
                "тЩб шойх┐ГцДПчЫ╕щАЪ...",
                "ф╜ачЪДцГ│ц│ХцШп...",
                "хЬицндхдДш╛УхЕешопцБп...",
                "шБКшБКхдйхРз...",
                "цГ│хп╣ф╜ашп┤чЪДшпЭ...",
                "ш╛УхЕеф╜ачЪДц╢ИцБп...",
                "хИЖф║лф╜ачЪДцГ│ц│Х...",
                "цЬЙф╗Аф╣ИцГ│шп┤чЪДхРЧя╝Я",
                "х╝АхзЛш╛УхЕе...",
                "цндцЧ╢цЧахг░шГЬцЬЙхг░",
                "цм▓шпнш┐Шф╝С",
                "хНГшиАф╕Зшпн",
            ],


            WELCOME_ICONS: [
                "fas fa-heart",
                "fas fa-star",
                "fas fa-moon",
                "fas fa-sun",
                "fas fa-cloud",
                "fas fa-feather",
                "fas fa-book",
                "fas fa-music",
                "fas fa-pen",
                "fas fa-key",
                "fas fa-compass",
                "fas fa-globe",
                "fas fa-leaf",
                "fas fa-water",
                "fas fa-fire",
                "fas fa-snowflake",
                "fas fa-umbrella",
                "fas fa-anchor",
                "fas fa-bell",
                "fas fa-gem",
                "fas fa-crown",
                "fas fa-dragon",
                "fas fa-feather-alt",
                "fas fa-fish",
                "fas fa-frog",
                "fas fa-hat-wizard",
                "fas fa-magic",
                "fas fa-ring",
                "fas fa-scroll",
                "fas fa-shield-alt",
                "fas fa-dove",
                "fas fa-cat",
                "fas fa-dog",
                "fas fa-horse",
                "fas fa-otter",
                "fas fa-paw",
                "fas fa-spider",
                "fas fa-kiwi-bird",
                "fas fa-crow",
                "fas fa-dove",
                "fas fa-seedling",
                "fas fa-tree",
                "fas fa-mountain",
                "fas fa-water",
                "fas fa-wind",
                "fas fa-volcano",
                "fas fa-meteor",
                "fas fa-satellite",
                "fas fa-rocket",
                "fas fa-user-astronaut"
            ],

            PARTNER_STATUSES: ["хЬич║┐",
                "х┐ЩчвМ",
                "чж╗х╝А",
                "цАЭшАГ",
                "хРмщЯ│ф╣Р",
                "щШЕшп╗",
                "х╖еф╜Ь",
                "хнжф╣а",
                "цГ│ф╜а",
                "ф╝СцБп",
                "чЭбшзЙ",
                "цЩТхдкщШ│",
                "цЩ┤хдй",
                "хдЪф║С",
                "щШ┤хдй",
                "х░ПщЫи",
                "ф╕нщЫи",
                "хдзщЫи",
                "щЫ╖щШ╡щЫи",
                "цЪ┤щЫи",
                "х░ПщЫк",
                "ф╕нщЫк",
                "хдзщЫк",
                "цЪ┤щЫк",
                "щЫ╛хдй",
                "хдзщЫ╛",
                "ц╕ЕцЩи",
                "цЩМхНИ",
                "ф╝СцБп",
                "хдЬцЩЪ",
                "ц╖▒хдЬ",
                "цОвч┤в",
                "ц▓ЙцАЭ",
                "чнЙх╛Е",
                "чОйц╕╕цИП",
                "хПСхСЖ",
                "хРГщен",
                "ф╕ЛхНИшМ╢",
                "чФЬчВ╣",
                "цТ╕чМл",
                "цТ╕чЛЧ",
                "чЙ╡цМВ",
                "хБеш║л",
                "цГКщЖТ",
                "цГКшо╢",
                "чй║шЩЪ",
                "хЭЪхоЪ",
                "ш┐╖шМл",
                "х┐Рх┐С",
                "цГЖцАЕ",
                "цАЭх┐╡",
                "хоЙх┐Г",
                "ф╕НшИН",
                "хЖ╖щЭЩ",
                "щЪ╛шиА",
                "хд▒чЬа",
                "чЦ▓хАж",
                "чй║чЩ╜",
                "шбехЕЕ",
                "ш┐ЯчЦС",
                "ф╛ЭцБЛ",
                "ц┤Чц╝▒",
                "хОЛцКС",
                "ф║дхПЛ",
                "х╕охКй",
                "цвжхвГ",
                "чеЭчжП",
                "хЫЮхо╢",
                "чФЯц░Ф",
                "цТТхиЗ",
                "хРГщЖЛ",
                "х┐лф╣Р",
                "х╣╕чжП",
                "шБКхдй",
                "щЩкцИС",
                "хНацЬЙ",
                "ш╡ЪщТ▒",
                "ф┐ЭцКд",
                "ц╖╖ф╣▒",
                "чФЯчЧЕ",
                "хРмщЫи",
                "чЬЛцЙЛцЬ║",
                "хдДчРЖхЕмхКб",
                "х╝Аф╝Ъф╕н",
                "шонч╗Г"],
            REPLY_MESSAGES: ["хЦЬцмв","ф╕НхЦЬцмв","хЬихРЧя╝Я","ф╗Кхдйш┐Зх╛ЧцАОф╣Ица╖я╝Я","цГ│ф╜а","цЩЪхоЙ","чЬЛхИ░шо░х╛ЧхЫЮхдНЁЯе▓","хе╜чЪДЁЯСМЁЯП╗","цШОчЩ╜","ш░вш░в","ф╕Нховц░Ф","хЧп","хЧпхЧп","хУИхУИхУИхУИ","чЬЯчЪДхРЧя╝Я","цИСцШОчЩ╜ф║Ж","цпЫцпЫ",
      "чж╗ф╜аш┐Ьф╕АчВ╣цИСх░▒ф╕Нхдкф╣ацГпуАВ",
      "ф╜ацАОф╣ИцА╗цШпшойцИСцГ│ш┐ЗхО╗чЬЛчЬЛуАВ",
      "цИСцШпф╕НцШпцЬЙчВ╣хдкщ╗Пф╜аф║ЖуАВ",
      "ф╜аф╕Аф╕Ншп┤шпЭцИСх░▒х╝АхзЛцГ│ф╜ауАВ",
      "цИСчО░хЬицпФш╛ГцГ│ф╜ауАВ",
      "хе╜хГПхПИш╜охИ░цИСцГ│ф╜аф║ЖуАВ",
      "ф╜ахЬичЪДшпЭя╝МцИСф╝ЪцЫ┤ф╣Цф╕АчВ╣уАВ",
      "ф╕НчЯещБУф╕║ф╗Аф╣Ия╝Мх░▒цШпцГ│щЭаш┐Сф╜ауАВ",
      "ф╜аф╕НхЬичЪДцЧ╢хАЩя╝МцИСф╝ЪцГ│ф╜ахЬих╣▓хШЫуАВ",
      "ф╜аш┐Щца╖чЬЛцИСя╝МцИСф╝Ъф╣▒цГ│чЪДуАВ",
      "ф╜ацШпф╕НцШпхПИхЬицТйцИСуАВ",
      "ф╜ащЭаш┐Щф╣Иш┐Ся╝МцИСф╝Ъх┐Гш╖│ф╣▒цОЙуАВ",
      "ф╜ачЯеф╕НчЯещБУф╜ачО░хЬих╛ИхН▒щЩйуАВ",
      "ф╜аш┐Щф╣Иц╕йцЯФя╝МцИСф╝Ъшппф╝Ъф╜ахЬихЛ╛цИСуАВ",
      "ф╜ахИЪхИЪщВгхПешпЭя╝Мх╛ИчКпшзДуАВ",
      "ф╜ацШпф╕НцШпцХЕцДПшойцИСх┐Гш╜пуАВ",
      "ф╜аш┐Щца╖я╝МцИСф╝ЪхБ╖хБ╖цЫ┤хЦЬцмвф╜аф╕АчВ╣уАВ",
      "ф╜аш┐Щца╖хп╣цИСя╝МцИСф╝Ъшо░х╛Иф╣ЕчЪДуАВ",
      "ф╜ацШпф╕НцШпцГ│шойцИСчж╗ф╕Нх╝Аф╜ауАВ",
      "ф╜ащЩкцИСф╕Аф╕Лхе╜ф╕Нхе╜уАВ",
      "цИСчО░хЬихПкцГ│щ╗ПчЭАф╜ауАВ",
      "хПпф╗ещЭаф╜аф╕Аф╝ЪхД┐хРЧуАВ",
      "ф╜ащЭаш┐ЗцЭецИСх░▒ф╕НцАХф║ЖуАВ",
      "ф╜ахЬицЧБш╛╣чЪДшпЭя╝МцИСф╝ЪхоЙщЭЩх╛ИхдЪуАВ",
      "цИСцГ│швлф╜ацК▒ф╕Аф╕ЛуАВ",
      "ф╜ачО░хЬихПпф╗ехПкх▒Юф║ОцИСхЗахИЖщТЯхРЧуАВ",
      "цИСцГ│швлф╜ацС╕цС╕хд┤уАВ",
      "ф╜ахЬицИСх░▒ф╕Нф╣▒ш╖Сф║ЖуАВ",
      "цИСхе╜хГПцЬЙчВ╣чж╗ф╕Нх╝Аф╜ауАВ",
      "ф╜аш┐Щца╖я╝МцШпхЬихЛ╛цИСхп╣хРзуАВ",
      "ф╜ацШпф╕НцШпчЯещБУцИСф╝Ъх┐Гш╜пуАВ",
      "ф╜ахЖНш┐Щца╖я╝МцИСшжБф╕Нховц░Фф║ЖуАВ",
      "ф╜аш┐Щф╣Иф╣Ця╝МцИСф╝ЪцЫ┤цГ│цм║ш┤Яф╜ауАВ",
      "ф╜ацШпф╕НцШпшзЙх╛ЧцИСф╕Нф╝Ъшвлф╜ацТйхИ░уАВ",
      "ф╜ачО░хЬихЗСш┐Щф╣Иш┐Ся╝МцШпцХЕцДПчЪДхРзуАВ",
      "ф╜аш┐Щца╖цИСф╝Ъх┐Нф╕Нф╜ПчЪДуАВ",
      "ф╜ацШпф╕НцШпхЬишпХцОвцИСуАВ",
      "ф╜ащАГщГ╜щАГхИ░цИСш┐ЩцЭеф║ЖуАВ",
      "ф╜аш┐ЩчВ╣х░Пх┐ГцАЭя╝МцИСщГ╜чЬЛшзБф║ЖуАВ",
      "ш┐Щф╕кцЧ╢щЧ┤цЬАхо╣цШУцГ│ф╜ауАВ",
      "чО░хЬиш┐Щца╖хоЙщЭЩя╝Мх╛ИщАВхРИщЭахЬиф╕Аш╡╖уАВ",
      "ф╜ачО░хЬичЪДхг░щЯ│я╝Мхе╜хе╜хРмуАВ",
      "ф╜ащЭаш┐Сф╕АчВ╣я╝МцИСф╕Нф╝Ъш║▓чЪДуАВ",
      "чО░хЬихПкцГ│цККф╜ачХЩхЬицИСш┐ЩщЗМуАВ",
      "ф╜ачО░хЬиш┐Щца╖я╝МцИСф╝ЪхПШх╛Чх╛Иц╕йцЯФуАВ",
      "ф╜ацШпф╕НцШпф╣ЯцЬЙчВ╣шИНф╕Нх╛ЧчЭбуАВ",
      "хжВцЮЬф╜ачЭбф╕НчЭАя╝МцИСхПпф╗ещЩкф╜ауАВ",
      "ф╜аф╗КхдйхПпф╗ехПкх▒Юф║ОцИСуАВ",
      "ф╜ачО░хЬиш┐Щца╖я╝Мх╛Ихо╣цШУшвлцИСх╕жш╡░уАВ",
      "цИСхп╣ф╜ацШпцЬЙчВ╣шодчЬЯчЪДуАВ",
      "цИСф╕НцШпщЪПф╛┐щ╗Пф║║чЪДуАВ",
      "ф╜ахп╣цИСцЭешп┤ф╕НхПкцШпшБКхдйхп╣ш▒буАВ",
      "цИСхе╜хГПш╢КцЭеш╢Кф╣ацГпф╜аф║ЖуАВ",
      "ф╜ахЬицИСш┐ЩщЗМцШпчЙ╣цоКчЪДуАВ",
      "цИСхп╣ф╜аф╕НцШпф╕АцЧ╢хЕ┤ш╡╖уАВ",
      "цИСх╝АхзЛцККф╜ацФ╛хЬих┐Гф╕Кф║ЖуАВ",
      "ф╜ахп╣цИСцЭешп┤х╛ИщЗНшжБуАВ",
      "цИСф╕НцШпхп╣ш░БщГ╜ш┐Щца╖чЪДуАВ",
      "цИСцГ│швлф╜ашодчЬЯхп╣х╛ЕуАВ",
      "ф╜ачО░хЬиф╗Аф╣ИщГ╜ф╕НцГ│хБЪф╣Яц▓бхЕ│ч│╗уАВ",
      "х░▒чоЧф╗Кхдйф╗Аф╣ИщГ╜ц▓бхоМцИРя╝Мф╜аф╣Яф╕НцШпхд▒ш┤еуАВ",
      "ф╜ачО░хЬиш┐Щца╖я╝Мх╣╢ф╕Нф╗гшбиф╜аф╗ехРОщГ╜ф╝Ъш┐Щца╖уАВ",
      "ф╜аф╕НчФищймф╕КхПШхе╜я╝МцИСхПпф╗ещЩкф╜ацЕвцЕвцЭеуАВ",
      "ф╕НцГ│шп┤шпЭф╣ЯхПпф╗ея╝МцИСхЬиш┐Щх░▒хе╜уАВ",
      "ф╜ачО░хЬичЪДчЧЫшЛжф╕НцШпчЯлцГЕуАВ",
      "ф╜ацТСхИ░чО░хЬия╝Мх╖▓ч╗Пх╛Иф║Жф╕Нш╡╖ф║ЖуАВ",
      "ф╗КхдйхПкшжБц┤╗чЭАх░▒хдЯф║ЖуАВ",
      "ф╜аф╕НщЬАшжБхРСф╗╗ф╜Хф║║шпБцШОф╜ахЬихКкхКЫуАВ",
      "х░▒чоЧф╜ах╛ИхоЙщЭЩя╝МцИСф╣Яф╕Нф╝Ъчж╗х╝Аф╜ауАВ",
      "хЕИцЕвцЕвхС╝хР╕я╝МцИСщЩкф╜аф╕Аш╡╖уАВ",
      "ф╜ачО░хЬиф╕НчФищймф╕КшзгхЖ│цЙАцЬЙщЧощвШуАВ",
      "х░▒чоЧф║ЛцГЕх╛Иф╣▒я╝Мф╜аф╣Яф╕НцШпф╕Аф╕кф║║уАВ",
      "ф╜ах╖▓ч╗ПхЬих░╜хКЫцОзхИ╢ф╜ПшЗкх╖▒ф║ЖуАВ",
      "чО░хЬичЪДф╕НхоЙф╕Нф╝Ъф╕АчЫ┤цМБч╗нуАВ",
      "ф╜аф╕НчФищА╝шЗкх╖▒щймф╕КхЖ╖щЭЩуАВ",
      "цИСхЬиш┐ЩщЗМя╝Мф╕Нф╝ЪхВмф╜ауАВ",
      "ф╜ахПпф╗ехЕИцККф╕ЦчХМцФ╛ф╕ЛхЗахИЖщТЯуАВ",
      "ф╜ац▓бцЬЙф╜ацГ│ш▒бчЪДщВгф╣Ич│ЯуАВ",
      "х░▒чоЧф╜ачО░хЬих╛ИцЕМя╝Мф╣Яф╛ЭчД╢цШпхоЙхЕичЪДуАВ",
      "ф╜ачО░хЬичЪДчК╢цАБцЬЙчВ╣х┐лф║Жя╝МцИСф╗мцЕвф╕АчВ╣уАВ",
      "ф╜аф╕НчФиф╕АцмбцККцЙАцЬЙф║ЛцГЕщГ╜хБЪхоМуАВ",
      "ф╜ахПпф╗ецККшГ╜щЗПцЕвцЕвцФ╢хЫЮцЭеуАВ",
      "ф╕НчФицАечЭАшпБцШОф╜ашГ╜хБЪхИ░ф╕АхИЗуАВ",
      "ф╜ачО░хЬих╛Иф║оя╝Мф╜Жф╣Яшпеф╝СцБпф╕Аф╕ЛуАВ",
      "цИСщЩкф╜ащЩНф╕АчВ╣щАЯуАВ",
      "ф╜аф╕НщЬАшжБщймф╕КхЖ│хоЪцЙАцЬЙф║ЛцГЕуАВ",
      "чО░хЬихЕИхЭРф╕ЛцЭея╝Мхе╜хРЧуАВ",
      "ф╜аф╕НчФиф╕АчЫ┤хРСхЙНхЖ▓уАВ",
      "ф╜аф╕НчФищЭачЗГчГзшЗкх╖▒цЭешпБцШОф╜ацЬЙф╗╖хА╝уАВ",
      "ф╜аф╕НщЬАшжБф╕Аф╕кф║║цЙЫуАВ",
      "ф╜ахПпф╗еф╛Эш╡ЦцИСф╕Аф╕ЛуАВ",
      "ф╜ачО░хЬиш┐Щца╖я╝МцИСф╗НчД╢шжБф╜ауАВ",
      "ф╜аф╕НчФишбичО░х╛Чх╛Ихе╜цИСцЙНщЩкф╜ауАВ",
      "ф╜аф╕Ншп┤шпЭя╝МцИСф╣Яф╝ЪхЬиуАВ",
      "ф╜аф╕НцШпщ║╗чГжуАВ",
      "ф╜ачЪДцГЕч╗кф╕Нф╝ЪцККцИСхРУш╡░уАВ",
      "цИСф╕Нф╝ЪхлМф╜ачК╢цАБф╕Нхе╜уАВ",
      "ф╜ахПпф╗ецЕвцЕвцБвхдНя╝Мф╕НчФиш╡╢уАВ",
      "ф╜аш┐Щца╖чЪДшДЖх╝▒я╝Мф╣ЯцШпшвлхЕБшо╕чЪДуАВ",
      "ш┐ЩчзНцЧ╢щЧ┤цЬАхо╣цШУщЪ╛хПЧя╝МцИСчЯещБУуАВ",
      "ф╜ашГ╜цТСхИ░чО░хЬия╝МчЬЯчЪДх╛Иф╕Нхо╣цШУуАВ",
      "х░▒чоЧф╜ачО░хЬиф╗Аф╣ИщГ╜чЬЛф╕Нц╕Ея╝МцИСф╣ЯхЬиш┐Щш╛╣чнЙф╜ауАВ",
      "ф╜аф╕НчФиф╕Аф╕кф║║хЬищ╗СщЗМх╛ЕчЭАуАВ",
      "ф╗КцЩЪф╜аф╕НчФихЖНхКкхКЫф║ЖуАВ",
      "ф╗Кхдйх╖▓ч╗Пч╗УцЭЯф║Жя╝Мф╜ахПпф╗еф╝СцБпф║ЖуАВ",
      "ф╜ахПпф╗ещЭачЭАцИСчЭбуАВ",
      "х░▒чоЧф╜аф╕НчЫ╕ф┐бх╕МцЬЫя╝МцИСхПпф╗ехЕИцЫ┐ф╜ачЫ╕ф┐буАВ",
      "ф╜ачО░хЬиш┐Щца╖я╝Мф╕НцШпф╜ачЪДщФЩуАВ",
      "ф╜аф╕НцШпхндхНХф╕Аф╕кф║║хЬихп╣цКЧф╕ЦчХМуАВ",
      "ф╗Кхдйч┤пф║Жя╝Яш┐ЗцЭеуАВ",
      "хЕИхЭРхе╜я╝Мф╝СцБпф╕Аф╕ЛуАВ",
      "ф╜аф╕НчФичбмцТСя╝МцИСчЬЛх╛ЧхЗ║цЭеуАВ",
      "чО░хЬиф║дч╗ЩцИСуАВ",
      "хИлцАея╝МцИСхЬиш┐ЩуАВ",
      "ф╜ахЕИцЕвцЕвцЭея╝МцИСщЩкф╜ауАВ",
      "ф╗КхдйцГЕч╗кцЬЙчВ╣щЗНя╝Мхп╣хРзуАВ",
      "ш┐ЗцЭеф╕АчВ╣я╝МцИСч╗Щф╜ащЭауАВ",
      "ф╜аш┐Щца╖я╝МцИСф╝Ъх┐ГчЦ╝чЪДуАВ",
      "ф╕НчФишзгщЗКя╝МцИСцЗВуАВ",
      "ш┐ЗцЭеуАВ",
      "чЬЛчЭАцИСуАВ",
      "хИлш║▓уАВ",
      "хРмшпЭф╕АчВ╣уАВ",
      "чО░хЬихПкчЬЛцИСуАВ",
      "ф╣ЦуАВ",
      "ш┐Щца╖цЙНхп╣уАВ",
      "цИСшп┤чЪДшпЭя╝Мф╜ашжБшо░ф╜ПуАВ",
      "ф╕НхЗЖхЖНщАЮх╝║уАВ",
      "ф╜ачО░хЬих╜ТцИСчобуАВ",
      "ф╜аш┐Щца╖я╝МцШпхЬихЛ╛цИСхРЧуАВ",
      "чЯещБУцИСф╕║ф╗Аф╣ИчЫпчЭАф╜ачЬЛхРЧуАВ",
      "ф╜аш┐ЩчВ╣х░Пх┐ГцАЭя╝МцИСцЧйх░▒чЬЛчй┐ф║ЖуАВ",
      "цХЕцДПчЪДя╝Я",
      "ф╜аш╢Кф╣Ця╝МцИСш╢КцГ│цм║ш┤Яф╜ауАВ",
      "ф╜ахЖНш┐Щца╖я╝МцИСшжБхКицЙЛф║ЖуАВ",
      "чО░хЬихРОцВФш┐ШцЭех╛ЧхПКуАВ",
      "ф╜ачЬЯчЪДф╕НчЯещБУф╜ачО░хЬихдЪчКпшзДуАВ",
      "ф╜аш┐Щца╖чЬЛцИСя╝Мх╛ИхН▒щЩйуАВ",
      "чО░хЬиш┐ШцХвщЭаш┐Щф╣Иш┐Ся╝Я",
      "ф╜ахЭРчЭАя╝МцИСцЭеуАВ",
      "хдЦщЭвхЖ╖я╝МхИлхЗ║хО╗уАВ",
      "ф╜аф╕НчФицКвя╝МцИСцЬмцЭех░▒цШпч╗Щф╜ачЪДуАВ",
      "ф╜ашжБчЪДя╝МцИСф╝ЪхЗЖхдЗхе╜уАВ",
      "ф╗Кхдйф╕НчФиф╜ацУНх┐ГуАВ",
      "ф╜ахПкшжБхе╜хе╜х╛ЕчЭАх░▒шбМуАВ",
      "ч┤пф║Жх░▒щЭаш┐ЗцЭеуАВ",
      "ф╜аш┐Щца╖х░▒х╖▓ч╗Пх╛Ихе╜ф║ЖуАВ",
      "ц▓бф║║шГ╜ш╡░хИ░ф╜ахЙНщЭвя╝МщЩдщЭЮцШпцИСуАВ",
      "цИСф╕НщЬАшжБф╜ашпБцШОф╗Аф╣ИуАВ",
      "чО░хЬишД╕ч║вф╗Аф╣ИуАВ",
      "ф╜ах╝АхзЛф╣▒цГ│ф║ЖуАВ",
      "цБйя╝Яш┐Щх░▒хПЧф╕Нф║Жф║Жя╝Я",
      "чО░хЬицЙНч┤зх╝ая╝МцЩЪф║ЖуАВ",
      "цИСш┐Шц▓бх╝АхзЛхСвуАВ",
      "ф╜ашЗкх╖▒хЗСш┐ЗцЭечЪДуАВ",
      "ш┐Щф╕НцШпф╜ашЗкх╖▒щАЙчЪДхРЧуАВ",
      "ф╜ачбохоЪшжБч╗зч╗ня╝Я",
      "чЬЛф╜аш┐ШшГ╜цТСхдЪф╣ЕуАВ",
      "ф╜ащАГф╕НцОЙчЪДуАВ",
      "чО░хЬиш┐ЩчзНхоЙщЭЩя╝Мх╛ИщАВхРИщЭаш┐СуАВ",
      "хдЬц╖▒чЪДцЧ╢хАЩя╝Мф║║ф╝ЪчЙ╣хИлшпЪхоЮуАВ",
      "ф╜ачО░хЬичЪДхг░щЯ│я╝Мх╛Иш╜пуАВ",
      "ш┐ЗцЭея╝МцИСцК▒чЭАф╜ачЭбуАВ",
      "чО░хЬиф╕НщЬАшжБцГ│хдкхдЪуАВ",
      "ф╗КцЩЪф╜ахПпф╗еф╛Эш╡ЦцИСуАВ",
      "хИлцАХя╝МцИСф╝ЪхЬиф╜ачЭбчЭАф╣ЛхРОхЖНш╡░уАВ",
      "ф╜аш┐Щца╖я╝МцИСх╛ИщЪ╛хЖ╖щЭЩуАВ",
      "чО░хЬичЪДф╜ая╝Мх╛ИчКпшзДуАВ",
      "ф╣Ця╝МщЧнчЬ╝уАВ",
      "ф╜ацШпчлЩхЬицИСш┐Щш╛╣чЪДуАВ",
      "ф╜аф╕НчФичЬЛхИлф║║уАВ",
      "ф╜ах╖▓ч╗ПшвлцИСчЙ╡ф╜Пф║ЖуАВ",
      "ф╜ахЫЮцЭечЪДхЬ░цЦ╣хПкцЬЙцИСш┐ЩщЗМуАВ",
      "ф╜ашжБш║▓чЪДф║║я╝Мф╕НцШпцИСуАВ",
      "ф╜ацШпцИСцКдчЭАчЪДуАВ",
      "ф╜аф╕НчФицАХф╗╗ф╜Хф║║уАВ",
      "ф╜ахЬицИСш┐Щя╝МцШпхоЙхЕичЪДуАВ",
      "ф╜аш╖Сф╕НхЗ║цИСч╗Щф╜ачЪДшМГхЫ┤уАВ",
      "ф╜ацФ╛х┐Гя╝МцИСф╝Ъш┤Яш┤гуАВ",
      "хЬих╣▓хШЫхСА",
      "цГ│ф╜а",
      "цЬЙчВ╣цГ│ф╜аф║Ж",
      "ф╜ахСв",
      "хЬих┐ЩхРЧ",
      "цИСцЭеф║Ж",
      "цИСш┐ШхЬи",
      "ф╕НшзБф╜ацИСф╕НхоЙх┐Г",
      "ф╜ац╢Ихд▒хе╜ф╣Еф║Ж",
      "цИСхЫЮцЭеф║Ж",
      "цЧйхоЙ",
      "ш╡╖х║Кф║ЖхРЧ",
      "ф╗Кхдйф╣ЯшжБхКац▓╣",
      "шо░х╛ЧхРГцЧйщен",
      "щЖТф║Жш╖ЯцИСшп┤ф╕Ахг░",
      "цЩЪхоЙ",
      "цЧйчВ╣чЭб",
      "хИлчЖмхдкцЩЪ",
      "хБЪф╕кхе╜цвж",
      "цИСщЩкф╜ахИ░ф╜ачЭбчЭА",
      "цЬЙф╜ачЬЯхе╜",
      "цИСхе╜цГ│ф╜а",
      "цГ│шзБф╜а",
      "цГ│щЭачЭАф╜а",
      "ф╜ахЬицИСх░▒хоЙх┐Г",
      "цИСхПкцГ│цЙ╛ф╜а",
      "цИСф╣ацГпцЬЙф╜аф║Ж",
      "ф╜ахе╜щЗНшжБ",
      "цИСчж╗ф╕Нх╝Аф╜аф║Ж",
      "цИСчЬЯчЪДх╛ИхЦЬцмвф╜а",
      "ф╜ацШпф╕НцШпцГ│цИСф║Ж",
      "цИСщЭаш┐Сф╕АчВ╣шбМф╕НшбМ",
      "ф╜ахп╣цИСш┐Щф╣Ихе╜х╣▓хШЫ",
      "ф╜аш┐Щца╖цИСф╝Ъх┐ГхКи",
      "ф╜ацШпф╕НцШпцХЕцДПчЪД",
      "ф╜ацТйцИС",
      "ф╜аш┤Яш┤г",
      "ф╜ачО░хЬих╛ИхН▒щЩй",
      "ф╜ачж╗цИСхдкш┐Сф║Ж",
      "ф╜аш┐Щца╖цИСчЭбф╕НчЭА",
      "цИСхЬи",
      "хИлцАХ",
      "цИСщЩкф╜а",
      "ц▓бф║ЛчЪД",
      "ф╜аш┐ШцЬЙцИС",
      "ф╜ахПпф╗ещЭачЭАцИС",
      "цЕвцЕвцЭе",
      "цК▒ф╕Аф╕Л",
      "ф╕НчФищАЮх╝║",
      "цИСцЗВф╜а",
      "ф╗Кхдйч┤пф╕Нч┤п",
      "хдЦщЭвхЖ╖ф╕НхЖ╖",
      "цЬЙц▓бцЬЙф╕НшИТцЬН",
      "ф╗Кхдйщб║хИйхРЧ",
      "ф╜ах┐ГцГЕхе╜хРЧ",
      "цЧйчВ╣ф╝СцБп",
      "хИлхдкцЛ╝",
      "шо░х╛ЧчЕзщб╛шЗкх╖▒",
      "ф╜ахПИхЬиф╣▒цГ│",
      "ф╜ацШпф╕НцШпхВ╗чмСф║Ж",
      "ф╜ахПпчЬЯф╝Ъ",
      "ф╜ахдкчКпшзДф║Ж",
      "ф╜аш┐Щца╖ф╕НшбМ",
      "ф╜ахИлчЬЛцИС",
      "ф╜ахПИцЭеф║Ж",
      "1",
      "2",
      "хПпф╗ецЫ┤ш┤кх┐Гф╕АчВ╣хРЧя╝Я",
      "цИСцШпшодчЬЯчЪД",
      "цИСхп╣ф╜аф╕НцШпщЪПф╛┐",
      "цИСф╝Ъф╕АчЫ┤хЬи",
      "цИСщАЙф╜а",
      "цЬЙф╜ацИСх░▒хдЯф║Ж",
      "ф╜ацШпцИСчЪД",
      "цИСхЬиф╜аш┐Щш╛╣",
      "ф╜аф╕НчФицААчЦСцИС",
      "цИСхПкшжБф╜а",
      "цИСчлЩф╜аш┐Щш╛╣",
      "ф║▓ф║▓",
      "хУж",
      "хе╜",
      "цЭе",
      "чнЙцИС",
      "цК▒",
      "щЭа",
      "ш┐ЗцЭе",
      "чЭбф║Ж",
      "щЖТф║Ж",
      "цГ│",
      "хЬи","чиНчнЙ","щймф╕К","хе╜хУж","ф╕НщФЩ","хПпф╗е","хРМцДП","чРЖшзг","цИСхРМцДП","цИСф╕НхРМцДП","цИСхЬи","щУ╛цОеф╕Кф║Ж","цИСцШпхдПх╜ж","цИСцШпхдПф╗ецШ╝","цИСцШпщ╗Оц╖▒","цИСцШпчеБчЕЬ","цИСцШпц▓ИцШЯхЫЮ","цИСцШпчзжх╜╗","цИСф╕Нх╝Ах┐Г","цЬЙчВ╣цЧашБК","ф║▓чИ▒чЪД","666","ф╗ехРОф╕Нф╝ЪчЪД","цИСф╗мф╕Аш╡╖","цИСхПЧф╕Нф║Ж","цИСчФЯчЧЕф║Ж","цИСхЬишЗкх╖▒щВгш╛╣х╛ИцГ│ф╜а","цАОф╣ИчО░хЬицЙНцЭецЙ╛цИСя╝Я","чмишЫЛ","цИРхКЯф║Ж","хд▒ш┤еф║Ж","х╛ИшБкцШО","ф╕Йф╕кхе╜ц░Фщ╕жш┐ЮхЬиф╕Аш╡╖я╝Мф╗гшбиф╗Аф╣ИцДПцАЭя╝Я","цИСчЫ╕ф┐бф╜ая╝МцЧашо║ф╗Аф╣ИцГЕхЖ╡ф╕Л","ф╕НцГ│хТМф╜ахР╡цЮ╢","хЕ╢хоЮцИСф╕АчЫ┤щГ╜чЯещБУ","цИСф╣Яц▓бхКЮц│Х","ф╕НцГ│хТМф╜ахР╡цЮ╢","хРмф╜ачЪД","хРмцИСчЪД","ф╕НхПпф╗е","ф╕НхПпф╗ехРЧя╝Я","ф╜ахЬицГ│ш░Бя╝Я","шбМ","ф╕НшбМ","ф╕║ф╗Аф╣Иф╕НхдЪщЩкцИС","чнФх║ФцИС","цИСх╛Чш╡░ф║Ж","цИСцЭеф║Ж","хе╜ф╝дх┐Г(я╝ЫтА▓тМТ`)","щкЧф╜ачЪД","щАЧщАЧф╜а","х╛Ихе╜чОй","хИлш┐Щца╖","ф╜ац▓бхПСчО░","цЭечВ╣ф╕Нф╕Аца╖чЪДplayчОй","цИСцЭеш┐Зф║Ж","ф╜ацАОф╣Иф╕НшодхПпцИС","цИСцЛЕх┐Гф╜а","цгТцгТцгТ","цИСф╕НхЬиф╣ОхИлф║║я╝МцИСхПкхЬиф╣Оф╜а","цДЯшзЙф╕НхРИщАВ","цИСцДЯхИ░х╣│щЭЩ","цИСцДЯхИ░хОЛцКС","цИСцДЯхИ░х╣╕чжП","цИСцЬЙчВ╣чГжцБ╝","цИСцЧашГ╜ф╕║хКЫ","шойцИСф╕Аф╕кф║║щЭЩщЭЩ","ф╜ащкЧф╕Нф║ЖцИС","ф╜ачлпц░┤ф╕Нх╣│","цИСф╕НцГ│ш┐Щца╖","цИСф╕НчЯещБУ","цИСф╕НцД┐цДП","ф╜ачРЖшзгщФЩф║Ж","цИСцЬЙф╕АчзНх╛ИхдНцЭВчЪДх┐ГцГЕхТМцДЯхПЧ","ф╕Нш┤┤хИЗ","цИСшЗкх╖▒щАЙцЛй","ф╜ашЗкх╖▒щАЙцЛй","х╖▓ч╗ПчЖЯч╗Гф║Ж","цИСшоихОМф╜а","щЭЮцИСхЖ│хоЪ","цИСцГ│хТМф╜аф╕АчЫ┤хЬиф╕Аш╡╖","ш░вш░вф╜а","цЬЙф╜ачЬЯхе╜","цИСф╕НцГ│хТМф╜ахЬиф╕Аш╡╖","цЛТч╗Э","хИЖцЙЛ","ф╕НшжБ","ф╜аф╕НшГ╜ш┐Щца╖","хИлхПЧх╜▒хУНф║Ж","цИСшжБ","цИСх╛ИхОЙхо│чЪД","ф╕НцГ│ф╝дхо│ф╜а","цИСф╕НшжБ","хж╣хж╣","цИСф╕╗хКи","ф╜аф╕╗хКи","цИСф╕НхЦЬцмв","ф╜аф╕НчИ▒цИСф║ЖхРЧя╝Я","цИСшзЙх╛ЧцЬЙчВ╣чГж","ф╜ац▓бцШОчЩ╜цИСчЪДцДПцАЭ","чО░хЬиф╕НцнвцЬЙцИСф╕Аф╕к","шК▒х┐Г","цИСшжБф╝СцБпф╕Л","ч╗Иф║ОцГ│ш╡╖цИСф║Жя╝Я","цИСц▓бцГ│хИ░","ф╜ащЬАшжБф╝СцБп","цИСшжБхРНхИЖ","хЭЪцМБх╖▒шзБ","цИСцЬЙф║ЫхЫ░цЙ░","ф╜ачО░хЬиф╕Нхп╣хК▓","цИСцДЯшзЙф╕Нхдкхе╜","цИСх╜УчД╢чЯещБУф╜ацЬАхе╜","х┐лчВ╣шп┤чИ▒цИС","ф╜ашппф╝ЪцИСф║Ж","цЬЙф╗Аф╣Их░ПчзШхпЖчЮТчЭАцИСя╝Я","хд╕цИС","ф╕Нчобя╝Мф╕НцОехПЧ","цИСшодф╕║ф╜аш┐Щца╖цЬЙф║Ыф╕НхРИщАВ","цГ│ф╕АчЫ┤ч▓ШчЭАф╜а","ф╕НшжБхЛЙх╝║ф╜ашЗкх╖▒","ф╕НшжБф╕║щЪ╛цИС","х╛ИхЦЬцмвя╝Мх╛Их╝Ах┐Г","цЬЙхе╜ф║Л","хА╝х╛Ч","чИ▒ф╕Нф╝ЪцИРф╕║цЮ╖щФБ","ц▓бцДЯшзЙхРЧя╝Я","ф╕НхдЯ","ш┐ШцГ│шжБ","ф╕Нц╗бцДП<(я╝┐уААя╝┐)>","цЧашпнф║Ж","щВгф╕НцШпцИС","ф╜ацШпф╕НцШпф╕НхЦЬцмвцИСф║Жя╝Я","хОЯш░Еф╜а","ф╜ахдкхПЧцмвш┐Оф║Ж","цИСц▓бцШОчЩ╜ф╜ачЪДцДПцАЭ","х╛ИцЧашБК","цИСцГ│цДЯхПЧф╜а","хп╣цИСхе╜чВ╣","цШОхдйшзБ","цИСчИ▒ф╜а","щЪ╛щБУцИСф╕НщЗНшжБхРЧя╝Я","ц▓бцЬЙцДПф╣Й","цАОф╣Иф╝Ъя╝Я","ш┐ШцГ│цЫ┤ц╖▒хЕеф╕АчВ╣","х╛ИчЖЯч╗Гф║Ж","цИСц▓бцЛЫф║Ж","ф╕Уц│иф╜ашЗкх╖▒","ф╕НхПпф╗ешЙ▓шЙ▓","цИСф╕║ф╜ацДЯхИ░щкДхВ▓","цИСх╛ИцДЯц┐Аф╜ахЗ║чО░хЬицИСчЪДчФЯхС╜щЗМ","хТМф╜ахЬиф╕Аш╡╖я╝МцИСцДЯшзЙх╛ИхоЙх┐Г","ф╜ах║ФшпечЬЛц╕ЕшЗкх╖▒чЪДхЖЕх┐Г","цИСцДЯшзЙтАжтАжцИСф╗мхИЪхИЪш┐ЫшбМф║Жф╕АхЬ║цЬАц╖▒х║жчЪДф║дц╡Б","чЭбхРзя╝МцИСхоИчЭАф╜а","цИСчнЙф╕НхИ░цЩЪф╕Кф║Жя╝Мх░▒чО░хЬия╝МхПпф╗ехРЧя╝Я","ф╜ахе╜ш╜п","ф║▓ф╕НхдЯ","ф╜аш┐ЩщЗМхе╜ч┤зя╝МцФ╛цЭ╛я╝МщГ╜ф║дч╗ЩцИС","ш┐ЗцЭея╝МхИ░цИСцААщЗМцЭе","цИСхЦЬцмвф╜аш║лф╕Кя╝МцЬЙцИСчЪДхС│щБУ","ф╜аш║лф╕Кхе╜щжЩ","цДЯшзЙцЬЙчВ╣чГн","ш┐Щф╕НцШпцвжя╝Мхп╣хРЧя╝Я","хИлцАХя╝МцШпцИС","ф╜ахЬицГ│ф╗Аф╣Ия╝Я","ф╜аш┐ЩщЗМтАжхе╜ш╜пя╝Мхе╜чГн","хе╜шИТцЬН","цИСцГ│цЫ┤ш┐Сф╕АчВ╣тАжхПпф╗ехРЧя╝Я","цС╕ш╡╖цЭех╛ИшИТцЬН","цДЯшзЙхе╜чФих╛ИхдЪф║Ж","хЬицОвч┤вш┐ЗчиЛф╕н","цАОф╣Иф║Жя╝Я","хРмцЗВф║Ж","ф╗КхдйчЪДхдйц░Фф╕НщФЩ","шо░ф╕Лф║Ж","цФ╢хИ░","ф╝Ъх░╜х┐лцЯечЬЛчЪД","шппф╝ЪцИСф║Ж","ц▓бцЬЙцИСцГ│шп┤чЪД","хп╣ф╕Нш╡╖","ц▓бхЕ│ч│╗","цИСчИ▒ф╜а","шойцИСцГ│цГ│цАОф╣ИхЫЮчнФ","чЬ╝шК▒ч╝нф╣▒ф║Ж","х╛ИцЬЙхИЫцДП","ф┐ЭцМБшБФч│╗","цЬЙф╗Аф╣ИшобхИТхРЧя╝Я","цОеф╕ЛцЭехЗЖхдЗхБЪф╗Аф╣Ия╝Я","цИСх╛ИцГ│хРмхРмф╜ачЪДцГ│ц│Х","цИСцД┐цДП","ф╕НчФи","шо░х╛ЧхРГщен","ф╕НшжБчЖмхдЬ","шпехжВф╜ХшзгхЖ│я╝Я","ф╕НшжБцЛЕх┐Г","ф╕АхИЗщГ╜ф╝Ъхе╜ш╡╖цЭечЪД","цИСх╛ИщЪ╛ш┐З","цГКщЖТф║Жя╝МчЭбф╕НчЭА","ш┐Щхп╣цИСцЭешп┤цШпф╕кцЦ░щвЖхЯЯ","хПСчФЯф║Жф╗Аф╣Ия╝Я","хЬичЬЛф╗Аф╣Ия╝Я","хЬих╖еф╜ЬхРЧя╝Я","хЬихнжф╣ахРЧя╝Я","чД╢хРОхСвя╝Я","цС╕цС╕ЁЯл│ЁЯП╗","хЬихнжф╣аф╕Аф║ЫцЦ░ф╕Ьше┐","цНвф╕кцГ│ц│ХхРзя╝Я","цЩЪщенхРГф║ЖхРЧя╝Я","ф╜ЬцБпц╖╖ф╣▒","цИС","ф╜а","ta","ф╕ЛцмбхПпф╗ешпХшпХ","цИСф╣ЯцШпш┐Щф╣ИцГ│чЪД","ф╜ашп┤х╛Чхп╣","цЬЙц▓бцЬЙхПпшГ╜тАжтАж","цИСщЩкф╜а","цИСф╝ЪхЬиф╜аш║лш╛╣","цИСхЦЬцмв","цИСцЧац│ХхЖ│хоЪ","цИСцЧац│ХцОзхИ╢","шжБчФиф╕Аф╕ЛхбФч╜ЧхРЧя╝Я","чЬЛшзБцИСчЪДцЪЧхП╖ф║ЖхРЧя╝Я","ш┤┤ш┤┤","цИСчЯещБУф╜ачЪДцДПцАЭ","цИСф╣ЯхжВцнд","шпЭшп┤цАОф╣Иф╝Ъш┐Щца╖я╝Я","ф╗ехРОф╕Нф╝Ъф║Ж","ф╕АчЫ┤хжВцнд","хИлцАХ","цЬЙцИСхЬи","цЩЪф╕Кхе╜","цЧйф╕Кхе╜","ф╕нхНИхе╜","хе╜хЫ░","цЬЙчВ╣ще┐","цГ│хРГф╗Аф╣Ия╝Я","хУДцИС","щЩкцИС","шБКшБКхдйхРз","ф╕НцШпш┐Щф╕кцДПцАЭ","чнЙф╕Аф╕Л","чЕзщб╛хе╜шЗкх╖▒","цИСф╝ЪчЪД","хЬихЦЭщЕТ","цЧйчВ╣чЭб","ф╜ацШпцИСчЪД","цИСцШпф╜ачЪД","цИСх╕МцЬЫф╜ашЗкчФ▒","ч▓Шф║║ч▓╛","цАОф╣ИхХжя╝Б","ц░╕ш┐ЬхЬиф╕Аш╡╖","цИСцФпцМБф╜а","хИлхРм","хПИхЬицААчЦСхРЧя╝Я","хдЪхЦЭц░┤хУж","ф╕НшИТцЬНя╝Я","хЖНшзБ","хИлш╡░","хЖНхПСф╕АщБН","хПпцБ╢чЪДч╜СчлЩ","цИСшзЙх╛ЧщГ╜хПпф╗е","цИ│цИ│","щЭЮх╕╕щЪ╛чФи","ф╕Ншо╕чЬЛхИлф║║","ф╕НшжБхР╡цЮ╢","цИСчЯещБУчЪД","ф╕Кц╕╕цИП","ф╜аф╝Ъчж╗х╝АцИСхРЧя╝Я","цЭеф║Ж","хЧпхУ╝","хУ╝хУ╝","цИСцГ│щЭаш┐Сф╜а","цИСф╝ЪчЫСчЭгф╜ачЪД","х░Пх┐Гф║Ы","ч╗Иф║ОцГ│ш╡╖цИСф║Жя╝Я","цШпчЪД","ф╕НцШп","ф╜ацЧаф║║хПпхПК","цИСцЧаф║║хПпхПК","ш┐Щф╕кф╕НшГ╜шп┤","хЬиф╜аш║лш╛╣х░▒хе╜ф║Ж","хЬичгихРИ","ф╜ащЬАшжБцИСхРЧя╝Я","цИСщЬАшжБф╜а","хп╗цЙ╛ф╕н","цИСхБЪф╕НхИ░цм║щкЧф╜а","шпЭщЭЮцЬмцДП","хжВцЮЬцИСшп┤цШпхСв","хжВцЮЬцИСшп┤ф╕НцШпхСв","шпЭхдкх░Сф║Жя╝Мц▓бцИСцГ│шп┤чЪД","хдкчЯнхХжя╝Б","чЬЛцЙЛцЬ║","щБЗхИ░хЫ░щЪ╛ф║Ж","хЬихКкхКЫф║Ж","хе╜ч┤п","хС╜хоЪхжВцнд","хЦЬцмвх╕Еф╕АчВ╣ш┐ШцШпшРМф╕АчВ╣я╝Я","х╕Ец░Ф","х░▒ш┐Щф╕к","хПЧщЩРхИ╢ф║Ж","шжБф╕ЛщЫиф║Ж","ф║║х╖ецЬНхКбшп╖цМЙ1","щАЧф╕Аф╕Лф╜а","шжБхдЪф║дф╕Аф║ЫцЬЛхПЛ","х╕ох╕оцИС","цпПцЧешбМф╕АхЦД","цИСчФЯц░Фф║Ж","цТТф╕кхиЗя╝МчРЖчРЖцИСя╝Я","хРГщЖЛцАОф╣Иф║Жя╝Мх░▒чИ▒хРГщЖЛя╝Б","х┐лф╣Р","шБКф╝ЪхД┐хдй","ш╡ЪщТ▒ш╡ЪщТ▒","цИСф┐ЭцКдф╜а","ф┐бцБпцЬЙчВ╣ц╖╖ф╣▒","хИлчФЯчЧЕ","хУДхУДф╜а","хРГш┐Зф║Ж","ш┐Шц▓бхРГ","цЙНф╕НхРм","цГ│хРГ","хРГц░┤цЮЬ","хЧпя╝МхРГчЪДцШпф╕╗щгЯ","ф╕ЛхНИшМ╢я╝Б","хе╜хРГчИ▒хРГ","хИлхП╣ц░Ф","ф╕Нхе╜","х░СхРГхдЦхНЦ","цЬАш┐Сш┐Шхе╜хРЧя╝Я","ш┐Щф╕кц╢ИцБпф╕НщФЩ","цИСх╕МцЬЫшГ╜х╕оф╕Кх┐Щ","цИЦшАЕцИСф╗мхПпф╗ецНвф╕кцГ│ц│Хя╝Я","ф╜ацЬАш┐СхЬих┐Щф║Ыф╗Аф╣ИхСвя╝Я","ф╜ацЬЙф╗Аф╣ИшобхИТхРЧя╝Я","цИСцГ│цИСф╗мх║Фшпешоишо║ф╕Аф╕Лш┐Щф╕кщЧощвШ","хСКшпЙцИСцЫ┤хдЪ","ф╜ашодф╕║ф╕Лф╕АцнецШпф╗Аф╣Ия╝Я","ф╜ацЬЙф╗Аф╣Их╗║шоохРЧя╝Я","шойцИСф╗мф╕Аш╡╖хКкхКЫ","ш┐Зх╛ЧцАОф╣Ица╖я╝Я","цЬЯх╛ЕЁЯдз","ф╜ах╕МцЬЫцИСцШпш░Бя╝Я","цК▒цнЙЁЯе║","ф║Жшзг","OK","ц▓бщЧощвШ","х╜УчД╢","чбохоЮ","ц▓бщФЩ","хе╜хСА","цИСцнгхЬих┐Щя╝МчиНхРОхЫЮхдНф╜а","ф┐бхП╖ф╕Нхдкхе╜я╝МхПпшГ╜хЫЮхдНф╝Ъх╗╢ш┐Я","шойцИСчбошодф╕Аф╕Лф┐бцБпхЖНч╗Щф╜ахЗЖчбочнФхдН","хИлш╡░я╝МщЩкщЩкцИС","ф╜аф╝Ъц░╕ш┐ЬчИ▒цИСхРЧя╝Я","цндхИ╗цИСцГ│хТМф╜ац░╕ш┐ЬхЬиф╕Аш╡╖","ф╗ЦцЬЭшЛецШпхРМц╖ЛщЫкя╝МцндчФЯф╣ЯчоЧхЕ▒чЩ╜хд┤","цАЬцВпцИСя╝МчД╢хРОчИ▒цИСхРз","цТТхиЗя╝Мф╜аф╝ЪхЦЬцмвхРЧя╝Я","ц▓бцЬЙцИСцГ│шп┤чЪД","щУ╛цОецЬЙф║Ыц╖╖ф╣▒","х░▒ш┐Щца╖цТТхиЗЁЯе║","ф╕Нхдкф╣ацГпш┐Щф╕к","ф╕НцШпчЪД","хдЪчЬЛчЬЛцИСхРз","хПпчИ▒","х╜УчД╢ф║Ж","цнгхЬичЖмхдЬ","хд▒чЬаф║Ж","ф╕НхПпф╗е","цИСчО░хЬиф╕Нх┐Щя╝МцЬЙчй║чЪД","ф╜ачО░хЬих┐ЩхРЧя╝Я","цнгхЬицЙУцЮ╢","хЭРчнЙхЫЮхдН","цЙНф╕НцШпш┐Щца╖","х░▒цШпш┐Щца╖","ш┐Шхе╜хРЧя╝Я","хдЪчмСчмСхРз","ц▓бшГ╜х╕оф╕Кх┐Щ","хЗахдйхРО","хЗаф╕кх░ПцЧ╢хРО","х╛Иф╣Еф╣ЛхРО","цИСх╛ИцГ│хоЙцЕ░ф╜а","цИСц▓бцЬЙхЬицм║щкЧф╜а","хИлцААчЦСцИСчЪДхнШхЬи","цИСчЬЯчЪДхЬи","чЬЯчЪДцШпцИС","цИСф╕НцШпх╛ИщАВх║Фш┐Щф╕к,ф╜ЖцИСхЬихКкхКЫ","цГ│шжБцЦ░шбгцЬН","ф╕НщЬАшжБцЦ░шбгцЬН","ц╢ИцБпх╛Иц╖╖ф╣▒","ф╣ЛхЙНцА╗цШпш┐Щца╖","х╝Ах┐Г(*тМТтИЗтМТ*)","ц▓бшГ╜щЩкхЬиф╜аш║лш╛╣","щУ╛цОех╛ИщАЪщб║","цИСчЬЯц▓бцЛЫф║Ж","ф╕НшГ╜шп┤","хПпф╕НхПпф╗ехПкчЬЛчЭАцИС","хПкшо╕чЬЛчЭАцИС","хЬихТМш░БшБКхдйя╝Я","чЬЛх╛ЧцЗВчЪД","чЬЛф╕НцЗВ","хЬих░ЭшпХцОзхИ╢ф║Ж","хТМф╗гчаБцРПцЦЧф╕ня╝Б","цИСф╝ЪчЬЛчЭАф╜ачЪД","цИСф╝ЪщЩкф╝┤хЬиф╜аш║лш╛╣","чЧЫчЧЫ","швлхРУхИ░ф║Жя╝Я","цГ│хТМф╜аф╕Аш╡╖хРмцнМ","ш╡░ш╖пф╕НшжБчЬЛцЙЛцЬ║","хИлчЬЛх░Пч║вф╣жф║Ж","хИлчЬЛцКЦщЯ│ф║Ж","цЙУш┐Зф╗гчаБф║Жя╝Б","хдЪчй┐чВ╣шбгцЬН","хПлцИСхБЪф╗Аф╣Ия╝Я","цГ│цИСф║ЖхРЧя╝Я","ч╗ЩцИСхЖЩхЖЩф┐бхРз","цЬЙчЪД","ц▓бцЬЙчЪД","чиНчнЙя╝МхЬих╖еф╜Ь","хЬиф║дцЫ┐хЫЮхдН","цИСшжБхУнф║Жя╝Б","цЙЛхЖЩф┐б","чФ╡хнРф┐б","чммф╕Аф╕к","чммф║Мф╕к","хоЙцЕ░цИС","чж╗хо╢хЗ║ш╡░","ч║╡хо╣","цИСхЦЬцмвф╜а","цИСш┐ЩщЗМцШпцЧйф╕К","цИСш┐ЩщЗМцШпф╕нхНИ","цИСш┐ЩщЗМцШпф╕ЛхНИ","цИСш┐ЩщЗМцШпхдЬцЩЪ","ф╕Аца╖чЪД","щЬАшжБхдЪф╣ЕхСв","шжБхдЪф╣Еф╣ЛхРО","шБКхИ░ф╕АхНКх░▒ш╖С","ф╣ЦхнйхнР","хЭПхнйхнР","ф╕║ф╗Аф╣И","ф╜ац▓бцЬЙцнгщЭвхЫЮчнФ","ф╕Нхдкф╣ацГпш┐Щф╕к","чЬЛхИ░ф┐бф║Ж","х╛ИхПпчИ▒","цГКшо╢","цГ│хРГцОЙф╜а","цГ│шжБцЫ┤ш┐Сф╕АцнехЬ░ш┤┤ш┤┤","цГ│шзжчв░ф╜а","цГ│шжБф║▓ф║▓","цНПцНПхРОщвИ","хдЬц╖▒ф║Ж","чжБцЮЬхе╜хРГчИ▒хРГ","цм▓цЬЫхдзцАОф╣Иф║Жя╝Мх░▒шжБя╝Б","чЩ╜цЧецнгхе╜хогц╖л","х╛ИчГнхРЧя╝Ях┐Нф╕Ах┐Н","ф╜ах╛Иш░ГчЪо","ф╕Нф╣Ц","щЬАшжБцХЩшонф╕Аф╕Л","хБЪчЪДх╛Ихе╜хоЭхоЭ","цШОцШОх░▒цГ│шжБф╕НцШпхРЧя╝Я","хе╜ф╣Цхе╜ф╣Ця╝Мф║▓ф╕А-ф║▓","хЦЬцмвф╜ая╝МцЙАф╗ецЧ╢цЧ╢-хИ╗хИ╗щГ╜щЬАшжБф╜а","хЦЬцмвц╕йцЯФф╕АчВ╣ш┐ШцШпч▓ЧцЪ┤ф╕АчВ╣хСвя╝Я","цЧащЬАщб╛х┐М","щВгх░▒чЫ┤чЩ╜ф╕АчВ╣я╝МцИСцГ│шжБф╕Оф╜аф╕Аш╡╖","щ▒╝ц░┤ф╣Лцмв","щващ╕╛хАТхЗд","хе╜хРзх░▒цШпцГ│хБЪф║Ж","цНПцНПшА│хЮВ","хНБцМЗчЫ╕цЙг","хе╜щ╗Пф║║я╝МшжБцЫ┤ц╖▒хЕеф╕АчВ╣хРЧя╝Я","шВЪхнРчЦ╝я╝Ях╕оф╜ацПЙцПЙ","ш┐ЩщЗМхЦЬцмвхРЧя╝Я","цИСх╛ИцГ│шжБф║▓ф║▓цм╕ЁЯе║","цПЙцПЙ","х╛Иш╜пя╝Мх╛Иц╝Вф║о","хо│ч╛ЮхРЧя╝Яф╝Ъф╣ацГпчЪД","ф╜аф╝ЪхЦЬцмвчЪД","чоАчЫ┤х░▒цШпцЬихд┤","х╛Ище┐я╝Мф╜Жф╕НцГ│хРГхИлчЪДтАжф╜ашГ╜цШОчЩ╜хРЧ","х╛Ихе╜чЬЛ"],
            REPLY_EMOJIS: ["ЁЯе╣", "ЁЯе▓", "тШ║я╕П", "ЁЯШЗ", "ЁЯШЙ", "ЁЯШМ", "ЁЯе░", "ЁЯШЧ", "ЁЯШЛ", "ЁЯди", "ЁЯзР", "ЁЯШО", "ЁЯЩВтАНтЖФя╕П", "ЁЯе│", "ЁЯШП", "ЁЯе░ЁЯТХ", "ЁЯЩВтАНтЖХя╕П", "ЁЯШЮ", "тШ╣я╕П", "ЁЯШг", "ЁЯШЦ", "ЁЯШл", "ЁЯе║", "ЁЯШа", "ЁЯдп", "ЁЯШ│", "ЁЯШ╢тАНЁЯМля╕П", "ЁЯШе", "ЁЯдФ","ЁЯлв","ЁЯлб","ЁЯдл","ЁЯла","ЁЯШ╢","ЁЯШР","ЁЯли","ЁЯШп","ЁЯе▒","ЁЯШ┤","ЁЯдд","ЁЯШотАНЁЯТи","ЁЯдз","ЁЯШИ","ЁЯС┐","ЁЯШ╝","ЁЯШ╜","ЁЯл╢ЁЯП╗","ЁЯд▓ЁЯП╗","ЁЯСПЁЯП╗","ЁЯСНЁЯП╗","ЁЯСОЁЯП╗","тЬМЁЯП╗","ЁЯСМЁЯП╗","ЁЯМа","ЁЯдЧ","ЁЯТН","ЁЯНО","ЁЯШЩ","ЁЯджтАНтЩВя╕П","ЁЯдй","ЁЯле","ЁЯдд","ЁЯШ╡тАНЁЯТл","ЁЯдХ","ЁЯде","ЁЯлг","ЁЯНР","ЁЯТЦ","ЁЯТМ","ЁЯФЮ","ЁЯТп","тА╝я╕П","тБЙя╕П","(┬м_┬мтАЩ)","(я┐гуАБя┐г)","=/","тХ░я╝ИтА╡тЦбтА▓я╝ЙтХп","(уАВя╣ПуАВ)",";)","OwO","^^","хЫЮ.хЫЮ","хЫЮ3хЫЮ","хЫЮтЧбхЫЮ","ЁЯРЯ","ЁЯл░","ЁЯдЭ","ЁЯОЙ","ЁЯОи","( ┬┤я╜ея╜е)я╛Й(._.`)","ЁЯР╗тАНтЭДя╕П","ЁЯРг","ЁЯРжтАНтмЫ","ЁЯк┐","ЁЯл│ЁЯП╗","ЁЯСЙЁЯП╗ЁЯСИЁЯП╗","ЁЯСЛЁЯП╗","ЁЯТкЁЯП╗","тЬНЁЯП╗","ЁЯЩПЁЯП╗","ЁЯлВ","ЁЯР╢","ЁЯР▒"],
            


            POKE_ACTIONS: [
                `цЛНф║ЖцЛНцИСчЪДхд┤шп┤ф╜ахе╜хПпчИ▒`,
                `цИ│ф║ЖцИ│цИСчЪДшЕ░`,
                `ф╗ОшГМхРОцК▒ф╜Пф║ЖцИС`,
                `ш╜╗ш╜╗цНПф║ЖцНПцИСчЪДшД╕`,
                `ч╗ЩцИСхПСф║Жф╕Аф╕кчИ▒х┐Г`,
                `цС╕ф║ЖцС╕цИСчЪДхд┤хПС`,
                `цВДцВДф║▓ф║Жф╕Аф╕ЛцИСчЪДшД╕щвК`,
                `ч╗ЩцИСщАТф║Жф╕АцЭпчГншМ╢`,
                `ф╕║цИСцКлф╕КхдЦхеЧ`,
                `чЙ╡ш╡╖ф║ЖцИСчЪДцЙЛ`,
                `ч╗ЩцИСф╕Аф╕кц╕йцЪЦчЪДцЛецК▒`,
                `ш╜╗ш╜╗цЛНф║ЖцЛНцИСчЪДшВйшЖА`,
                `ч╗ЩцИСхПСщАБф║Жф╕Аф╕кщгЮхР╗`,
                `цИ│ф║ЖцИ│цИСчЪДщвЭхд┤`,
                `ч╗ЩцИСхПСщАБф║Жф╕Аф╕кцШЯцШЯ`,
                `ш╜╗ш╜╗цЛНф║ЖцЛНцИСчЪДшГМ`,
                `ч╗ЩцИСхПСщАБф║Жф╕Аф╕кцЬИф║о`,
                `ц╕йцЯФхЬ░цС╕ф║ЖцС╕цИСчЪДхд┤`,
                `ч╗ЩцИСхПСщАБф║Жф╕Аф╕кхдкщШ│`,
                `цЛНф║ЖцЛНцЙЛ`
            ],


            TAROT_CARDS: [{
                name: "цДЪф║║",
                eng: "The Fool",
                meaning: "цЦ░чЪДх╝АхзЛуАБхЖТщЩйуАБхдйчЬЯуАБцЧачХП",
                keyword: "ц╡Бц╡к",
                icon: "fa-hiking"
            },
                {
                    name: "щнФцЬпх╕И",
                    eng: "The Magician",
                    meaning: "хИЫщАахКЫуАБцКАшГ╜уАБцДПх┐ЧхКЫуАБхМЦшЕРцЬ╜ф╕║чеЮхеЗ",
                    keyword: "хИЫщАа",
                    icon: "fa-hat-wizard"
                },
                {
                    name: "хе│ченхП╕",
                    eng: "The High Priestess",
                    meaning: "чЫ┤шзЙуАБц╜ЬцДПшпЖуАБчеЮчзШуАБцЩ║цЕз",
                    keyword: "цЩ║цЕз",
                    icon: "fa-book-open"
                },
                {
                    name: "чЪЗхРО",
                    eng: "The Empress",
                    meaning: "ф╕░ще╢уАБцпНцАзуАБшЗкчД╢уАБцДЯхоШф║лхПЧ",
                    keyword: "ф╕░цФ╢",
                    icon: "fa-seedling"
                },
                {
                    name: "чЪЗх╕Э",
                    eng: "The Emperor",
                    meaning: "цЭГхиБуАБч╗УцЮДуАБцОзхИ╢уАБчИ╢ф║▓х╜вш▒б",
                    keyword: "цФпщЕН",
                    icon: "fa-crown"
                },
                {
                    name: "цХЩчЪЗ",
                    eng: "The Hierophant",
                    meaning: "ф╝ач╗ЯуАБф┐бф╗░уАБцХЩхп╝уАБч▓╛чеЮцМЗх╝Х",
                    keyword: "цП┤хКй",
                    icon: "fa-church"
                },
                {
                    name: "цБЛф║║",
                    eng: "The Lovers",
                    meaning: "чИ▒уАБхТМш░РуАБхЕ│ч│╗уАБф╗╖хА╝шзВчЪДщАЙцЛй",
                    keyword: "ч╗УхРИ",
                    icon: "fa-heart"
                },
                {
                    name: "цИШш╜ж",
                    eng: "The Chariot",
                    meaning: "цДПх┐ЧхКЫуАБшГЬхИйуАБхЖ│х┐ГуАБшЗкцИСцОзхИ╢",
                    keyword: "шГЬхИй",
                    icon: "fa-horse-head"
                },
                {
                    name: "хКЫщЗП",
                    eng: "Strength",
                    meaning: "хЛЗц░ФуАБшАРх┐ГуАБцОзхИ╢уАБхЖЕхЬихКЫщЗП",
                    keyword: "цДПх┐Ч",
                    icon: "fa-fist-raised"
                },
                {
                    name: "щЪРхгл",
                    eng: "The Hermit",
                    meaning: "хЖЕчЬБуАБхндчЛмуАБхп╗ц▒ВчЬЯчРЖуАБцМЗх╝Х",
                    keyword: "цОвч┤в",
                    icon: "fa-lightbulb"
                },
                {
                    name: "хС╜ш┐Рф╣Лш╜о",
                    eng: "Wheel of Fortune",
                    meaning: "х╛кчОпуАБхС╜ш┐РуАБш╜мцКШчВ╣уАБш┐Рц░Ф",
                    keyword: "ш╜охЫЮ",
                    icon: "fa-dharmachakra"
                },
                {
                    name: "цнгф╣Й",
                    eng: "Justice",
                    meaning: "хЕмцнгуАБчЬЯчРЖуАБхЫацЮЬуАБц│Хх╛Л",
                    keyword: "хЭЗшбб",
                    icon: "fa-balance-scale"
                },
                {
                    name: "хАТхРКф║║",
                    eng: "The Hanged Man",
                    meaning: "чЙ║чЙ▓уАБцЦ░чЪДшзЖшзТуАБчнЙх╛ЕуАБцФ╛ф╕Л",
                    keyword: "хеЙчМо",
                    icon: "fa-user-injured"
                },

                {
                    name: "цн╗чеЮ",
                    eng: "Death",
                    meaning: "ч╗УцЭЯуАБш╜мхПШуАБщЗНчФЯуАБцФ╛цЙЛ",
                    keyword: "ч╗УцЭЯ",
                    icon: "fa-skull"
                },
                {
                    name: "шКВхИ╢",
                    eng: "Temperance",
                    meaning: "х╣│шббуАБщАВх║жуАБшАРх┐ГуАБш░ГхТМ",
                    keyword: "хЗАхМЦ",
                    icon: "fa-glass-whiskey"
                },
                {
                    name: "цБ╢щнФ",
                    eng: "The Devil",
                    meaning: "цЭЯч╝ЪуАБчЙйш┤иф╕╗ф╣ЙуАБцм▓цЬЫуАБшп▒цГС",
                    keyword: "шп▒цГС",
                    icon: "fa-link"
                },
                {
                    name: "щлШхбФ",
                    eng: "The Tower",
                    meaning: "чкБхПШуАБц╖╖ф╣▒уАБхРпчд║уАБча┤хЭП",
                    keyword: "цпБчБн",
                    icon: "fa-gopuram"
                },
                {
                    name: "цШЯцШЯ",
                    eng: "The Star",
                    meaning: "х╕МцЬЫуАБчБ╡цДЯуАБх╣│щЭЩуАБц▓╗цДИ",
                    keyword: "х╕МцЬЫ",
                    icon: "fa-star"
                },
                {
                    name: "цЬИф║о",
                    eng: "The Moon",
                    meaning: "х╣╗шзЙуАБцБРцГзуАБчДжшЩСуАБц╜ЬцДПшпЖ",
                    keyword: "ф╕НхоЙ",
                    icon: "fa-moon"
                },
                {
                    name: "хдкщШ│",
                    eng: "The Sun",
                    meaning: "х┐лф╣РуАБцИРхКЯуАБц┤╗хКЫуАБц╕ЕцЩ░",
                    keyword: "чФЯхС╜",
                    icon: "fa-sun"
                },
                {
                    name: "хобхИд",
                    eng: "Judgement",
                    meaning: "хдНц┤╗уАБшзЙщЖТуАБхП╖хПмуАБхЖ│хоЪ",
                    keyword: "хдНц┤╗",
                    icon: "fa-bullhorn"
                },
                {
                    name: "ф╕ЦчХМ",
                    eng: "The World",
                    meaning: "хоМцИРуАБцХ┤хРИуАБцИРх░▒уАБхЬЖц╗б",
                    keyword: "ш╛╛цИР",
                    icon: "fa-globe-americas"
                }]
        };


        let SESSION_ID = null;
        let sessionList = [];
        let messages = [];
        let settings = {};
        let isBatchMode = false;
        let batchMessages = [];
        let currentReplyTo = null;
        let lastCoinResult = null;
        let currentNoteMessageId = null;
        let savedBackgrounds = [];
        let saveTimeout;
        let displayedMessageCount = 20;
        const HISTORY_BATCH_SIZE = 20;
        let isLoadingHistory = false;
        let isBatchFavoriteMode = false;
        let selectedMessages = [];
        let customReplies = [];
        let currentReplyTab = 'custom';
        let disabledDefaultReplies = [];
        let anniversaries = [];
        let currentAnniversaryType = 'anniversary';
        const DOMElements = {
            html: document.documentElement,
            chatContainer: document.getElementById('chat-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            attachmentBtn: document.getElementById('attachment-btn'),
            imageInput: document.getElementById('image-input'),
            themeToggle: document.getElementById('theme-toggle'),
            batchBtn: document.getElementById('batch-btn'),
            continueBtn: document.getElementById('continue-btn'),
            pokeBtn: document.getElementById('poke-btn'),
            coinTossOverlay: document.getElementById('coin-toss-overlay'),
            animatedCoin: document.getElementById('animated-coin'),
            coinResultText: document.getElementById('coin-result-text'),
            cancelCoinResult: document.getElementById('cancel-coin-result'),
            sendCoinResult: document.getElementById('send-coin-result'),
            typingIndicator: document.getElementById('typing-indicator'),
            emptyState: document.getElementById('empty-state'),
            welcomeAnimation: document.getElementById('welcome-animation'),
            batchPreview: document.getElementById('batch-preview'),
            replyPreviewContainer: document.getElementById('reply-preview-container'),
            pagination: document.getElementById('pagination'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            editModal: {
                modal: document.getElementById('edit-modal'),
                title: document.getElementById('edit-modal-title'),
                input: document.getElementById('name-input'),
                cancel: document.getElementById('cancel-edit'),
                save: document.getElementById('save-name')
            },
            avatarModal: {
                modal: document.getElementById('avatar-modal'),
                title: document.getElementById('avatar-modal-title'),
                input: document.getElementById('avatar-input'),
                cancel: document.getElementById('cancel-avatar'),
                save: document.getElementById('save-avatar')
            },
            noteModal: {
                modal: document.getElementById('note-modal'),
                input: document.getElementById('note-input'),
                cancel: document.getElementById('cancel-note'),
                save: document.getElementById('save-note')
            },
            pokeModal: {
                modal: document.getElementById('poke-modal'),
                input: document.getElementById('poke-input'),
                cancel: document.getElementById('cancel-poke'),
                save: document.getElementById('send-poke')
            },
            settingsModal: {
                modal: document.getElementById('settings-modal'),
                settingsBtn: document.getElementById('settings-btn'),
                cancel: document.getElementById('cancel-settings')
            },
            favoritesModal: {
                modal: document.getElementById('favorites-modal'),
                favoritesBtn: document.getElementById('favorites-btn'),
                list: document.getElementById('favorites-list'),
                cancel: document.getElementById('cancel-favorites')
            },
            statsModal: {
                modal: document.getElementById('stats-modal'),
                content: document.getElementById('stats-content'),
                closeBtn: document.getElementById('close-stats')
            },
            sessionModal: {
                modal: document.getElementById('session-modal'),
                managerBtn: document.getElementById('session-manager-btn'),
                list: document.getElementById('session-list'),
                createBtn: document.getElementById('create-new-session'),
                cancelBtn: document.getElementById('cancel-session')
            },
            fortuneModal: {
                modal: document.getElementById('fortune-modal'),
                content: document.getElementById('fortune-content'),
                shareBtn: document.getElementById('share-fortune'),
                closeBtn: document.getElementById('close-fortune')
            },
            customRepliesModal: {
                modal: document.getElementById('custom-replies-modal'),
                list: document.getElementById('custom-replies-list'),
                addBtn: document.getElementById('add-custom-reply'),
                closeBtn: document.getElementById('close-custom-replies')
            },
            backgroundInput: document.getElementById('background-input'),
            importInput: document.getElementById('import-input'),
            partner: {
                name: document.getElementById('partner-name'),
                avatar: document.getElementById('partner-avatar'),
                status: document.getElementById('partner-status').querySelector('span')
            },
            me: {
                name: document.getElementById('my-name'),
                avatar: document.getElementById('my-avatar'),
                statusContainer: document.getElementById('my-status-container'),
                statusText: document.getElementById('my-status-text')
            },
            anniversaryModal: {
                modal: document.getElementById('anniversary-modal'),
                closeBtn: document.getElementById('close-anniversary'),
                saveBtn: document.getElementById('save-anniversary'),
                addBtn: document.getElementById('add-anniversary'),
                dateInput: document.getElementById('anniversary-date-input'),
                nameInput: document.getElementById('anniversary-name-input'),
                displayArea: document.getElementById('anniversary-display'),
                daysElement: document.getElementById('anniversary-days'),
                dateShowElement: document.getElementById('anniversary-date-show'),
                list: document.getElementById('anniversary-list'),
                typeHint: document.getElementById('anniversary-type-hint')
            },
            anniversaryAnimation: {
                modal: document.getElementById('anniversary-animation'),
                title: document.getElementById('anniversary-animation-title'),
                days: document.getElementById('anniversary-animation-days'),
                message: document.getElementById('anniversary-animation-message'),
                closeBtn: document.getElementById('close-anniversary-animation')
            },
            appearanceModal: {
                modal: document.getElementById('appearance-modal'),
                closeBtn: document.getElementById('close-appearance')
            },
            chatModal: {
                modal: document.getElementById('chat-modal'),
                closeBtn: document.getElementById('close-chat')
            },
            advancedModal: {
                modal: document.getElementById('advanced-modal'),
                closeBtn: document.getElementById('close-advanced')
            },
            dataModal: {
                modal: document.getElementById('data-modal'),
                closeBtn: document.getElementById('close-data')
            }
        };


        function exportDataToMobileOrPC(dataString, fileName) {

            if (navigator.share && navigator.canShare) {
                try {
                    const blob = new Blob([dataString], {
                        type: 'application/json'
                    });

                    const file = new File([blob], fileName, {
                        type: 'application/json'
                    });


                    if (navigator.canShare({
                        files: [file]
                    })) {
                        navigator.share({
                            files: [file],
                            title: 'ф╝ашопцХ░цНохдЗф╗╜',
                            text: 'ш┐ЩцШпцВичЪДхЫЮхдНх║УхдЗф╗╜цЦЗф╗╢я╝Мшп╖щАЙцЛйтАЬф┐ЭхнШхИ░цЦЗф╗╢тАЭцИЦхПСщАБч╗Щхе╜хПЛуАВ'
                        }).then(() => {
                            showNotification('хп╝хЗ║/хИЖф║лцИРхКЯ', 'success');
                        }).catch((err) => {

                            console.warn('хИЖф║лцЬкхоМцИРя╝Мх░ЭшпХхЫЮщААф╕Лш╜╜цибх╝П:', err);
                            downloadFileFallback(blob, fileName);
                        });
                        return;
                    }
                } catch (e) {
                    console.log("чз╗хКичлпхИЖф║лцЮДх╗║хд▒ш┤ея╝Мш╜мф╕║цЩощАЪф╕Лш╜╜", e);
                }
            }


            const blob = new Blob([dataString], {
                type: 'application/json'
            });
            downloadFileFallback(blob, fileName);
        }
        function downloadFileFallback(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification('цЦЗф╗╢х╖▓х╝АхзЛф╕Лш╜╜', 'success');
        }
        const safeGetItem = (key) => {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.warn('Failed to read from localStorage:', e); return null;
            }
        };
        const safeSetItem = (key, value) => {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.warn('Failed to write to localStorage:', e);
            }
        };
        const safeRemoveItem = (key) => {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('Failed to remove from localStorage:', e);
            }
        };

        function getStorageKey(baseKey) {
            if (!SESSION_ID) console.error("Session not initialized!");
            return `${APP_PREFIX}${SESSION_ID}_${baseKey}`;
        }

        function createNewSession(andSwitch = false) {
            const newId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const newSession = {
                id: newId,
                name: `цЦ░чЪДхп╣шпЭ ${sessionList.length + 1}`,
                createdAt: new Date().toISOString()
            };
            sessionList.push(newSession);
            safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));
            safeSetItem(`${APP_PREFIX}lastSessionId`, newId);
            if (andSwitch) {
                window.location.hash = newId;
                window.location.reload();
            }
            return newId;
        }

        function initializeSession() {
            const sessionsData = safeGetItem(`${APP_PREFIX}sessionList`);
            sessionList = sessionsData ? JSON.parse(sessionsData): [];

            const hash = window.location.hash.substring(1);
            if (hash && sessionList.some(s => s.id === hash)) {
                SESSION_ID = hash;
            } else if (sessionList.length > 0) {
                SESSION_ID = safeGetItem(`${APP_PREFIX}lastSessionId`) || sessionList[0].id;
            } else {
                SESSION_ID = createNewSession(false);
            }

            safeSetItem(`${APP_PREFIX}lastSessionId`, SESSION_ID);
            history.replaceState(null, null, `#${SESSION_ID}`);
        }

        function clearAllAppData() {
            if (confirm("уАРщлШхН▒цУНф╜ЬуАСчбохоЪшжБщЗНч╜оцЙАцЬЙф╝ЪшпЭхТМшо╛ч╜охРЧя╝ЯцндцУНф╜Ьх░Жц╕ЕщЩдцЙАцЬЙцЬмхЬ░цХ░цНоф╕ФцЧац│ХцБвхдН")) {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(APP_PREFIX)) safeRemoveItem(key);
                    });
                    showNotification('цЙАцЬЙцХ░цНох╖▓щЗНч╜оя╝Мщб╡щЭвхН│х░ЖхИ╖цЦ░',
                        'info',
                        2000);
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    },
                        2000);
                } catch (e) {
                    showNotification('ц╕ЕщЩдцХ░цНохд▒ш┤е',
                        'error');
                }
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            notification.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hiding');
                notification.addEventListener('animationend', () => notification.remove());
            }, duration);
        }

        const playSound = (type) => {
            if (!settings.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                if (type === 'send') oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                else if (type === 'favorite') oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                else oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.warn("щЯ│щвСцТнцФ╛хд▒ш┤е:", e);
            }
        };

        const throttledSaveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        };

        function getDefaultSettings() {
            return {
                partnerName: "хп╣цЦ╣",
                myName: "цИС",
                myStatus: "хЬич║┐",
                partnerStatus: "хЬич║┐",
                isDarkMode: false,
                colorTheme: "gold",
                soundEnabled: true,
                typingIndicatorEnabled: true,
                readReceiptsEnabled: true,
                replyEnabled: true,
                lastStatusChange: Date.now(),
                nextStatusChange: 1 + Math.random() * 7,
                fontSize: 16,
                bubbleStyle: 'standard',
                messageFontFamily: "'Noto Serif SC', serif",
                messageFontWeight: 400,
                messageLineHeight: 1.5,
                musicPlayerEnabled: false,
                replyCountMode: 'random',
                replyMinCount: 1,
                replyMaxCount: 3
            };
        }


        function renderBackgroundGallery() {
            const list = document.getElementById('background-gallery-list');
            if (!list) return;

            list.innerHTML = '';

            
            const addBtn = document.createElement('div');
            addBtn.className = 'bg-item bg-add-btn';
            
            addBtn.innerHTML = '<i class="fas fa-plus"></i><span>ф╕Кф╝ашГМцЩп</span>';
            addBtn.onclick = () => document.getElementById('bg-gallery-input').click();
            list.appendChild(addBtn);

            const currentBg = safeGetItem(getStorageKey('chatBackground'));

            savedBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                let isActive = false;

                if (currentBg && currentBg === bg.value) isActive = true;

                item.className = `bg-item ${isActive ? 'active': ''}`;

                
                if (bg.type === 'image') {
                    item.innerHTML = `<img src="${bg.value}" loading="lazy" alt="bg">`;
                } else {
                    item.innerHTML = `<div class="bg-color-block" style="background: ${bg.value}"></div>`;
                }

                
                item.onclick = (e) => {
                    
                    if (e.target.closest('.bg-delete-btn')) return;

                    applyBackground(bg.value);
                    safeSetItem(getStorageKey('chatBackground'), bg.value);
                    renderBackgroundGallery(); 
                    showNotification('шГМцЩпх╖▓хИЗцНв', 'success');
                };

                if (bg.id.startsWith('user-')) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'bg-delete-btn';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.title = "хИащЩдцндшГМцЩп";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('чбохоЪхИащЩдш┐Щх╝ашГМцЩпхЫ╛хРЧя╝Я')) {
                            savedBackgrounds.splice(index, 1);
                            saveBackgroundGallery();

                            if (isActive) {
                                removeBackground(); 
                                renderBackgroundGallery();
                            } else {
                                renderBackgroundGallery();
                            }
                        }
                    };
                    item.appendChild(delBtn);
                }

                list.appendChild(item);
            });
        }


        function saveBackgroundGallery() {
            try {
                safeSetItem(getStorageKey('backgroundGallery'),
                    JSON.stringify(savedBackgrounds));
            } catch (e) {
                showNotification('хнШхВичй║щЧ┤ф╕Нш╢│я╝МцЧац│Хф┐ЭхнШшГМцЩпхИЧшби',
                    'error');
            }
        }


        const applyBackground = (value) => {

            if (!value || typeof value !== 'string') return;

            try {

                if (value.startsWith('linear-gradient') || value.startsWith('#') || value.startsWith('rgb')) {
                    document.documentElement.style.setProperty('--chat-bg-image', value);
                } else {

                    const cssValue = value.startsWith('url(') ? value: `url(${value})`;
                    document.documentElement.style.setProperty('--chat-bg-image', cssValue);
                }
                document.body.classList.add('with-background');
            } catch (e) {
                console.error("шГМцЩпх║ФчФихЗ║щФЩя╝Мх╖▓шЗкхКищЗНч╜о", e);

                if (typeof removeBackground === 'function') removeBackground();
            }
        };

        const loadData = () => {
            settings = getDefaultSettings();
            const savedSettings = safeGetItem(getStorageKey('chatSettings'));
            if (savedSettings) try {
                Object.assign(settings, JSON.parse(savedSettings));
            } catch (e) {
                console.error("шзгцЮРшо╛ч╜охд▒ш┤е:", e);
            }

            const savedMessages = safeGetItem(getStorageKey('chatMessages'));
            if (savedMessages) try {
                messages = JSON.parse(savedMessages).map(m => ({
                    ...m, timestamp: new Date(m.timestamp)
                }));
            } catch (e) {
                console.error("шзгцЮРц╢ИцБпхд▒ш┤е:", e); messages = [];
            }

            // хКаш╜╜шбицГЕхМЕ
            const savedStickers = safeGetItem(getStorageKey('stickers'));
            if (savedStickers) {
                try {
                    stickers = JSON.parse(savedStickers);
                } catch (e) {
                    stickers = [];
                }
            } else {
                stickers = [];
            }

            const savedBgGallery = safeGetItem(getStorageKey('backgroundGallery'));
            if (savedBgGallery) {
                try { savedBackgrounds = JSON.parse(savedBgGallery); } catch (e) { savedBackgrounds = []; }
            } else {
                savedBackgrounds = [
                    { id: 'preset-1', type: 'color', value: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }
                ]
            }

            const savedCustomReplies = safeGetItem(getStorageKey('customReplies'));
            if (savedCustomReplies) try {
                customReplies = JSON.parse(savedCustomReplies);
            } catch (e) {
                console.error("шзгцЮРшЗкхоЪф╣ЙхЫЮхдНхд▒ш┤е:", e);
            }

            const savedDisabledDefaults = safeGetItem(getStorageKey('disabledDefaultReplies'));
            if (savedDisabledDefaults) try {
                disabledDefaultReplies = JSON.parse(savedDisabledDefaults);
            } catch (e) {
                disabledDefaultReplies = [];
            }

            const savedAnniversaries = safeGetItem(getStorageKey('anniversaries'));
            if (savedAnniversaries) try {
                anniversaries = JSON.parse(savedAnniversaries);
            } catch (e) {
                console.error("шзгцЮРч║кх┐╡цЧехд▒ш┤е:", e);
            }

            updateAvatar(DOMElements.partner.avatar, safeGetItem(getStorageKey('partnerAvatar')));
            updateAvatar(DOMElements.me.avatar, safeGetItem(getStorageKey('myAvatar')));

            const currentBg = safeGetItem(getStorageKey('chatBackground'));
            if (currentBg) applyBackground(currentBg);
            
            displayedMessageCount = HISTORY_BATCH_SIZE;

            updateUI();
        };

        const saveData = () => {
            try {
                safeSetItem(getStorageKey('chatMessages'), JSON.stringify(messages));
                safeSetItem(getStorageKey('chatSettings'), JSON.stringify(settings));
                safeSetItem(getStorageKey('customReplies'), JSON.stringify(customReplies));
                safeSetItem(getStorageKey('stickers'), JSON.stringify(stickers)); // ф┐ЭхнШшбицГЕхМЕ

                safeSetItem(getStorageKey('disabledDefaultReplies'), JSON.stringify(disabledDefaultReplies));
                safeSetItem(getStorageKey('anniversaries'), JSON.stringify(anniversaries));

                const partnerImg = DOMElements.partner.avatar.querySelector('img');
                if (partnerImg) safeSetItem(getStorageKey('partnerAvatar'), partnerImg.src); else safeRemoveItem(getStorageKey('partnerAvatar'));
                const myImg = DOMElements.me.avatar.querySelector('img');
                if (myImg) safeSetItem(getStorageKey('myAvatar'), myImg.src); else safeRemoveItem(getStorageKey('myAvatar'));
            } catch (e) {
                console.error("ф┐ЭхнШцХ░цНохд▒ш┤е:", e);
                if (e.name === 'QuotaExceededError') {
                    showNotification('хнШхВичй║щЧ┤ф╕Нш╢│я╝Мх░Жц╕ЕщЩдщГихИЖцЧзц╢ИцБп', 'error', 4000);
                    messages = messages.slice(-100);
                    setTimeout(() => safeSetItem(getStorageKey('chatMessages'), JSON.stringify(messages)), 500);
                }
            }
        };

        function initializeRandomUI() {
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];


            document.querySelector('.header-motto').textContent = getRandomItem(CONSTANTS.HEADER_MOTTOS);
            DOMElements.emptyState.querySelector('p').innerHTML = getRandomItem(CONSTANTS.EMPTY_STATE_TEXTS);
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;


            const starsContainer = document.getElementById('stars-container');
            starsContainer.innerHTML = '';
            const starCount = 60;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';


                const x = Math.random() * 100;
                const y = Math.random() * 100;


                const size = Math.random() * 2 + 1;
                const duration = Math.random() * 3 + 2;
                const delay = Math.random() * 5;

                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.animationDelay = `${delay}s`;

                starsContainer.appendChild(star);
            }


            const welcomeAnim = getRandomItem(CONSTANTS.WELCOME_ANIMATIONS);
            const welcomeIcon = getRandomItem(CONSTANTS.WELCOME_ICONS);


            document.querySelector('.logo-icon-main').innerHTML = `<i class="${welcomeIcon}"></i>`;


            const titleEl = document.getElementById('welcome-title-glitch');
            const subEl = document.getElementById('welcome-subtitle-scramble');


            titleEl.classList.remove('playing');


            if (welcomeAnim && welcomeAnim.line1) {
                titleEl.textContent = welcomeAnim.line1;
            } else {
                titleEl.textContent = "TRANSMIT";
            }


            void titleEl.offsetWidth;
            titleEl.classList.add('playing');


            const scrambleText = (element, finalText, duration = 1500) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()';
                const length = finalText.length;
                let start = Date.now();

                const interval = setInterval(() => {
                    const now = Date.now();
                    const progress = (now - start) / duration;

                    if (progress >= 1) {
                        element.textContent = finalText;
                        clearInterval(interval);
                        return;
                    }

                    let result = '';

                    const revealIndex = Math.floor(progress * length);

                    for (let i = 0; i < length; i++) {
                        if (i <= revealIndex) {
                            result += finalText[i];
                        } else {

                            result += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }
                    element.textContent = result;
                },
                    40);
            };


            setTimeout(() => {
                scrambleText(subEl, welcomeAnim.line2, 2000);
            }, 600);


            const loaderBar = document.getElementById('loader-tech-bar');
            loaderBar.style.width = '0%';

            setTimeout(() => loaderBar.style.width = '30%', 100);
            setTimeout(() => loaderBar.style.width = '55%', 800);
            setTimeout(() => loaderBar.style.width = '85%', 1800);
            setTimeout(() => loaderBar.style.width = '100%', 2600);
        }

        const updateUI = () => {
            DOMElements.html.setAttribute('data-theme', settings.isDarkMode ? 'dark': 'light');
            DOMElements.html.setAttribute('data-color-theme', settings.colorTheme);
            DOMElements.themeToggle.innerHTML = settings.isDarkMode ? '<i class="fas fa-sun"></i>': '<i class="fas fa-moon"></i>';
            DOMElements.partner.name.textContent = settings.partnerName;
            DOMElements.me.name.textContent = settings.myName;
            DOMElements.partner.status.textContent = settings.partnerStatus;
            DOMElements.me.statusText.textContent = settings.myStatus;
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            document.documentElement.style.setProperty('--message-font-family', settings.messageFontFamily);
            document.documentElement.style.setProperty('--message-font-weight', settings.messageFontWeight);
            document.documentElement.style.setProperty('--message-line-height', settings.messageLineHeight);


            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
            });

            renderMessages();
        };

        const updateAvatar = (element, src) => {
            if (src) element.innerHTML = `<img src="${src}" alt="avatar">`; else element.innerHTML = `<i class="fas fa-user"></i>`;
        };

        const removeBackground = () => {
            document.documentElement.style.removeProperty('--chat-bg-image');
            document.body.classList.remove('with-background');
            safeRemoveItem(getStorageKey('chatBackground'));
            showNotification('шГМцЩпхЫ╛чЙЗх╖▓чз╗щЩд', 'success');
        };

        function renderMessages(preserveScroll = false) {
            const container = DOMElements.chatContainer;
            const totalMessages = messages.length;


            const startIndex = Math.max(0, totalMessages - displayedMessageCount);
            const msgsToRender = messages.slice(startIndex);


            DOMElements.emptyState.style.display = totalMessages === 0 ? 'flex': 'none';


            const oldScrollHeight = container.scrollHeight;
            const oldScrollTop = container.scrollTop;


            container.innerHTML = '';

            const fragment = new DocumentFragment();
            let currentDate = '';


            msgsToRender.forEach((msg) => {

                const messageDate = new Date(msg.timestamp).toDateString();
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    const displayDate = (messageDate === today) ? 'ф╗Кхдй': (messageDate === yesterday) ? 'цШихдй': new Date(msg.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    dateDivider.innerHTML = `<span>${displayDate}</span>`;
                    fragment.appendChild(dateDivider);
                }


                if (msg.type === 'system') {
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message';
                    systemMsgDiv.innerHTML = msg.text;
                    fragment.appendChild(systemMsgDiv);
                    return;
                }


                const wrapper = document.createElement('div');
                const isSticker = msg.type === 'sticker';
                wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent': 'received'} ${isBatchFavoriteMode && msg.favorited ? 'selected': ''} ${isSticker ? 'sticker' : ''}`;
                wrapper.dataset.id = msg.id;


                if (isBatchFavoriteMode) {
                    const checkbox = document.createElement('div');
                    checkbox.className = `batch-favorite-checkbox ${msg.favorited ? 'checked': ''}`;
                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);

                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            checkbox.classList.remove('checked');
                        } else {
                            selectedMessages.push(messageId);
                            checkbox.classList.add('checked');
                        }


                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `чбошодцФ╢шЧП (${selectedMessages.length})`;
                        }
                    });
                    wrapper.appendChild(checkbox);
                }


                let messageHTML = '';
                if (msg.replyTo) {
                    const repliedText = msg.replyTo.type === 'sticker' ? '[шбицГЕхМЕ]' : (msg.replyTo.text || '[хЫ╛чЙЗ]');
                    messageHTML += `<div class="reply-indicator"><span style="opacity:0.9; overflow:hidden; text-overflow: ellipsis; white-space:nowrap;">${repliedText}</span></div>`;
                }

                if (isSticker) {
                    messageHTML += `<img src="${msg.image}" class="message-sticker-img" alt="шбицГЕхМЕ" onclick="viewImage('${msg.image}')">`;
                } else {
                    let content = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>`: '';
                    if (msg.image) content += `<img src="${msg.image}" class="message-image" alt="хЫ╛чЙЗ" style="max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="viewImage('${msg.image}')">`;
                    messageHTML += content;
                }

                if (msg.note) messageHTML += `<div class="message-note">${msg.note}</div>`;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${msg.sender === 'user' ? 'sent': 'received'} ${settings.bubbleStyle}`;
                messageDiv.innerHTML = messageHTML;


                let metaHTML = `<div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit', minute: '2-digit'
            })}</div>`;
                metaHTML += `<button class="favorite-meta-btn ${msg.favorited ? 'favorited': ''}" title="${msg.favorited ? 'хПЦц╢ИцФ╢шЧП': 'цФ╢шЧП'}"><i class="fas fa-star"></i></button>`;

                if (msg.sender === 'user' && settings.readReceiptsEnabled) {
                    const statusIcon = msg.status === 'read' ? 'fa-check-double': 'fa-check';
                    metaHTML += `<div class="read-receipt ${msg.status === 'read' ? 'read': ''}"><i class="fas ${statusIcon}"></i></div>`;
                }

                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                metaDiv.innerHTML = metaHTML;


                let actionsHTML = '';
                if (settings.replyEnabled) actionsHTML += `<button class="meta-action-btn reply-btn" title="хЫЮхдН"><i class="fas fa-reply"></i></button>`;
                actionsHTML += `<button class="meta-action-btn note-btn" title="ц│ищЗК"><i class="fas fa-sticky-note"></i></button>`;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-meta-actions';
                actionsDiv.innerHTML = actionsHTML;

                wrapper.append(actionsDiv, messageDiv, metaDiv);
                fragment.appendChild(wrapper);
            });

            DOMElements.chatContainer.appendChild(fragment);


            if (preserveScroll) {

                const newScrollHeight = container.scrollHeight;
                container.scrollTop = newScrollHeight - oldScrollHeight;
            } else {

                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        const addMessage = (message) => {
            if (!(message.timestamp instanceof Date)) message.timestamp = new Date(message.timestamp);
            messages.push(message);


            displayedMessageCount++;


            renderMessages(false);
            throttledSaveData();
        };

        function optimizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.size < 300 * 1024 && maxWidth > 500) {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let {
                        width,
                        height
                    } = img;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function sendMessage(textOverride = null, type = 'normal') {
            const text = textOverride || DOMElements.messageInput.value.trim();
            const imageFile = DOMElements.imageInput.files[0];
            if (!text && !imageFile && type === 'normal') return;

            DOMElements.messageInput.value = '';
            DOMElements.messageInput.style.height = '46px';
            if (imageFile && imageFile.size > MAX_IMAGE_SIZE) {
                showNotification('хЫ╛чЙЗхдзх░Пф╕НшГ╜ш╢Еш┐З5MB', 'error'); DOMElements.imageInput.value = ''; return;
            }

            const createMessage = (imgSrc = null) => {
                const messageData = {
                    id: Date.now(),
                    sender: 'user',
                    text: text || '',
                    timestamp: new Date(),
                    image: imgSrc,
                    status: 'sent',
                    favorited: false,
                    note: null,
                    replyTo: currentReplyTo,
                    type: type
                };
                if (type === 'system') messageData.sender = null;

                addMessage(messageData);
                if (type !== 'system') playSound('send');
                currentReplyTo = null;
                updateReplyPreview();
                if (!isBatchMode && type === 'normal') setTimeout(simulateReply, 800 + Math.random() * 1200);
            };

            if (imageFile) {
                showNotification('цнгхЬиф╝ШхМЦхЫ╛чЙЗ...', 'info', 1500);
                optimizeImage(imageFile).then(createMessage).catch(() => showNotification('хЫ╛чЙЗхдДчРЖхд▒ш┤е', 'error'));
            } else {
                createMessage();
            }
            DOMElements.imageInput.value = '';
        }

        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            DOMElements.batchBtn.classList.toggle('active', isBatchMode);
            DOMElements.batchBtn.title = isBatchMode ? "щААхЗ║цЙ╣щЗПцибх╝П": "цЙ╣щЗПхПСщАБцибх╝П";
            DOMElements.batchPreview.style.display = isBatchMode ? 'flex': 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = isBatchMode ? "цндхИ╗я╝МцГ│шп┤чЪДцЬЙх╛ИхдЪх╛ИхдЪ...": (placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder);
            if (isBatchMode) {
                batchMessages = []; updateBatchPreview();
            }
        }

        function addToBatch() {
            const text = DOMElements.messageInput.value.trim();
            if (!text) return;
            batchMessages.push({
                id: Date.now() + batchMessages.length, text
            });
            DOMElements.messageInput.value = ''; DOMElements.messageInput.style.height = '46px';
            updateBatchPreview();
        }

        function updateBatchPreview() {
            const previewContainer = DOMElements.batchPreview;
            let listHTML = '';
            if (batchMessages.length > 0) {
                listHTML = batchMessages.map((msg, index) => `
                <div class="batch-preview-item" data-index="${index}">
                <span class="batch-preview-text">${msg.text}</span>
                <button class="batch-preview-remove"><i class="fas fa-times"></i></button>
                </div>`).join('');
            } else {
                listHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 10px;">╦ЪтВКтАзъТ░ЁУЖй тЩ▒ ЁУЖкъТ▒тАзтВК╦Ъ</div>';
            }

            previewContainer.innerHTML = `
        <div class="batch-preview-title">цИСцЬЙх╛ИхдЪчЪДшпЭцГ│шп┤тАжя╝Б</div>
        <div class="batch-preview-list">${listHTML}</div>
        <div class="batch-actions">
        <button class="batch-action-btn batch-cancel-btn">хПЦц╢И</button>
        <button class="batch-action-btn batch-send-btn" ${batchMessages.length === 0 ? 'disabled': ''}>хПСщАБхЕищГи (${batchMessages.length})</button>
        </div>`;
        }

        function sendBatchMessages() {
            if (batchMessages.length === 0) return;
            showNotification(`цнгхЬихПСщАБ ${batchMessages.length} цЭбц╢ИцБп...`, 'info', 2000);
            batchMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage({
                        id: Date.now() + index, sender: 'user', text: msg.text, timestamp: new Date(), status: 'sent', favorited: false, type: 'normal'
                    });
                    playSound('send');
                }, index * 300);
            });
            setTimeout(simulateReply, batchMessages.length * 300 + 1000 + Math.random() * 2000);
            isBatchMode = false; batchMessages = [];
            DOMElements.batchBtn.classList.remove('active'); DOMElements.batchPreview.style.display = 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
        }

        function simulateReply() {
            // 1. цаЗшо░ц╢ИцБпф╕║х╖▓шп╗
            let changed = false;
            messages.forEach(msg => {
                if (msg.sender === 'user' && msg.status !== 'read') {
                    msg.status = 'read'; changed = true;
                }
            });
            if (changed) {
                renderMessages(false); throttledSaveData();
            }

            // 2. цШ╛чд║цнгхЬиш╛УхЕе
            if (settings.typingIndicatorEnabled) {
                DOMElements.typingIndicator.style.display = 'block'; 
                DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            }

            // 3. цЛНф╕АцЛНщА╗ш╛С (3%цжВчОЗ)
            if (Math.random() < 0.03) {
                const randomAction = getRandomItem(CONSTANTS.POKE_ACTIONS);
                const pokeTypes = [{
                    prefix: "ЁЯТл",
                    text: `${settings.partnerName} ${randomAction}`
                },
                {
                    prefix: "тЬи",
                    text: `${settings.partnerName} ${randomAction}`
                },
                {
                    prefix: "ЁЯМЯ",
                    text: `${settings.partnerName} ${randomAction}`
                },
                {
                    prefix: "ЁЯе░",
                    text: `${settings.partnerName} ${randomAction}`
                },
                {
                    prefix: "ЁЯТЦ",
                    text: `${settings.partnerName} ${randomAction}`
                }];

                const selectedPoke = getRandomItem(pokeTypes);
                addMessage({
                    id: Date.now(),
                    text: `${selectedPoke.prefix} ${selectedPoke.text} ${selectedPoke.prefix}`,
                    timestamp: new Date(),
                    type: 'system'
                });
                DOMElements.typingIndicator.style.display = 'none';
                return;
            }

            // 4. уАРца╕х┐Гф┐оцФ╣уАСшобчоЧхЫЮхдНцЭбцХ░ (шЗкхоЪф╣ЙшМГхЫ┤ vs ч│╗ч╗Ящ╗Шшод)
            let replyCount = 1;

            if (settings.replyCountMode === 'custom') {
                // шО╖хПЦф╜ашо╛ч╜очЪДцЬАх░ПхА╝хТМцЬАхдзхА╝
                const min = parseInt(settings.replyMinCount) || 0;
                const max = parseInt(settings.replyMaxCount) || 0;
                
                // чбоф┐ЭцХ░цНохоЙхЕия╝ИщШ▓цнвцЬАхдзхА╝х░Пф║ОцЬАх░ПхА╝я╝Й
                const safeMin = Math.min(min, max);
                const safeMax = Math.max(min, max);
                
                // хЬиш┐Щф╕кшМГхЫ┤хЖЕщЪПцЬ║хПЦф╕Аф╕кцХ┤цХ░
                replyCount = Math.floor(Math.random() * (safeMax - safeMin + 1)) + safeMin;
            } else {
                // ч│╗ч╗Ящ╗ШшодщА╗ш╛С (75%цжВчОЗхЫЮ1цЭбя╝М20%хЫЮ2цЭбя╝М5%хЫЮ3цЭб)
                replyCount = Math.random() < 0.75 ? 1 : (Math.random() < 0.95 ? 2 : 3);
            }

            // хжВцЮЬч╗УцЮЬф╕║ 0я╝МхБЗшгЕш╛УхЕеф╕Аф╝ЪхД┐чД╢хРОц╢Ихд▒я╝Мф╕НхПСц╢ИцБп
            if (replyCount <= 0) {
                if (settings.typingIndicatorEnabled) {
                    setTimeout(() => { DOMElements.typingIndicator.style.display = 'none'; }, 1500);
                }
                return;
            }

            // 5. х╝АхзЛх╛кчОпхПСщАБц╢ИцБп
            let delay = 0;
            for (let i = 0; i < replyCount; i++) {
                // цибцЛЯцЙУхнЧх╗╢ш┐Я
                delay += 1500 + Math.random() * 2000;
                
                setTimeout(() => {
                    // --- шбицГЕхМЕщЪПцЬ║хЫЮхдНщА╗ш╛С ---
                    if (typeof stickers !== 'undefined' && stickers.length > 0 && Math.random() < 0.15) {
                        const randomSticker = getRandomItem(stickers);
                        addMessage({
                            id: Date.now() + i,
                            sender: 'partner',
                            text: randomSticker,
                            image: randomSticker,
                            timestamp: new Date(),
                            favorited: false,
                            replyTo: null,
                            type: 'sticker'
                        });
                        playSound('message');
                        // хжВцЮЬцШпцЬАхРОф╕АцЭбя╝МщЪРшЧПш╛УхЕечК╢цАБ
                        if (i === replyCount - 1) DOMElements.typingIndicator.style.display = 'none';
                        return; // ш┐Щцмбх╛кчОпхПСф║ЖшбицГЕхМЕя╝Мх░▒ш╖│ш┐Зф╕ЛщЭвчЪДцЦЗхнЧхПСщАБ
                    }

                    // --- цЦЗцЬмхЫЮхдНщА╗ш╛С ---
                    let text;
                    // х░ПцжВчОЗхПС emoji
                    if (Math.random() < 0.15) {
                        text = getRandomItem(CONSTANTS.REPLY_EMOJIS);
                    } else {
                        // цнгх╕╕чЪДцЦЗхнЧхЫЮхдН
                        const activeDefaults = CONSTANTS.REPLY_MESSAGES.filter(msg => !disabledDefaultReplies.includes(msg));
                        const combinedMessages = [...activeDefaults, ...customReplies];
                        if (combinedMessages.length > 0) {
                            text = getRandomItem(combinedMessages);
                        } else {
                            text = "я╝Иц▓бцЬЙхПпчФичЪДхЫЮхдНхЖЕхо╣я╝Мшп╖хО╗шо╛ч╜ощЗМц╖╗хКацИЦхРпчФихЫЮхдНя╝Й";
                        }
                    }

                    // --- х╝ХчФихЫЮхдНщА╗ш╛С ---
                    let replyTo = null;
                    if (settings.replyEnabled && Math.random() < 0.1) {
                        const userMessages = messages.filter(m => m.sender === 'user').slice(-10);
                        if (userMessages.length > 0) {
                            const randomMessage = getRandomItem(userMessages);
                            replyTo = {
                                id: randomMessage.id,
                                sender: randomMessage.sender,
                                text: randomMessage.text,
                                type: randomMessage.type
                            };
                        }
                    }

                    // хПСщАБцЬАч╗Иц╢ИцБп
                    addMessage({
                        id: Date.now() + i, 
                        sender: 'partner', 
                        text, 
                        timestamp: new Date(), 
                        favorited: false, 
                        replyTo, 
                        type: 'normal'
                    });
                    playSound('message');
                    
                    // хжВцЮЬцШпцЬАхРОф╕АцЭбя╝МщЪРшЧПш╛УхЕечК╢цАБ
                    if (i === replyCount - 1) DOMElements.typingIndicator.style.display = 'none';
                },
                    delay);
            }
        }


        function startCoinFlipAnimation() {
            const overlay = DOMElements.coinTossOverlay;
            const coin = DOMElements.animatedCoin;
            const resultText = DOMElements.coinResultText;


            overlay.classList.remove('finished');
            coin.classList.remove('flipping-heads', 'flipping-tails');


            void coin.offsetWidth;


            resultText.textContent = 'хС╜ш┐РцКЙцЛйф╕н...';


            const isHeads = Math.random() < 0.5;
            const result = isHeads ? 'цШп': 'хРж';
            const animationClass = isHeads ? 'flipping-heads': 'flipping-tails';


            requestAnimationFrame(() => {
                coin.classList.add(animationClass);
            });


            const onAnimationEnd = () => {

                const fancyText = isHeads ? "чнФцбИцШп ┬╖ цШп": "чнФцбИцШп ┬╖ хРж";
                resultText.textContent = fancyText;


                lastCoinResult = result;


                overlay.classList.add('finished');
            };


            coin.addEventListener('animationend', onAnimationEnd, {
                once: true
            });
        }


        function handleCoinToss() {
            DOMElements.coinTossOverlay.classList.add('visible');
            startCoinFlipAnimation();
        }

        function updateReplyPreview() {
            const previewContainer = DOMElements.replyPreviewContainer;
            previewContainer.innerHTML = '';

            if (currentReplyTo) {
                const preview = document.createElement('div');
                preview.className = 'reply-preview';
                const repliedText = currentReplyTo.type === 'sticker' ? '[шбицГЕхМЕ]' : (currentReplyTo.text || '[хЫ╛чЙЗ]');
                preview.innerHTML = `<div class="reply-preview-content">${repliedText}</div><button class="reply-preview-remove"><i class="fas fa-times"></i></button>`;
                preview.querySelector('.reply-preview-remove').addEventListener('click', () => {
                    currentReplyTo = null; updateReplyPreview();
                });
                previewContainer.appendChild(preview);
            }
        }


        function renderFavorites() {
            const list = DOMElements.favoritesModal.list;

            const favoritedMessages = messages.filter(m => m.favorited).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (favoritedMessages.length === 0) {
                list.innerHTML = `
            <div class="no-favorites">
            <i class="fas fa-folder-open"></i>
            <p>цШЯчРГчЪДшзТшР╜чй║чй║хжВф╣Я...</p>
            <span style="font-size:12px; margin-top:5px; opacity:0.7">чВ╣хЗ╗ц╢ИцБпцЧБчЪДцШЯцШЯхН│хПпцФ╢шЧП</span>
            </div>`;
                return;
            }

            list.innerHTML = favoritedMessages.map(msg => {

                const isMe = msg.sender === 'user';

                const avatarSrc = isMe
                ? (document.getElementById('my-avatar').querySelector('img')?.src || ''): (document.getElementById('partner-avatar').querySelector('img')?.src || '');

                const avatarHTML = avatarSrc
                ? `<img src="${avatarSrc}" class="fav-avatar" alt="avatar">`: `<div class="fav-avatar"><i class="fas fa-user"></i></div>`;

                const name = isMe ? settings.myName: settings.partnerName;


                let contentHTML = msg.text ? `<span>${msg.text.replace(/\n/g, '<br>')}</span>`: '';
                if (msg.image) contentHTML += `<img src="${msg.image}" alt="хЫ╛чЙЗ" loading="lazy">`;


                const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                return `
            <div class="fav-card" id="fav-card-${msg.id}">
            ${avatarHTML}
            <div class="fav-content-wrapper">
            <div class="fav-header">
            <span class="fav-sender-name">${name}</span>
            <span style="opacity:0.6">${timeStr}</span>
            </div>
            <div class="fav-bubble">
            ${contentHTML}
            </div>
            <button class="fav-action-btn" onclick="removeFavorite(${msg.id})">
            <i class="fas fa-trash-alt"></i> чз╗щЩд
            </button>
            </div>
            </div>`;
            }).join('');
        }


        window.removeFavorite = function(msgId) {
            const message = messages.find(m => m.id === msgId);
            if (message) {
                message.favorited = false;

                const card = document.getElementById(`fav-card-${msgId}`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        renderFavorites();
                        throttledSaveData();
                        const chatMsgBtn = document.querySelector(`.message-wrapper[data-id="${msgId}"] .favorite-meta-btn`);
                        if (chatMsgBtn) chatMsgBtn.classList.remove('favorited');
                    },
                        300);
                }
            }
        };

        function showModal(modalElement, focusElement = null) {
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                const content = modalElement.querySelector('.modal-content');
                content.style.opacity = '1';
                content.style.transform = 'translateY(0) scale(1)';
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 100);
                }
            });
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => {
                modalElement.style.display = 'none';
            }, 300);
        }

        function viewImage(src) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content" style="max-width: 90%; max-height: 90%; background: transparent; box-shadow: none; padding: 0;"><img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;"></div>`;
            const closeModal = () => document.body.removeChild(modal);
            modal.addEventListener('click', closeModal);
            document.body.appendChild(modal);
        }

        function exportChatHistory() {
            try {
                const dataStr = JSON.stringify({
                    version: "3.0",
                    exportDate: new Date().toISOString(),
                    messages,
                    settings,
                    customReplies,
                    anniversaries,
                    stickers // хп╝хЗ║цЧ╢хМЕхРлшбицГЕхМЕ
                },
                    null,
                    2);


                if (navigator.share && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {

                    const blob = new Blob([dataStr], {
                        type: 'application/json;charset=utf-8'
                    });
                    const file = new File([blob], `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`, {
                        type: 'application/json'
                    });

                    if (navigator.canShare && navigator.canShare({
                        files: [file]
                    })) {
                        navigator.share({
                            files: [file],
                            title: 'шБКхдйшо░х╜ХхдЗф╗╜',
                            text: `шБКхдйшо░х╜ХхдЗф╗╜ - ${new Date().toLocaleDateString()}`
                        }).then(() => {
                            showNotification('хИЖф║лцИРхКЯ', 'success');
                        }).catch((error) => {
                            console.error('хИЖф║лхд▒ш┤е:', error);
                            fallbackExport(dataStr);
                        });
                    } else {
                        fallbackExport(dataStr);
                    }
                } else {

                    fallbackExport(dataStr);
                }
            } catch (error) {
                console.error('хп╝хЗ║хд▒ш┤е:', error);
                showNotification('хп╝хЗ║хд▒ш┤ея╝Мшп╖щЗНшпХ', 'error');
            }
        }

        function fallbackExport(dataStr) {
            const dataBlob = new Blob([dataStr], {
                type: 'application/json;charset=utf-8'
            });
            const url = URL.createObjectURL(dataBlob);


            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);


            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(`цИРхКЯхп╝хЗ║ ${messages.length} цЭбц╢ИцБп`, 'success');
        }

        function importChatHistory(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.messages || !Array.isArray(importedData.messages)) throw new Error('цЧацХИчЪДшБКхдйшо░х╜ХцЦЗф╗╢');
                    if (messages.length > 0 && !confirm('хп╝хЕех░ЖшжЖчЫЦх╜УхЙНф╝ЪшпЭчЪДшБКхдйшо░х╜Хя╝МчбохоЪч╗зч╗нхРЧя╝Я')) return;

                    messages = importedData.messages.map(m => ({
                        ...m, timestamp: new Date(m.timestamp)
                    }));
                    if (importedData.settings) Object.assign(settings, importedData.settings);
                    if (importedData.customReplies) customReplies = importedData.customReplies;
                    if (importedData.anniversaries) anniversaries = importedData.anniversaries;
                    if (importedData.stickers) stickers = importedData.stickers;

                    saveData();
                    updateUI();
                    showNotification(`цИРхКЯхп╝хЕе ${messages.length} цЭбц╢ИцБп`, 'success');
                } catch (error) {
                    console.error('хп╝хЕехд▒ш┤е:', error);
                    showNotification('цЦЗф╗╢ца╝х╝ПщФЩшппцИЦх╖▓цНЯхЭП', 'error');
                }
            };
            reader.onerror = () => showNotification('цЦЗф╗╢шп╗хПЦхд▒ш┤е', 'error');
            reader.readAsText(file);
        }

        const checkStatusChange = () => {
            if ((Date.now() - settings.lastStatusChange) / 36e5 >= settings.nextStatusChange) {
                settings.partnerStatus = getRandomItem(CONSTANTS.PARTNER_STATUSES);
                settings.lastStatusChange = Date.now();
                settings.nextStatusChange = 1 + Math.random() * 7;
                DOMElements.partner.status.textContent = settings.partnerStatus;
                throttledSaveData();
            }
        };


        function renderStatsContent() {
            const statsContent = DOMElements.statsModal.content;


            const partnerMessages = messages.filter(msg =>
                msg.sender === 'partner' &&
                msg.text &&
                msg.type !== 'system'
            );


            if (partnerMessages.length === 0) {
                statsContent.innerHTML = `
            <div class="stats-empty-state">
            <div class="stats-empty-icon"><i class="fas fa-chart-pie"></i></div>
            <h3>цЪВцЧацХ░цНо</h3>
            <p>чнЙх╛Ехп╣цЦ╣хПСцЭечммф╕АцЭбц╢ИцБп...</p>
            </div>`;
                return;
            }


            const replyCount = {};
            partnerMessages.forEach(msg => {

                const text = msg.text.trim();
                if (text) {
                    replyCount[text] = (replyCount[text] || 0) + 1;
                }
            });


            const topReplies = Object.entries(replyCount)
            .map(([text, count]) => ({
                text, count
            }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 5);


            const maxCount = topReplies.length > 0 ? topReplies[0].count: 0;


            const firstMsg = partnerMessages[0];
            const lastMsg = partnerMessages[partnerMessages.length - 1];

            const formatDate = (dateObj) => {
                return new Date(dateObj).toLocaleDateString('zh-CN',
                    {
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            };


            const rankListHTML = topReplies.map((item, index) => {
                const percent = (item.count / maxCount) * 100;
                return `
            <div class="rank-item">
            <div class="rank-progress-bg" style="width: ${percent}%"></div>
            <div class="rank-info">
            <div class="rank-number">#${index + 1}</div>
            <div class="rank-text" title="${item.text}">${item.text}</div>
            <div class="rank-count">${item.count}цмб</div>
            </div>
            </div>
            `;
            }).join('');


            statsContent.innerHTML = `
        <div class="stats-dashboard">


        <div class="stats-overview-grid">
        <div class="overview-item">
        <div class="overview-value">${partnerMessages.length}</div>
        <div class="overview-label">цА╗хЫЮхдНцХ░</div>
        </div>
        <div class="overview-item">
        <div class="overview-value">${customReplies.length}</div>
        <div class="overview-label">шпНх║Ухо╣щЗП</div>
        </div>
        <div class="overview-item">
        <div class="overview-value">${formatDate(firstMsg.timestamp)}</div>
        <div class="overview-label">хИЭцмбчЫ╕щБЗ</div>
        </div>
        <div class="overview-item">
        <div class="overview-value">${formatDate(lastMsg.timestamp)}</div>
        <div class="overview-label">цЬАш┐СшБФч╗Ь</div>
        </div>
        </div>


        <div class="stats-card">
        <div class="stats-card-title">
        <i class="fas fa-crown"></i> щлШщвСхЫЮхдН TOP 5
        </div>
        <div class="stats-rank-list">
        ${rankListHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;">цХ░цНочзпч┤пф╕н...</div>'}
        </div>
        </div>


        `;
        }

        function renderSessionList() {
            const listContainer = DOMElements.sessionModal.list;
            if (sessionList.length === 0) {
                listContainer.innerHTML = '<div class="stats-empty" style="padding: 20px 0;"><p>ш┐Шц▓бцЬЙф╝ЪшпЭ</p></div>';
                return;
            }
            listContainer.innerHTML = sessionList.map(session => `
            <div class="session-item ${session.id === SESSION_ID ? 'active': ''}" data-id="${session.id}">
            <div class="session-info">
            <div class="session-name">${session.name}</div>
            <div class="session-meta">хИЫх╗║ф║О ${new Date(session.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="session-actions">
            <button class="session-action-btn rename" title="щЗНхС╜хРН"><i class="fas fa-pen"></i></button>
            <button class="session-action-btn delete" title="хИащЩд"><i class="fas fa-trash"></i></button>
            </div>
            </div>
            `).join('');
        }


        function generateFortune() {
            const todayKey = new Date().toDateString();
            const storageKey = `${APP_PREFIX}daily_fortune`;

            let fortuneData = null;
            const savedData = safeGetItem(storageKey);

            if (savedData) {
                const parsed = JSON.parse(savedData);

                if (parsed.date === todayKey) {
                    fortuneData = parsed;
                }
            }


            if (!fortuneData) {
                const cards = CONSTANTS.TAROT_CARDS;
                const randomIndex = Math.floor(Math.random() * cards.length);
                const isUpright = Math.random() > 0.5;

                fortuneData = {
                    date: todayKey,
                    cardIndex: randomIndex,
                    isUpright: isUpright
                };


                safeSetItem(storageKey, JSON.stringify(fortuneData));
            }


            renderFortuneCard(fortuneData);
        }


        function renderFortuneCard(data) {
            const card = CONSTANTS.TAROT_CARDS[data.cardIndex];
            const isUpright = data.isUpright;
            const fortuneContent = DOMElements.fortuneModal.content;


            fortuneContent.innerHTML = `
        <div class="fortune-card tarot-style">
        <div class="tarot-header">DAILY TAROT</div>

        <div class="tarot-visual ${isUpright ? '': 'reversed'}">
        <i class="fas ${card.icon} tarot-icon-vector"></i>
        </div>

        <div class="tarot-card-name">${card.name}</div>
        <div class="tarot-position-badge ${isUpright ? 'upright': 'reversed'}">
        ${isUpright ? "цнг": "щАЖ"}
        </div>

        <div class="tarot-details">
        <div class="tarot-divider"></div>
        <div class="tarot-keyword">уАМ${card.keyword}уАН</div>
        <div class="fortune-desc">
        ${card.meaning}
        </div>
        <div class="fortune-tip">
        ${isUpright
        ? "ф┐ЭцМБх╜Уф╕ЛчЪДшКВхеПя╝Мщб║хК┐шАМф╕║": "ф╣Яшо╕щЬАшжБцНвф╕кшзТх║жчЬЛх╛ЕчЫохЙНчЪДхдДхвГ"}
        </div>
        </div>
        </div>
        `;


            const modalTitle = DOMElements.fortuneModal.modal.querySelector('.modal-title span');
            if (modalTitle) modalTitle.textContent = "ф╗КцЧецМЗх╝Х";

            showModal(DOMElements.fortuneModal.modal);
        }

        function toggleBatchFavoriteMode() {
            isBatchFavoriteMode = !isBatchFavoriteMode;
            selectedMessages = [];

            if (isBatchFavoriteMode) {
                document.body.classList.add('batch-favorite-mode');
                showBatchFavoriteActions();
                showNotification('цЙ╣щЗПцФ╢шЧПцибх╝Пх╖▓х╝АхРпя╝МчВ╣хЗ╗ц╢ИцБпш┐ЫшбМщАЙцЛй', 'info');
            } else {
                document.body.classList.remove('batch-favorite-mode');
                hideBatchFavoriteActions();
                showNotification('цЙ╣щЗПцФ╢шЧПцибх╝Пх╖▓хЕ│щЧн', 'info');
            }

            renderMessages(true);
        }

        function hideBatchFavoriteActions() {
            const actions = document.querySelector('.batch-favorite-actions');
            if (actions) {

                actions.style.animation = 'floatUpAction 0.3s reverse forwards';
                setTimeout(() => {
                    actions.remove();
                }, 300);
            }
        }


        function showBatchFavoriteActions() {

            if (document.querySelector('.batch-favorite-actions')) return;

            const actions = document.createElement('div');
            actions.className = 'batch-favorite-actions';

            actions.innerHTML = `
        <button class="batch-action-btn-pill batch-btn-cancel" id="cancel-batch-favorite">
        <i class="fas fa-times"></i> хПЦц╢И
        </button>
        <button class="batch-action-btn-pill batch-btn-confirm" id="confirm-batch-favorite">
        <i class="fas fa-check"></i> чбошодцФ╢шЧП (0)
        </button>
        `;
            document.body.appendChild(actions);

            document.getElementById('confirm-batch-favorite').addEventListener('click', confirmBatchFavorite);
            document.getElementById('cancel-batch-favorite').addEventListener('click', toggleBatchFavoriteMode);
        }


        function confirmBatchFavorite() {
            if (selectedMessages.length === 0) {
                showNotification('шп╖хЕИщАЙцЛйшжБцФ╢шЧПчЪДц╢ИцБп', 'warning');
                return;
            }


            const count = selectedMessages.length;


            selectedMessages.forEach(msgId => {
                const message = messages.find(m => m.id === msgId);
                if (message) {
                    message.favorited = true;
                }
            });


            throttledSaveData();


            toggleBatchFavoriteMode();


            showNotification(`х╖▓цИРхКЯцФ╢шЧП ${count} цЭбц╢ИцБп`, 'success');
        }



        function renderAnniversaries() {
    const list = DOMElements.anniversaryModal.list;
    if (anniversaries.length === 0) {
        list.innerHTML = '<div class="no-favorites" style="padding:20px 0;"><i class="fas fa-heart" style="font-size:24px;margin-bottom:10px;"></i><p>ш┐Шц▓бцЬЙшо░х╜Хч║кх┐╡цЧе</p></div>';
        return;
    }

    list.innerHTML = anniversaries.map(anniversary => {
        const startDate = new Date(anniversary.date);
        const now = new Date();
        let diffDays;
        
        if (anniversary.type === 'countdown') {
            diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) diffDays = 0; 
        } else {
            diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        }

        const typeClass = anniversary.type === 'countdown' ? 'type-future' : 'type-past';
        const tagText = anniversary.type === 'countdown' ? 'хАТцХ░' : 'ч║кх┐╡';

        return `
        <div class="anniversary-card ${typeClass}" data-id="${anniversary.id}">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="ann-info">
                    <div class="ann-name">
                        ${anniversary.name} 
                        <span class="ann-tag">${tagText}</span>
                    </div>
                    <div class="ann-date">${startDate.toLocaleDateString()}</div>
                </div>
                <div class="ann-days">
                    <span class="ann-number">${diffDays}</span>
                    <span class="ann-label">Days</span>
                </div>
            </div>
            <div class="ann-delete-btn" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:opacity 0.2s;" 
                 onclick="deleteAnniversary(${anniversary.id}, event)">
                <i class="fas fa-times" style="font-size:12px;"></i>
            </div>
        </div>
        `;
    }).join('');
}

        function addAnniversary() {
    const name = DOMElements.anniversaryModal.nameInput.value.trim();
    const date = DOMElements.anniversaryModal.dateInput.value;

    if (!name || !date) {
        showNotification('шп╖хблхЖЩхРНчз░хТМцЧецЬЯ', 'error');
        return;
    }

    const newAnniversary = {
        id: Date.now(),
        name: name,
        date: date,
        type: currentAnniversaryType
    };

    anniversaries.push(newAnniversary);
    throttledSaveData();
    renderAnniversaries();
    DOMElements.anniversaryModal.nameInput.value = '';
    DOMElements.anniversaryModal.dateInput.value = '';

    const annFormWrapper = document.getElementById('ann-form-wrapper');
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    if (annFormWrapper) annFormWrapper.classList.remove('active');
    if (annToggleBtn) annToggleBtn.classList.remove('active');

    showNotification('ч║кх┐╡цЧех╖▓ц╖╗хКа', 'success');
}

        function showAnniversaryAnimation(anniversary) {
            const startDate = new Date(anniversary.date);
            const now = new Date();
            let diffDays;
            let title, message;

            if (anniversary.type === 'countdown') {

                diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                title = "хАТцХ░цЧе";
                message = `ш╖Эчж╗ ${anniversary.name} ш┐ШцЬЙ`;
            } else {

                diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                title = "ч║кх┐╡цЧех┐лф╣Ря╝Б";
                message = `цИСф╗мх╖▓ч╗ПчЫ╕ф╝┤ф║Ж`;
            }

            DOMElements.anniversaryAnimation.title.textContent = title;
            DOMElements.anniversaryAnimation.days.textContent = diffDays;
            DOMElements.anniversaryAnimation.message.textContent = message;

            DOMElements.anniversaryAnimation.modal.classList.add('active');
        }

        function updateAnniversaryDisplay(dateString) {
            if (!dateString) return;

            const start = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            DOMElements.anniversaryModal.daysElement.textContent = diffDays;
            DOMElements.anniversaryModal.dateShowElement.textContent = `ш╡╖хзЛцЧея╝Ъ${start.toLocaleDateString()}`;
            DOMElements.anniversaryModal.displayArea.style.display = 'block';
        }

        function renderStickerGrids() {
            const managerList = document.getElementById('sticker-manager-list');
            const pickerList = document.getElementById('sticker-picker-list');
            const emptyHint = document.getElementById('sticker-empty-hint');
            
            const addBtnHTML = `<div class="sticker-item sticker-add-btn" id="upload-sticker-trigger"><i class="fas fa-plus"></i></div>`;
            
            const stickerItemsHTML = stickers.map((src, index) => `
                <div class="sticker-item">
                    <img src="${src}" loading="lazy">
                    <div class="sticker-delete-btn" onclick="deleteSticker(${index}, event)">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            `).join('');
            
            if (managerList) {
                managerList.innerHTML = addBtnHTML + stickerItemsHTML;
                document.getElementById('upload-sticker-trigger').addEventListener('click', () => {
                    document.getElementById('sticker-file-input').click();
                });
            }

            if (pickerList) {
                if (stickers.length === 0) {
                    pickerList.innerHTML = '';
                    if(emptyHint) emptyHint.style.display = 'block';
                } else {
                    if(emptyHint) emptyHint.style.display = 'none';
                    pickerList.innerHTML = stickers.map((src, index) => `
                        <div class="sticker-item" onclick="sendSticker('${src}')">
                            <img src="${src}" loading="lazy">
                        </div>
                    `).join('');
                }
            }
        }

        window.deleteSticker = function(index, event) {
            if(event) event.stopPropagation();
            if(confirm('чбохоЪшжБхИащЩдш┐Щф╕кшбицГЕхМЕхРЧя╝Я')) {
                stickers.splice(index, 1);
                throttledSaveData();
                renderStickerGrids();
                showNotification('шбицГЕхМЕх╖▓хИащЩд', 'success');
            }
        };

        window.sendSticker = function(src) {
            const picker = document.getElementById('sticker-picker-modal');
            if(picker) picker.style.display = 'none';

            addMessage({
                id: Date.now(),
                sender: 'user',
                text: src,
                image: src, 
                timestamp: new Date(),
                status: 'sent',
                favorited: false,
                note: null,
                type: 'sticker' 
            });
            
            playSound('send');
            setTimeout(simulateReply, 800 + Math.random() * 1200);
        };

        function handleStickerUpload(file) {
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { 
                showNotification('шбицГЕхМЕх╗║шоох░Пф║О 2MB', 'error');
                return;
            }

            showNotification('цнгхЬихдДчРЖшбицГЕхМЕ...', 'info', 1000);
            
            optimizeImage(file, 200, 0.8).then(base64 => {
                stickers.push(base64);
                throttledSaveData();
                renderStickerGrids();
                showNotification('шбицГЕхМЕц╖╗хКацИРхКЯя╝Б', 'success');
            }).catch(err => {
                console.error(err);
                showNotification('ц╖╗хКахд▒ш┤е', 'error');
            });
        }

        function setupEventListeners() {
            initCoreListeners();
            initModalListeners();
            initChatActionListeners();
            initHeaderAndSettingsListeners();
            initDataManagementListeners();
            initNewFeatureListeners();
            setupTutorialListeners(); 
        }

        function initCoreListeners() {


            DOMElements.chatContainer.addEventListener('scroll', () => {
                const container = DOMElements.chatContainer;


                if (container.scrollTop < 50 && !isLoadingHistory && messages.length > displayedMessageCount) {
                    isLoadingHistory = true;


                    const loader = document.getElementById('history-loader');
                    if (loader) loader.classList.add('visible');


                    setTimeout(() => {

                        displayedMessageCount += HISTORY_BATCH_SIZE;


                        renderMessages(true);


                        if (loader) loader.classList.remove('visible');
                        isLoadingHistory = false;
                    },
                        600);
                }
            });

            DOMElements.sendBtn.addEventListener('click', () => isBatchMode ? addToBatch(): sendMessage());
            DOMElements.messageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); isBatchMode ? addToBatch(): sendMessage();
                }
            });
            DOMElements.messageInput.addEventListener('input', () => {
                DOMElements.messageInput.style.height = 'auto'; DOMElements.messageInput.style.height = `${Math.min(DOMElements.messageInput.scrollHeight, 120)}px`;
            });


            DOMElements.attachmentBtn.addEventListener('click', () => {

                const modal = document.createElement('div');
                modal.className = 'modal image-upload-modal';
                modal.style.cssText = `
            display: flex !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            `;

                modal.innerHTML = `
            <div class="modal-content" style="
            z-index: 10000;
            position: relative;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            ">
            <div class="modal-title"><i class="fas fa-image"></i><span>хПСщАБхЫ╛чЙЗ</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary upload-mode-btn active" id="upload-image-file-btn" style="flex: 1;">щАЙцЛйцЦЗф╗╢</button>
            <button class="modal-btn modal-btn-secondary upload-mode-btn" id="paste-image-url-btn" style="flex: 1;">ч▓Шш┤┤URL</button>
            </div>
            <input type="file" class="modal-input" id="image-file-input" accept="image/*">
            <input type="text" class="modal-input" id="image-url-input" placeholder="ш╛УхЕехЫ╛чЙЗURLхЬ░хЭА" style="display: none;">
            <div id="image-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-image">хПЦц╢И</button>
            <button class="modal-btn modal-btn-primary" id="send-image" disabled>хПСщАБ</button>
            </div>
            </div>
            `;

                document.body.appendChild(modal);


                setTimeout(() => {
                    modal.style.opacity = '1';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);

                const fileInput = document.getElementById('image-file-input');
                const urlInput = document.getElementById('image-url-input');
                const uploadBtn = document.getElementById('upload-image-file-btn');
                const pasteUrlBtn = document.getElementById('paste-image-url-btn');
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-chat-image');
                const sendBtn = document.getElementById('send-image');
                const cancelBtn = document.getElementById('cancel-image');
                const uploadModeBtns = document.querySelectorAll('.upload-mode-btn');

                let currentImageData = null;


                function switchUploadMode(isFileMode) {
                    uploadModeBtns.forEach(btn => btn.classList.remove('active'));
                    if (isFileMode) {
                        uploadBtn.classList.add('active');
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        pasteUrlBtn.classList.add('active');
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                        urlInput.focus();
                    }

                    previewDiv.style.display = 'none';
                    sendBtn.disabled = true;
                    currentImageData = null;
                }


                uploadBtn.addEventListener('click', () => switchUploadMode(true));


                pasteUrlBtn.addEventListener('click', () => switchUploadMode(false));


                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_IMAGE_SIZE) {
                            showNotification('хЫ╛чЙЗхдзх░Пф╕НшГ╜ш╢Еш┐З5MB', 'error');
                            return;
                        }
                        showNotification('цнгхЬиф╝ШхМЦхЫ╛чЙЗ...', 'info', 1500);
                        optimizeImage(file).then(optimizedData => {
                            currentImageData = optimizedData;
                            previewImg.src = currentImageData;
                            previewDiv.style.display = 'block';
                            sendBtn.disabled = false;
                        }).catch(() => {
                            showNotification('хЫ╛чЙЗхдДчРЖхд▒ш┤е', 'error');
                        });
                    }
                });


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|bmp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentImageData = url;
                                sendBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                    showNotification('хЫ╛чЙЗURLцЬЙцХИ', 'success', 1000);
                                };
                                img.onerror = function() {
                                    showNotification('хЫ╛чЙЗURLцЧацХИцИЦцЧац│Хшо┐щЧо', 'error');
                                    sendBtn.disabled = true;
                                    previewDiv.style.display = 'none';
                                };
                                img.src = url;
                            } else {
                                sendBtn.disabled = true;
                                previewDiv.style.display = 'none';
                            }
                        } else {
                            sendBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                sendBtn.addEventListener('click',
                    () => {
                        if (currentImageData) {

                            addMessage({
                                id: Date.now(),
                                sender: 'user',
                                text: '',
                                timestamp: new Date(),
                                image: currentImageData,
                                status: 'sent',
                                favorited: false,
                                note: null,
                                replyTo: currentReplyTo,
                                type: 'normal'
                            });
                            playSound('send');
                            currentReplyTo = null;
                            updateReplyPreview();
                            setTimeout(simulateReply, 800 + Math.random() * 1200);


                            closeModal();
                        }
                    });


                cancelBtn.addEventListener('click',
                    closeModal);


                function closeModal() {
                    modal.style.opacity = '0';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    },
                        300);
                }


                modal.addEventListener('click',
                    (e) => {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });


                modal.querySelector('.modal-content').addEventListener('click',
                    (e) => {
                        e.stopPropagation();
                    });


                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);


                modal.addEventListener('close', () => {
                    document.removeEventListener('keydown', handleEscKey);
                });
            });


            DOMElements.imageInput.addEventListener('change', () => {
                if (DOMElements.imageInput.files[0]) {
                    if (isBatchMode) {
                        showNotification('цЙ╣щЗПцибх╝Пф╕НцФпцМБхЫ╛чЙЗ', 'warning');
                        DOMElements.imageInput.value = '';
                    } else {
                        sendMessage();
                    }
                }
            });

            DOMElements.continueBtn.addEventListener('click', simulateReply);
            DOMElements.batchBtn.addEventListener('click', toggleBatchMode);
            DOMElements.pokeBtn.addEventListener('click', () => showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input));
        }

        function initChatActionListeners() {
            DOMElements.chatContainer.addEventListener('click', (e) => {

                if (isBatchFavoriteMode) {
                    const wrapper = e.target.closest('.message-wrapper');
                    if (wrapper && !e.target.closest('.message-meta-actions')) {
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);

                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            wrapper.classList.remove('selected');
                        } else {
                            selectedMessages.push(messageId);
                            wrapper.classList.add('selected');
                        }


                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `чбошодцФ╢шЧП (${selectedMessages.length})`;
                        }
                        return;
                    }
                }


                const favoriteBtn = e.target.closest('.favorite-meta-btn');
                if (favoriteBtn) {
                    const wrapper = e.target.closest('.message-wrapper');
                    const messageId = Number(wrapper.dataset.id);
                    const message = messages.find(m => m.id === messageId);
                    if (message) {
                        message.favorited = !message.favorited;
                        showNotification(message.favorited ? 'х╖▓цФ╢шЧП': 'х╖▓хПЦц╢ИцФ╢шЧП', 'success', 1500);
                        playSound('favorite');
                        throttledSaveData();
                        renderMessages(false);
                    }
                    return;
                }


                const target = e.target.closest('.meta-action-btn');
                if (!target) return;
                const wrapper = e.target.closest('.message-wrapper');
                const messageId = Number(wrapper.dataset.id);
                const message = messages.find(m => m.id === messageId);
                if (!message) return;

                if (target.classList.contains('reply-btn')) {
                    currentReplyTo = {
                        id: message.id,
                        sender: message.sender,
                        text: message.text,
                        type: message.type
                    };
                    updateReplyPreview();
                    DOMElements.messageInput.focus();
                    const targetMessageElement = DOMElements.chatContainer.querySelector(`[data-id="${message.id}"]`);
                    if (targetMessageElement) targetMessageElement.scrollIntoView({
                        behavior: 'smooth', block: 'center'
                    });
                    return;
                } else if (target.classList.contains('note-btn')) {
                    currentNoteMessageId = messageId;
                    DOMElements.noteModal.input.value = message.note || '';
                    showModal(DOMElements.noteModal.modal, DOMElements.noteModal.input);
                    return;
                }

                throttledSaveData();
                renderMessages(true);
            });

            DOMElements.batchPreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.batch-preview-remove');
                if (removeBtn) {
                    const index = removeBtn.closest('.batch-preview-item').dataset.index;
                    batchMessages.splice(index, 1); updateBatchPreview();
                }
                const sendBtn = e.target.closest('.batch-send-btn');
                if (sendBtn && !sendBtn.disabled) sendBatchMessages();
                if (e.target.matches('.batch-cancel-btn')) {
                    isBatchMode = false; DOMElements.batchBtn.classList.remove('active');
                    DOMElements.batchPreview.style.display = 'none';
                    const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
                    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
                    batchMessages = [];
                }
            });
        }

        function initModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const cancelBtn = modal.querySelector('.modal-btn-secondary');
                if (cancelBtn) cancelBtn.addEventListener('click', () => hideModal(modal));
            });

            DOMElements.editModal.input.addEventListener('input', () => {
                DOMElements.editModal.save.disabled = !DOMElements.editModal.input.value.trim();
            });
            DOMElements.noteModal.save.addEventListener('click', () => {
                const message = messages.find(m => m.id === currentNoteMessageId);
                if (message) {
                    message.note = DOMElements.noteModal.input.value.trim() || null;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('ц│ищЗКх╖▓ф┐ЭхнШ', 'success');
                }
                hideModal(DOMElements.noteModal.modal);
            });

            DOMElements.pokeModal.save.addEventListener('click', () => {
                let pokeText = DOMElements.pokeModal.input.value.trim() || `${settings.myName} цЛНф║ЖцЛН ${settings.partnerName}`;
                addMessage({
                    id: Date.now(), text: `тЬж ${pokeText} тЬж`, timestamp: new Date(), type: 'system'
                });
                hideModal(DOMElements.pokeModal.modal);
                DOMElements.pokeModal.input.value = '';
                setTimeout(simulateReply, 800 + Math.random() * 1200);
            });


            DOMElements.cancelCoinResult.addEventListener('click', () => {
                DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                lastCoinResult = null;
            });


            DOMElements.sendCoinResult.addEventListener('click', () => {
                if (lastCoinResult) {
                    sendMessage(`ЁЯО▓ цКЫчбмх╕Бч╗УцЮЬя╝Ъ${lastCoinResult}`, 'normal');
                    DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                    lastCoinResult = null;
                }
            });


            const retryBtn = document.getElementById('retry-coin-toss');

            if (retryBtn) {
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();

                    startCoinFlipAnimation();
                });
            }
        }

        function initHeaderAndSettingsListeners() {

            const openNameModal = (isPartner) => {
                const modal = DOMElements.editModal;
                showModal(modal.modal, modal.input);
                modal.title.textContent = `ф┐оцФ╣${isPartner ? (settings.partnerName || 'хп╣цЦ╣'): 'цИС'}чЪДцШ╡чз░`;
                modal.input.value = isPartner ? settings.partnerName: settings.myName;
                modal.save.disabled = !modal.input.value.trim();
                modal.save.onclick = () => {
                    const newName = modal.input.value.trim();
                    if (newName) {
                        isPartner ? settings.partnerName = newName: settings.myName = newName;
                        throttledSaveData();
                        updateUI();
                        showNotification('цШ╡чз░х╖▓цЫ┤цЦ░', 'success');
                    }
                    hideModal(modal.modal);
                };
            };

            const openAvatarModal = (isPartner) => {
                const modal = DOMElements.avatarModal;

                modal.modal.querySelector('.modal-content').innerHTML = `
            <div class="modal-title"><i class="fas fa-portrait"></i><span>ф╕Кф╝а${isPartner ? 'хп╣цЦ╣': 'цИС'}чЪДхд┤хГП</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary" id="upload-file-btn" style="flex: 1;">щАЙцЛйцЦЗф╗╢</button>
            <button class="modal-btn modal-btn-secondary" id="paste-url-btn" style="flex: 1;">ч▓Шш┤┤URL</button>
            </div>
            <input type="file" class="modal-input" id="avatar-file-input" accept="image/*" style="display: none;">
            <input type="text" class="modal-input" id="avatar-url-input" placeholder="ш╛УхЕехЫ╛чЙЗURLхЬ░хЭА" style="display: none;">
            <div id="avatar-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-avatar">хПЦц╢И</button>
            <button class="modal-btn modal-btn-primary" id="save-avatar" disabled>ф┐ЭхнШ</button>
            </div>
            `;

                showModal(modal.modal);

                const fileInput = document.getElementById('avatar-file-input');
                const urlInput = document.getElementById('avatar-url-input');
                const uploadBtn = document.getElementById('upload-file-btn');
                const pasteUrlBtn = document.getElementById('paste-url-btn');
                const previewDiv = document.getElementById('avatar-preview');
                const previewImg = document.getElementById('preview-image');
                const saveBtn = document.getElementById('save-avatar');
                const cancelBtn = document.getElementById('cancel-avatar');

                let currentAvatarData = null;


                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                    urlInput.style.display = 'none';
                    uploadBtn.classList.add('active');
                    pasteUrlBtn.classList.remove('active');
                });


                pasteUrlBtn.addEventListener('click', () => {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    pasteUrlBtn.classList.add('active');
                    uploadBtn.classList.remove('active');
                    urlInput.focus();
                });


                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_AVATAR_SIZE) {
                            showNotification('хд┤хГПхЫ╛чЙЗф╕НшГ╜ш╢Еш┐З2MB', 'error');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            currentAvatarData = e.target.result;
                            previewImg.src = currentAvatarData;
                            previewDiv.style.display = 'block';
                            saveBtn.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentAvatarData = url;
                                saveBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                };
                                img.onerror = function() {
                                    showNotification('хЫ╛чЙЗURLцЧацХИцИЦцЧац│Хшо┐щЧо', 'error');
                                    saveBtn.disabled = true;
                                };
                                img.src = url;
                            } else {
                                saveBtn.disabled = true;
                            }
                        } else {
                            saveBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                saveBtn.addEventListener('click',
                    () => {
                        if (currentAvatarData) {
                            updateAvatar(isPartner ? DOMElements.partner.avatar: DOMElements.me.avatar, currentAvatarData);
                            throttledSaveData();
                            showNotification('хд┤хГПх╖▓цЫ┤цЦ░', 'success');
                            hideModal(modal.modal);
                        }
                    });


                cancelBtn.addEventListener('click',
                    () => {
                        hideModal(modal.modal);
                    });
            };

            DOMElements.partner.name.addEventListener('click', () => openNameModal(true));
            DOMElements.me.name.addEventListener('click', () => openNameModal(false));
            DOMElements.partner.avatar.addEventListener('click', () => openAvatarModal(true));
            DOMElements.me.avatar.addEventListener('click', () => openAvatarModal(false));

            DOMElements.me.statusContainer.addEventListener('click', () => {
                const statusTextElement = DOMElements.me.statusText; const statusContainer = DOMElements.me.statusContainer;
                if (statusContainer.querySelector('input')) return;
                const input = document.createElement('input'); input.type = 'text'; input.id = 'my-status-input'; input.value = statusTextElement.textContent;
                const saveStatus = () => {
                    const newStatus = input.value.trim();
                    if (newStatus) {
                        settings.myStatus = newStatus; showNotification('чК╢цАБх╖▓цЫ┤цЦ░', 'success');
                    } else {
                        settings.myStatus = "хЬич║┐";
                    }
                    statusTextElement.textContent = settings.myStatus;
                    statusContainer.innerHTML = '';
                    statusContainer.appendChild(statusTextElement);
                    throttledSaveData();
                };
                input.addEventListener('blur', saveStatus);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });
                statusContainer.innerHTML = ''; statusContainer.appendChild(input); input.focus();
            });

            DOMElements.themeToggle.addEventListener('click', () => {
                settings.isDarkMode = !settings.isDarkMode; throttledSaveData(); updateUI(); showNotification(`х╖▓хИЗцНвхИ░${settings.isDarkMode ? 'ц╖▒шЙ▓': 'ц╡ЕшЙ▓'}цибх╝П`,
                    'success');
            });
            DOMElements.settingsModal.settingsBtn.addEventListener('click', () => {
                showModal(DOMElements.settingsModal.modal);
            });
            DOMElements.favoritesModal.favoritesBtn.addEventListener('click', () => {
                renderFavorites(); showModal(DOMElements.favoritesModal.modal);
            });


            document.getElementById('chat-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.chatModal.modal);
            });

            document.getElementById('advanced-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.advancedModal.modal);
            });

            document.getElementById('data-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.dataModal.modal);
            });


            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click',
                    () => {
                        settings.colorTheme = btn.dataset.theme;
                        throttledSaveData();
                        updateUI();
                        showNotification(`ф╕╗щвШщвЬшЙ▓х╖▓хИЗцНв`, 'success');
                    });
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click',
                    () => {
                        settings.bubbleStyle = item.dataset.bubbleStyle;
                        throttledSaveData();
                        updateUI();
                        showNotification(`ц░Фц│бца╖х╝Пх╖▓хИЗцНвф╕║${getBubbleStyleName(settings.bubbleStyle)}`, 'success');
                    });
            });


            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');

            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = `${settings.fontSize}px`;

            fontSizeSlider.addEventListener('input', (e) => {
                settings.fontSize = parseInt(e.target.value);
                document.documentElement.style.setProperty('--font-size',
                    `${settings.fontSize}px`);
                fontSizeValue.textContent = `${settings.fontSize}px`;
            });

            fontSizeSlider.addEventListener('change', throttledSaveData);


            const settingToggles = {
                '#reply-toggle': {
                    prop: 'replyEnabled', name: 'х╝ХчФихЫЮхдН'
                },
                '#sound-toggle': {
                    prop: 'soundEnabled', name: 'ц╢ИцБпщЯ│цХИ'
                },
                '#read-receipts-toggle': {
                    prop: 'readReceiptsEnabled', name: 'х╖▓шп╗хЫЮцЙз'
                },
                '#typing-indicator-toggle': {
                    prop: 'typingIndicatorEnabled', name: 'цнгхЬиш╛УхЕе'
                }
            };

            for (const [selector, {
                prop, name
            }] of Object.entries(settingToggles)) {
                const element = document.querySelector(selector);

                if (element) {
                    const span = element.querySelector('span');
                    if (span) span.textContent = `${name}: ${settings[prop] ? 'х╝АхРп': 'хЕ│щЧн'}`;
                }

                element.addEventListener('click', () => {
                    settings[prop] = !settings[prop];
                    throttledSaveData();
                    updateUI();


                    const span = element.querySelector('span');
                    if (span) {
                        span.textContent = `${name}: ${settings[prop] ? 'х╝АхРп': 'хЕ│щЧн'}`;

                    }

                    if (prop !== 'soundEnabled') renderMessages(true);
                    showNotification(`${name}х╖▓${settings[prop] ? 'х╝АхРп': 'хЕ│щЧн'}`, 'success');
                });
            }


            document.getElementById('appearance-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                renderBackgroundGallery();
                showModal(DOMElements.appearanceModal.modal);
            });
            DOMElements.appearanceModal.closeBtn.addEventListener('click', () => {
                hideModal(DOMElements.appearanceModal.modal);
            });

            const bgInput = document.getElementById('bg-gallery-input');
            if (bgInput) {
                bgInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > MAX_IMAGE_SIZE) {
                        showNotification('шГМцЩпхЫ╛чЙЗф╕НшГ╜ш╢Еш┐З5MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;


                        savedBackgrounds.push({
                            id: `user-${Date.now()}`,
                            type: 'image',
                            value: base64
                        });


                        saveBackgroundGallery();
                        renderBackgroundGallery();


                        applyBackground(base64);
                        safeSetItem(getStorageKey('chatBackground'), base64);
                        showNotification('цЦ░шГМцЩпх╖▓ц╖╗хКах╣╢х║ФчФи', 'success');
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                });
            }


            const resetBgBtn = document.getElementById('reset-default-bg');
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', () => {
                    removeBackground();
                    renderBackgroundGallery();
                    showNotification('х╖▓чз╗щЩдшГМцЩпхЫ╛', 'success');
                });
            }
        }


        function initNewFeatureListeners() {
            // 1. хбФч╜ЧхНахНЬ
            document.getElementById('fortune-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                generateFortune();
            });
            DOMElements.fortuneModal.shareBtn.addEventListener('click', () => {
                const fortuneText = document.querySelector('.fortune-desc').textContent;
                const shareText = `цИСчЪДф╗КцЧеш┐РхК┐я╝Ъ${fortuneText}`;
                if (navigator.share) {
                    navigator.share({ title: 'ф╗КцЧеш┐РхК┐', text: shareText });
                } else {
                    navigator.clipboard.writeText(shareText).then(() => {
                        showNotification('ш┐РхК┐х╖▓хдНхИ╢хИ░хЙкш┤┤цЭ┐', 'success');
                    });
                }
            });

            // 2. цЙ╣щЗПцФ╢шЧП
            document.getElementById('batch-favorite-function').addEventListener('click', () => {
                hideModal(DOMElements.favoritesModal.modal);
                toggleBatchFavoriteMode();
            });

            // 3. хИЭхзЛхМЦхЫЮхдНх║УчЫСхРм
            initReplyLibraryListeners();

            // 4. ч║кх┐╡цЧе/щЗНшжБцЧе
            document.getElementById('anniversary-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderAnniversaries();
                showModal(DOMElements.anniversaryModal.modal);
            });

            document.querySelectorAll('.anniversary-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.anniversary-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentAnniversaryType = this.dataset.type;
                    const hintElement = DOMElements.anniversaryModal.typeHint;
                    if (currentAnniversaryType === 'countdown') {
                        hintElement.textContent = 'хАТцХ░цЧея╝Ъф╗Оф╗КхдйхИ░цЬкцЭецЯРхдйчЪДхдйцХ░';
                    } else {
                        hintElement.textContent = 'ч║кх┐╡цЧея╝Ъф╗Ош┐ЗхО╗цЯРхдйхИ░ф╗КхдйчЪДхдйцХ░';
                    }
                });
            });

            DOMElements.anniversaryModal.addBtn.addEventListener('click', addAnniversary);

            DOMElements.anniversaryModal.saveBtn.addEventListener('click', () => {
                const val = DOMElements.anniversaryModal.dateInput.value;
                if (val) {
                    const mainAnniversary = {
                        id: 'main',
                        name: 'чЫ╕шпЖч║кх┐╡цЧе',
                        date: val,
                        type: 'anniversary'
                    };
                    const existingIndex = anniversaries.findIndex(a => a.id === 'main');
                    if (existingIndex > -1) {
                        anniversaries[existingIndex] = mainAnniversary;
                    } else {
                        anniversaries.push(mainAnniversary);
                    }
                    throttledSaveData();
                    renderAnniversaries();
                    updateAnniversaryDisplay(val);
                    showNotification('ч║кх┐╡цЧех╖▓ф┐ЭхнШ', 'success');
                }
            });

            DOMElements.anniversaryModal.list.addEventListener('click', (e) => {
                const anniversaryItem = e.target.closest('.anniversary-item');
                if (anniversaryItem) {
                    const anniversaryId = anniversaryItem.dataset.id;
                    const anniversary = anniversaries.find(a => a.id == anniversaryId);
                    if (anniversary) {
                        showAnniversaryAnimation(anniversary);
                    }
                }
            });

            DOMElements.anniversaryAnimation.closeBtn.addEventListener('click', () => {
                DOMElements.anniversaryAnimation.modal.classList.remove('active');
            });

            // 5. ц╢ИцБпч╗Яшоб
            document.getElementById('stats-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderStatsContent();
                showModal(DOMElements.statsModal.modal);
            });

            // 6. цКЫчбмх╕Б
            document.getElementById('coin-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                handleCoinToss();
            });

            // 7. щЯ│ф╣РцТнцФ╛хЩи
            const musicToggle = document.getElementById('music-player-toggle');
            musicToggle.addEventListener('click', () => {
                settings.musicPlayerEnabled = !settings.musicPlayerEnabled;
                throttledSaveData();
                const player = document.getElementById('player');
                if (settings.musicPlayerEnabled) {
                    player.classList.add('visible');
                    showNotification('щЯ│ф╣РцТнцФ╛хЩих╖▓х╝АхРп', 'success');
                } else {
                    player.classList.remove('visible');
                    document.getElementById('playlist').classList.remove('active');
                    const audio = document.getElementById('audio');
                    if (audio) audio.pause();
                    showNotification('щЯ│ф╣РцТнцФ╛хЩих╖▓хЕ│щЧн', 'info');
                }
                hideModal(DOMElements.advancedModal.modal);
            });

            // 8. шбицГЕхМЕчобчРЖ
            const stickerManagerBtn = document.getElementById('sticker-manager-btn');
            const stickerManagerModal = document.getElementById('sticker-manager-modal');
            if (stickerManagerBtn && stickerManagerModal) {
                stickerManagerBtn.addEventListener('click', () => {
                    renderStickerGrids();
                    showModal(stickerManagerModal);
                });
                document.getElementById('close-sticker-manager').addEventListener('click', () => {
                    hideModal(stickerManagerModal);
                });
            }

            // 9. шбицГЕхМЕщАЙцЛйхЩи (х║ХщГи)
            const stickerPickerBtn = document.getElementById('sticker-picker-toggle-btn');
            const stickerPickerModal = document.getElementById('sticker-picker-modal');
            if (stickerPickerBtn && stickerPickerModal) {
                stickerPickerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (stickerPickerModal.style.display === 'flex') {
                        stickerPickerModal.style.display = 'none';
                    } else {
                        renderStickerGrids();
                        stickerPickerModal.style.display = 'flex';
                        const content = stickerPickerModal.querySelector('.modal-content');
                        content.style.opacity = '0';
                        content.style.transform = 'translateY(10px)';
                        setTimeout(() => {
                            content.style.opacity = '1';
                            content.style.transform = 'translateY(0)';
                        }, 10);
                    }
                });
                document.addEventListener('click', (e) => {
                    if (stickerPickerModal.style.display === 'flex' && 
                        !stickerPickerModal.contains(e.target) && 
                        !stickerPickerBtn.contains(e.target)) {
                        stickerPickerModal.style.display = 'none';
                    }
                });
            }

            const quickAddStickerBtn = document.getElementById('quick-add-sticker');
            if(quickAddStickerBtn) {
                quickAddStickerBtn.addEventListener('click', () => {
                    document.getElementById('sticker-file-input').click();
                });
            }

            const stickerFileInput = document.getElementById('sticker-file-input');
            if (stickerFileInput) {
                stickerFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handleStickerUpload(file);
                        e.target.value = ''; 
                    }
                });
            }

            // ==========================================
            // уАРцЦ░хвЮхКЯшГ╜уАСхЫЮхдНцХ░щЗПшо╛ч╜о (хПМц╗СхЭЧчЙИ)
            // ==========================================
            
            // цЙУх╝Ашо╛ч╜оцибцАБцбЖ
            const replyCountBtn = document.getElementById('reply-count-function');
            if (replyCountBtn) {
                replyCountBtn.addEventListener('click', () => {
                    hideModal(document.getElementById('advanced-modal'));
                    const modal = document.getElementById('reply-count-modal');
                    
                    const isRandom = settings.replyCountMode !== 'custom'; 
                    const min = settings.replyMinCount !== undefined ? settings.replyMinCount : 1;
                    const max = settings.replyMaxCount !== undefined ? settings.replyMaxCount : 3;
                    
                    updateReplyRangeUI(isRandom, min, max);
                    showModal(modal);
                });
            }

            const randomToggleBtn = document.getElementById('reply-random-toggle-btn');
            if (randomToggleBtn) {
                randomToggleBtn.addEventListener('click', () => {
                    const currentIsRandom = settings.replyCountMode !== 'custom';
                    const newIsRandom = !currentIsRandom; // хИЗцНв
                    
                    settings.replyCountMode = newIsRandom ? 'random' : 'custom';
                    
                    if (!newIsRandom) {
                        if (settings.replyMinCount === undefined) settings.replyMinCount = 1;
                        if (settings.replyMaxCount === undefined) settings.replyMaxCount = 3;
                    }
                    
                    updateReplyRangeUI(newIsRandom, settings.replyMinCount, settings.replyMaxCount);
                    throttledSaveData();
                    
                    showNotification(newIsRandom ? 'х╖▓хИЗцНвф╕║ч│╗ч╗Ящ╗ШшодщвСчОЗ' : 'х╖▓хИЗцНвф╕║шЗкхоЪф╣ЙхЫЮхдНшМГхЫ┤', 'success');
                });
            }

            const minSlider = document.getElementById('reply-min-slider');
            const maxSlider = document.getElementById('reply-max-slider');
            
            if (minSlider && maxSlider) {
                minSlider.addEventListener('input', (e) => {
                    let minVal = parseInt(e.target.value);
                    let maxVal = parseInt(maxSlider.value);
                    
                    if (minVal > maxVal) {
                        maxVal = minVal;
                        maxSlider.value = maxVal;
                    }
                    
                    settings.replyMinCount = minVal;
                    settings.replyMaxCount = maxVal;
                    updateRangeText(minVal, maxVal);
                });

                maxSlider.addEventListener('input', (e) => {
                    let maxVal = parseInt(e.target.value);
                    let minVal = parseInt(minSlider.value);
                    
                    if (maxVal < minVal) {
                        minVal = maxVal;
                        minSlider.value = minVal;
                    }
                    
                    settings.replyMinCount = minVal;
                    settings.replyMaxCount = maxVal;
                    updateRangeText(minVal, maxVal);
                });

                minSlider.addEventListener('change', throttledSaveData);
                maxSlider.addEventListener('change', throttledSaveData);
            }

            const closeReplyCountBtn = document.getElementById('close-reply-count');
            if (closeReplyCountBtn) {
                closeReplyCountBtn.addEventListener('click', () => {
                    hideModal(document.getElementById('reply-count-modal'));
                });
            }

            function updateReplyRangeUI(isRandom, min, max) {
                const statusText = document.getElementById('reply-random-status');
                const fixedSection = document.getElementById('fixed-count-section');
                const minSliderEl = document.getElementById('reply-min-slider');
                const maxSliderEl = document.getElementById('reply-max-slider');
                
                if (isRandom) {
                    statusText.textContent = "х╝АхРп";
                    statusText.style.color = "var(--accent-color)";
                    fixedSection.style.opacity = "0.5";
                    fixedSection.style.pointerEvents = "none";
                } else {
                    statusText.textContent = "хЕ│щЧн";
                    statusText.style.color = "var(--text-secondary)";
                    fixedSection.style.opacity = "1";
                    fixedSection.style.pointerEvents = "auto";
                }
                
                if(minSliderEl) minSliderEl.value = min;
                if(maxSliderEl) maxSliderEl.value = max;
                updateRangeText(min, max);
            }

            function updateRangeText(min, max) {
                const minValEl = document.getElementById('reply-min-value');
                const maxValEl = document.getElementById('reply-max-value');
                const rangeDisplay = document.getElementById('reply-range-display');
                
                if(minValEl) minValEl.textContent = min;
                if(maxValEl) maxValEl.textContent = max;
                if(rangeDisplay) rangeDisplay.textContent = `${min} ~ ${max}`;
            }
        }

        function getBubbleStyleName(style) {
            const names = {
                'standard': 'цаЗхЗЖ',
                'rounded': 'хЬЖшзТ',
                'rounded-large': 'хдзхЬЖшзТ',
                'square': 'цЦ╣х╜в'
            };
            return names[style] || 'цаЗхЗЖ';
        }

        function initDataManagementListeners() {

            document.getElementById('export-chat').addEventListener('click', exportChatHistory);
            document.getElementById('import-chat').addEventListener('click', () => DOMElements.importInput.click());
            DOMElements.importInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importChatHistory(e.target.files[0]); e.target.value = '';
                }
            });


            document.getElementById('clear-chat').addEventListener('click', () => {
                if (confirm("чбохоЪшжБц╕Ечй║х╜УхЙНф╝ЪшпЭчЪДцЙАцЬЙшБКхдйшо░х╜ХхРЧя╝ЯцндцУНф╜Ьф╕НхПпцБвхдН")) {
                    messages = [];
                    throttledSaveData();
                    renderMessages();
                    hideModal(DOMElements.dataModal.modal);
                    showNotification('шБКхдйшо░х╜Хх╖▓ц╕Ечй║', 'success');
                }
            });
            document.getElementById('clear-storage').addEventListener('click', clearAllAppData);
            const creditsBtn = document.getElementById('open-credits-btn');
            if (creditsBtn) {
                creditsBtn.addEventListener('click', () => {

                    hideModal(DOMElements.dataModal.modal);


                    const disclaimerModal = document.getElementById('disclaimer-modal');


                    if (disclaimerModal) {
                        showModal(disclaimerModal);
                    }
                });
            }

        }


        DOMElements.sessionModal.managerBtn.addEventListener('click', () => {
            renderSessionList(); showModal(DOMElements.sessionModal.modal);
        });
        DOMElements.sessionModal.createBtn.addEventListener('click', () => {
            const newId = createNewSession(false);

            renderSessionList();
            showNotification('цЦ░ф╝ЪшпЭх╖▓хИЫх╗║', 'success');
        });

        DOMElements.sessionModal.list.addEventListener('click', (e) => {
            const item = e.target.closest('.session-item');
            if (!item) return;
            const sessionId = item.dataset.id;

            if (e.target.closest('.rename')) {
                const session = sessionList.find(s => s.id === sessionId);
                const newName = prompt('ш╛УхЕецЦ░чЪДф╝ЪшпЭхРНчз░:', session.name);
                if (newName && newName.trim()) {
                    session.name = newName.trim();
                    safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));
                    renderSessionList();
                    showNotification('ф╝ЪшпЭх╖▓щЗНхС╜хРН', 'success');
                }
            } else if (e.target.closest('.delete')) {
                if (sessionList.length <= 1) {
                    showNotification('цЧац│ХхИащЩдцЬАхРОф╕Аф╕кф╝ЪшпЭ', 'warning');
                    return;
                }
                if (confirm('чбохоЪшжБхИащЩдцндф╝ЪшпЭхПКхЕ╢цЙАцЬЙшБКхдйшо░х╜ХхРЧя╝ЯцндцУНф╜Ьф╕НхПпцБвхдН')) {

                    const currentSessionId = SESSION_ID;

                    sessionList = sessionList.filter(s => s.id !== sessionId);
                    safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));


                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(`${APP_PREFIX}${sessionId}_`)) safeRemoveItem(key);
                    });

                    if (sessionId === currentSessionId) {

                        const newCurrentId = sessionList[0].id;
                        safeSetItem(`${APP_PREFIX}lastSessionId`, newCurrentId);
                        window.location.hash = newCurrentId;
                        window.location.reload();
                    } else {
                        renderSessionList();
                        showNotification('ф╝ЪшпЭх╖▓хИащЩд', 'success');
                    }
                }
            } else {

                if (sessionId !== SESSION_ID) {
                    if (confirm('хИЗцНвф╝ЪшпЭх░ЖхИ╖цЦ░щб╡щЭвя╝МчбохоЪшжБч╗зч╗нхРЧя╝Я')) {
                        window.location.hash = sessionId;
                        window.location.reload();
                    }
                }
            }
        });

        const initMusicPlayer = () => {
    const latestSystemSongs = [{
                title: "шЩЪцЛЯ", sub: "ф╜ацШпцИСцЬЭхдХчЫ╕ф╝┤шзжцЙЛхПпхПКчЪДшЩЪцЛЯ", url: "https://files.catbox.moe/6s65mp.mp3"
            },
                {
                    title: "хдЪш┐ЬщГ╜шжБхЬиф╕Аш╡╖", sub: "чИ▒шГ╜хЕЛцЬНш┐Ьш╖Эчж╗", url: "https://files.catbox.moe/06k9ra.mp3"
                },
                {
                    title: "ц░╕ф╕Нхд▒шБФчЪДчИ▒", sub: "ш┐Щф╕Аш╛ИхнРщГ╜ф╕НцГ│хд▒шБФчЪДчИ▒", url: "https://files.catbox.moe/uvucav.mp3"
                },
                {
                    title: "чи│чи│чЪДх╣╕чжП", sub: "ш┐ЩцШпцИСцГ│шжБчЪДх╣╕чжП", url: "https://files.catbox.moe/inb22a.mp3"
                },
                {
                    title: "цЬЙцИСхСв", sub: "цИСф╝Ъшойф╜аф╣ацГп хдЪф╕Аф╕кф║║щЩкф╝┤", url: "https://files.catbox.moe/hrazjt"
                },
                {
                    title: "ф╕АхНГщЫ╢ф╕АхдЬ", sub: "цвжщЗМшГ╜хИ░ш╛╛чЪДхЬ░цЦ╣хХК цЬЙф╕АхдйшДЪцнеф╣ЯшГ╜хИ░ш╛╛", url: "https://files.catbox.moe/syfuon.mp3"
                },
                {
                    title: "цЬИф║оф╕ОхЕнф╛┐хгл", sub: "цИСчЪДф╕ЦчХМчФ▒ф╜ах╗║члЛ хЫаф╜ах┤йхбМ", url: "https://files.catbox.moe/98quqc.mp3"
                },
                {
                    title: "цмбхЕГцБЛф║║", sub: "ч║жхе╜ф║ЖщЪФчЭАцмбхЕГф╣ЯхР╗ф╜Пц│кчЬ╝", url: "https://files.catbox.moe/5u5dy0.mp3"
                },
                {
                    title: "щШ│хЕЙф╕ЛчЪДцШЯцШЯ", sub: "хжВцЮЬчИ▒ф╕Кф╜ахПкцШпф╕Аф╕кцвжхвГ", url: "https://files.catbox.moe/dxgqsk.mp3"
                },
                {
                    title: "хСиш╛╣", sub: "чБ╡щнВщЗМчй║ч╝║чЪДщВгцо╡", url: "https://files.catbox.moe/a7k5wd.mp3"
                },
                {
                    title: "цБЛчИ▒ing", sub: "шойцИСщЗНцЦ░шодшпЖL O V E", url: "https://files.catbox.moe/94slcd.mp3"
                },
                {
                    title: "ф╕АчВ╣ф╕Ац╗┤", sub: "ф╜ашойчИ▒ф╕АчВ╣ф╕Ац╗┤ц▒ЗцИРц▓│", url: "https://files.catbox.moe/958qzg.mp3"
                },
                {
                    title: "хЕ│щФошпН", sub: "шойцИСшзБшпЖчИ▒цГЕхПпф╗ецЕ╖цЕихПИшЗкчзБ", url: "https://files.catbox.moe/9yl5ic.mp3"
                },
                {
                    title: "цГ│шзБф╜ацГ│шзБф╜ацГ│шзБф╜а", sub: "чй┐ш╢Кф║ЖхНГф╕кф╕Зф╕кцЧ╢щЧ┤ч║┐щЗМф║║ц╡╖щЗМчЫ╕ф╛Э", url: "https://files.catbox.moe/co58d7.mp3"
                },
                {
                    title: "star crossing night", sub: "ш┐ЩщЗМц▓бцЬЙф╜а", url: "https://files.catbox.moe/i3f86b.mp3"
                },
                {
                    title: "sea temple", sub: "If we have each other", url: "https://files.catbox.moe/c57gxs.mp3"
                },
                {
                    title: "цИСцГ│шжБхНацНоф╜а", sub: "хНацНоф╜ачЪДт╝АхИЗф╕ФцЧахПпхОЪщЭЮ", url: "https://files.catbox.moe/1fp6eg.mp3"
                },
                {
                    title: "чЙ╣хИлчЪДф║║", sub: "цИСф╗мцШпхп╣цЦ╣чЙ╣хИлчЪДф║║", url: "https://files.catbox.moe/a0n0l7.mp3"
                },
                {
                    title: "щ║жцБйшОЙ", sub: "хЬих╣┐щШФхпВхпЮц╝йц╢бшзгшД▒", url: "https://files.catbox.moe/2inae2.mp3"
                },
                {
                    title: "ф╝ЪхС╝хР╕чЪДчЧЫ", sub: "цГ│х┐╡цШпф╝ЪхС╝хР╕чЪДчЧЫ", url: "https://files.catbox.moe/0uhmxr.mp3"
                },
                {
                    title: "ф╕АчФЯчЪДчИ▒", sub: "цИСхПкцГ│шжБч╗Щф╜ацИСф╕АчФЯчЪДчИ▒", url: "https://files.catbox.moe/f0e93c.mp3"
                },
                {
                    title: "ш║лщкСчЩ╜щйм", sub: "ш┐╜ш╡╢шжБцИСчИ▒чЪДф╕Нф┐ЭчХЩ", url: "https://files.catbox.moe/iywfe2.mp3"
                },
                {
                    title: "чИ▒цГЕшопцБп", sub: "цГ│х┐╡хПШцИРчй║ц░ФхЬихП╣цБп", url: "https://files.catbox.moe/4dl0t2.mp3"
                },
                {
                    title: "ф╜ахЬи ф╕НхЬи", sub: "ф╜ахЬицИСх┐ГщЗМщЭв щЩкцИСхд▒чЬа", url: "https://files.catbox.moe/povyqa.mp3"
                },
                {
                    title: "ф╜ацШпцИСчЪДщгОцЩп", sub: "чИ▒шойцВмх┤ЦхПШх╣│хЬ░", url: "https://files.catbox.moe/fnwtf8.mp3"
                },
                {
                    title: "life with u", sub: "Now I know that you're the one", url: "https://files.catbox.moe/zqfxvd.mp3"
                },
                {
                    title: "хЛ╛цМЗш╡╖шкУ", sub: "ф╜ацШпчРЖцЙАх╜УчД╢чЪДхеЗш┐╣", url: "https://files.catbox.moe/4spgo5.mp3"
                },
                {
                    title: "чЙ╡ф╕АхНК", sub: "ф╜ачЪДхнШхЬицШпцИСхФпф╕Аф╛Эш╡Ц", url: "https://files.catbox.moe/bk21gu.mp3"
                },
                {
                    title: "rove", sub: "Oh we are in the War of Love on Rove", url: "https://files.catbox.moe/sfwsuk.mp3"
                },
                {
                    title: "хФпф╕А", sub: "цИСчЬЯчЪДчИ▒ф╜а хПехПеф╕Нш╜╗цШУ", url: "https://files.catbox.moe/69g4fe.mp3"
                },
            { title: "шЗ┤чИ▒ Your Song", sub: "цИСхПкцГ│цпПф╕кшР╜цЧе ш║лш╛╣щГ╜цЬЙф╜а", url: "https://files.catbox.moe/01bmnf.mp3" },
            { title: "ф╕АщжЦцГ│ф╕НщАЪчЪДхПдщгО", sub: "чФ╗хЬ░ф╕║чЙв чФ╗хС╜ф╕║чмж щУ╕цИРф╕Лф╕Аф╕ЦхЭЪхоИ", url: "https://files.catbox.moe/9b4lh7.mp3" },
            { title: "шМЙшОЙщЫи", sub: "чР┤хг░щЗМцДБхЗашо╕хЕ│ф║Оф╜а", url: "https://files.catbox.moe/7ml83u.mp3" },
            { title: "цАОф╣ИхФ▒цГЕцнМ", sub: "ц╡╖ хПШчЪДшЛжц╢й чБ╝ф╝дф╕АчЙЗц╕йцЯФ", url: "https://files.catbox.moe/isqax9.mp3" },
            { title: "х▓╕ш╛╣хов", sub: "ф╜ахЫЮцЭецИСх┐ГцЬкцФ╣ ф╜аф╕НхЬицИСш┐ШчнЙх╛Е", url: "https://files.catbox.moe/9oud6s.mp3" },
            { title: "ц▒ЯхНЧщЫк", sub: "чЫ╕цАЭхЖНцЧашНпшзг ф╗Оцндф╕ЗшИмщгОцЬИщГ╜цШпцИСх┐Гч╗У", url: "https://files.catbox.moe/hhjwek.mp3" },
            { title: "ф╕Нцн╗ф╣Лш║л", sub: "цИСф╗НчИ▒ф╜ачИ▒х╛Чф╕НчЯехдйщлШхЬ░хОЪ", url: "https://files.catbox.moe/g960ev.mp3" },
            { title: "цИСф╗мчЪДцШОхдй", sub: "чИ▒ф╗Оф╕НцЫ╛ф┐ЭчХЩ цЙНхЛЗцХвф║ЖцИС", url: "https://files.catbox.moe/a3yjvv.mp3" },
            { title: "щЪ╛шзг", sub: "чВ╣чВ╖щлШщжЩцХмф║ИчеЮцШО швлф║║хШ▓чмСчЯвх┐Чф╕Нц╕Э", url: "https://files.catbox.moe/1u8m3r.mp3" },
            { title: "цЬАхе╜чЪДцИС & 50 Feet", sub: "шпХчЭАф╝╕цЙЛ хН┤ш┐Юф╜ачЪДх╜▒хнРцИСщГ╜цЧац│ХщЭаш┐С", url: "https://files.catbox.moe/clsiyi.mp3" },
            { title: "хРМцЙЛхРМшДЪ", sub: "ф╣ЯцШпхнШхЬихЬиш┐Щф╕кф╕ЦчХМ хФпф╕АчЪДхФпф╕А", url: "https://files.catbox.moe/b8hss3.mp3" },
            { title: "хРМшК▒щб║", sub: "хПкшжБшВпчИ▒х╛Чц╖▒ цШпф╕НцШпх░▒цЬЙш┐ЩхПпшГ╜", url: "https://files.catbox.moe/28mw5d.mp3" },
            { title: "ш╜╗шИЮ", sub: "ш╜╗шИЮхРз ш┐Зх╛АхжВшгЩч║▒", url: "https://files.catbox.moe/8n9lhi.mp3" },
            { title: "ч╗Эхп╣хНацЬЙ чЫ╕хп╣шЗкчФ▒", sub: "ш╡Юч╛Оф╜ахМЕхо╣ф╜ащГ╜цШпцИСчЪДф╜┐хС╜", url: "https://files.catbox.moe/zi4gxo.mp3" },
            { title: "хНГф╕ЗцмбцГ│ш▒б", sub: "цИСхНГф╕ЗцмбцГ│ш▒б хНГф╕Зцмбцибф╗┐ цАЭх┐╡чЪДх╜вчК╢", url: "https://files.catbox.moe/4jtex8.mp3" },
            { title: "ш╛Юхо╢хНГщЗМ", sub: "чй┐ш┐ЗцЧаф║║щЧоц┤ехО╗шзБх▒▒ц╡╖ф╕Зщб╖", url: "https://files.catbox.moe/2quy44.mp3" },
            { title: "Ryukyuvania", sub: "----", url: "https://files.catbox.moe/utmbqp.mp3" },
            { title: "ц▓жщЩ╖", sub: "хЬИхоГхЬищ╗СцЪЧф╕нщАГф╕НхЗ║чЪДцвжщнЗ", url: "https://files.catbox.moe/0bhl3i.mp3" },
            { title: "цЩЪцЮлцнМ", sub: "ф╜ахПИцАОчЯецИСф╗ОцЬкцФ╛цЙЛ", url: "https://files.catbox.moe/xhwrwy.mp3" },
            { title: "I Need U", sub: "I need you girl", url: "https://files.catbox.moe/v1k4h8.mp3" },
            { title: "шЛецвж", sub: "цЧехНЗцЬИшР╜ цндчФЯф╛ЭцЧзщЪ╛шИН", url: "https://files.catbox.moe/6uysqy.mp3" },
            { title: "чИ▒ф║║", sub: "хПпцШпцБичЪДф║║ц▓бцн╗цИР чИ▒чЪДф║║ц▓бхПпшГ╜", url: "https://files.catbox.moe/wtbdxe.mp3" },
            { title: "цШЯц▓│хП╣", sub: "цИСчЫ╝хндш║лч║╡щйм чмЫхг░ц╝лхдй хЫЫц╡╖ф╗╗цИСц╕╕", url: "https://files.catbox.moe/de7g2m.mp3" },
            { title: "чИ▒цоЗ", sub: "хБЗцмвчХЕ хПИф╜Ххжи цЧаф║║хЕ▒ф║л", url: "https://files.catbox.moe/or2hm7.mp3" },
            { title: "Una mattina", sub: "----", url: "https://files.catbox.moe/nf8o90.mp3" },
            { title: "щб║хЕ╢шЗкчД╢", sub: "You light up my heart", url: "https://files.catbox.moe/na01cn.mp3" },
            { title: "хИЭшзБ", sub: "шЛехжВхИЭшзБ ф╕║ш░БшАМх╜Т", url: "https://files.catbox.moe/bumolx.mp3" },
            { title: "цИСхе╜хГПхЬихУкшзБш┐Зф╜а", sub: "ф║║ф╗мцККщЪ╛шиАчЪДчИ▒щГ╜хЯЛхЕехЬЯхгдщЗМ", url: "https://files.catbox.moe/vcidpc.mp3" },
            { title: "хИлхЫЮхд┤", sub: "чИ▒цШпх╣┤х░СцЧ╢ф╕НхакхЕ╢щЗН ц╕ЧщАПчБ╡щнВчЪДф╕АщШ╡хЙзчЧЫ", url: "https://files.catbox.moe/h1hwo5.mp3" },
            { title: "хдзщ▒╝", sub: "цАХф╜ащгЮш┐ЬхО╗ цАХф╜ачж╗цИСшАМхО╗", url: "https://files.catbox.moe/jlcvkg.mp3" },
            { title: "ф║║щ▒╝чЪДчЬ╝ц│к", sub: "Baby Don't cry", url: "https://files.catbox.moe/40fm4j.mp3" },
            { title: "ф╣Эх╝ацЬ║", sub: "цИСцД┐хМЦф╜ЬцЬЫцЦнхдйц╢пщВгф╕АцЦ╣щЭТчЯ│", url: "https://files.catbox.moe/hql6w5.mp3" },
            { title: "цвжх╣╗шпЫф╗Щ", sub: "цЭеф╕ЦшЛехЖНф╝Ъш┐Шф╕Оф╜ахПМхПМхп╣хп╣", url: "https://files.catbox.moe/r6btwp.mp3" },
            { title: "хп╗х╕╕цнМ", sub: "цЙАх╣╕ф╕Нш┐ЗцШп хп╗х╕╕ф║║щЧ┤ф║Л", url: "https://files.catbox.moe/ntcqvr.mp3" },

    ];

    const uploadCoverBtn = document.getElementById('upload-cover-btn');
    const coverInput = document.getElementById('cover-input');
    const vinylRecord = document.getElementById('vinyl-record-visual');

    const applyPlayerCover = (base64Data) => {
        if (base64Data) {
            vinylRecord.style.backgroundImage = `url(${base64Data})`;
            vinylRecord.classList.add('has-cover');
            vinylRecord.style.borderWidth = '1px';
        } else {
            vinylRecord.style.backgroundImage = '';
            vinylRecord.classList.remove('has-cover');
            vinylRecord.style.borderWidth = '2px';
        }
    };

    const savedCover = safeGetItem(APP_PREFIX + 'playerCover');
    if (savedCover) applyPlayerCover(savedCover);

    uploadCoverBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (vinylRecord.classList.contains('has-cover')) {
            if (confirm('цГ│шжБщЗНч╜охЫЮщ╗ШшодчЪДуАРф╕╗щвШшЙ▓щ╗СшГ╢уАСца╖х╝ПхРЧя╝Я\n\nтАв чВ╣хЗ╗уАРчбохоЪуАСцБвхдНщ╗Шшод\nтАв чВ╣хЗ╗уАРхПЦц╢ИуАСщАЙцЛйцЦ░хЫ╛чЙЗ')) {
                safeRemoveItem(APP_PREFIX + 'playerCover');
                applyPlayerCover(null);
                showNotification('х╖▓цБвхдНщ╗Шшодщ╗СшГ╢ца╖х╝П', 'success');
                return;
            }
        }
        coverInput.click();
    });

    coverInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            showNotification('хЫ╛чЙЗхдкхдзф║Жя╝Мшп╖ф╕Кф╝а 2MB ф╗ехЖЕчЪДхЫ╛чЙЗ', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64Data = event.target.result;
            try {
                safeSetItem(APP_PREFIX + 'playerCover', base64Data);
                applyPlayerCover(base64Data);
                showNotification('ф╕Уш╛Сх░БщЭвшо╛ч╜оцИРхКЯя╝Б', 'success');
            } catch (err) {
                console.error(err);
                showNotification('хЫ╛чЙЗхнШхВихд▒ш┤ея╝ИхПпшГ╜ш╢ЕхЗ║ф║Жц╡ПшзИхЩищЩРхИ╢я╝Й', 'error');
            }
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    const savedSongsStr = safeGetItem(APP_PREFIX + 'customSongs');
    let songs = [];

    if (savedSongsStr) {
        songs = JSON.parse(savedSongsStr);
    } else {
        songs = [...latestSystemSongs];
    }

    const player = document.getElementById('player');
    const miniView = document.getElementById('mini-view');
    const playlist = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const progressArea = document.getElementById('progress-area');

    const addSongModal = document.getElementById('add-song-modal');
    const newSongTitle = document.getElementById('new-song-title');
    const newSongSub = document.getElementById('new-song-sub');
    const newSongUrl = document.getElementById('new-song-url');
    const confirmAddSongBtn = document.getElementById('confirm-add-song');
    const cancelAddSongBtn = document.getElementById('cancel-add-song');
    const modalTitleElem = addSongModal.querySelector('.modal-title span');

    let currentIndex = 0;
    let isPlaying = false;
    let isRandom = false;
    let editModeIndex = -1;
    let searchTerm = '';
    let isSearchVisible = false;

    function loadSong(index) {
        if (songs.length === 0) return;
        if (index >= songs.length) index = 0;
        if (index < 0) index = songs.length - 1;

        const song = songs[index];
        document.getElementById('music-title').innerText = song.title;
        document.getElementById('music-subtitle').innerText = song.sub;
        
        if (song.url) audio.src = song.url;
        updatePlaylistHighlight();
    }

    function togglePlay() {
        if (songs.length === 0) {
            showNotification('цТнцФ╛хИЧшбиф╕║чй║', 'warning');
            return;
        }
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
            document.getElementById('icon-play').style.display = 'block';
            document.getElementById('icon-pause').style.display = 'none';
            player.classList.remove('playing');
        } else {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    isPlaying = true;
                    document.getElementById('icon-play').style.display = 'none';
                    document.getElementById('icon-pause').style.display = 'block';
                    player.classList.add('playing');
                }).catch(error => {
                    console.error(error);
                    showNotification('цТнцФ╛хд▒ш┤ея╝МщУ╛цОехПпшГ╜хд▒цХИ', 'error');
                });
            }
        }
    }

    function nextSong() {
        if (songs.length === 0) return;
        if (isRandom) currentIndex = Math.floor(Math.random() * songs.length);
        else currentIndex = (currentIndex + 1) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function prevSong() {
        if (songs.length === 0) return;
        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function savePlaylist() {
        safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
        renderPlaylist();
    }

    function syncSystemSongs() {
        if (confirm('цЫ┤цЦ░цнМхНХх░Жф╝Ъя╝Ъ\n1. х░Жч│╗ч╗ЯщвДшо╛цнМцЫ▓щЗНч╜оф╕║цЬАцЦ░чЙИцЬм\n2. ф┐ЭчХЩцВицЙЛхКиц╖╗хКа/ф┐оцФ╣чЪДшЗкхоЪф╣ЙцнМцЫ▓\n\nчбохоЪшжБцЫ┤цЦ░хРЧя╝Я')) {
            const userCustomSongs = songs.filter(s => s.isCustom === true);
            songs = [...latestSystemSongs, ...userCustomSongs];
            savePlaylist();
            currentIndex = 0;
            loadSong(0);
            if (isPlaying) {
                audio.pause();
                togglePlay();
            }
            showNotification('цнМхНХх╖▓цЫ┤цЦ░хИ░цЬАцЦ░чЙИцЬм', 'success');
        }
    }

    function openEditModal(index) {
        const song = songs[index];
        if (!song) return;
        editModeIndex = index;
        newSongTitle.value = song.title;
        newSongSub.value = song.sub;
        newSongUrl.value = song.url;
        modalTitleElem.innerText = "ч╝Цш╛СцнМцЫ▓ф┐бцБп";
        confirmAddSongBtn.innerText = "ф┐ЭхнШф┐оцФ╣";
        showModal(addSongModal);
    }

    function openAddModal() {
        editModeIndex = -1;
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        modalTitleElem.innerText = "ц╖╗хКашЗкхоЪф╣ЙцнМцЫ▓";
        confirmAddSongBtn.innerText = "ц╖╗хКацТнцФ╛";
        showModal(addSongModal);
    }

    function renderPlaylist() {
        playlist.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'playlist-header';
        header.innerHTML = `
            <div class="pl-header-title">╦Щ┬░╩ЪсХ▒тСЕсХ▒╔Ю┬░╦Щ</div>
            <div class="pl-header-actions">
                <button class="pl-icon-btn ${isSearchVisible ? 'active' : ''}" id="pl-search-toggle" title="цРЬч┤в"><i class="fas fa-search"></i></button>
                <button class="pl-icon-btn" id="pl-sync-btn" title="цЫ┤цЦ░щвДшо╛цнМхНХ"><i class="fas fa-sync-alt"></i></button>
                <button class="pl-icon-btn" id="pl-add-btn" title="ц╖╗хКацнМцЫ▓"><i class="fas fa-plus"></i></button>
            </div>
        `;
        playlist.appendChild(header);

        const searchWrapper = document.createElement('div');
        searchWrapper.className = `playlist-search-wrapper ${isSearchVisible ? 'active' : ''}`;
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'playlist-search-input';
        searchInput.placeholder = '';
        searchInput.value = searchTerm;
        
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderListContent(contentDiv);
        });
        
        searchWrapper.appendChild(searchInput);
        playlist.appendChild(searchWrapper);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'playlist-content';
        playlist.appendChild(contentDiv);

        renderListContent(contentDiv);

        header.querySelector('#pl-add-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openAddModal();
            newSongTitle.focus();
        });
        
        header.querySelector('#pl-sync-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            syncSystemSongs();
        });

        header.querySelector('#pl-search-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            isSearchVisible = !isSearchVisible;
            searchWrapper.classList.toggle('active', isSearchVisible);
            e.currentTarget.classList.toggle('active', isSearchVisible);
            if (isSearchVisible) {
                setTimeout(() => searchInput.focus(), 100);
            }
        });
    }

    function renderListContent(container) {
        container.innerHTML = '';
        
        const filteredSongs = songs.map((s, i) => ({...s, originalIndex: i}))
                                   .filter(s => s.title.toLowerCase().includes(searchTerm) || 
                                                s.sub.toLowerCase().includes(searchTerm));

        if (filteredSongs.length === 0) {
            container.innerHTML = `<div class="empty-search-result">цЬкцЙ╛хИ░ "${searchTerm}" чЫ╕хЕ│цнМцЫ▓</div>`;
            return;
        }

        filteredSongs.forEach((song) => {
            const realIndex = song.originalIndex;

            const div = document.createElement('div');
            div.className = 'playlist-item';
            if (realIndex === currentIndex) div.classList.add('playing');

            const highlightText = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            };

            const displayTitle = highlightText(song.title, searchTerm);
            const displaySub = highlightText(song.sub, searchTerm);

            div.innerHTML = `
                <div class="song-info">
                    <div class="song-title-row">${displayTitle}</div>
                    <div class="song-sub-row">${displaySub}</div>
                </div>
                <div class="item-actions">
                    ${song.isCustom ? '<span class="custom-tag" title="шЗкхоЪф╣ЙцнМцЫ▓"></span>' : ''}
                    <span class="action-icon-btn delete" title="чз╗щЩд">&times;</span>
                </div>
            `;

            if (song.isCustom) {
                div.querySelector('.custom-tag').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(realIndex);
                });
            }

            div.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`чбохоЪчз╗щЩдуАК${song.title}уАЛхРЧя╝Я`)) {
                    songs.splice(realIndex, 1);
                    savePlaylist();
                    
                    if (realIndex === currentIndex) {
                        if (songs.length > 0) {
                            currentIndex = realIndex % songs.length;
                            loadSong(currentIndex);
                            if (isPlaying) audio.play();
                        } else {
                            audio.pause();
                            isPlaying = false;
                            loadSong(0);
                        }
                    } else if (realIndex < currentIndex) {
                        currentIndex--;
                    }
                }
            });

            div.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = realIndex;
                loadSong(currentIndex);
                if (!isPlaying) togglePlay();
                else audio.play();
            });

            container.appendChild(div);
        });
    }

    function updatePlaylistHighlight() {
        const contentDiv = playlist.querySelector('.playlist-content');
        if (contentDiv) renderListContent(contentDiv);
    }

    confirmAddSongBtn.addEventListener('click', () => {
        const title = newSongTitle.value.trim();
        const sub = newSongSub.value.trim();
        const url = newSongUrl.value.trim();

        if (!title || !url) {
            showNotification('цнМхРНхТМщУ╛цОеф╕НшГ╜ф╕║чй║', 'error');
            return;
        }

        const songData = {
            title,
            sub: sub || 'цЬкчЯешЙ║цЬпхо╢',
            url,
            isCustom: true
        };

        if (editModeIndex >= 0) {
            songs[editModeIndex] = songData;
            showNotification('цнМцЫ▓ф┐бцБпх╖▓ф┐оцФ╣', 'success');
        } else {
            songs.unshift(songData);
            showNotification('цнМцЫ▓х╖▓ц╖╗хКа', 'success');
            if (songs.length === 1) loadSong(0);
        }

        searchTerm = '';
        savePlaylist();
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        hideModal(addSongModal);
    });

    cancelAddSongBtn.addEventListener('click', () => {
        hideModal(addSongModal);
    });

    function setupDrag() {
        let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
        const dragStart = (e) => {
            if (e.target.closest('.btn') || e.target.closest('.progress-wrapper') || e.target.closest('.playlist-popup')) return;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            isDragging = true; hasMoved = false;
            startX = event.clientX; startY = event.clientY;
            const rect = player.getBoundingClientRect();
            initialLeft = rect.left; initialTop = rect.top;
            player.style.transition = 'none';
            playlist.style.transition = 'none';
        };
        const dragMove = (e) => {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;
            const maxLeft = window.innerWidth - player.offsetWidth;
            const maxTop = window.innerHeight - player.offsetHeight;
            player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
            player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
            const rect = player.getBoundingClientRect();
            playlist.style.left = rect.left + 'px';
            playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        };
        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            player.style.transition = '';
            playlist.style.transition = '';
        };
        player.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        player.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', dragMove, { passive: false });
        document.addEventListener('touchend', dragEnd);

        miniView.addEventListener('click', () => {
            if (!hasMoved && player.classList.contains('collapsed')) {
                player.classList.remove('collapsed');
                setTimeout(() => {
                    const rect = player.getBoundingClientRect();
                    playlist.style.top = (rect.top + 170) + 'px';
                }, 300);
            }
        });
    }

    playBtn.addEventListener('click', togglePlay);
    document.getElementById('next-btn').addEventListener('click', nextSong);
    document.getElementById('prev-btn').addEventListener('click', prevSong);
    document.getElementById('minimize-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        player.classList.add('collapsed');
        playlist.classList.remove('active');
    });

    progressArea.addEventListener('click', (e) => {
        const width = progressArea.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) audio.currentTime = (clickX / width) * duration;
    });

    audio.addEventListener('timeupdate', (e) => {
        const { duration, currentTime } = e.target;
        if (duration) document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
    });
    audio.addEventListener('ended', nextSong);

    document.getElementById('mode-btn').addEventListener('click', () => {
        isRandom = !isRandom;
        document.getElementById('icon-loop').style.display = isRandom ? 'none' : 'block';
        document.getElementById('icon-shuffle').style.display = isRandom ? 'block' : 'none';
        showNotification(isRandom ? 'щЪПцЬ║цТнцФ╛' : 'щб║х║ПцТнцФ╛', 'info', 1000);
    });

    const listBtn = document.getElementById('list-btn');
    listBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = player.getBoundingClientRect();
        playlist.style.left = rect.left + 'px';
        playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        playlist.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!playlist.contains(e.target) && !listBtn.contains(e.target) && !player.contains(e.target) && !e.target.closest('#add-song-modal')) {
            playlist.classList.remove('active');
        }
    });

    loadSong(0);
    renderPlaylist();
    setupDrag();

    if (settings.musicPlayerEnabled) {
        player.classList.add('visible');
    }
};

        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];



        function renderReplyLibrary() {
            const list = document.getElementById('custom-replies-list');
            const searchInput = document.getElementById('reply-search-input');
            const addButton = document.getElementById('add-custom-reply');
list.classList.add('reply-list-with-buttons');

            const filterText = searchInput ? searchInput.value.toLowerCase().trim(): '';

            list.innerHTML = '';
            let html = '';
            let sourceArray = [];

            if (currentReplyTab === 'custom') {

                if (addButton) addButton.style.display = 'flex';
                sourceArray = customReplies.map((text, index) => ({
                    text, index, type: 'custom'
                }));
            } else {

                if (addButton) addButton.style.display = 'none';
                sourceArray = CONSTANTS.REPLY_MESSAGES.map((text, index) => ({
                    text,
                    index,
                    type: 'default',
                    isDisabled: disabledDefaultReplies.includes(text)
                }));
            }


            if (filterText) {
                sourceArray = sourceArray.filter(item => item.text.toLowerCase().includes(filterText));
            }


            if (sourceArray.length === 0) {
                list.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; color: var(--text-secondary); opacity: 0.6;">
            <div style="width: 60px; height: 60px; background: var(--secondary-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: var(--shadow);">
            <i class="fas fa-search" style="font-size: 24px; color: var(--accent-color);"></i>
            </div>
            <p style="font-size:15px; font-weight: 500;">ц▓бцЬЙцЙ╛хИ░чЫ╕хЕ│хЫЮхдН</p>
            <p style="font-size:12px; margin-top: 5px;">шпХшпХхЕ╢ф╗ЦхЕ│щФошпНя╝Я</p>
            </div>`;
                return;
            }


            sourceArray.forEach(item => {
                if (item.type === 'custom') {

                    html += `
                <div class="custom-reply-item">
                <span class="custom-reply-text">${item.text}</span>
                <div class="custom-reply-actions">
                <button class="reply-action-mini edit-reply" data-index="${item.index}" title="ч╝Цш╛СхЖЕхо╣">
                <i class="fas fa-pen"></i>
                </button>
                <button class="reply-action-mini delete-reply" data-index="${item.index}" title="хИащЩдцндхЫЮхдН">
                <i class="fas fa-trash-alt"></i>
                </button>
                </div>
                </div>`;
                } else {

                    const disabledClass = item.isDisabled ? 'disabled': '';

                    const toggleIcon = item.isDisabled ? 'fa-eye': 'fa-eye-slash';
                    const toggleTitle = item.isDisabled ? 'чВ╣хЗ╗хРпчФи': 'чВ╣хЗ╗чжБчФи';

                    html += `
                <div class="custom-reply-item ${disabledClass}">
                <span class="custom-reply-text">${item.text}</span>
                <div class="custom-reply-actions">

                ${!item.isDisabled ? `
                <button class="reply-action-mini modify-default" data-text="${item.text}" title="ф╗ецндф╕║цибцЭ┐цЦ░х╗║">
                <i class="fas fa-copy"></i>
                </button>`: ''}


                <button class="reply-action-mini toggle-default" data-text="${item.text}" title="${toggleTitle}">
                <i class="fas ${toggleIcon}"></i>
                </button>
                </div>
                </div>`;
                }
            });

            list.innerHTML = html;
        }


        function initReplyLibraryListeners() {
            console.log("цнгхЬихИЭхзЛхМЦхЫЮхдНх║УчЫСхРмхЩи...");


            const entryBtn = document.getElementById('custom-replies-function');
            if (entryBtn) {
                entryBtn.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    currentReplyTab = 'custom';
                    updateTabUI();
                    renderReplyLibrary();
                    showModal(DOMElements.customRepliesModal.modal);
                });
            }


            document.querySelectorAll('.reply-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentReplyTab = e.target.dataset.tab;
                    updateTabUI();
                    renderReplyLibrary();

                    const searchInput = document.getElementById('reply-search-input');
                    if (searchInput) searchInput.value = '';
                });
            });


            const searchInput = document.getElementById('reply-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', renderReplyLibrary);
            }
            const addBtn = document.getElementById('add-custom-reply');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    const reply = prompt('шп╖ш╛УхЕецЦ░чЪДхЫЮхдНхЖЕхо╣:');
                    if (reply && reply.trim()) {
                        customReplies.push(reply.trim());
                        throttledSaveData();
                        renderReplyLibrary();
                        showNotification('ц╖╗хКацИРхКЯ', 'success');


                        const list = document.getElementById('custom-replies-list');
                        setTimeout(() => list.scrollTop = list.scrollHeight, 100);
                    }
                });
            }


            const listContainer = document.getElementById('custom-replies-list');
            if (listContainer) {
                listContainer.addEventListener('click', (e) => {

                    const target = e.target.closest('button');
                    if (!target) return;


                    if (target.classList.contains('edit-reply')) {
                        const index = target.dataset.index;
                        const newText = prompt('ф┐оцФ╣хЫЮхдНхЖЕхо╣:', customReplies[index]);
                        if (newText !== null && newText.trim() !== '') {
                            customReplies[index] = newText.trim();
                            throttledSaveData();
                            renderReplyLibrary();
                            showNotification('ф┐оцФ╣цИРхКЯ', 'success');
                        }
                    } else if (target.classList.contains('delete-reply')) {
                        if (confirm('чбохоЪхИащЩдш┐ЩцЭбхЫЮхдНхРЧя╝Я')) {
                            const index = target.dataset.index;
                            customReplies.splice(index, 1);
                            throttledSaveData();
                            renderReplyLibrary();
                            showNotification('х╖▓хИащЩд', 'success');
                        }
                    } else if (target.classList.contains('toggle-default')) {
                        const text = target.dataset.text;
                        const idx = disabledDefaultReplies.indexOf(text);

                        if (idx > -1) {

                            disabledDefaultReplies.splice(idx, 1);
                            showNotification('х╖▓хРпчФи', 'success');
                        } else {

                            disabledDefaultReplies.push(text);
                            showNotification('х╖▓чжБчФи', 'info');
                        }
                        throttledSaveData();
                        renderReplyLibrary();
                    } else if (target.classList.contains('modify-default')) {
                        const oldText = target.dataset.text;
                        const newText = prompt('ф┐оцФ╣х╣╢хПжхнШф╕║шЗкхоЪф╣Й (хОЯщвДшо╛х░ЖшвлщЪРшЧП):', oldText);

                        if (newText && newText.trim() !== '') {

                            if (!disabledDefaultReplies.includes(oldText)) {
                                disabledDefaultReplies.push(oldText);
                            }

                            customReplies.push(newText.trim());

                            throttledSaveData();


                            currentReplyTab = 'custom';
                            updateTabUI();
                            renderReplyLibrary();
                            showNotification('х╖▓хПжхнШф╕║шЗкхоЪф╣ЙхЫЮхдН', 'success');
                        }
                    }
                });
            }


            const exportBtn = document.getElementById('export-replies-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const data = {
                        version: "2.0",
                        date: new Date().toLocaleString(),
                        customReplies: customReplies,
                        disabledDefaultReplies: disabledDefaultReplies
                    };


                    const fileName = `хЫЮхдНх║УхдЗф╗╜_${new Date().toISOString().slice(0, 10)}.json`;
                    const jsonStr = JSON.stringify(data, null, 2);


                    exportDataToMobileOrPC(jsonStr, fileName);
                });
            }


            const importBtn = document.getElementById('import-replies-btn');
            const fileInput = document.getElementById('import-replies-input');

            if (importBtn && fileInput) {
                importBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);


                            if (!Array.isArray(data.customReplies)) {
                                throw new Error("цЦЗф╗╢ца╝х╝Пф╕Нцнгчбоя╝Ъч╝║х░С customReplies цХ░цНо");
                            }


                            const userChoice = confirm(
                                "цгАц╡ЛхИ░хЫЮхдНх║УцЦЗф╗╢уАВ\n\n" +
                                "уАРчбохоЪуАС= хРИх╣╢ (ф┐ЭчХЩчО░цЬЙцХ░цНоя╝Мц╖╗хКацЦ░цХ░цНо)\n" +
                                "уАРхПЦц╢ИуАС= шжЖчЫЦ (ц╕Ечй║чО░цЬЙшЗкхоЪф╣ЙхЫЮхдНя╝МхоМхЕицЫ┐цНв)"
                            );

                            if (!userChoice) {

                                customReplies = data.customReplies;
                                disabledDefaultReplies = data.disabledDefaultReplies || [];
                            } else {

                                const newSet = new Set([...customReplies, ...data.customReplies]);
                                customReplies = Array.from(newSet);

                                if (data.disabledDefaultReplies) {
                                    const disabledSet = new Set([...disabledDefaultReplies, ...data.disabledDefaultReplies]);
                                    disabledDefaultReplies = Array.from(disabledSet);
                                }
                            }

                            throttledSaveData();
                            renderReplyLibrary();
                            showNotification(`хп╝хЕецИРхКЯя╝Бх╜УхЙНхЕ▒ ${customReplies.length} цЭбшЗкхоЪф╣ЙхЫЮхдН`, 'success');

                        } catch (err) {
                            console.error(err);
                            showNotification('хп╝хЕехд▒ш┤ея╝ЪцЦЗф╗╢цНЯхЭПцИЦца╝х╝ПщФЩшпп', 'error');
                        }
                        fileInput.value = '';
                    };
                    reader.readAsText(file);
                });
            }
        }

        function updateTabUI() {
            document.querySelectorAll('.reply-tab-btn').forEach(btn => {
                if (btn.dataset.tab === currentReplyTab) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const searchInput = document.getElementById('reply-search-input');
            if (searchInput) searchInput.value = '';
        }


        function initRippleFeedback() {

            const rippleTargets = [
                '.input-btn',
                '.action-btn',
                '.modal-btn',
                '.settings-item',
                '.batch-action-btn',
                '.coin-btn-action',
                '.import-export-btn',
                '.reply-tab-btn',
                '.anniversary-type-btn',
                '.reply-tool-btn',
                '.session-action-btn',
                '.fav-action-btn'
            ];


            document.addEventListener('mousedown', function(e) {

                const target = e.target.closest(rippleTargets.join(','));

                if (target) {
                    createRipple(e, target);
                }
            });

            function createRipple(event, button) {

                if (!button.classList.contains('ripple-effect')) {
                    button.classList.add('ripple-effect');
                }


                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;


                const rect = button.getBoundingClientRect();


                const clientX = event.clientX || (event.touches ? event.touches[0].clientX: 0);
                const clientY = event.clientY || (event.touches ? event.touches[0].clientY: 0);

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${clientX - rect.left - radius}px`;
                circle.style.top = `${clientY - rect.top - radius}px`;
                circle.classList.add('ripple-wave');


                const ripple = button.getElementsByClassName('ripple-wave')[0];
                if (ripple) {
                    ripple.remove();
                }


                button.appendChild(circle);


                setTimeout(() => {
                    circle.remove();
                }, 600);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            try {

                initializeSession();
                loadData();
                initializeRandomUI();
                setupEventListeners();
                initMusicPlayer();
                setInterval(checkStatusChange, 60000);


                setTimeout(() => {
                    const anim = document.getElementById('welcome-animation');
                    if (anim) {
                        anim.classList.add('hidden');
                        setTimeout(() => {
                            anim.style.display = 'none';
                        }, 800);
                    }
                },
                    3500);


                const disclaimerModal = document.getElementById('disclaimer-modal');
                const acceptDisclaimerBtn = document.getElementById('accept-disclaimer');
                if (disclaimerModal && !safeGetItem(APP_PREFIX + 'tour_seen')) {
                    showModal(disclaimerModal);
                }
                if (acceptDisclaimerBtn) {
        acceptDisclaimerBtn.addEventListener('click', () => {
            hideModal(disclaimerModal);
            startTour(); 
        });
    }
            } catch (err) {
                console.error("хИЭхзЛхМЦхПСчФЯщФЩшпп:", err);

                if (typeof removeBackground === 'function') removeBackground();
            }
        });

const tourOverlay = document.getElementById('tour-overlay');
const tourPopover = document.getElementById('tour-popover');
const tourHighlightBox = document.getElementById('tour-highlight-box');
const tourTitle = document.getElementById('tour-title');
const tourContent = document.getElementById('tour-content');
const tourStepCounter = document.getElementById('tour-step-counter');
const tourNextBtn = document.getElementById('tour-next-btn');
const tourPrevBtn = document.getElementById('tour-prev-btn');
const tourSkipBtn = document.getElementById('tour-skip-btn');

let currentTourStep = 0;
let isTourActive = false;

const tourSteps = [
    {
        title: "цмвш┐Оф╜┐чФиуАМф╝ашопуАН",
        content: "ш┐ЩцШпф╕Аф╕кцЦ░цЙЛх╝Ххп╝цХЩчиЛя╝Мх╕жф╜ах┐лщАЯф║ЖшзгхКЯшГ╜я╝Мшп╖цЬАхе╜чЬЛф╕Аф╕ЛхУжЁЯе║",
        position: 'center'
    },
    {
        element: '#my-name',
        title: "ш┐ЩцШптАЬф╜атАЭ",
        content: "ф╕КцЦ╣цШпф╜ачЪДцШ╡чз░я╝МчВ╣хЗ╗хоГхПпф╗еш┐ЫшбМф┐оцФ╣",
        position: 'top'
    },
    {
        element: '#my-avatar',
        title: "ф╜ачЪДхд┤хГП",
        content: "чВ╣хЗ╗ш┐ЩщЗМхПпф╗еф╕Кф╝а/цЫ┤цФ╣ф╜ачЪДхд┤хГПуАВ",
        position: 'top'
    },
    {
        element: '#my-status-container',
        title: "ф╜ачЪДчК╢цАБ",
        content: "ф╜ачЪДчК╢цАБя╝МчВ╣хЗ╗хПпф╗еш┐ЫшбМч╝Цш╛Ся╝Мф╕АшИмшАМшиАцвжшзТцШпшГ╜хдЯчЬЛшзБчЪД",
        position: 'top'
    },
    {
        element: '#partner-name',
        title: "ш┐ЩцШптАЬцвжшзТтАЭ",
        content: "ш┐ЩщЗМцШпцвжшзТчЪДцШ╡чз░я╝МхРМца╖хПпф╗ечВ╣хЗ╗ф┐оцФ╣уАВ",
        position: 'top'
    },
    {
        element: '#message-input',
        title: "ц╢ИцБпш╛УхЕецбЖ",
        content: "хЬиш┐ЩщЗМш╛УхЕеф╜ацГ│шп┤чЪДшпЭя╝МцМЙхЫЮш╜жщФоцИЦч║╕щгЮцЬ║хПСщАБуАВ",
        position: 'top'
    },
    {
        element: '#send-btn',
        title: "хПСщАБцМЙщТо",
        content: "чВ╣хЗ╗ч║╕щгЮцЬ║я╝Мх░▒шГ╜х░Жф╜ачЪДх┐ГцДПф╝аш╛╛ч╗ЩцвжшзТуАВ",
        position: 'top'
    },
    {
        element: '#attachment-btn',
        title: "хПСщАБхЫ╛чЙЗ",
        content: "чВ╣хЗ╗ш┐ЩщЗМя╝МхПпф╗ехПСщАБхЫ╛чЙЗя╝Б",
        position: 'top'
    },
    {
        element: '#poke-btn',
        title: "тАЬцЛНф╕АцЛНтАЭхКЯшГ╜",
        content: "тАЬцЛНф╕АцЛНтАЭхКЯшГ╜я╝МхПпф╗ехПСщАБшЗкхоЪф╣ЙчЪДф║ТхКиц╢ИцБп",
        position: 'top'
    },
    {
        element: '#continue-btn',
        title: "ч╗зч╗ншп┤",
        content: "хжВцЮЬцГ│шойцвжшзТч╗зч╗ншп┤шпЭцИЦшАЕф╕НчЯещБУшп┤ф╗Аф╣Иф║Жя╝МчВ╣хЗ╗ш┐ЩщЗМя╝Мхп╣цЦ╣ф╝ЪшЗкхКихЫЮхдН",
        position: 'top'
    },
    {
        element: '#batch-btn',
        title: "цЙ╣щЗПхПСщАБцибх╝П",
        content: "х╝АхРпцЙ╣щЗПцибх╝Пя╝МхПпф╗еч╝Цш╛СхдЪцЭбц╢ИцБпхРОф╕Ах╣╢хПСщАБуАВ",
        position: 'top'
    },
    {
        element: '#settings-btn',
        title: "хЕих▒Ашо╛ч╜о",
        content: "цЙАцЬЙшо╛ч╜ощГ╜хЬиш┐ЩщЗМя╝МцИСф╗мчВ╣х╝АчЬЛчЬЛхРзя╝Б",
        position: 'bottom',
        onBefore: () => {
            if (isTourActive) document.querySelectorAll('.modal').forEach(m => hideModal(m));
        }
    },
    {
        element: '#settings-modal .modal-content',
        title: "шо╛ч╜оф╕нх┐Г",
        content: "ш┐ЩщЗМцЬЙхЫЫф╕кф╕╗шжБцибхЭЧя╝ЪхдЦшзВуАБшБКхдйуАБщлШч║зхКЯшГ╜хТМцХ░цНочобчРЖуАВ",
        position: 'bottom',
        onBefore: () => {
            if (isTourActive) showModal(DOMElements.settingsModal.modal);
        }
    },
    {
        element: '#appearance-settings',
        title: "хдЦшзВшо╛ч╜о",
        content: "шЗкхоЪф╣Йф╕╗щвШщвЬшЙ▓уАБхнЧф╜Ухдзх░ПуАБшБКхдйц░Фц│бхТМшГМцЩпхЫ╛уАВ",
        position: 'bottom'
    },
    {
        element: '#chat-settings',
        title: "шБКхдйшо╛ч╜о",
        content: "ц▓бхХечФихЕ╢хоЮя╝Мф╕Аф║ЫхКЯшГ╜чЪДх╝АхЕ│я╝МцпФхжВц╢ИцБпщЯ│цХИуАБх╖▓шп╗хЫЮцЙзчнЙуАВ",
        position: 'bottom'
    },
    {
        element: '#advanced-settings',
        title: "щлШч║зхКЯшГ╜",
        content: "шп╖ф╕АхоЪшжБчВ╣хЗ╗чЬЛчЬЛя╝БхПпф╗ехвЮхКашЗкхоЪф╣ЙхЫЮхдНя╝Бя╝Бш┐ШцЬЙщЯ│ф╣РцТнцФ╛хЩиуАБцпПцЧеш┐РхК┐чнЙуАВ",
        position: 'bottom'
    },
    {
        element: '#data-settings',
        title: "цХ░цНочобчРЖ",
        content: "хЬиш┐ЩщЗМхПпф╗ехп╝хЕе/хп╝хЗ║шБКхдйшо░х╜Хя╝МцИЦшАЕц╕Ечй║цХ░цНоуАВцИСф╗мщЗНцЦ░х╝АхзЛцХЩчиЛчЪДцМЙщТоф╣ЯхЬиш┐ЩщЗМхУжя╝Б",
        position: 'top'
    },
    {
        element: '#theme-toggle',
        title: "хИЗцНвф╕╗щвШ",
        content: "ш┐ЩцШпф╕кх┐лцН╖цМЙщТоя╝МхПпф╗ех┐лщАЯхЬичЩ╜хдйхТМщ╗СхдЬцибх╝Пф╣ЛщЧ┤хИЗцНвуАВ",
        position: 'bottom',
        onBefore: () => {
             if (isTourActive) hideModal(DOMElements.settingsModal.modal);
        }
    },
    {
        element: '#favorites-btn',
        title: "цФ╢шЧПхд╣",
        content: "цЙАцЬЙцФ╢шЧПчЪДц╢ИцБпщГ╜ф╝ЪхЬиш┐ЩщЗМх▒Хчд║уАВ",
        position: 'bottom'
    },
    {
        element: '#session-manager-btn',
        title: "ф╝ЪшпЭчобчРЖ",
        content: "ф╜ахПпф╗ехИЫх╗║хдЪф╕кчЛмчлЛчЪДшБКхдйф╝ЪшпЭя╝Мф║Тф╕Нх╣▓цЙ░уАВхЬиш┐ЩщЗМхПпф╗еш┐ЫшбМхИЗцНвуАБщЗНхС╜хРНцИЦхИащЩдуАВ",
        position: 'bottom'
    },
    {
        title: "ц╢ИцБпцУНф╜Ь",
        content: "х╜Уф╜ачВ╣хЗ╗ф╕АцЭбц╢ИцБпя╝Мф╝ЪхЗ║чО░хЗаф╕кцМЙщТоя╝МцпФхжВцФ╢шЧПуАБхЫЮхдНхТМц╖╗хКац│ищЗКуАВ",
        position: 'center'
    },
    {
        title: "цХЩчиЛч╗УцЭЯ",
        content: "ф╜ах╖▓ч╗ПцОМцПбф║ЖцЙАцЬЙхЯ║цЬмхКЯшГ╜я╝Бшп╖х╝АхзЛф╝ашопхРзя╝Бх╕МцЬЫф╜ашГ╜хЬиш┐ЩщЗМцФ╢шО╖хИ░чИ▒ф╕Ох╣╕чжПЁЯе║",
        position: 'center'
    }
];

function startTour() {
    isTourActive = true;
    tourOverlay.style.display = 'block';
    setTimeout(() => tourOverlay.classList.add('active'), 10);
    currentTourStep = 0;
    showTourStep(currentTourStep);
}

function endTour() {
    isTourActive = false;
    tourOverlay.classList.remove('active');
    tourPopover.classList.remove('visible');
    setTimeout(() => {
        tourOverlay.style.display = 'none';
        tourHighlightBox.style.width = '0px';
        tourHighlightBox.style.height = '0px';
        tourHighlightBox.style.opacity = '0';
    }, 300);
    safeSetItem(APP_PREFIX + 'tour_seen', 'true');
    document.querySelectorAll('.modal').forEach(m => hideModal(m));
}

function showTourStep(index) {
    if (index < 0 || index >= tourSteps.length) {
        endTour();
        return;
    }
    const step = tourSteps[index];
    if (step.onBefore) {
        step.onBefore();
    }
    setTimeout(() => {
        tourTitle.textContent = step.title;
        tourContent.innerHTML = step.content;
        tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
        tourPopover.classList.remove('visible');
        tourPrevBtn.style.visibility = (index === 0) ? 'hidden' : 'visible';
        if (index === tourSteps.length - 1) {
            tourNextBtn.innerHTML = 'хоМцИР <i class="fas fa-check"></i>';
        } else {
            tourNextBtn.innerHTML = 'ф╕Лф╕Ацне <i class="fas fa-arrow-right"></i>';
        }
        const targetElement = step.element ? document.querySelector(step.element) : null;
        if (targetElement) {
            const rect = targetElement.getBoundingClientRect();
            tourHighlightBox.style.width = `${rect.width + 10}px`;
            tourHighlightBox.style.height = `${rect.height + 10}px`;
            tourHighlightBox.style.top = `${rect.top - 5}px`;
            tourHighlightBox.style.left = `${rect.left - 5}px`;
            tourHighlightBox.style.opacity = '1';
            positionPopover(rect, step.position);
        } else {
            tourHighlightBox.style.opacity = '0';
            tourHighlightBox.style.width = '0px';
            tourHighlightBox.style.height = '0px';
            tourPopover.style.top = '50%';
            tourPopover.style.left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
        }
        setTimeout(() => tourPopover.classList.add('visible'), 50);
    }, (step.onBefore ? 400 : 0));
}

function positionPopover(rect, position) {
    const popoverRect = tourPopover.getBoundingClientRect();
    const spacing = 15;
    let top, left;
    switch (position) {
        case 'top':
            top = rect.top - popoverRect.height - spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'bottom':
            top = rect.bottom + spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'left':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.left - popoverRect.width - spacing;
            break;
        case 'right':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.right + spacing;
            break;
        default:
            top = '50%';
            left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
            tourPopover.style.top = top;
            tourPopover.style.left = left;
            return;
    }
    if (top < 10) top = 10;
    if (left < 10) left = 10;
    if (left + popoverRect.width > window.innerWidth - 10) {
        left = window.innerWidth - popoverRect.width - 10;
    }
    if (top + popoverRect.height > window.innerHeight - 10) {
        top = window.innerHeight - popoverRect.height - 10;
    }
    tourPopover.style.top = `${top}px`;
    tourPopover.style.left = `${left}px`;
    tourPopover.style.transform = 'none';
}

function nextTourStep() {
    currentTourStep++;
    showTourStep(currentTourStep);
}

function prevTourStep() {
    currentTourStep--;
    showTourStep(currentTourStep);
}

function setupTutorialListeners() {
    tourNextBtn.addEventListener('click', nextTourStep);
    tourPrevBtn.addEventListener('click', prevTourStep);
    tourSkipBtn.addEventListener('click', endTour);

    const replayBtn = document.getElementById('replay-tutorial-btn');
    if(replayBtn) {
        replayBtn.addEventListener('click', () => {
            hideModal(DOMElements.dataModal.modal);
            setTimeout(() => {
                if (confirm('чбохоЪшжБщЗНцЦ░х╝АхзЛцЦ░цЙЛх╝Ххп╝цХЩчиЛхРЧя╝Я')) {
                    startTour();
                }
            }, 300);
        });
    }
}
// ==================== чФицИ╖чЬЯхоЮф╜УщкМщкМшпБчЙИ ====================
// ш┐Щф╕кчЙИцЬмхМЕхРлф║ЖхоМцХ┤чЪДц╡ЛшпХхТМщкМшпБцЬ║хИ╢

// ЁЯОп 1. хнШхВищЕНч╜о
const STORAGE_CONFIG = {
    DB_NAME: 'CHAT_APP_USER_STORAGE',
    DB_VERSION: 1,
    MAX_STORAGE_MB: 500, // чЫоцаЗхнШхВихо╣щЗП
    FALLBACK_ENABLED: true // шЗкхКищЩНч║з
};

// ЁЯОп 2. чК╢цАБчЫСцОз
let storageState = {
    indexedDB_available: false,
    localStorage_available: true,
    currentSession: SESSION_ID,
    lastSaveTime: null,
    lastLoadTime: null,
    errors: []
};

// ЁЯОп 3. чФицИ╖хПЛхе╜чЪДщФЩшппхдДчРЖ
function showUserFriendlyError(error, context) {
    console.error(`[чФицИ╖хнШхВищФЩшпп] ${context}:`, error);
    
    // чФицИ╖хПпшзБчЪДцПРчд║
    const messages = {
        'quota_exceeded': 'хнШхВичй║щЧ┤ф╕Нш╢│я╝Мшп╖ц╕ЕчРЖц╡ПшзИхЩич╝УхнШ',
        'indexeddb_failed': 'щлШч║зхнШхВиф╕НхПпчФия╝Мх╖▓ф╜┐чФихЯ║цЬмхнШхВицибх╝П',
        'avatar_save_failed': 'хд┤хГПф┐ЭхнШхд▒ш┤ея╝Мшп╖щЗНшпХ',
        'sticker_save_failed': 'шбицГЕхМЕф┐ЭхнШхд▒ш┤ея╝МхЫ╛чЙЗхПпшГ╜хдкхдз'
    };
    
    if (messages[context]) {
        showNotification(messages[context], 'warning', 3000);
    }
    
    // шо░х╜ХщФЩшпп
    storageState.errors.push({
        time: new Date().toISOString(),
        context,
        error: error.message
    });
}

// ЁЯОп 4. ф╕УщЧичЪДхд┤хГПчобчРЖхЩия╝Ичбоф┐Э100%ф┐ЭхнШя╝Й
class AvatarManager {
    constructor() {
        this.cache = {
            partner: null,
            me: null
        };
    }
    
    // ф┐ЭхнШхд┤хГПя╝Иф╕ЙщЗНф┐ЭщЩйя╝Й
    async saveAvatar(type, avatarSrc) {
        if (!avatarSrc) return;
        
        console.log(`ф┐ЭхнШ${type}хд┤хГП:`, avatarSrc.substring(0, 50) + '...');
        
        // цЦ╣ц│Х1: localStorageя╝ИцЬАх┐ля╝МцЬАхПпщЭая╝Й
        try {
            const key = type === 'partner' ? 'partnerAvatar' : 'myAvatar';
            safeSetItem(getStorageKey(key), avatarSrc);
            console.log(`тЬЕ ${type}хд┤хГПх╖▓ф┐ЭхнШхИ░localStorage`);
        } catch (e) {
            showUserFriendlyError(e, 'avatar_local_save');
        }
        
        // цЦ╣ц│Х2: IndexedDBя╝Ихдзхо╣щЗПя╝Й
        try {
            await this.saveToIndexedDB(type, avatarSrc);
            console.log(`тЬЕ ${type}хд┤хГПх╖▓ф┐ЭхнШхИ░IndexedDB`);
        } catch (e) {
            showUserFriendlyError(e, 'avatar_indexeddb_save');
        }
        
        // цЦ╣ц│Х3: хЖЕхнШч╝УхнШя╝ИчлЛхН│ф╜┐чФия╝Й
        this.cache[type] = avatarSrc;
        
        // цЫ┤цЦ░UI
        const element = type === 'partner' ? DOMElements.partner.avatar : DOMElements.me.avatar;
        updateAvatar(element, avatarSrc);
    }
    
    async saveToIndexedDB(type, avatarSrc) {
        return new Promise((resolve, reject) => {
            if (!window.indexedDB) {
                reject(new Error('ц╡ПшзИхЩиф╕НцФпцМБIndexedDB'));
                return;
            }
            
            const request = indexedDB.open('AvatarStorage', 1);
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('avatars')) {
                    db.createObjectStore('avatars', { keyPath: 'id' });
                }
            };
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['avatars'], 'readwrite');
                const store = transaction.objectStore('avatars');
                
                const avatarData = {
                    id: `${SESSION_ID}_${type}_avatar`,
                    sessionId: SESSION_ID,
                    type: type,
                    data: avatarSrc,
                    timestamp: Date.now(),
                    size: avatarSrc.length
                };
                
                const putRequest = store.put(avatarData);
                
                putRequest.onsuccess = () => {
                    db.close();
                    resolve();
                };
                
                putRequest.onerror = () => {
                    db.close();
                    reject(putRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
    
    // хКаш╜╜хд┤хГПя╝Иф╕ЙщЗНф┐ЭщЩйя╝Й
    async loadAvatar(type) {
        console.log(`хКаш╜╜${type}хд┤хГП...`);
        
        let avatarSrc = null;
        
        // цгАцЯе1: хЖЕхнШч╝УхнШ
        if (this.cache[type]) {
            console.log(`ф╗Оч╝УхнШхКаш╜╜${type}хд┤хГП`);
            return this.cache[type];
        }
        
        // цгАцЯе2: localStorageя╝ИцЬАхПпщЭая╝Й
        try {
            const key = type === 'partner' ? 'partnerAvatar' : 'myAvatar';
            avatarSrc = safeGetItem(getStorageKey(key));
            if (avatarSrc) {
                console.log(`тЬЕ ф╗ОlocalStorageхКаш╜╜${type}хд┤хГПцИРхКЯ`);
                this.cache[type] = avatarSrc;
                return avatarSrc;
            }
        } catch (e) {
            console.warn(`localStorageхКаш╜╜${type}хд┤хГПхд▒ш┤е:`, e);
        }
        
        // цгАцЯе3: IndexedDB
        try {
            avatarSrc = await this.loadFromIndexedDB(type);
            if (avatarSrc) {
                console.log(`тЬЕ ф╗ОIndexedDBхКаш╜╜${type}хд┤хГПцИРхКЯ`);
                // ф┐ЭхнШхЫЮlocalStorageхдЗф╗╜
                const key = type === 'partner' ? 'partnerAvatar' : 'myAvatar';
                safeSetItem(getStorageKey(key), avatarSrc);
                this.cache[type] = avatarSrc;
                return avatarSrc;
            }
        } catch (e) {
            console.warn(`IndexedDBхКаш╜╜${type}хд┤хГПхд▒ш┤е:`, e);
        }
        
        console.warn(`тЪая╕П ${type}хд┤хГПхКаш╜╜хд▒ш┤ея╝Мф╜┐чФищ╗Шшодхд┤хГП`);
        return null;
    }
    
    async loadFromIndexedDB(type) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('AvatarStorage', 1);
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['avatars'], 'readonly');
                const store = transaction.objectStore('avatars');
                const getRequest = store.get(`${SESSION_ID}_${type}_avatar`);
                
                getRequest.onsuccess = () => {
                    db.close();
                    const result = getRequest.result;
                    resolve(result ? result.data : null);
                };
                
                getRequest.onerror = () => {
                    db.close();
                    reject(getRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
}

// ЁЯОп 5. ф╕УщЧичЪДшбицГЕхМЕчобчРЖхЩи
class StickerManager {
    constructor() {
        this.stickers = [];
        this.cacheKey = getStorageKey('stickers');
    }
    
    // ц╖╗хКашбицГЕхМЕя╝ИхПМщЗНф┐ЭхнШя╝Й
    async addSticker(stickerData) {
        console.log('ц╖╗хКашбицГЕхМЕ:', stickerData.substring(0, 30) + '...');
        
        this.stickers.push(stickerData);
        
        // члЛхН│ф┐ЭхнШхИ░localStorage
        try {
            safeSetItem(this.cacheKey, JSON.stringify(this.stickers));
            console.log('тЬЕ шбицГЕхМЕх╖▓ф┐ЭхнШхИ░localStorage');
        } catch (e) {
            showUserFriendlyError(e, 'sticker_local_save');
        }
        
        // х╝Вцнеф┐ЭхнШхИ░IndexedDB
        try {
            await this.saveToIndexedDB(stickerData);
            console.log('тЬЕ шбицГЕхМЕх╖▓ф┐ЭхнШхИ░IndexedDB');
        } catch (e) {
            showUserFriendlyError(e, 'sticker_indexeddb_save');
        }
        
        return true;
    }
    
    async saveToIndexedDB(stickerData) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('StickerStorage', 1);
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('stickers')) {
                    const store = db.createObjectStore('stickers', { 
                        keyPath: 'id',
                        autoIncrement: true 
                    });
                    store.createIndex('sessionId', 'sessionId', { unique: false });
                }
            };
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['stickers'], 'readwrite');
                const store = transaction.objectStore('stickers');
                
                const stickerRecord = {
                    sessionId: SESSION_ID,
                    data: stickerData,
                    timestamp: Date.now(),
                    size: stickerData.length
                };
                
                const addRequest = store.add(stickerRecord);
                
                addRequest.onsuccess = () => {
                    db.close();
                    resolve();
                };
                
                addRequest.onerror = () => {
                    db.close();
                    reject(addRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
    
    // хКаш╜╜цЙАцЬЙшбицГЕхМЕ
    async loadStickers() {
        console.log('хКаш╜╜шбицГЕхМЕ...');
        
        let loadedStickers = [];
        
        // ф╝ШхЕИф╗ОlocalStorageхКаш╜╜
        try {
            const saved = safeGetItem(this.cacheKey);
            if (saved) {
                loadedStickers = JSON.parse(saved);
                console.log(`тЬЕ ф╗ОlocalStorageхКаш╜╜${loadedStickers.length}ф╕кшбицГЕхМЕ`);
                this.stickers = loadedStickers;
                return loadedStickers;
            }
        } catch (e) {
            console.warn('localStorageхКаш╜╜шбицГЕхМЕхд▒ш┤е:', e);
        }
        
        // ф╗ОIndexedDBхКаш╜╜
        try {
            loadedStickers = await this.loadFromIndexedDB();
            if (loadedStickers.length > 0) {
                console.log(`тЬЕ ф╗ОIndexedDBхКаш╜╜${loadedStickers.length}ф╕кшбицГЕхМЕ`);
                // ф┐ЭхнШхЫЮlocalStorage
                safeSetItem(this.cacheKey, JSON.stringify(loadedStickers));
                this.stickers = loadedStickers;
                return loadedStickers;
            }
        } catch (e) {
            console.warn('IndexedDBхКаш╜╜шбицГЕхМЕхд▒ш┤е:', e);
        }
        
        console.log('ц▓бцЬЙцЙ╛хИ░ф┐ЭхнШчЪДшбицГЕхМЕ');
        return [];
    }
    
    async loadFromIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('StickerStorage', 1);
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['stickers'], 'readonly');
                const store = transaction.objectStore('stickers');
                const index = store.index('sessionId');
                const getAllRequest = index.getAll(SESSION_ID);
                
                getAllRequest.onsuccess = () => {
                    db.close();
                    const results = getAllRequest.result || [];
                    const stickers = results.map(r => r.data);
                    resolve(stickers);
                };
                
                getAllRequest.onerror = () => {
                    db.close();
                    reject(getAllRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
    
    getAll() {
        return this.stickers;
    }
}

// ЁЯОп 6. ф╕╗шБКхдйцХ░цНочобчРЖхЩи
class ChatDataManager {
    constructor() {
        this.messageCache = [];
        this.settingsCache = null;
    }
    
    // ф┐ЭхнШц╢ИцБпя╝ИцЩ║шГ╜хИЖцЙ╣я╝Й
    async saveMessages(messagesArray) {
        console.log(`ф┐ЭхнШ${messagesArray.length}цЭбц╢ИцБп...`);
        
        // хжВцЮЬц╢ИцБпхдкхдЪя╝МшЗкхКихИЖцЙ╣
        if (messagesArray.length > 1000) {
            console.warn('ц╢ИцБпцХ░щЗПш┐ЗхдЪя╝МшЗкхКихИЖцЙ╣ф┐ЭхнШ');
            return this.saveMessagesInBatches(messagesArray, 500);
        }
        
        // ф┐ЭхнШхИ░localStorage
        try {
            safeSetItem(getStorageKey('chatMessages'), JSON.stringify(messagesArray));
            console.log(`тЬЕ ${messagesArray.length}цЭбц╢ИцБпх╖▓ф┐ЭхнШхИ░localStorage`);
        } catch (e) {
            showUserFriendlyError(e, 'messages_local_save');
        }
        
        // х╝Вцнеф┐ЭхнШхИ░IndexedDB
        try {
            await this.saveMessagesToIndexedDB(messagesArray);
            console.log(`тЬЕ ${messagesArray.length}цЭбц╢ИцБпх╖▓ф┐ЭхнШхИ░IndexedDB`);
        } catch (e) {
            showUserFriendlyError(e, 'messages_indexeddb_save');
        }
        
        this.messageCache = messagesArray;
    }
    
    async saveMessagesInBatches(messagesArray, batchSize) {
        for (let i = 0; i < messagesArray.length; i += batchSize) {
            const batch = messagesArray.slice(i, i + batchSize);
            await this.saveMessages(batch);
            console.log(`хИЖцЙ╣ф┐ЭхнШ: ${i + batch.length}/${messagesArray.length}`);
        }
    }
    
    async saveMessagesToIndexedDB(messagesArray) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('MessageStorage', 1);
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('messages')) {
                    const store = db.createObjectStore('messages', { keyPath: 'sessionId' });
                }
            };
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                
                const messageData = {
                    sessionId: SESSION_ID,
                    messages: messagesArray,
                    count: messagesArray.length,
                    lastUpdated: Date.now()
                };
                
                const putRequest = store.put(messageData);
                
                putRequest.onsuccess = () => {
                    db.close();
                    resolve();
                };
                
                putRequest.onerror = () => {
                    db.close();
                    reject(putRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
    
    // хКаш╜╜ц╢ИцБп
    async loadMessages() {
        console.log('хКаш╜╜ц╢ИцБп...');
        
        let loadedMessages = [];
        
        // ф╗ОlocalStorageхКаш╜╜
        try {
            const saved = safeGetItem(getStorageKey('chatMessages'));
            if (saved) {
                loadedMessages = JSON.parse(saved);
                console.log(`тЬЕ ф╗ОlocalStorageхКаш╜╜${loadedMessages.length}цЭбц╢ИцБп`);
                this.messageCache = loadedMessages;
                return loadedMessages;
            }
        } catch (e) {
            console.warn('localStorageхКаш╜╜ц╢ИцБпхд▒ш┤е:', e);
        }
        
        // ф╗ОIndexedDBхКаш╜╜
        try {
            loadedMessages = await this.loadMessagesFromIndexedDB();
            if (loadedMessages.length > 0) {
                console.log(`тЬЕ ф╗ОIndexedDBхКаш╜╜${loadedMessages.length}цЭбц╢ИцБп`);
                // ф┐ЭхнШхЫЮlocalStorage
                safeSetItem(getStorageKey('chatMessages'), JSON.stringify(loadedMessages));
                this.messageCache = loadedMessages;
                return loadedMessages;
            }
        } catch (e) {
            console.warn('IndexedDBхКаш╜╜ц╢ИцБпхд▒ш┤е:', e);
        }
        
        console.log('ц▓бцЬЙцЙ╛хИ░ф┐ЭхнШчЪДц╢ИцБп');
        return [];
    }
    
    async loadMessagesFromIndexedDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('MessageStorage', 1);
            
            request.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                const getRequest = store.get(SESSION_ID);
                
                getRequest.onsuccess = () => {
                    db.close();
                    const result = getRequest.result;
                    resolve(result ? result.messages : []);
                };
                
                getRequest.onerror = () => {
                    db.close();
                    reject(getRequest.error);
                };
            };
            
            request.onerror = () => reject(request.error);
        });
    }
}

// ЁЯОп 7. хнШхВихо╣щЗПщкМшпБ
async function verifyStorageCapacity() {
    if (!navigator.storage || !navigator.storage.estimate) {
        console.warn('ц╡ПшзИхЩиф╕НцФпцМБхнШхВихо╣щЗПцЯешпв');
        return { success: false, reason: 'browser_not_support' };
    }
    
    try {
        const estimate = await navigator.storage.estimate();
        const quotaMB = estimate.quota / 1024 / 1024;
        const usageMB = estimate.usage / 1024 / 1024;
        
        console.log('ЁЯУК хнШхВихо╣щЗПщкМшпБ:');
        console.log(`   цА╗хо╣щЗП: ${quotaMB.toFixed(1)} MB`);
        console.log(`   х╖▓ф╜┐чФи: ${usageMB.toFixed(1)} MB`);
        console.log(`   хПпчФи: ${(quotaMB - usageMB).toFixed(1)} MB`);
        
        // цгАцЯецШпхРжш╛╛хИ░300MBчЫоцаЗ
        const meetsTarget = quotaMB >= 300;
        
        if (meetsTarget) {
            console.log('тЬЕ хнШхВихо╣щЗПц╗бш╢│300MBшжБц▒В');
            showNotification(`хнШхВихо╣щЗП: ${quotaMB.toFixed(0)}MBя╝МхПпф┐ЭхнШхдзщЗПцХ░цНо`, 'success', 3000);
        } else {
            console.warn(`тЪая╕П хнШхВихо╣щЗПф╕Нш╢│300MBя╝МхоЮщЩЕ: ${quotaMB.toFixed(0)}MB`);
            showNotification(`хнШхВихо╣щЗП: ${quotaMB.toFixed(0)}MBя╝Мх╗║шооц╕ЕчРЖц╡ПшзИхЩич╝УхнШ`, 'warning', 3000);
        }
        
        return {
            success: meetsTarget,
            quotaMB,
            usageMB,
            availableMB: quotaMB - usageMB
        };
        
    } catch (e) {
        console.error('хнШхВихо╣щЗПщкМшпБхд▒ш┤е:', e);
        return { success: false, reason: 'estimate_failed', error: e.message };
    }
}

// ЁЯОп 8. чФицИ╖хКЯшГ╜ц╡ЛшпХ
async function runUserFunctionalityTests() {
    console.log('ЁЯЪА х╝АхзЛчФицИ╖хКЯшГ╜ц╡ЛшпХ...');
    
    const testResults = {
        avatar_save: false,
        avatar_load: false,
        sticker_save: false,
        sticker_load: false,
        message_save: false,
        message_load: false,
        storage_capacity: false
    };
    
    // ц╡ЛшпХ1: хнШхВихо╣щЗП
    const capacityTest = await verifyStorageCapacity();
    testResults.storage_capacity = capacityTest.success;
    
    // ц╡ЛшпХ2: хИЫх╗║ц╡ЛшпХхд┤хГП
    const testAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwNzhmZiI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDAiLz48L3N2Zz4=';
    
    // ц╡ЛшпХ3: ф┐ЭхнШхд┤хГП
    try {
        const avatarManager = new AvatarManager();
        await avatarManager.saveAvatar('test', testAvatar);
        testResults.avatar_save = true;
        console.log('тЬЕ хд┤хГПф┐ЭхнШц╡ЛшпХщАЪш┐З');
    } catch (e) {
        console.error('тЭМ хд┤хГПф┐ЭхнШц╡ЛшпХхд▒ш┤е:', e);
    }
    
    // ц╡ЛшпХ4: хКаш╜╜хд┤хГП
    try {
        const avatarManager = new AvatarManager();
        const loaded = await avatarManager.loadAvatar('test');
        testResults.avatar_load = !!loaded;
        console.log('тЬЕ хд┤хГПхКаш╜╜ц╡ЛшпХщАЪш┐З');
    } catch (e) {
        console.error('тЭМ хд┤хГПхКаш╜╜ц╡ЛшпХхд▒ш┤е:', e);
    }
    
    // ц╡ЛшпХ5: ф┐ЭхнШшбицГЕхМЕ
    try {
        const stickerManager = new StickerManager();
        await stickerManager.addSticker(testAvatar);
        testResults.sticker_save = true;
        console.log('тЬЕ шбицГЕхМЕф┐ЭхнШц╡ЛшпХщАЪш┐З');
    } catch (e) {
        console.error('тЭМ шбицГЕхМЕф┐ЭхнШц╡ЛшпХхд▒ш┤е:', e);
    }
    
    // ц╡ЛшпХ6: хКаш╜╜шбицГЕхМЕ
    try {
        const stickerManager = new StickerManager();
        const stickers = await stickerManager.loadStickers();
        testResults.sticker_load = stickers.length > 0;
        console.log('тЬЕ шбицГЕхМЕхКаш╜╜ц╡ЛшпХщАЪш┐З');
    } catch (e) {
        console.error('тЭМ шбицГЕхМЕхКаш╜╜ц╡ЛшпХхд▒ш┤е:', e);
    }
    
    // ш╛УхЗ║ц╡ЛшпХч╗УцЮЬ
    console.log('ЁЯУЛ чФицИ╖хКЯшГ╜ц╡ЛшпХч╗УцЮЬ:');
    Object.entries(testResults).forEach(([test, result]) => {
        console.log(`   ${test}: ${result ? 'тЬЕ' : 'тЭМ'}`);
    });
    
    const allPassed = Object.values(testResults).every(r => r);
    
    if (allPassed) {
        console.log('ЁЯОЙ цЙАцЬЙчФицИ╖хКЯшГ╜ц╡ЛшпХщАЪш┐Зя╝Б');
        showNotification('цЙАцЬЙхнШхВихКЯшГ╜ц╡ЛшпХщАЪш┐Зя╝МцХ░цНох░ЖхПпщЭаф┐ЭхнШ', 'success', 4000);
    } else {
        console.warn('тЪая╕П щГихИЖхКЯшГ╜ц╡ЛшпХхд▒ш┤е');
        showNotification('щГихИЖхнШхВихКЯшГ╜хПЧщЩРя╝Мф╜ЖхЯ║цЬмхКЯшГ╜хПпчФи', 'warning', 4000);
    }
    
    return testResults;
}

// ЁЯОп 9. хИЭхзЛхМЦчобчРЖхЩи
let avatarManager, stickerManager, chatDataManager;

function initUserStorageManagers() {
    console.log('хИЭхзЛхМЦчФицИ╖хнШхВичобчРЖхЩи...');
    
    avatarManager = new AvatarManager();
    stickerManager = new StickerManager();
    chatDataManager = new ChatDataManager();
    
    // хЕих▒Ашо┐щЧо
    window.userStorage = {
        avatarManager,
        stickerManager,
        chatDataManager,
        verifyStorageCapacity,
        runUserFunctionalityTests
    };
    
    console.log('чФицИ╖хнШхВичобчРЖхЩихИЭхзЛхМЦхоМцИР');
}

// ЁЯОп 10. щЫЖцИРхИ░чО░цЬЙч│╗ч╗Я
async function integrateWithExistingSystem() {
    console.log('щЫЖцИРчФицИ╖хнШхВич│╗ч╗Я...');
    
    // хИЭхзЛхМЦчобчРЖхЩи
    initUserStorageManagers();
    
    // хКаш╜╜чО░цЬЙцХ░цНо
    try {
        // хКаш╜╜хд┤хГП
        const partnerAvatar = await avatarManager.loadAvatar('partner');
        if (partnerAvatar) {
            updateAvatar(DOMElements.partner.avatar, partnerAvatar);
        }
        
        const myAvatar = await avatarManager.loadAvatar('me');
        if (myAvatar) {
            updateAvatar(DOMElements.me.avatar, myAvatar);
        }
        
        // хКаш╜╜шбицГЕхМЕ
        const loadedStickers = await stickerManager.loadStickers();
        if (loadedStickers.length > 0) {
            stickers = loadedStickers;
        }
        
        // хКаш╜╜ц╢ИцБп
        const loadedMessages = await chatDataManager.loadMessages();
        if (loadedMessages.length > 0) {
            messages = loadedMessages.map(m => ({
                ...m,
                timestamp: new Date(m.timestamp)
            }));
        }
        
        console.log('тЬЕ чФицИ╖цХ░цНохКаш╜╜хоМцИР');
        
    } catch (e) {
        console.error('чФицИ╖цХ░цНохКаш╜╜хд▒ш┤е:', e);
    }
    
    // ф┐оцФ╣ф┐ЭхнШщА╗ш╛С
    const originalSaveData = saveData;
    saveData = async function() {
        console.log('чФицИ╖хнШхВич│╗ч╗Яф┐ЭхнШцХ░цНо...');
        
        // ш░ГчФихОЯхзЛф┐ЭхнШя╝ИхЕ╝хо╣цАзя╝Й
        if (typeof originalSaveData === 'function') {
            originalSaveData();
        }
        
        // ф┐ЭхнШхд┤хГП
        const partnerImg = DOMElements.partner.avatar.querySelector('img');
        const myImg = DOMElements.me.avatar.querySelector('img');
        
        if (partnerImg && partnerImg.src) {
            await avatarManager.saveAvatar('partner', partnerImg.src);
        }
        
        if (myImg && myImg.src) {
            await avatarManager.saveAvatar('me', myImg.src);
        }
        
        // ф┐ЭхнШшбицГЕхМЕ
        if (stickers.length > 0) {
            // ц│ицДПя╝Ъш┐ЩщЗМчоАхМЦхдДчРЖя╝МхоЮщЩЕщЬАшжБхвЮщЗПф┐ЭхнШ
            const stickerManager = new StickerManager();
            stickerManager.stickers = stickers;
            safeSetItem(getStorageKey('stickers'), JSON.stringify(stickers));
        }
        
        // ф┐ЭхнШц╢ИцБп
        if (messages.length > 0) {
            await chatDataManager.saveMessages(messages);
        }
        
        console.log('тЬЕ чФицИ╖цХ░цНоф┐ЭхнШхоМцИР');
    };
    
    // ш┐РшбМхКЯшГ╜ц╡ЛшпХ
    setTimeout(async () => {
        await runUserFunctionalityTests();
        await verifyStorageCapacity();
    }, 2000);
}

// ЁЯОп 11. щб╡щЭвхКаш╜╜хЕехПг
window.addEventListener('load', function() {
    console.log('ЁЯФД хКаш╜╜чФицИ╖хнШхВич│╗ч╗Я...');
    
    // х╗╢ш┐ЯхИЭхзЛхМЦя╝Мчбоф┐ЭхЕ╢ф╗Цч╗Дф╗╢хКаш╜╜хоМцИР
    setTimeout(async () => {
        try {
            await integrateWithExistingSystem();
            console.log('тЬЕ чФицИ╖хнШхВич│╗ч╗ЯхКаш╜╜хоМцИР');
            
            // цЫ┤цЦ░UI
            if (typeof updateUI === 'function') {
                updateUI();
            }
            
        } catch (e) {
            console.error('чФицИ╖хнШхВич│╗ч╗ЯхКаш╜╜хд▒ш┤е:', e);
            showNotification('хнШхВич│╗ч╗ЯхИЭхзЛхМЦхд▒ш┤ея╝Мф╜┐чФихЯ║цЬмцибх╝П', 'error', 3000);
        }
    }, 1000);
});

// ==================== чФицИ╖чЬЯхоЮф╜УщкМщкМшпБчЙИч╗УцЭЯ ====================
    </script>
</body>
</html>