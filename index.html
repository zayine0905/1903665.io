<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="gold">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">

    <title>传讯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0;
        }
        
        :root {
            --primary-bg: #f9f9f9;
            --secondary-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #7a7a7a;
            --border-color: #ebebeb;
            --message-sent-text: #ffffff;
            --message-received-bg: #f0f0f0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-family: 'Noto Serif SC', serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size: 16px;
            --favorite-color: #ffc107;
            
            --primary-bg-rgb: 249, 249, 249;
            --secondary-bg-rgb: 255, 255, 255;
            --bubble-style: 'standard';
            --message-font-family: 'Noto Serif SC', serif;
            --message-font-weight: 400;
            --message-line-height: 1.5;
        }

        :root[data-color-theme="gold"] { --accent-color: #c5a47e; --accent-color-dark: #d4af37; --accent-color-rgb: 197, 164, 126; }
        :root[data-color-theme="blue"] { --accent-color: #7FA6CD; --accent-color-dark: #7FA6CD; --accent-color-rgb: 127, 166, 205;}
        :root[data-color-theme="purple"] { --accent-color: #BB9EC7; --accent-color-dark: #BB9EC7; --accent-color-rgb: 187, 158, 199;}
        :root[data-color-theme="green"] { --accent-color: #7BC8A4; --accent-color-dark: #7BC8A4; --accent-color-rgb: 123, 200, 164;}
        :root[data-color-theme="pink"] { --accent-color: #F4A6B3; --accent-color-dark: #F4A6B3; --accent-color-rgb: 244, 166, 179;}
        :root[data-color-theme="black-white"] { --accent-color: #333333; --accent-color-dark: #D6D6D6; --accent-color-rgb: 51, 51, 51;}
        :root[data-color-theme="pastel"] { --accent-color: #A8D8EA; --accent-color-dark: #AA96DA; --accent-color-rgb: 168, 216, 234;}
        :root[data-color-theme="sunset"] { --accent-color: #FF9A8B; --accent-color-dark: #FF6B6B; --accent-color-rgb: 255, 154, 139;}
        :root[data-color-theme="forest"] { --accent-color: #7BA05B; --accent-color-dark: #556B2F; --accent-color-rgb: 123, 160, 91;}
        :root[data-color-theme="ocean"] { --accent-color: #4A90E2; --accent-color-dark: #2E5B9A; --accent-color-rgb: 74, 144, 226;}
        
        html[data-theme="dark"] {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-primary: #e5e5e5;
            --text-secondary: #8c8c8c;
            --border-color: #2f2f2f;
            --message-sent-text: #ffffff; 
            --message-received-bg: #2a2a2a;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --favorite-color: #ffd700;
            
            --primary-bg-rgb: 18, 18, 18;
            --secondary-bg-rgb: 30, 30, 30;
        }
        
        html[data-theme="dark"][data-color-theme="black-white"] .message-sent {
            color: #121212 !important;
        }
        
        html[data-theme="dark"][data-color-theme="gold"] .message-sent,
        html[data-theme="dark"][data-color-theme="blue"] .message-sent,
        html[data-theme="dark"][data-color-theme="purple"] .message-sent,
        html[data-theme="dark"][data-color-theme="green"] .message-sent,
        html[data-theme="dark"][data-color-theme="pink"] .message-sent,
        html[data-theme="dark"][data-color-theme="pastel"] .message-sent,
        html[data-theme="dark"][data-color-theme="sunset"] .message-sent,
        html[data-theme="dark"][data-color-theme="forest"] .message-sent,
        html[data-theme="dark"][data-color-theme="ocean"] .message-sent {
            color: #121212;
        }

        .message.rounded { border-radius: var(--radius); }
        .message.rounded-large { border-radius: 24px; }
        .message.square { border-radius: 8px; }
        .message.rounded-sent { border-radius: var(--radius) var(--radius) 6px var(--radius); }
        .message.rounded-received { border-radius: var(--radius) var(--radius) var(--radius) 6px; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: var(--primary-bg); 
            color: var(--text-primary); 
            transition: background-color 0.5s ease, color 0.5s ease; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            overflow-x: hidden;
            font-family: var(--font-family);
            font-weight: 400;
            position: relative;
            
            font-size: var(--font-size);
            opacity: 0;
            animation: delayedShow 0.01s ease 0.1s forwards;
        }
        @keyframes delayedShow { to {opacity: 1;} }
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none; 
    background-color: var(--primary-bg);
    background-image: var(--chat-bg-image); 
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    transition: background-image 0.5s ease;
}
        
        .header { 
            padding: 0;
            border-bottom: 1px solid var(--border-color); 
            background-color: var(--secondary-bg); 
            box-shadow: var(--shadow); 
            z-index: 10; 
            flex-shrink: 0; 
            position: relative;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }
        
        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 650px;
            margin: 0 auto;
            padding: 15px 5px;
            width: 100%;
        }

        .avatar { 
            width: 60px;
            height: 60px;
            border-radius: 50%; 
            object-fit: cover; 
            cursor: pointer; 
            background-color: var(--border-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            border: 2px solid transparent; 
            transition: var(--transition); 
            order: 2; 
        }
        
        .header-motto {
            position: absolute; 
            top: 8px; 
            left: 0; 
            right: 0;
            text-align: center; 
            font-size: 12px; 
            color: var(--accent-color);
            font-weight: 500; 
            letter-spacing: 2px; 
            opacity: 0.8; 
            font-style: italic;
            transition: color 0.5s ease;
            background: linear-gradient(90deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        html[data-theme="dark"] .header-motto { 
            background: linear-gradient(90deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .user-info { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            min-width: 60px;
        }
        
        .avatar:hover { border-color: var(--accent-color); transform: scale(1.05); }
        html[data-theme="dark"] .avatar:hover { border-color: var(--accent-color-dark); }
        .avatar > img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .username { 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            transition: var(--transition); 
            order: 1; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }
        .username:hover { color: var(--accent-color); }
        html[data-theme="dark"] .username:hover { color: var(--accent-color-dark); }
        .status { 
            font-size: 12px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            cursor: pointer; 
            order: 3; 
            padding: 2px 6px; 
            border-radius: 6px; 
            transition: background-color 0.3s ease; 
            white-space: nowrap;
        }
        .status:hover { background-color: var(--message-received-bg); }
        
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .action-btn { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 18px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            transition: var(--transition); 
        }
        .action-btn:hover { background-color: var(--message-received-bg); color: var(--text-primary); transform: rotate(15deg) scale(1.1); }
        
        .main-chat-area { 
            flex: 1; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        .chat-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            transition: background-color 0.5s ease; 
            background-color: transparent; 
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar { display: none; width: 0; }
        
        .message-wrapper { 
            display: flex; 
            flex-direction: column; 
            max-width: 85%; 
            margin-bottom: 12px; 
            animation: messageAppear 0.4s ease-out forwards; 
            opacity: 0;
            position: relative;
        }

        @keyframes messageAppear { 
            from { opacity: 0; transform: translateY(0) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .message-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.received { align-self: flex-start; align-items: flex-start; }
        
        .message { 
            padding: 12px 18px; 
            border-radius: var(--radius); 
            word-wrap: break-word; 
            line-height: var(--message-line-height); 
            box-shadow: var(--shadow); 
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease; 
            position: relative;
            overflow: hidden;
            min-width: 50px;
            font-family: var(--message-font-family);
            font-weight: var(--message-font-weight);
        }
        
        .message-sent { 
            background-color: var(--accent-color); 
            color: var(--message-sent-text); 
            border-bottom-right-radius: 6px; 
        }
        html[data-theme="dark"] .message-sent { background-color: var(--accent-color-dark); }
        
        .message-received { 
            background-color: var(--message-received-bg); 
            color: var(--text-primary); 
            border-bottom-left-radius: 6px; 
        }
        
        .message-meta { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin: 6px 10px 0 10px; 
            opacity: 0.7;
            font-size: 11px;
            color: var(--text-secondary);
            position: relative;
        }

        .favorite-meta-btn {
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 2px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
        }

        .favorite-meta-btn:hover { 
            opacity: 1; 
            transform: scale(1.2); 
        }

        .favorite-meta-btn.favorited { 
            color: var(--favorite-color); 
            opacity: 1;
        }

        .message-meta-actions {
            position: absolute;
            top: -12px;
            background-color: var(--secondary-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            padding: 4px 6px;
            opacity: 0;
            transform: translateY(5px);
            transition: var(--transition);
            z-index: 2;
        }
        .message-wrapper:hover .message-meta-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-wrapper.sent .message-meta-actions { left: -20px; }
        .message-wrapper.received .message-meta-actions { right: -20px; }

        .meta-action-btn {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .meta-action-btn:hover { transform: scale(1.2); color: var(--text-primary); }
        .meta-action-btn.favorited { color: var(--favorite-color); }
        
        .timestamp { 
            font-weight: 500; 
            text-shadow: 0 1px 1px rgba(0,0,0,0.1); 
        }
        .read-receipt { 
            font-size: 12px; 
        }
        .read-receipt.read { color: var(--accent-color); }
        html[data-theme="dark"] .read-receipt.read { color: var(--accent-color-dark); }
        
        .input-area-wrapper {
            flex-shrink: 0;
            background-color: var(--secondary-bg);
            transition: background-color 0.5s ease;
        }
        .input-area { 
            display: flex; 
            padding: 12px 15px; 
            gap: 10px; 
            border-top: 1px solid var(--border-color); 
            align-items: flex-end; 
            transition: border-color 0.5s ease; 
        }
        .message-input { 
            flex: 1; 
            border: 1px solid transparent; 
            border-radius: 24px; 
            padding: 12px 18px; 
            background-color: var(--primary-bg); 
            color: var(--text-primary); 
            resize: none; 
            outline: none; 
            max-height: 120px; 
            min-height: 46px; 
            transition: var(--transition); 
            font-weight: 500; 
            font-family: var(--font-family); 
            font-size: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-input:focus { 
            border-color: var(--accent-color); 
            background-color: var(--secondary-bg); 
        }
        html[data-theme="dark"] .message-input:focus { border-color: var(--accent-color-dark); }
        
        .input-buttons { 
            display: flex; 
            gap: 8px; 
        }
        .input-btn { 
            border: none; 
            border-radius: 50%; 
            width: 46px; 
            height: 46px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: var(--transition); 
            flex-shrink: 0; 
        }
        .input-btn:hover { transform: scale(1.08) rotate(5deg); filter: brightness(1.1); }
        
        .send-btn, .batch-btn.active { 
            background-color: var(--accent-color); 
            color: var(--message-sent-text); 
        }
        html[data-theme="dark"] .send-btn, html[data-theme="dark"] .batch-btn.active { 
            background-color: var(--accent-color-dark); 
        }

        .coin-btn, .batch-btn, .continue-btn, .attachment-btn, .poke-btn { 
            background-color: var(--message-received-bg); 
            color: var(--text-secondary); 
        }
        .attachment-btn:hover, .continue-btn:hover, .batch-btn:hover, .coin-btn:hover, .poke-btn:hover { color: var(--text-primary); }
        
        #reply-preview-container {
            padding: 0 15px;
        }
        .reply-preview {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
            border-left: 3px solid var(--accent-color);
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .reply-preview-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        
        .reply-preview-remove {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            font-size: 14px; width: 22px; height: 22px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0; transition: var(--transition);
        }
        .reply-preview-remove:hover { background-color: var(--border-color); color: var(--text-primary); transform: scale(1.1); }
        
        .reply-indicator {
            font-style: italic;
            opacity: 0.8;
            border-left: 2px solid var(--accent-color);
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            background-color: rgba(var(--primary-bg-rgb), 0.6);
            border-radius: 8px;
        }
        
        .message-wrapper.sent .reply-indicator {
            background-color: rgba(255, 255, 255, 0.2);
            color: inherit;
            border-left-color: rgba(255, 255, 255, 0.5);
        }
        html[data-theme="dark"] .message-wrapper.sent .reply-indicator {
            background-color: rgba(0, 0, 0, 0.15);
            color: inherit;
            border-left-color: rgba(0, 0, 0, 0.4);
        }
	.modal-btn.active {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}

.modal {
    z-index: 2000 !important;
}

.modal-content {
    z-index: 2001 !important;
}

        .message-note {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
        }
        html[data-theme="dark"] .message-note { color: var(--text-primary); }

        .system-message {
            align-self: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 10px 0;
            box-shadow: none;
        }

        body.with-background .header,
        body.with-background .input-area-wrapper {
            background-color: rgba(var(--secondary-bg-rgb), 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        body.with-background .input-area {
            border-top-color: transparent;
        }
        body.with-background .message-received { background-color: rgba(var(--secondary-bg-rgb), 0.95); }
        body.with-background .message-input { background-color: rgba(var(--primary-bg-rgb), 0.8); }
        body.with-background .message-input:focus { background-color: rgba(var(--secondary-bg-rgb), 0.9); }
        body.with-background .batch-preview {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.with-background .message-meta { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0, 0, 0, 0.6); 
    z-index: 2000; 
    align-items: center; 
    justify-content: center; 
    backdrop-filter: blur(8px); 
    animation: modalBgFadeIn 0.3s ease; 
}
        @keyframes modalBgFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { 
            background-color: var(--secondary-bg); border-radius: var(--radius); padding: 24px; 
            width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); animation: modalContentSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            transition: background-color 0.5s ease; scrollbar-width: none; -ms-overflow-style: none;
            transform: translateY(20px) scale(0.95); opacity: 0; display: flex; flex-direction: column;
        }
        .modal-content::-webkit-scrollbar { display: none; width: 0; }
        @keyframes modalContentSlideIn { to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-title { 
            font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; 
            align-items: center; gap: 8px; transition: color 0.5s ease; flex-shrink: 0; 
        }
        .modal-title i { color: var(--accent-color); }
        html[data-theme="dark"] .modal-title i { color: var(--accent-color-dark); }
        .modal-input, .modal-textarea { 
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; 
            background-color: var(--primary-bg); color: var(--text-primary); margin-bottom: 16px; 
            transition: var(--transition); font-family: var(--font-family);
        }
        .modal-textarea { resize: vertical; min-height: 80px; }
        .modal-input:focus, .modal-textarea:focus { border-color: var(--accent-color); transform: translateY(-1px); }
        html[data-theme="dark"] .modal-input:focus, html[data-theme="dark"] .modal-textarea:focus { border-color: var(--accent-color-dark); }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px; flex-shrink: 0; }
        .modal-btn { 
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; 
            font-weight: 600; transition: var(--transition); font-family: var(--font-family);
        }
        .modal-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal-btn-primary { background-color: var(--accent-color); color: var(--message-sent-text); }
        html[data-theme="dark"] .modal-btn-primary { background-color: var(--accent-color-dark); }
        .modal-btn-primary:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); }
        .modal-btn-secondary { background-color: var(--message-received-bg); color: var(--text-primary); }
        .modal-btn-secondary:hover:not(:disabled) { background-color: var(--border-color); transform: translateY(-1px); }
        
        #favorites-modal .modal-content { max-width: 500px; }
        .favorites-list { flex: 1; overflow-y: auto; margin: 0 -10px; padding: 0 10px; scrollbar-width: none; -ms-overflow-style: none;}
        .favorites-list::-webkit-scrollbar { display: none; }
        .favorite-item {
            padding: 12px; border-bottom: 1px solid var(--border-color); display: flex;
            flex-direction: column; gap: 6px; animation: fadeIn 0.3s ease;
        }
        .favorite-item:last-child { border-bottom: none; }
        .favorite-item-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-secondary); }
        .favorite-item-sender { font-weight: 600; }
        .favorite-item-content { line-height: 1.6; }
        .favorite-item-content img { max-width: 100px; border-radius: 8px; margin-top: 5px; }
        .no-favorites { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .no-favorites i { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }

        .file-input { display: none; }
        .typing-indicator, .empty-state { 
            position: absolute; left: 20px; bottom: 20px; z-index: 5; 
        }
        .empty-state { 
            left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: var(--text-secondary); text-align: center; 
            padding: 20px; width: 100%; transition: color 0.5s ease; 
        }
        .empty-state i { font-size: 64px; margin-bottom: 16px; opacity: 0.4; }
        .empty-state p { font-size: 16px; font-weight: 500; }
        
        .typing-indicator { 
            align-self: flex-start; background-color: var(--message-received-bg); padding: 12px 16px; 
            border-radius: var(--radius); border-bottom-left-radius: 6px; box-shadow: var(--shadow); 
            animation: fadeIn 0.4s ease-out; display: none; transition: background-color 0.5s ease, box-shadow 0.5s ease; 
        }
        .typing-dots { display: flex; gap: 5px; }
        .typing-dot { 
            width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); 
            animation: typing 1.4s infinite ease-in-out both; 
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* =========================================
   设置列表项通用美化 (条形卡片风格)
   ========================================= */

.settings-item-list {
    display: flex;
    flex-direction: column;
    gap: 12px; /* 增加项目间距 */
    margin-bottom: 16px;
}

/* 通用列表项样式 */
.settings-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px;
    background-color: var(--primary-bg); /* 浅色背景 */
    border-radius: 16px; /* 大圆角 */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    border: 1px solid transparent; /* 预留边框位置 */
    position: relative;
}

/* 列表项悬停 */
.settings-item:hover {
    background-color: var(--secondary-bg);
    transform: translateX(5px); /* 轻微右移 */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    border-color: rgba(var(--accent-color-rgb), 0.3);
}

/* 列表项图标美化 */
.settings-item i {
    font-size: 18px;
    color: var(--accent-color);
    /* 给图标加个彩色底座 */
    width: 40px;
    height: 40px;
    background-color: rgba(var(--accent-color-rgb), 0.1);
    border-radius: 12px; /* 方圆形 */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.settings-item:hover i {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
    transform: scale(1.1);
}

/* 列表项文字 */
.settings-item span {
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    flex: 1; /* 让文字撑开中间区域 */
}

/* 给普通列表项右侧加一个小箭头，提示可点击 */
.settings-item::after {
    content: "\f054"; /* FontAwesome 的右箭头 */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.5;
    transition: transform 0.3s ease;
}

.settings-item:hover::after {
    transform: translateX(3px);
    opacity: 0.8;
    color: var(--accent-color);
}

/* =========================================
   【重点】高级功能 - 宫格布局优化
   ========================================= */
/* 专门针对 ID 为 advanced-modal 里的列表进行改造 */

#advanced-modal .settings-item-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 强制分为两列 */
    gap: 12px;
}

#advanced-modal .settings-item {
    flex-direction: column; /* 上下排列 */
    align-items: center;
    text-align: center;
    padding: 20px 10px;
    background-color: var(--primary-bg);
    border: 1px solid var(--border-color);
    gap: 10px;
}

#advanced-modal .settings-item:hover {
    transform: translateY(-5px); /* 宫格模式改为上浮，不是右移 */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    z-index: 1;
}

/* 高级功能图标变大 */
#advanced-modal .settings-item i {
    width: 56px;
    height: 56px;
    font-size: 24px;
    border-radius: 20px; /* 更圆润 */
    margin-bottom: 4px;
}

/* 去掉宫格模式下的小箭头 */
#advanced-modal .settings-item::after {
    display: none;
}

/* 针对 外观设置 里气泡选择的特殊处理（保持横条，但稍微紧凑） */
#appearance-modal .settings-item-list {
    gap: 8px;
}

/* 针对 数据管理 按钮的美化 */
.import-export-buttons {
    display: flex;
    gap: 12px;
    margin-top: 5px;
}
.import-export-btn {
    flex: 1;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid transparent;
    background-color: var(--primary-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}
.import-export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
/* 导出按钮强调色 */
.import-export-btn.export {
    background-color: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    border-color: rgba(var(--accent-color-rgb), 0.2);
}
.import-export-btn.export:hover {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}
            
        .settings-item:hover { background-color: var(--primary-bg); transform: translateX(5px); }
        
        #my-status-input { 
            background: transparent; border: none; outline: none; color: var(--text-primary); 
            font-size: 12px; font-weight: 500; font-family: var(--font-family); 
            text-align: center; padding: 2px 6px; width: 100px; 
        }
        
      /* =========================================
   4.0 终极进化版开场动画 (Cosmic Transmission)
   ========================================= */
.welcome-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    overflow: hidden;
    /* 关键：退场动画变为模糊扩散 */
    transition: all 0.8s cubic-bezier(0.7, 0, 0.3, 1);
}

.welcome-animation.hidden {
    opacity: 0;
    transform: scale(1.1);
    filter: blur(20px);
    pointer-events: none;
}

/* 动态星空背景 */
.stars-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    pointer-events: none;
}

.star {
    position: absolute;
    background: white;
    border-radius: 50%;
    animation: twinkle var(--duration) ease-in-out infinite;
    opacity: 0;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1.2); }
}

.welcome-content-wrapper {
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
}

/* Logo 科技感容器 */
.logo-tech-container {
    position: relative;
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-icon-main {
    font-size: 48px;
    color: var(--accent-color);
    z-index: 5;
    filter: drop-shadow(0 0 15px rgba(var(--accent-color-rgb), 0.6));
    animation: floatIcon 3s ease-in-out infinite;
}

.logo-circle-outer {
    position: absolute;
    width: 100%;
    height: 100%;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: pulseRing 2s infinite;
}

.logo-circle-inner {
    position: absolute;
    width: 70%;
    height: 70%;
    border: 1px dashed rgba(var(--accent-color-rgb), 0.4);
    border-radius: 50%;
    animation: rotateCircle 10s linear infinite;
}

.orbit-dot {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    animation: rotateCircle 3s linear infinite;
}

.orbit-dot::after {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    width: 6px;
    height: 6px;
    background: var(--accent-color);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 10px var(--accent-color);
}

/* 文字特效容器 */
.text-tech-container {
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 80px;
}

.welcome-title-glitch {
    font-family: 'Noto Serif SC', serif;
    font-size: 32px;
    font-weight: 700;
    color: #fff;
    letter-spacing: 4px;
    position: relative;
}

.welcome-subtitle-scramble {
    font-family: monospace;
    font-size: 12px;
    color: var(--accent-color);
    letter-spacing: 2px;
    opacity: 0.8;
    text-transform: uppercase;
}

/* 进度条 */
.loader-tech {
    width: 160px;
    height: 2px;
    background: rgba(255, 255, 255, 0.1);
    position: relative;
    overflow: hidden;
    border-radius: 2px;
}

.loader-tech-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 0%;
    height: 100%;
    background: var(--accent-color);
    box-shadow: 0 0 15px var(--accent-color);
    transition: width 0.2s linear;
}

/* 动画关键帧 */
@keyframes floatIcon {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
}

@keyframes rotateCircle {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes pulseRing {
    0% { transform: scale(0.8); opacity: 0.1; border-color: rgba(var(--accent-color-rgb), 0.2); }
    50% { transform: scale(1.1); opacity: 0.3; border-color: rgba(var(--accent-color-rgb), 0.5); }
    100% { transform: scale(0.8); opacity: 0.1; border-color: rgba(var(--accent-color-rgb), 0.2); }
}

@keyframes breath { 0%, 100% { transform: scale(0.8); opacity: 0.1; } 50% { transform: scale(1.2); opacity: 0.2; } }
@keyframes iconFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes ripple { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 150px; height: 150px; opacity: 0; } }
@keyframes blink-caret { from, to { border-color: transparent; } 50% { border-color: var(--accent-color); } }
        
        .batch-preview { 
            position: absolute; bottom: 85px; left: 15px; right: 15px; background-color: var(--secondary-bg); 
            border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); display: none; 
            flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto; 
            border: 1px solid var(--border-color); z-index: 5; transition: all 0.5s ease; 
            scrollbar-width: none; -ms-overflow-style: none; animation: batchPreviewSlideUp 0.3s ease;
        }
        .batch-preview::-webkit-scrollbar { display: none; width: 0; }
        @keyframes batchPreviewSlideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .batch-preview-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; 
            background-color: var(--primary-bg); border-radius: 8px; font-size: 14px; 
            transition: background-color 0.5s ease, opacity 0.3s ease; user-select: none; animation: batchItemAppear 0.2s ease;
        }
        @keyframes batchItemAppear { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .batch-preview-text { flex-grow: 1; cursor: text; margin-right: 10px; }
        .batch-preview-input { 
            flex-grow: 1; border: none; background-color: transparent; border-bottom: 1px solid var(--accent-color); 
            color: var(--text-primary); font-family: var(--font-family); font-size: 14px; outline: none; 
        }
        .batch-preview-remove { 
            background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; 
            width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; flex-shrink: 0; transition: var(--transition);
        }
        .batch-preview-remove:hover { background-color: var(--border-color); color: var(--text-primary); transform: scale(1.1); }
        .batch-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
        .batch-action-btn { 
            padding: 6px 12px; border-radius: 6px; border: none; font-size: 12px; 
            cursor: pointer; transition: var(--transition); font-family: var(--font-family);
        }
        .batch-send-btn { background-color: var(--accent-color); color: var(--message-sent-text); }
        html[data-theme="dark"] .batch-send-btn { background-color: var(--accent-color-dark); }
        .batch-cancel-btn { background-color: var(--message-received-bg); color: var(--text-primary); }

        .theme-picker { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; }
        .theme-picker-label { font-weight: 500; font-size: 14px; }
        .theme-color-btn { 
            width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border-color); 
            cursor: pointer; transition: var(--transition); 
        }
        .theme-color-btn:hover { transform: scale(1.1); }
        .theme-color-btn.active { border-color: var(--text-primary); transform: scale(1.1); }
        #theme-gold { background-color: #c5a47e; }
        #theme-blue { background-color: #7FA6CD; }
        #theme-purple { background-color: #BB9EC7; }
        #theme-green { background-color: #7BC8A4; }
        #theme-pink { background-color: #F4A6B3; }
        #theme-black-white { background: linear-gradient(135deg, #000000 50%, #ffffff 50%); }
        #theme-pastel { background: linear-gradient(135deg, #A8D8EA, #AA96DA); }
        #theme-sunset { background: linear-gradient(135deg, #FF9A8B, #FF6B6B); }
        #theme-forest { background: linear-gradient(135deg, #7BA05B, #556B2F); }
        #theme-ocean { background: linear-gradient(135deg, #4A90E2, #2E5B9A); }

        .font-size-control { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .font-size-label { font-weight: 500; font-size: 14px; }
        .font-size-slider { 
            flex: 1; -webkit-appearance: none; height: 6px; border-radius: 3px; 
            background: var(--message-received-bg); outline: none; 
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; 
            background: var(--accent-color); cursor: pointer; transition: var(--transition);
        }
        .font-size-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .font-size-slider::-moz-range-thumb {
            width: 18px; height: 18px; border-radius: 50%; background: var(--accent-color); cursor: pointer; border: none;
        }
        .font-size-value { font-size: 14px; color: var(--text-secondary); min-width: 40px; text-align: center; }

        .settings-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .settings-section-title { 
            font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--accent-color); 
            display: flex; align-items: center; gap: 8px; 
        }
        html[data-theme="dark"] .settings-section-title { color: var(--accent-color-dark); }

        .notification {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background-color: var(--secondary-bg);
            color: var(--text-primary); padding: 12px 20px; border-radius: var(--radius); box-shadow: var(--shadow);
            z-index: 10001 !important;  display: flex; align-items: center; gap: 10px; max-width: 90%;
            animation: notificationSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); border-left: 4px solid var(--accent-color);
        }
        @keyframes notificationSlideIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .notification.hiding { animation: notificationSlideOut 0.4s ease-in forwards; }
        @keyframes notificationSlideOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }
        .notification i { color: var(--accent-color); }
        html[data-theme="dark"] .notification i { color: var(--accent-color-dark); }

        .import-export-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .import-export-btn {
            flex: 1; padding: 10px 15px; border-radius: 8px; border: none; background-color: var(--message-received-bg);
            color: var(--text-primary); cursor: pointer; transition: var(--transition); font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-family: var(--font-family);
        }
        .import-export-btn:hover { background-color: var(--border-color); transform: translateY(-2px); }
        .import-export-btn.export { background-color: var(--accent-color); color: var(--message-sent-text); }
        html[data-theme="dark"] .import-export-btn.export { background-color: var(--accent-color-dark); }

        .date-divider { 
            display: flex; align-items: center; margin: 20px 0; color: var(--text-secondary); 
            font-size: 12px; font-weight: 500; 
        }
        .date-divider::before, .date-divider::after { content: ""; flex: 1; height: 1px; background-color: var(--border-color); }
        .date-divider span { padding: 0 12px; }
        
        /* =========================================
   极简主义抛硬币样式 (Minimalist Coin Toss)
   ========================================= */

/* =========================================
   极简主义抛硬币样式 (Minimalist Coin Toss) - 修复版
   ========================================= */

.coin-toss-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(20, 20, 20, 0.6);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.coin-toss-overlay.visible {
    display: flex;
    opacity: 1;
}

.coin-container {
    perspective: 1200px;
    margin-bottom: 40px;
    filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.2));
}

.coin {
    width: 180px;
    height: 180px;
    position: relative;
    transform-style: preserve-3d;
    border-radius: 50%;
}

/* 翻转动画 */
.coin.flipping-heads { animation: flip-coin-heads 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
.coin.flipping-tails { animation: flip-coin-tails 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

.coin-face {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Noto Serif SC', serif;
    border: 8px solid rgba(255, 255, 255, 0.2);
    box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
}

.coin-front {
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    color: #333;
    transform: rotateY(0deg);
}
.coin-front::after {
    content: ""; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
    border: 1px dashed #bdc3c7; border-radius: 50%;
}

.coin-back {
    background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
    color: #fdfbfb;
    transform: rotateY(180deg);
}
.coin-back::after {
    content: ""; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
    border: 1px dashed #7f8c8d; border-radius: 50%;
}

.coin-text-main { font-size: 48px; font-weight: 400; letter-spacing: 4px; margin-bottom: 5px; }
.coin-text-sub { font-size: 12px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; font-family: sans-serif; }

/* 结果文字容器 - 修复：默认状态下可见，显示"命运抉择中" */
.coin-result-container {
    min-height: 60px;
    display: flex;
    justify-content: center;
}

.coin-result-text {
    font-family: 'Noto Serif SC', serif;
    font-size: 15px;
    color: #fff;
    font-weight: 300;
    opacity: 0.8; /* 关键：让等待文字可见 */
    letter-spacing: 3px;
    transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin-top: 20px;
    text-align: center;
}

/* 结果出来后的状态 - 变大变亮 */
.coin-toss-overlay.finished .coin-result-text {
    font-size: 28px;
    opacity: 1;
    font-weight: 500;
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

/* 操作按钮区域 - 修复：延迟浮现 */
.coin-confirm-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    justify-content: center;
    
    opacity: 0; /* 默认隐藏 */
    transform: translateY(20px);
    pointer-events: none; /* 不可点击 */
    
    /* 关键：默认没有 delay，这样点击“再来一次”时按钮能瞬间消失 */
    transition: opacity 0.3s ease, transform 0.3s ease;
}

/* 结果出来后的状态 */
.coin-toss-overlay.finished .coin-confirm-buttons {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
    /* 关键：等结果文字出完后，按钮才出来，更有仪式感 */
    transition-delay: 0.3s;
}

.coin-btn-action {
    padding: 10px 24px;
    border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.8);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    backdrop-filter: blur(5px);
}
.coin-btn-action:hover { background: rgba(255,255,255,0.2); color: #fff; transform: translateY(-2px); }

.coin-btn-primary { background: #fff; color: #000; border-color: #fff; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.coin-btn-primary:hover { background: #f0f0f0; box-shadow: 0 6px 20px rgba(255,255,255,0.3); transform: translateY(-2px) scale(1.02); }
/* 动画关键帧调整 (更流畅的物理感) */
@keyframes flip-coin-heads {
    0% { transform: rotateY(0) scale(1); animation-timing-function: ease-in; }
    40% { transform: rotateY(1080deg) scale(1.4); animation-timing-function: ease-out; }
    100% { transform: rotateY(2160deg) scale(1); } 
}

@keyframes flip-coin-tails {
    0% { transform: rotateY(0) scale(1); animation-timing-function: ease-in; }
    40% { transform: rotateY(1080deg) scale(1.4); animation-timing-function: ease-out; }
    100% { transform: rotateY(2340deg) scale(1); }
}
        
        .settings-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .settings-footer a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        .settings-footer a:hover {
            text-decoration: underline;
        }

        #session-modal .modal-content { max-width: 500px; }
        .session-list { flex: 1; overflow-y: auto; margin: 0 -10px; padding: 0 10px; max-height: 50vh;}
        .session-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px; transition: var(--transition); }
        .session-item:hover { background-color: var(--primary-bg); transform: translateX(5px); }
        .session-item.active { border-color: var(--accent-color); background-color: rgba(var(--accent-color-rgb), 0.1); font-weight: 600; }
        .session-info { cursor: pointer; flex-grow: 1; }
        .session-name { font-size: 15px; }
        .session-meta { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .session-actions { display: flex; gap: 8px; }
        .session-action-btn { background: none; border: none; color: var(--text-secondary); font-size: 14px; cursor: pointer; padding: 8px; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .session-action-btn:hover { color: var(--text-primary); background-color: var(--border-color); transform: scale(1.1); }
        .session-action-btn.delete:hover { color: #e53935; }

        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }
        
        .pagination-btn {
            background-color: var(--message-received-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .pagination-btn:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* === 极简塔罗牌样式 (Minimalist) === */
        .fortune-card.tarot-style {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }
        
        /* 装饰性边框 */
        .fortune-card.tarot-style::before {
            content: "";
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            pointer-events: none;
        }

        /* 顶部日期/标题栏 */
        .tarot-header {
            padding: 20px 0 10px;
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* 卡面核心视觉区域 */
        .tarot-visual {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            position: relative;
        }

        /* 矢量图标样式 */
        .tarot-icon-vector {
            font-size: 64px;
            color: var(--text-primary);
            opacity: 0.8;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* 逆位时图标旋转 */
        .tarot-visual.reversed .tarot-icon-vector {
            transform: rotate(180deg);
            opacity: 0.6;
        }

        /* 牌名 */
        .tarot-card-name {
            font-family: var(--font-family);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }

        /* 正逆位标签 */
        .tarot-position-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .tarot-position-badge.reversed {
            color: #e57373; /* 柔和的红色 */
            background-color: rgba(229, 115, 115, 0.1);
            border-color: rgba(229, 115, 115, 0.2);
        }

        /* 详情区域 */
        .tarot-details {
            padding: 0 30px 30px;
            position: relative;
            z-index: 2;
        }

        .tarot-divider {
            height: 1px;
            width: 40px;
            background-color: var(--accent-color);
            margin: 0 auto 15px;
        }

        .tarot-keyword {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .fortune-desc {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            font-style: italic;
        }

        .fortune-tip {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }

        /* 动画 */
        .fortune-card {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 批量收藏样式 */
        .batch-favorite-mode .message-wrapper {
            cursor: pointer;
        }
        
        .batch-favorite-mode .message-wrapper:hover .message {
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .batch-favorite-mode .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px var(--favorite-color);
        }
        
        .batch-favorite-actions {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-bg);
            border-radius: 20px;
            padding: 10px 15px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        /* 自定义回复样式 */
        .custom-replies-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .custom-reply-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--primary-bg);
            margin-bottom: 5px;
            transition: var(--transition);
        }
        
        .custom-reply-item:hover {
            background-color: var(--message-received-bg);
        }
        
        .custom-reply-actions {
            display: flex;
            gap: 5px;
        }

        /* =========================================
   消息统计界面 - 修正版
   ========================================= */

/* 统计面板容器 */
.stats-dashboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 5px 0; /* 减少左右padding，利用modal自带的 */
}

/* 卡片通用样式 */
.stats-card {
    background-color: var(--primary-bg);
    border-radius: 16px;
    padding: 16px;
    border: 1px solid var(--border-color);
    /* 底部增加一点边距，防止贴着关闭按钮 */
    margin-bottom: 5px; 
}

/* 概览数据 (4宫格) */
.stats-overview-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.overview-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    text-align: center;
    border: 1px solid transparent; /* 预留边框 */
}
/* 鼠标悬停微交互 */
.overview-item:hover {
    border-color: var(--border-color);
    background-color: var(--primary-bg);
}

.overview-value {
    font-family: 'Georgia', serif;
    font-size: 22px; /* 稍微调小一点，防止换行 */
    font-weight: 700;
    color: var(--accent-color);
    line-height: 1.2;
}

.overview-label {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* 标题栏 */
.stats-card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 8px;
}

/* =========================================
   修复：排行榜布局优化 (右对齐 + 长文本换行)
   ========================================= */

.stats-rank-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.rank-item {
    position: relative;
    display: flex;
    align-items: center; /* 垂直居中 */
    padding: 8px 10px;
    background: transparent;
    border-radius: 8px;
    overflow: hidden;
    min-height: 44px; /* 保证最小高度 */
}

/* 进度条背景 - 自动铺满高度 */
.rank-progress-bg {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    background-color: rgba(var(--accent-color-rgb), 0.12); /* 稍微淡一点 */
    z-index: 0;
    border-radius: 8px;
    transition: width 0.6s ease;
}

/* 内容容器 */
.rank-info {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center; /* 垂直方向居中 */
    justify-content: space-between; /* 关键：内容和次数两端对齐 */
    width: 100%;
    gap: 12px; /* 文字和右侧次数的间距 */
}

/* 序号 */
.rank-number {
    width: 24px;
    font-weight: 800;
    font-style: italic;
    color: var(--text-secondary); /* 默认灰色 */
    opacity: 0.5;
    flex-shrink: 0; /* 防止被挤压 */
    text-align: center;
    font-size: 14px;
}
/* 前三名高亮颜色 */
.rank-item:nth-child(1) .rank-number { color: #FFD700; opacity: 1; text-shadow: 0 1px 0 rgba(0,0,0,0.1); font-size: 16px; }
.rank-item:nth-child(2) .rank-number { color: #9EA1A3; opacity: 1; font-size: 15px; }
.rank-item:nth-child(3) .rank-number { color: #CD7F32; opacity: 1; font-size: 15px; }

/* 核心修改：文本区域 */
.rank-text {
    flex: 1; /* 占据中间剩余的所有空间 */
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    line-height: 1.4;
    
    /* --- 长文本处理方案 --- */
    white-space: normal;        /* 允许换行 */
    word-break: break-all;      /* 强制长单词/链接换行 */
    
    /* 限制显示2行，超出省略，既不消失也不占太多地 */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* 核心修改：次数统计 */
.rank-count {
    flex-shrink: 0; /* 关键：禁止被长文本挤压变形 */
    font-size: 12px;
    color: var(--accent-color);
    font-weight: 700;
    background-color: var(--secondary-bg); /* 给个背景挡住进度条 */
    padding: 4px 8px;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border: 1px solid var(--border-color);
    min-width: 40px;
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1;
}
.rank-count small {
    font-size: 9px;
    opacity: 0.7;
    font-weight: normal;
    margin-top: 2px;
}

/* 空状态 */
.stats-empty-state {
    text-align: center;
    padding: 30px 10px;
    color: var(--text-secondary);
}
/* =========================================
   修复：统计弹窗布局与滚动条
   ========================================= */

/* 1. 强制模态框内容区域为 Flex 列布局 */
#stats-modal .modal-content {
    display: flex;
    flex-direction: column;
    max-height: 85vh; /* 限制最大高度，避免撑破屏幕 */
    padding: 20px;    /* 调整内边距 */
    overflow: hidden; /* 禁止外层滚动 */
}

/* 2. 标题区域防止压缩 */
#stats-modal .modal-title {
    flex-shrink: 0;
    margin-bottom: 15px;
}

/* 3. 核心：让统计内容区域占据剩余空间并允许内部滚动 */
#stats-content {
    flex: 1;               /* 自动占据中间剩余空间 */
    overflow-y: auto;      /* 内容过多时显示滚动条 */
    min-height: 0;         /* Flex 布局滚动修复 */
    padding-right: 5px;    /* 防止滚动条遮挡文字 */
    margin-bottom: 15px;   /* 与底部按钮保持距离 */
    
    /* 隐藏滚动条但保持功能 (可选，根据你喜好保留或删除) */
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
#stats-content::-webkit-scrollbar {
    display: none;
}

/* 4. 底部按钮区域防止压缩 */
#stats-modal .modal-buttons {
    flex-shrink: 0;        /* 禁止按钮被压缩 */
    margin-top: 0;         /* 也就是由 stats-content 的 margin-bottom 控制间距 */
    padding-top: 10px;
    border-top: 1px solid var(--border-color); /* 加一条分割线，更清晰 */
    display: flex;
    justify-content: flex-end;
}
/* =========================================
   2. 进化：纪念日高级卡片 (Anniversary Cards)
   ========================================= */
#anniversary-list {
    display: grid;
    grid-template-columns: 1fr; /* 单列布局 */
    gap: 12px;
    padding: 5px;
    max-height: 450px;
    overflow-y: auto; /* 允许内部滚动 */
}

.anniversary-card {
    position: relative;
    border-radius: 16px;
    padding: 18px 20px;
    color: #fff;
    overflow: hidden;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    min-height: 90px;
}

.anniversary-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.15);
}

/* 类型区分颜色 */
/* 倒数日：蓝色/紫色渐变 */
.anniversary-card.type-future {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
/* 纪念日：暖色/粉金渐变 */
.anniversary-card.type-past {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
}
html[data-color-theme="gold"] .anniversary-card.type-past {
    background: linear-gradient(135deg, #d4af37 0%, #C5A47E 100%);
}
html[data-color-theme="gold"] .anniversary-card.type-future {
    background: linear-gradient(135deg, #243B55 0%, #141E30 100%);
}

/* 卡片左侧 */
.ann-info { z-index: 2; display: flex; flex-direction: column; gap: 5px; }
.ann-name { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.ann-date { font-size: 12px; opacity: 0.8; letter-spacing: 1px; }
.ann-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.2); margin-left: 5px; vertical-align: middle; }

/* 卡片右侧 */
.ann-days { z-index: 2; text-align: right; }
.ann-number { font-size: 36px; font-weight: 700; font-family: 'Arial', sans-serif; line-height: 1; letter-spacing: -1px; }
.ann-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }

/* 删除按钮 */
.ann-delete-btn {
    position: absolute; top: 10px; right: 10px; width: 20px; height: 20px;
    background: rgba(0,0,0,0.15); border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 12px; opacity: 0; transition: opacity 0.2s; z-index: 10;
}
.anniversary-card:hover .ann-delete-btn { opacity: 1; }
.ann-delete-btn:hover { background: rgba(255,0,0,0.6); transform: scale(1.1); }

/* 背景装饰 */
.anniversary-card::after {
    content: ""; position: absolute; top: -30px; right: -30px; width: 100px; height: 100px;
    background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;
}

/* 顶部主纪念日展示区 */
#anniversary-display {
    text-align: center;
    padding: 25px 0;
    background-color: var(--primary-bg);
    border-radius: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    animation: fadeIn 0.5s ease;
}

        @media (max-width: 768px) {
            .header-inner { padding: 12px 8px; max-width: 95%; }
            .user-info { min-width: 45px; }
            .avatar { width: 48px; height: 48px; }
            .username { font-size: 12px; max-width: 55px; }
            .status { font-size: 10px; }
            .header-motto { font-size: 9px; top: 5px; }
            .header-actions { gap: 6px; }
            .action-btn { width: 32px; height: 32px; font-size: 16px; }
            .chat-container { padding: 20px 10px; }
            .message-wrapper { max-width: 90%; }
            .input-area { padding: 10px 12px; gap: 8px; }
            .input-btn { width: 42px; height: 42px; }
            .message-input { min-height: 42px; padding: 10px 16px; }
            .modal-content { width: 95%; max-width: none; }
            .batch-preview { left: 10px; right: 10px; bottom: 75px; }
            .stats-content { max-height: 300px; }
        }
        @media (max-width: 480px) {
            .header-inner { padding: 10px 6px; }
            .user-info { min-width: 40px; }
            .avatar { width: 40px; height: 40px; }
            .username { font-size: 11px; max-width: 45px; }
            .status { font-size: 9px; padding: 1px 4px; }
            .header-motto { font-size: 8px; top: 4px; }
            .header-actions { gap: 4px; }
            .action-btn { width: 30px; height: 30px; font-size: 14px; }
            .chat-container { padding: 15px 8px; }
            .input-area { padding: 8px 10px; gap: 6px; }
            .input-btn { width: 38px; height: 38px; }
            .message-input { min-height: 38px; padding: 8px 14px; font-size: 14px; }
            .batch-preview { left: 8px; right: 8px; bottom: 70px; max-height: 130px; }
            .empty-state i { font-size: 48px; }
            .empty-state p { font-size: 14px; }
        }
        @media (max-width: 360px) {
            .username { display: none; }
            .user-info { gap: 2px; }
            .header-inner { padding: 8px 5px; }
            .input-buttons { gap: 5px; }
            .input-btn { width: 36px; height: 36px; }
        }

#anniversary-days {
    text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
    animation: pulse 2s infinite ease-in-out;
}

.report-card {
    background-color: rgba(255,255,255,0.5);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    animation: slideInUp 0.5s ease forwards;
    opacity: 0;
    transform: translateY(20px);
}
html[data-theme="dark"] .report-card {
    background-color: rgba(30,30,30,0.5);
    border: 1px solid rgba(255,255,255,0.05);
}

.report-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 8px;
}

.report-card .highlight-text {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-color);
    margin: 5px 0;
}

.report-card .sub-text {
    font-size: 12px;
    opacity: 0.7;
    line-height: 1.5;
}

.report-tag {
    display: inline-block;
    background: var(--message-received-bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 2px;
}

@keyframes slideInUp {
    to { opacity: 1; transform: translateY(0); }
}

/* =========================================
   设置面板美化 (替换原有的 Settings Grid 部分)
   ========================================= */

/* 网格布局：增加间距 */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 强制两列 */
    gap: 16px; /* 增加卡片间距 */
    padding: 10px 5px; /* 增加外部呼吸感 */
}

/* 卡片样式：现代化、玻璃感微调 */
.settings-card {
    background-color: var(--primary-bg);
    border-radius: 20px; /* 更圆润的边角 */
    padding: 25px 15px; /* 增加内部高度 */
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02); /* 默认极淡阴影 */
    position: relative;
    overflow: hidden;
}

/* 悬停效果：上浮 + 投影加深 + 边框变色 */
.settings-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    border-color: var(--accent-color);
    background-color: var(--secondary-bg);
}

/* 图标容器化：增加圆形背景 */
.settings-card i {
    font-size: 28px;
    color: var(--accent-color);
    /* 创建一个圆形底托 */
    width: 64px;
    height: 64px;
    background-color: rgba(var(--accent-color-rgb), 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 5px;
    transition: all 0.4s ease;
}

/* 暗夜模式下的图标背景适配 */
html[data-theme="dark"] .settings-card i {
    background-color: rgba(var(--accent-color-rgb), 0.2);
}

/* 悬停时图标的变化 */
.settings-card:hover i {
    background-color: var(--accent-color);
    color: var(--message-sent-text); /* 图标变白 */
    transform: scale(1.1) rotate(5deg); /* 微放大和旋转 */
    box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.4);
}

/* 文字样式优化 */
.settings-card span {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: 0.5px;
}

/* 底部页脚美化：卡片化，减少视觉干扰 */
.settings-footer {
    margin-top: 25px;
    padding: 20px;
    border-radius: 16px;
    background-color: rgba(var(--primary-bg-rgb), 0.5);
    border: 1px dashed var(--border-color);
    text-align: center;
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.8;
}

.settings-footer p {
    margin: 2px 0;
}

/* 针对小屏幕的微调 */
@media (max-width: 480px) {
    .settings-grid {
        gap: 12px;
    }
    .settings-card {
        padding: 20px 10px;
    }
    .settings-card i {
        width: 50px;
        height: 50px;
        font-size: 22px;
    }
    .settings-card span {
        font-size: 13px;
    }
}

/* 批量收藏优化 */
.batch-favorite-checkbox {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: var(--secondary-bg);
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: var(--transition);
}

.batch-favorite-checkbox.checked {
    background-color: var(--favorite-color);
    border-color: var(--favorite-color);
}

.batch-favorite-checkbox.checked::after {
    content: "✓";
    color: white;
    font-size: 12px;
    font-weight: bold;
}

.batch-favorite-mode .message-wrapper {
    position: relative;
}

.batch-favorite-mode .message-wrapper .batch-favorite-checkbox {
    display: flex;
}

.batch-favorite-mode .message-wrapper:not(.batch-favorite-mode) .batch-favorite-checkbox {
    display: none;
}

/* 纪念日动画 */
.anniversary-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

.anniversary-animation.active {
    opacity: 1;
    pointer-events: all;
}

.anniversary-animation-content {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    color: white;
    max-width: 80%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transform: scale(0.8);
    opacity: 0;
    transition: all 0.5s ease;
}

.anniversary-animation.active .anniversary-animation-content {
    transform: scale(1);
    opacity: 1;
}

.anniversary-animation-title {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
}

.anniversary-animation-days {
    font-size: 48px;
    font-weight: bold;
    margin: 20px 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.anniversary-animation-message {
    font-size: 16px;
    opacity: 0.9;
}

/* 修复纪念日模态框样式 */
.anniversary-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.anniversary-type-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.anniversary-type-btn.active {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
    border-color: var(--accent-color);
}

.anniversary-type-btn:hover {
    transform: translateY(-2px);
}
.player-container {
    position: fixed;
    top: 100px;
    left: 20px; 
    width: 320px;
    height: 160px;
    background: rgba(var(--secondary-bg-rgb), 0.85); 
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-radius: 24px;
    box-shadow: var(--shadow); 
    transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                border-radius 0.4s ease,
                opacity 0.3s ease, visibility 0.3s ease;
    z-index: 990; 
    overflow: hidden;
    cursor: grab;
    border: 1px solid var(--border-color);
    display: none; 
    touch-action: none; 
}

.player-container.visible { display: block; }

.player-container:active { cursor: grabbing; }

.player-container.collapsed {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    padding: 0;
    border-color: transparent;
}

.full-view {
    opacity: 1;
    transform: translateY(0);
    transition: all 0.3s ease 0.1s;
    padding: 15px 20px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.player-container.collapsed .full-view {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-20px);
    position: absolute;
}

.mini-view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: all 0.3s ease;
    cursor: pointer;
}

.player-container.collapsed .mini-view { opacity: 1; pointer-events: auto; }

/* 黑胶动画 */
.vinyl-record {
    width: 40px; height: 40px;
    background: #1a1a1a; /* 黑胶永远是黑的 */
    border-radius: 50%;
    position: relative;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    animation: spin 4s linear infinite;
    animation-play-state: paused;
    border: 2px solid var(--border-color);
}
.player-container.collapsed.playing .vinyl-record { animation-play-state: running; }
@keyframes spin { 100% { transform: rotate(360deg); } }
.vinyl-record::after { content: ''; width: 10px; height: 10px; background: var(--secondary-bg); border-radius: 50%; position: absolute; }
.vinyl-record svg { width: 14px; height: 14px; fill: #fff; z-index: 2; opacity: 0; transition: opacity 0.2s; }
.mini-view:hover .vinyl-record svg { opacity: 1; }

.minimize-btn {
    position: absolute; top: 10px; right: 15px; width: 24px; height: 24px;
    cursor: pointer; opacity: 0.6; transition: opacity 0.2s; z-index: 10;
    color: var(--text-secondary);
}
.minimize-btn:hover { opacity: 1; color: var(--text-primary); }
.minimize-btn svg { width: 100%; height: 100%; fill: currentColor; }

.track-info { text-align: center; margin-top: 5px; }
.track-name { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.track-sub { font-size: 11px; color: var(--text-secondary); opacity: 0.8; }

/* 进度条 */
.progress-wrapper {
    width: 100%; height: 4px; background: var(--border-color);
    border-radius: 2px; cursor: pointer; margin: 10px 0; position: relative;
}
.progress-wrapper::before { content: ''; position: absolute; top: -6px; bottom: -6px; left: 0; right: 0; }
.progress-bar {
    height: 100%; width: 0%; 
    background: var(--accent-color); /* 跟随主题色 */
    border-radius: 2px; position: relative;
    transition: background-color 0.3s ease;
}
.progress-bar::after {
    content: ''; position: absolute; right: -4px; top: -3px; width: 10px; height: 10px;
    background: var(--accent-color); border-radius: 50%; opacity: 0; transition: opacity 0.2s;
}
.progress-wrapper:hover .progress-bar::after { opacity: 1; }

/* 按钮 */
.controls { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; }
.btn {
    background: none; border: none; cursor: pointer;
    color: var(--text-secondary); transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 50%;
}
.btn:hover { background: var(--message-received-bg); color: var(--text-primary); }
.btn-main {
    width: 44px; height: 44px;
    background: var(--accent-color); /* 跟随主题色 */
    color: var(--message-sent-text);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
html[data-theme="dark"] .btn-main { background: var(--accent-color-dark); }
.btn-main:hover { transform: scale(1.05); filter: brightness(1.1); color: var(--message-sent-text); }
.btn svg { width: 18px; height: 18px; fill: currentColor; }

/* 播放列表 */
.playlist-popup {
    position: absolute; top: 0; left: 0; width: 320px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    border-radius: 16px; padding: 10px;
    box-shadow: var(--shadow); border: 1px solid var(--border-color);
    opacity: 0; transform: translateY(-10px) scale(0.95);
    pointer-events: none; transition: all 0.3s ease;
    z-index: 980; max-height: 0; overflow: hidden;
}
.playlist-popup.active {
    opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
    max-height: 200px; overflow-y: auto;
}
.playlist-item {
    padding: 8px 12px; font-size: 13px; color: var(--text-secondary);
    border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between;
    transition: var(--transition); border-bottom: 1px solid transparent;
}
.playlist-item:hover { background: var(--primary-bg); color: var(--text-primary); }
.playlist-item.playing {
    color: var(--accent-color); font-weight: 600;
    background: rgba(var(--accent-color-rgb), 0.1);
}
html[data-theme="dark"] .playlist-item.playing { color: var(--accent-color-dark); }
/* 播放列表底部的添加按钮样式 */
.playlist-add-btn {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px dashed var(--border-color);
    background: rgba(var(--primary-bg-rgb), 0.5);
    color: var(--text-secondary);
    border-radius: 8px;
    cursor: pointer;
    text-align: center;
    font-size: 13px;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}
.playlist-add-btn:hover {
    background: var(--message-received-bg);
    color: var(--accent-color);
    border-color: var(--accent-color);
}
/* =========================================
   沉浸式加载历史记录样式
   ========================================= */

/* 隐藏旧的分页器（以防万一没删干净） */
.pagination { display: none !important; }

/* 聊天区域微调，给顶部留一点呼吸空间 */
.chat-container {
    padding-top: 20px;
}

/* 加载动画容器：悬浮在聊天框顶部 */
.history-loader {
    position: absolute;
    top: 10px;
    left: 0;
    width: 100%;
    height: 30px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none; /* 让鼠标事件穿透，不影响点击消息 */
}

/* 加载时显示 */
.history-loader.visible {
    opacity: 1;
}

/* 旋转的圆圈 */
.history-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(var(--accent-color-rgb), 0.2);
    border-top-color: var(--accent-color);
    border-radius: 50%;
    animation: history-spin 0.8s linear infinite;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

@keyframes history-spin {
    to { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <!-- 4.0 终极进化版开场结构 -->
<div class="welcome-animation" id="welcome-animation">
    <div class="stars-container" id="stars-container"></div>
    <div class="welcome-content-wrapper">
        <div class="logo-tech-container">
            <div class="logo-circle-outer"></div>
            <div class="logo-circle-inner"></div>
            <div class="logo-icon-main"><i class="fas fa-satellite-dish"></i></div>
            <div class="orbit-dot"></div>
        </div>
        
        <div class="text-tech-container">
            <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="传讯">TRANSMIT</div>
            <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">INITIALIZING...</div>
        </div>

        <div class="loader-tech">
            <div class="loader-tech-bar" id="loader-tech-bar"></div>
        </div>
    </div>
</div>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
            <div class="user-info">
                <div id="partner-name" class="username">对方</div>
                <div class="avatar" id="partner-avatar"><i class="fas fa-user"></i></div>
                <div class="status" id="partner-status"><span>在线</span></div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="会话管理"><i class="fas fa-comments"></i></button>
                <button id="favorites-btn" class="action-btn" title="收藏夹"><i class="fas fa-star"></i></button>
                <button id="theme-toggle" class="action-btn" title="切换主题"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="设置"><i class="fas fa-cog"></i></button>
            </div>
            <div class="user-info">
                <div class="username" id="my-name">我</div>
                <div class="avatar" id="my-avatar"><i class="fas fa-user"></i></div>
                <div class="status" id="my-status-container"><span id="my-status-text">在线</span></div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">
    <!-- 【新增】顶部加载历史的转圈动画 -->
    <div class="history-loader" id="history-loader">
        <div class="history-spinner"></div>
    </div>
    
    <div class="chat-container" id="chat-container"></div>
    <div class="empty-state" id="empty-state"><i class="far fa-comments"></i><p></p></div>
    <div class="typing-indicator" id="typing-indicator"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>
    <div class="batch-preview" id="batch-preview"></div>
</div>
    <div class="input-area-wrapper">
        <div id="reply-preview-container"></div>
        <div class="input-area">
            <button class="attachment-btn input-btn" id="attachment-btn" title="发送图片"><i class="fas fa-image"></i></button>
            <button class="poke-btn input-btn" id="poke-btn" title="拍一拍"><i class="fas fa-hand-sparkles"></i></button>
            <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
            <div class="input-buttons">
                <button class="continue-btn input-btn" id="continue-btn" title="让对方继续说"><i class="fas fa-ellipsis-h"></i></button>
                <button class="batch-btn input-btn" id="batch-btn" title="批量发送模式"><i class="fas fa-layer-group"></i></button>
                <button class="send-btn input-btn" id="send-btn" title="发送消息"><i class="fas fa-paper-plane"></i></button>
            </div>
            <input type="file" id="image-input" class="file-input" accept="image/*">
        </div>
    </div>

    <!-- 所有模态框 -->
    <div class="modal" id="edit-modal"><div class="modal-content"><div class="modal-title"><i class="fas fa-user-edit"></i><span id="edit-modal-title">修改昵称</span></div><input type="text" class="modal-input" id="name-input" placeholder="输入新昵称"><div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="cancel-edit">取消</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>保存</button></div></div></div>
    
    <div class="modal" id="avatar-modal"><div class="modal-content"><div class="modal-title"><i class="fas fa-portrait"></i><span id="avatar-modal-title">上传头像</span></div><input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="cancel-avatar">取消</button><button class="modal-btn modal-btn-primary" id="save-avatar">保存</button></div></div></div>
    
    <div class="modal" id="note-modal"><div class="modal-content"><div class="modal-title"><i class="fas fa-sticky-note"></i><span>编辑注释</span></div><textarea class="modal-textarea" id="note-input" placeholder="为这条消息添加注释..."></textarea><div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="cancel-note">取消</button><button class="modal-btn modal-btn-primary" id="save-note">保存</button></div></div></div>
    
    <div class="modal" id="poke-modal"><div class="modal-content"><div class="modal-title"><i class="fas fa-hand-sparkles"></i><span>拍一拍</span></div><input type="text" class="modal-input" id="poke-input" placeholder="例如：拍了拍"对方"的肩膀"><div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="cancel-poke">取消</button><button class="modal-btn modal-btn-primary" id="send-poke">发送</button></div></div></div>
    
    <div class="modal" id="settings-modal"><div class="modal-content">
        <div class="modal-title"><i class="fas fa-cog"></i><span>设置</span></div>
        
        <div class="settings-grid">
            <div class="settings-card" id="appearance-settings">
                <i class="fas fa-palette"></i>
                <span>外观设置</span>
            </div>
            <div class="settings-card" id="chat-settings">
                <i class="fas fa-comments"></i>
                <span>聊天设置</span>
            </div>
            <div class="settings-card" id="advanced-settings">
                <i class="fas fa-tools"></i>
                <span>高级功能</span>
            </div>
            <div class="settings-card" id="data-settings">
                <i class="fas fa-database"></i>
                <span>数据管理</span>
            </div>
        </div>
        
        
        <div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="cancel-settings">关闭</button></div>
    </div></div>
    
    <!-- 外观设置模态框 -->
    <div class="modal" id="appearance-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-palette"></i><span>外观设置</span></div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-paint-brush"></i>主题颜色</div>
                <div class="theme-picker">
                    <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="金色"></button>
                    <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="蓝色"></button>
                    <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="紫色"></button>
                    <button class="theme-color-btn" id="theme-green" data-theme="green" title="绿色"></button>
                    <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="粉色"></button>
                    <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="简约黑白"></button>
                    <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="柔和粉彩"></button>
                    <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="日落橙红"></button>
                    <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="森林绿"></button>
                    <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="海洋蓝"></button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-text-height"></i>字体大小</div>
                <div class="font-size-control">
                    <span class="font-size-label">字体大小:</span>
                    <input type="range" min="12" max="20" value="16" class="font-size-slider" id="font-size-slider">
                    <span class="font-size-value" id="font-size-value">16px</span>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-comment"></i>气泡样式</div>
                <div class="settings-item-list">
                    <div class="settings-item" data-bubble-style="standard"><i class="fas fa-comment"></i><span>标准气泡</span></div>
                    <div class="settings-item" data-bubble-style="rounded"><i class="fas fa-comment"></i><span>圆角气泡</span></div>
                    <div class="settings-item" data-bubble-style="rounded-large"><i class="fas fa-comment"></i><span>大圆角气泡</span></div>
                    <div class="settings-item" data-bubble-style="square"><i class="fas fa-comment"></i><span>方形气泡</span></div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-image"></i>聊天背景</div>
                <div class="settings-item-list">
                    <div class="settings-item" id="set-background"><i class="fas fa-image"></i><span>设置聊天背景</span></div>
                    <div class="settings-item" id="remove-background"><i class="fas fa-ban"></i><span>移除聊天背景</span></div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-appearance">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 聊天设置模态框 -->
    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-comments"></i><span>聊天设置</span></div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-toggle-on"></i>功能开关</div>
                <div class="settings-item-list">
                    <div class="settings-item" id="reply-toggle"><i class="fas fa-reply"></i><span>引用回复: 开启</span></div>
                    <div class="settings-item" id="sound-toggle"><i class="fas fa-volume-up"></i><span>消息音效: 开启</span></div>
                    <div class="settings-item" id="read-receipts-toggle"><i class="fas fa-check-double"></i><span>已读回执: 开启</span></div>
                    <div class="settings-item" id="typing-indicator-toggle"><i class="fas fa-keyboard"></i><span>正在输入: 显示</span></div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-chat">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 高级功能模态框 -->
    <div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-tools"></i><span>高级功能</span></div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-magic"></i>实用工具</div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function"><i class="fas fa-comment-dots"></i><span>自定义回复</span></div>
<div class="settings-item" id="music-player-toggle"><i class="fas fa-music"></i><span>悬浮音乐播放器</span></div>
                    <div class="settings-item" id="stats-function"><i class="fas fa-chart-bar"></i><span>消息统计</span></div>
                    <div class="settings-item" id="coin-function"><i class="fas fa-coins"></i><span>抛硬币</span></div>
                    <div class="settings-item" id="fortune-function"><i class="fas fa-star-and-crescent"></i><span>塔罗占卜</span></div>
                    <div class="settings-item" id="anniversary-function"><i class="fas fa-heart"></i><span>重要日</span></div>

                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-advanced">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 数据管理模态框 -->
    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-database"></i><span>数据管理</span></div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-file-export"></i>导入导出</div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>导出记录</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>导入记录</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title"><i class="fas fa-trash-alt"></i>数据清理</div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-chat"><i class="fas fa-trash-alt"></i><span>清空当前会话</span></div>
                    <div class="settings-item" id="clear-storage"><i class="fas fa-server"></i><span>重置所有数据</span></div>
<!-- 在 id="data-modal" 的 .modal-content 内部 -->
<div class="settings-section">
    <div class="settings-section-title"><i class="fas fa-info-circle"></i>关于与声明</div>
    <div class="settings-item-list">
        <div class="settings-item" id="open-credits-btn"><i class="fas fa-scroll"></i><span>声明与致谢</span></div>
    </div>
</div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-data">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="favorites-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-star" style="color: var(--favorite-color);"></i><span>收藏夹</span></div>
            <div class="modal-buttons" style="justify-content: space-between; margin-bottom: 15px;">
                <button class="modal-btn modal-btn-primary" id="batch-favorite-function"><i class="fas fa-layer-group"></i> 批量收藏</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-favorites">关闭</button>
            </div>
            <div class="favorites-list" id="favorites-list"></div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-chart-bar"></i><span>消息统计</span></div>
            <div class="stats-content" id="stats-content"></div>
            <div class="modal-buttons"><button class="modal-btn modal-btn-secondary" id="close-stats">关闭</button></div>
        </div>    
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-comments"></i><span>会话管理</span></div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> 新建会话</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-star-and-crescent"></i><span>今日运势</span></div>
            <div id="fortune-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="share-fortune">分享运势</button>
                <button class="modal-btn modal-btn-secondary" id="close-fortune">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-comment-dots"></i><span>自定义回复</span></div>
            <div class="custom-replies-list" id="custom-replies-list"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="add-custom-reply"><i class="fas fa-plus"></i> 添加回复</button>
                <button class="modal-btn modal-btn-secondary" id="close-custom-replies">关闭</button>
            </div>
        </div>
    </div>

    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">
                <!-- 正面 -->
                <div class="coin-face coin-front">
                    <div class="coin-text-main">是</div>
                    <div class="coin-text-sub">YES</div>
                </div>
                <!-- 反面 -->
                <div class="coin-face coin-back">
                    <div class="coin-text-main">否</div>
                    <div class="coin-text-sub">NO</div>
                </div>
            </div>
        </div>
        
        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>

        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">取消</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> 再来一次</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">发送结果</button>
        </div>
</div>
    <div class="modal" id="disclaimer-modal">
    <div class="modal-content">
        <div class="modal-title"><i class="fas fa-scroll"></i><span>关于 & 声明</span></div>
        <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">
            <!-- 这里是原来的感谢声明，现在移动到了这里 -->
            <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                <h3 style="color: var(--accent-color); margin-bottom: 10px;">特别鸣谢</h3>
                <p>感谢 <strong>@苏铂潼</strong></p>
                <p style="font-size: 12px; opacity: 0.8;">小红书号：9568228497</p>
                <p style="font-size: 12px; margin-top: 5px; font-style: italic;">(聊天统计部分代码参考)</p>
            </div>

            <div style="margin-top: 15px;">
                <p style="font-weight: bold; color: var(--text-primary); text-align: center;">原创：小红书 @milk (1149615009)</p>
                <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">此代码绝对禁止商用和盈利行为，一旦发现追究到底</p>
                <p style="text-align: center; margin-bottom: 15px;">支持二改二传，感谢使用！</p>
                
                <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>反对性别暴力</b></li>
                <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>尊重不该是奢求,安全必须是底线</b></li>
            </div>
        </div>
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="modal-btn modal-btn-primary" id="accept-disclaimer" style="width: 100%;">关闭</button>
        </div>
    </div>
</div>
    <!-- 重要日模态框 -->
    <div class="modal" id="anniversary-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-calendar-alt"></i><span>纪念日管理</span></div>
            
            <div id="anniversary-display" style="text-align: center; padding: 20px 0; display: none;">
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;">我们已经相识</div>
                <div id="anniversary-days" style="font-size: 48px; font-weight: bold; color: var(--accent-color); font-family: 'Georgia', serif;">0</div>
                <div style="font-size: 14px; color: var(--text-secondary);">天</div>
                <div id="anniversary-date-show" style="margin-top: 10px; font-size: 12px; opacity: 0.7;"></div>
            </div>

            <div class="anniversary-list" id="anniversary-list"></div>

            <div style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">添加新纪念日</div>
                
                <!-- 纪念日类型选择器 -->
                <div class="anniversary-type-selector">
                    <button class="anniversary-type-btn active" data-type="anniversary">纪念日</button>
                    <button class="anniversary-type-btn" data-type="countdown">倒数日</button>
                </div>
                
                <input type="text" class="modal-input" id="anniversary-name-input" placeholder="纪念日名称">
                <input type="date" class="modal-input" id="anniversary-date-input">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    <span id="anniversary-type-hint">纪念日：从过去某天到今天的天数</span>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-anniversary">关闭</button>
                <button class="modal-btn modal-btn-primary" id="save-anniversary">保存日期</button>
                <button class="modal-btn modal-btn-primary" id="add-anniversary">添加纪念日</button>
            </div>
        </div>
    </div>

    <!-- 纪念日动画 -->
    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">纪念日快乐！</div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">0</div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">我们已经相伴了这么多天</div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">关闭</button>
            </div>
        </div>
    </div>
<!-- 音乐播放器组件 -->
    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="点击展开">
            <div class="vinyl-record">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z"/></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="收起"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></div>
            <div class="track-info">
                <div class="track-name" id="music-title">Loading...</div>
                <div class="track-sub" id="music-subtitle">...</div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="切换模式">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>
<!-- 添加歌曲模态框 -->
    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-music"></i><span>添加自定义歌曲</span></div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="歌曲名称 (例如: 这里的风景)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="歌手/备注 (例如: 你的名字)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="音频链接 (mp3/m4a 链接)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">取消</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">添加播放</button>
            </div>
        </div>
    </div>

    <script>
        const APP_PREFIX = 'CHAT_APP_V3_';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        const MAX_AVATAR_SIZE = 2 * 1024 * 1024;
        const MESSAGES_PER_PAGE = 50;

        const CONSTANTS = {
            HEADER_MOTTOS: [
                "那么你的爱是我最好的补充剂", "⋆⁺₊⋆ ☾ ⋆⁺₊⋆ 思念的电波已连接 ⋆⁺₊⋆ ☾ ⋆⁺₊⋆", "我们是彼此的宇宙回响", "所有思绪，都奔向你", "答案很长，我准备用一生来回答",
                "月色真美", "一期一会", "念念不忘，必有回响", "山有木兮木有枝", "今晚月色真美",
                "春风十里不如你", "心有猛虎，细嗅蔷薇", "人间有味是清欢", "斯人若彩虹，遇上方知有",
                "You are my sunshine", "I love you three thousand", "What is essential is invisible to the eye", "Carpe diem", "To be or not to be",
                "永遠の一瞬", "君の名は", "世界が終わるまでは", "さようなら、ありがとう", "君と会えてよかった",
                "人生若只如初见", "当时只道是寻常", "曾经沧海难为水", "此情可待成追忆", "似此星辰非昨夜",
                "The best is yet to come", "All you need is love", "Let it be", "Here comes the sun", "Yesterday once more",
                "春はあけぼの", "物の哀れ", "わびさび", "花は桜木人は武士", "一期一会","山有木兮木有枝", "心悦君兮君不知",  "风起于青萍之末", "云卷云舒", "花开花落", "月圆月缺", "潮起潮落",
                "心有灵犀一点通", "言有尽而意无穷","风乍起，吹皱一池春水", "云无心以出岫", "花自飘零水自流", "月是故乡明", "潮平两岸阔",
                "心有千千结", "言不尽意", "此时此夜难为情", "欲语泪先流", "千山万水",
                "风萧萧兮易水寒", "云淡风轻", "花好月圆", "月落乌啼霜满天", "潮落夜江斜月里",
                "心之所向，素履以往", "言为心声", "此情可待成追忆", "欲穷千里目", "千里共婵娟"
            ],
            WELCOME_ANIMATIONS: [
                { line1: "♡ 爱 ♡", line2: "✧ 正在连接我们的思绪 ✧" }, 
                { line1: "𝑳𝒐𝒗𝒆", line2: "若要由我来谈论爱的话" }, 
                { line1: "𝕰𝖈𝖍𝖔", line2: "听见我的回音了吗？" }, 
                { line1: "𝚂𝚘𝚞𝚕𝚖𝚊𝚝𝚎", line2: "灵魂正在共振" }, 
                { line1: "Akashic Eye", line2: "链接已建立" },
                { line1: "✦ 相遇 ✦", line2: "在万千人海中遇见你" }, 
                { line1: "詩篇", line2: "为你写下的每一行诗" }, 
                { line1: "Melody", line2: "心跳的旋律为你奏响" }, 
                { line1: "Destiny", line2: "命运的红线将我们相连" }, 
                { line1: "Memory", line2: "创造属于我们的回忆" },
                { line1: "言葉", line2: "想传达给你的话语" }, 
                { line1: "絆", line2: "看不见的羁绊" }, 
                { line1: "未来", line2: "一起走向的未来" }, 
                { line1: "希望", line2: "你就是我的希望" }, 
                { line1: "光", line2: "你是我生命中的光" },
{ line1: "Amore", line2: "心跳漏拍的那一秒" },
{ line1: "共振", line2: "频率相同的两个灵魂" },
{ line1: "∞", line2: "无限循环的思念" },
{ line1: "Serendipity", line2: "最美丽的意外" },
{ line1: "浮世", line2: "沉浮人世间的温柔" },
{ line1: "量子纠缠", line2: "超越距离的默契" },
{ line1: "Elysian", line2: "与你共度的理想乡" },
{ line1: "星轨", line2: "交汇时互放的光亮" },
{ line1: "虹色", line2: "折射出所有的可能" },
{ line1: "Paracosm", line2: "共同构建的私宇宙" },
{ line1: "潮汐", line2: "因你而起的律动" },
{ line1: "Æther", line2: "弥漫在空气中的悸动" },
{ line1: "双星", line2: "彼此环绕的永恒舞蹈" },
{ line1: "绯色", line2: "染上脸颊的温度" },
{ line1: "Symphony", line2: "生命交织的乐章" },
{ line1: "经纬", line2: "注定相遇的坐标" },
{ line1: "Nebula", line2: "朦胧而璀璨的心事" },
{ line1: "时雨", line2: "恰到好处的温柔" },
{ line1: "Event Horizon", line2: "再也无法逃离的引力" },
{ line1: "花火", line2: "刹那即永恒的光芒" },
{ line1: "ℰ𝓉𝑒𝓇𝓃𝒶𝓁", line2: "时间停驻的此刻" },
{ line1: "韶光", line2: "与你共度的每寸光阴" },
{ line1: "𝒮𝓊𝓂𝓂𝑒𝓇", line2: "永不结束的盛夏" },
{ line1: "星霜", line2: "共同经历的岁月" },
{ line1: "𝓚𝓲𝓼𝓼", line2: "未说出口的告白" },
{ line1: "月下", line2: "两人独处的夜晚" },
{ line1: "𝓕𝓸𝓻𝓮𝓿𝓮𝓻", line2: "想要延续的永远" },
{ line1: "朝露", line2: "晶莹剔透的真心" },
{ line1: "𝓜𝓲𝓻𝓪𝓬𝓵𝓮", line2: "你就是奇迹本身" },
{ line1: "春风", line2: "轻轻拂过的温柔" },
{ line1: "𝓛𝓾𝓬𝓴𝔂", line2: "此生最大的幸运" },
{ line1: "萤火", line2: "黑暗中指引的光" },
{ line1: "𝓗𝓮𝓪𝓻𝓽", line2: "为你跳动的心脏" },
{ line1: "初雪", line2: "纯洁无瑕的爱意" },
{ line1: "𝓒𝓸𝓶𝓮𝓽", line2: "划过天际的相遇" },
{ line1: "潮鸣", line2: "内心澎湃的声音" },
{ line1: "𝓢𝓽𝓪𝓻𝓭𝓾𝓼𝓽", line2: "散落在身的星尘" },
{ line1: "梧桐", line2: "等待凤凰的执着" },
{ line1: "𝓟𝓻𝓮𝓬𝓲𝓸𝓾𝓼", line2: "视若珍宝的你我" },
{ line1: "青空", line2: "澄澈如你的眼眸" },
{ line1: "𝒜𝓂𝒶𝓇𝓃𝓉𝒽", line2: "永不凋零的心意" },
{ line1: "Étoile", line2: "你是我唯一的星辰" },
{ line1: "𝑩𝒍ü𝒕𝒆", line2: "悄然绽放的恋慕" },
{ line1: "運命", line2: "避无可避的相遇" },
{ line1: "𝑪𝒆𝒍𝒆𝒔𝒕𝒆", line2: "来自天际的馈赠" },
{ line1: "恋心", line2: "藏不住的悸动" },
{ line1: "𝑺𝒆𝒓𝒂𝒑𝒉", line2: "守护你的六翼天使" },
{ line1: "一期一会", line2: "一生一次的邂逅" },
{ line1: "𝑬𝒑𝒐𝒏𝒂", line2: "穿越时空的眷恋" },
{ line1: "月の雫", line2: "月光凝成的泪滴" },
{ line1: "𝑽𝒆𝒓𝒔𝒂𝒊𝒍𝒍𝒆𝒔", line2: "为你建造的宫殿" },
{ line1: "千夜一夜", line2: "诉不尽的夜话" },
{ line1: "𝑴𝒂𝒓é𝒆", line2: "温柔席卷的浪潮" },
{ line1: "桃源郷", line2: "只属于两人的乐土" },
{ line1: "𝑺𝒐𝒖𝒇𝒇𝒍𝒆𝒓", line2: "甜蜜的折磨" },
{ line1: "桜吹雪", line2: "纷飞如雪的思念" },
{ line1: "𝑨𝒖𝒓𝒐𝒓𝒆", line2: "黎明前的极光" },
{ line1: "十六夜", line2: "最圆满的夜晚" },
{ line1: "𝑪𝒚𝒂𝒏𝒐𝒑𝒉𝒚𝒍𝒍𝒆", line2: "青涩的恋之叶" },
{ line1: "金木犀", line2: "秋日里暗香浮动" },
            ],
            EMPTY_STATE_TEXTS: [
                "由此开始我们的传闻", "✦ 我们的故事，始于此刻 ✦", "说点什么，让故事发生", "所有伟大的交流都始于一声你好",
                "在这里写下我们的故事", "等待你的第一句话", "让对话开始吧", "从此刻开始连接",
                "等待你的讯息", "开始我们的对话", "第一句话总是最难的", "勇敢说出你想说的"
            ],
            INPUT_PLACEHOLDERS: [
                "⋆ ᧔ෆ᧓ ⋆", "♡ 让心意相通...", "你的想法是...", "在此处输入讯息...", "聊聊天吧...",
                "想对你说的话...", "输入你的消息...", "分享你的想法...", "有什么想说的吗？", "开始输入...",
                "此时无声胜有声", "欲语还休", "千言万语",
            ],
            
            // 随机图标数组 - 使用Font Awesome矢量图标
            WELCOME_ICONS: [
                "fas fa-heart", "fas fa-star", "fas fa-moon", "fas fa-sun", "fas fa-cloud",
                "fas fa-feather", "fas fa-book", "fas fa-music", "fas fa-pen", "fas fa-key",
                "fas fa-compass", "fas fa-globe", "fas fa-leaf", "fas fa-water", "fas fa-fire",
                "fas fa-snowflake", "fas fa-umbrella", "fas fa-anchor", "fas fa-bell", "fas fa-gem",
                "fas fa-crown", "fas fa-dragon", "fas fa-feather-alt", "fas fa-fish", "fas fa-frog",
                "fas fa-hat-wizard", "fas fa-magic", "fas fa-ring", "fas fa-scroll", "fas fa-shield-alt",
                "fas fa-dove", "fas fa-cat", "fas fa-dog", "fas fa-horse", "fas fa-otter",
                "fas fa-paw", "fas fa-spider", "fas fa-kiwi-bird", "fas fa-crow", "fas fa-dove",
                "fas fa-seedling", "fas fa-tree", "fas fa-mountain", "fas fa-water", "fas fa-wind",
                "fas fa-volcano", "fas fa-meteor", "fas fa-satellite", "fas fa-rocket", "fas fa-user-astronaut"
            ],
           
            PARTNER_STATUSES: ["在线","忙碌","离开","思考","听音乐","阅读","工作","学习","想你","休息","睡觉","晒太阳","晴天","多云","阴天","小雨","中雨","大雨","雷阵雨","暴雨","小雪","中雪","大雪","暴雪","雾天","大雾","清晨","晌午","休息","夜晚","深夜","探索","沉思","等待","玩游戏","发呆","吃饭","下午茶","甜点","撸猫","撸狗","牵挂","健身","惊醒","惊讶","空虚","坚定","迷茫","忐忑","惆怅","思念","安心","不舍","冷静","难言","失眠","疲倦","空白","补充","迟疑","依恋","洗漱","压抑","交友","帮助","梦境","祝福","回家","生气","撒娇","吃醋","快乐","幸福","聊天","陪我","占有","赚钱","保护","混乱","生病","听雨","看手机","处理公务","开会中","训练"],
            REPLY_MESSAGES: ["喜欢","不喜欢","在吗？","今天过得怎么样？","想你","晚安","看到记得回复🥲","好的👌🏻","明白","谢谢","不客气","嗯","嗯嗯","哈哈哈哈","真的吗？","我明白了","我相信你","稍等","马上","好哦","不错","可以","同意","理解","我同意","我不同意","我在","在探索过程中","怎么了？","听懂了","今天的天气不错","记下了","收到","会尽快查看的","误会我了","没有我想说的","对不起","没关系","我爱你","让我想想怎么回答","眼花缭乱了","很有创意","保持联系","有什么计划吗？","接下来准备做什么？","我很想听听你的想法","我愿意","不用","记得吃饭","不要熬夜","该如何解决？","不要担心","一切都会好起来的","我很难过","惊醒了，睡不着","这对我来说是个新领域","发生了什么？","在看什么？","在工作吗？","在学习吗？","然后呢？","摸摸🫳🏻","在学习一些新东西","换个想法吧？","晚饭吃了吗？","作息混乱","我","你","ta","下次可以试试","我也是这么想的","你说得对","有没有可能……","我陪你","我会在你身边","我喜欢","我无法决定","我无法控制","要用一下塔罗吗？","看见我的暗号了吗？","贴贴","我知道你的意思","我也如此","出去透透气","话说怎么会这样？","以后不会了","一直如此","别怕","有我在","晚上好","早上好","中午好","好困","有点饿","想吃什么？","哄我","陪我","聊聊天吧","不是这个意思","等一下","照顾好自己","我会的","在喝酒","早点睡","你是我的","我是你的","我希望你自由","粘人精","怎么啦！","永远在一起","我支持你","别听","又在怀疑吗？","多喝水哦","不舒服？","再见","别走","再发一遍","可恶的网站","我觉得都可以","戳戳","非常难用","不许看别人","不要吵架","我知道的","上游戏","你会离开我吗？","来了","嗯哼","哼哼","我想靠近你","我会监督你的","小心些","终于想起我了？","是的","不是","你无人可及","我无人可及","这个不能说","在你身边就好了","在磨合","你需要我吗？","我需要你","寻找中","我做不到欺骗你","话非本意","如果我说是呢","如果我说不是呢","话太少了，没我想说的","太短啦！","看手机","遇到困难了","在努力了","好累","命定如此","喜欢帅一点还是萌一点？","帅气","就这个","受限制了","要下雨了","人工服务请按1","逗一下你","要多交一些朋友","帮帮我","每日行一善","我生气了","撒个娇，理理我？","吃醋怎么了，就爱吃醋！","快乐","聊会儿天","赚钱赚钱","我保护你","信息有点混乱","别生病","哄哄你","吃过了","还没吃","才不听","想吃","吃水果","嗯，吃的是主食","下午茶！","好吃爱吃","别叹气","不好","少吃外卖","最近还好吗？","这个消息不错","我希望能帮上忙","或者我们可以换个想法？","你最近在忙些什么呢？","你有什么计划吗？","我想我们应该讨论一下这个问题","告诉我更多","你认为下一步是什么？","你有什么建议吗？","让我们一起努力","过得怎么样？","期待🤧","你希望我是谁？","抱歉🥺","了解","OK","没问题","当然","确实","没错","好呀","我正在忙，稍后回复你","信号不太好，可能回复会延迟","让我确认一下信息再给你准确答复","别走，陪陪我","你会永远爱我吗？","此刻我想和你永远在一起","他朝若是同淋雪，此生也算共白头","怜悯我，然后爱我吧","撒娇，你会喜欢吗？","没有我想说的","链接有些混乱","就这样撒娇🥺","不太习惯这个","不是的","多看看我吧","可爱","当然了","正在熬夜","失眠了","不可以","我现在不忙，有空的","你现在忙吗？","正在打架","坐等回复","才不是这样","就是这样","还好吗？","多笑笑吧","没能帮上忙","几天后","几个小时后","很久之后","我很想安慰你","我没有在欺骗你","别怀疑我的存在","我真的在","真的是我","我不是很适应这个,但我在努力","想要新衣服","不需要新衣服","消息很混乱","之前总是这样","开心(*⌒∇⌒*)","没能陪在你身边","链接很通顺","我真没招了","不能说","可不可以只看着我","只许看着我","在和谁聊天？","看得懂的","看不懂","在尝试控制了","和代码搏斗中！","我会看着你的","我会陪伴在你身边","痛痛","被吓到了？","想和你一起听歌","走路不要看手机","别看小红书了","别看抖音了","打过代码了！","多穿点衣服","叫我做什么？","想我了吗？","给我写写信吧","有的","没有的","稍等，在工作","在交替回复","我要哭了！","手写信","电子信","第一个","第二个了","安慰我","离家出走","纵容","我喜欢你","我这里是早上","我这里是中午","我这里是下午","我这里是夜晚","一样的","需要多久呢","要多久之后","聊到一半就跑","乖孩子","坏孩子","为什么","你没有正面回答","因为喜欢你所以需要你","看到信了","美好的象征","惊讶","想吃掉你","想要更近一步地贴贴","想触碰你","想要亲亲","捏捏后颈","夜深了","禁果好吃爱吃","欲望大怎么了，就要！","白日正好宣淫","很热吗？忍一忍","你很调皮","不乖","需要教训一下","做的很好宝宝","明明就想要不是吗？","好乖好乖，亲一-亲","喜欢你，所以时时-刻刻都需要你","喜欢温柔一点还是粗暴一点呢？","无需顾忌","那就直白一点，我想要与你一起","鱼水之欢","颠鸾倒凤","好吧就是想做了","捏捏耳垂","十指相扣","好黏人，要更深入一点吗？","肚子疼？帮你揉揉","这里喜欢吗？","我很想要亲亲欸🥺","揉揉","很软，很漂亮","害羞吗？会习惯的","你会喜欢的","简直就是木头","很饿，但不想吃别的…你能明白吗","水灵灵的、我喜欢的、最好的你"],
            REPLY_EMOJIS: ["🥹", "🥲", "☺️", "😇", "😉", "😌", "🥰", "😗", "😋", "🤨", "🧐", "😎", "🙂‍↔️", "🥳", "😏", "🥰💕", "🙂‍↕️", "😞", "☹️", "😣", "😖", "😫", "🥺", "😠", "🤯", "😳", "😶‍🌫️", "😥", "🤔","🫢","🫡","🤫","🫠","😶","😐","🫨","😯","🥱","😴","🤤","😮‍💨","🤧","😈","👿","😼","😽","🫶🏻","🤲🏻","👏🏻","👍🏻","👎🏻","✌🏻","👌🏻","🤏🏻","🐼","🐻‍❄️","🐨","🐯","🦁","🐣","🦅","🐦‍⬛","🪿","🫳🏻","👉🏻👈🏻","👋🏻","💪🏻","✍🏻","🙏🏻","🫂","🐶","🐱"],
            
            // 新增拍一拍动作
            POKE_ACTIONS: [
                `拍了拍我的头说你好可爱`,
                `戳了戳我的腰`,
                `从背后抱住了我`,
                `轻轻捏了捏我的脸`,
                `给我发了一个爱心`,
                `摸了摸我的头发`,
                `悄悄亲了一下我的脸颊`,
                `给我递了一杯热茶`,
                `为我披上外套`,
                `牵起了我的手`,
                `给我一个温暖的拥抱`,
                `轻轻拍了拍我的肩膀`,
                `给我发送了一个飞吻`,
                `调皮地戳了戳我的额头`,
                `给我发送了一个星星`,
                `轻轻拍了拍我的背`,
                `给我发送了一个月亮`,
                `温柔地摸了摸我的头`,
                `给我发送了一个太阳`,
                `开心地拍了拍手`
            ],
            
            // 运势内容
            
            TAROT_CARDS: [
                { name: "愚人", eng: "The Fool", meaning: "新的开始、冒险、天真、无畏", keyword: "流浪", icon: "fa-hiking" },
                { name: "魔术师", eng: "The Magician", meaning: "创造力、技能、意志力、化腐朽为神奇", keyword: "创造", icon: "fa-hat-wizard" },
                { name: "女祭司", eng: "The High Priestess", meaning: "直觉、潜意识、神秘、智慧", keyword: "智慧", icon: "fa-book-open" },
                { name: "皇后", eng: "The Empress", meaning: "丰饶、母性、自然、感官享受", keyword: "丰收", icon: "fa-seedling" },
                { name: "皇帝", eng: "The Emperor", meaning: "权威、结构、控制、父亲形象", keyword: "支配", icon: "fa-crown" },
                { name: "教皇", eng: "The Hierophant", meaning: "传统、信仰、教导、精神指引", keyword: "援助", icon: "fa-church" },
                { name: "恋人", eng: "The Lovers", meaning: "爱、和谐、关系、价值观的选择", keyword: "结合", icon: "fa-heart" },
                { name: "战车", eng: "The Chariot", meaning: "意志力、胜利、决心、自我控制", keyword: "胜利", icon: "fa-horse-head" },
                { name: "力量", eng: "Strength", meaning: "勇气、耐心、控制、内在力量", keyword: "意志", icon: "fa-fist-raised" },
                { name: "隐士", eng: "The Hermit", meaning: "内省、孤独、寻求真理、指引", keyword: "探索", icon: "fa-lantern" }, // 需要确保有这个图标，或者用 fa-lightbulb
                { name: "命运之轮", eng: "Wheel of Fortune", meaning: "循环、命运、转折点、运气", keyword: "轮回", icon: "fa-dharmachakra" },
                { name: "正义", eng: "Justice", meaning: "公正、真理、因果、法律", keyword: "均衡", icon: "fa-balance-scale" },
                { name: "倒吊人", eng: "The Hanged Man", meaning: "牺牲、新的视角、等待、放下", keyword: "奉献", icon: "fa-user-injured" }, // 或者 fa-anchor
                { name: "死神", eng: "Death", meaning: "结束、转变、重生、放手", keyword: "结束", icon: "fa-skull" },
                { name: "节制", eng: "Temperance", meaning: "平衡、适度、耐心、调和", keyword: "净化", icon: "fa-glass-whiskey" }, // 象征调和
                { name: "恶魔", eng: "The Devil", meaning: "束缚、物质主义、欲望、诱惑", keyword: "诱惑", icon: "fa-link" },
                { name: "高塔", eng: "The Tower", meaning: "突变、混乱、启示、破坏", keyword: "毁灭", icon: "fa-gopuram" }, // 近似塔
                { name: "星星", eng: "The Star", meaning: "希望、灵感、平静、治愈", keyword: "希望", icon: "fa-star" },
                { name: "月亮", eng: "The Moon", meaning: "幻觉、恐惧、焦虑、潜意识", keyword: "不安", icon: "fa-moon" },
                { name: "太阳", eng: "The Sun", meaning: "快乐、成功、活力、清晰", keyword: "生命", icon: "fa-sun" },
                { name: "审判", eng: "Judgement", meaning: "复活、觉醒、号召、决定", keyword: "复活", icon: "fa-bullhorn" },
                { name: "世界", eng: "The World", meaning: "完成、整合、成就、圆满", keyword: "达成", icon: "fa-globe-americas" }
            
                ]
            };
        

        let SESSION_ID = null;
        let sessionList = [];
        let messages = [];
        let settings = {};
        let isBatchMode = false;
        let batchMessages = [];
        let currentReplyTo = null;
        let lastCoinResult = null;
        let currentNoteMessageId = null;
        let saveTimeout;
// --- 沉浸式滚动变量 ---
let displayedMessageCount = 20; // 当前显示多少条
const HISTORY_BATCH_SIZE = 20;  // 每次下拉加载多少条
let isLoadingHistory = false;   // 是否正在加载中
        let isBatchFavoriteMode = false;
        let selectedMessages = [];
        let customReplies = [];
        let anniversaries = [];
        let currentAnniversaryType = 'anniversary'; // 'anniversary' 或 'countdown'

        const DOMElements = {
            html: document.documentElement,
            chatContainer: document.getElementById('chat-container'), 
            messageInput: document.getElementById('message-input'), 
            sendBtn: document.getElementById('send-btn'), 
            attachmentBtn: document.getElementById('attachment-btn'), 
            imageInput: document.getElementById('image-input'), 
            themeToggle: document.getElementById('theme-toggle'), 
            batchBtn: document.getElementById('batch-btn'), 
            continueBtn: document.getElementById('continue-btn'), 
            pokeBtn: document.getElementById('poke-btn'),
            coinTossOverlay: document.getElementById('coin-toss-overlay'),
            animatedCoin: document.getElementById('animated-coin'),
            coinResultText: document.getElementById('coin-result-text'),
            cancelCoinResult: document.getElementById('cancel-coin-result'),
            sendCoinResult: document.getElementById('send-coin-result'),
            typingIndicator: document.getElementById('typing-indicator'), 
            emptyState: document.getElementById('empty-state'),
            welcomeAnimation: document.getElementById('welcome-animation'),
            batchPreview: document.getElementById('batch-preview'),
            replyPreviewContainer: document.getElementById('reply-preview-container'),
            pagination: document.getElementById('pagination'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            editModal: { modal: document.getElementById('edit-modal'), title: document.getElementById('edit-modal-title'), input: document.getElementById('name-input'), cancel: document.getElementById('cancel-edit'), save: document.getElementById('save-name') },
            avatarModal: { modal: document.getElementById('avatar-modal'), title: document.getElementById('avatar-modal-title'), input: document.getElementById('avatar-input'), cancel: document.getElementById('cancel-avatar'), save: document.getElementById('save-avatar') },
            noteModal: { modal: document.getElementById('note-modal'), input: document.getElementById('note-input'), cancel: document.getElementById('cancel-note'), save: document.getElementById('save-note') },
            pokeModal: { modal: document.getElementById('poke-modal'), input: document.getElementById('poke-input'), cancel: document.getElementById('cancel-poke'), save: document.getElementById('send-poke') },
            settingsModal: { 
                modal: document.getElementById('settings-modal'), 
                settingsBtn: document.getElementById('settings-btn'), 
                cancel: document.getElementById('cancel-settings')
            },
            favoritesModal: { modal: document.getElementById('favorites-modal'), favoritesBtn: document.getElementById('favorites-btn'), list: document.getElementById('favorites-list'), cancel: document.getElementById('cancel-favorites') },
            statsModal: { modal: document.getElementById('stats-modal'), content: document.getElementById('stats-content'), closeBtn: document.getElementById('close-stats') },
            sessionModal: { modal: document.getElementById('session-modal'), managerBtn: document.getElementById('session-manager-btn'), list: document.getElementById('session-list'), createBtn: document.getElementById('create-new-session'), cancelBtn: document.getElementById('cancel-session') },
            fortuneModal: { modal: document.getElementById('fortune-modal'), content: document.getElementById('fortune-content'), shareBtn: document.getElementById('share-fortune'), closeBtn: document.getElementById('close-fortune') },
            customRepliesModal: { modal: document.getElementById('custom-replies-modal'), list: document.getElementById('custom-replies-list'), addBtn: document.getElementById('add-custom-reply'), closeBtn: document.getElementById('close-custom-replies') },
            backgroundInput: document.getElementById('background-input'),
            importInput: document.getElementById('import-input'),
            partner: { name: document.getElementById('partner-name'), avatar: document.getElementById('partner-avatar'), status: document.getElementById('partner-status').querySelector('span') },
            me: { name: document.getElementById('my-name'), avatar: document.getElementById('my-avatar'), statusContainer: document.getElementById('my-status-container'), statusText: document.getElementById('my-status-text') },
            anniversaryModal: { 
                modal: document.getElementById('anniversary-modal'), 
                closeBtn: document.getElementById('close-anniversary'), 
                saveBtn: document.getElementById('save-anniversary'),
                addBtn: document.getElementById('add-anniversary'),
                dateInput: document.getElementById('anniversary-date-input'),
                nameInput: document.getElementById('anniversary-name-input'),
                displayArea: document.getElementById('anniversary-display'), 
                daysElement: document.getElementById('anniversary-days'), 
                dateShowElement: document.getElementById('anniversary-date-show'),
                list: document.getElementById('anniversary-list'),
                typeHint: document.getElementById('anniversary-type-hint')
            },
            anniversaryAnimation: {
                modal: document.getElementById('anniversary-animation'),
                title: document.getElementById('anniversary-animation-title'),
                days: document.getElementById('anniversary-animation-days'),
                message: document.getElementById('anniversary-animation-message'),
                closeBtn: document.getElementById('close-anniversary-animation')
            },
            appearanceModal: { modal: document.getElementById('appearance-modal'), closeBtn: document.getElementById('close-appearance') },
            chatModal: { modal: document.getElementById('chat-modal'), closeBtn: document.getElementById('close-chat') },
            advancedModal: { modal: document.getElementById('advanced-modal'), closeBtn: document.getElementById('close-advanced') },
            dataModal: { modal: document.getElementById('data-modal'), closeBtn: document.getElementById('close-data') }
        };

        // 工具函数
        const safeGetItem = (key) => { try { return localStorage.getItem(key); } catch (e) { console.warn('Failed to read from localStorage:', e); return null; } };
        const safeSetItem = (key, value) => { try { localStorage.setItem(key, value); } catch (e) { console.warn('Failed to write to localStorage:', e); } };
        const safeRemoveItem = (key) => { try { localStorage.removeItem(key); } catch (e) { console.warn('Failed to remove from localStorage:', e); } };

        function getStorageKey(baseKey) {
            if (!SESSION_ID) console.error("Session not initialized!");
            return `${APP_PREFIX}${SESSION_ID}_${baseKey}`;
        }

        function createNewSession(andSwitch = false) {
            const newId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const newSession = {
                id: newId,
                name: `新的对话 ${sessionList.length + 1}`,
                createdAt: new Date().toISOString()
            };
            sessionList.push(newSession);
            safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));
            safeSetItem(`${APP_PREFIX}lastSessionId`, newId);
            if (andSwitch) {
                window.location.hash = newId;
                window.location.reload();
            }
            return newId;
        }

        function initializeSession() {
            const sessionsData = safeGetItem(`${APP_PREFIX}sessionList`);
            sessionList = sessionsData ? JSON.parse(sessionsData) : [];

            const hash = window.location.hash.substring(1);
            if (hash && sessionList.some(s => s.id === hash)) {
                SESSION_ID = hash;
            } else if (sessionList.length > 0) {
                SESSION_ID = safeGetItem(`${APP_PREFIX}lastSessionId`) || sessionList[0].id;
            } else {
                SESSION_ID = createNewSession(false);
            }
            
            safeSetItem(`${APP_PREFIX}lastSessionId`, SESSION_ID);
            history.replaceState(null, null, `#${SESSION_ID}`);
        }

        function clearAllAppData() {
            if (confirm("【高危操作】确定要重置所有会话和设置吗？此操作将清除所有本地数据且无法恢复")) {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(APP_PREFIX)) safeRemoveItem(key);
                    });
                    showNotification('所有数据已重置，页面即将刷新', 'info', 2000);
                    setTimeout(() => { window.location.href = window.location.pathname; }, 2000);
                } catch (e) {
                    showNotification('清除数据失败', 'error');
                }
            }
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotification = document.querySelector('.notification');
            if(existingNotification) existingNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconMap = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
            notification.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('hiding');
                notification.addEventListener('animationend', () => notification.remove());
            }, duration);
        }

        const playSound = (type) => {
            if (!settings.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                if (type === 'send') oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                else if (type === 'favorite') oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                else oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) { console.warn("音频播放失败:", e); }
        };

        const throttledSaveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        };

        function getDefaultSettings() {
            return { 
                partnerName: "对方", myName: "我", myStatus: "在线", partnerStatus: "在线", 
                isDarkMode: false, colorTheme: "gold", soundEnabled: true, 
                typingIndicatorEnabled: true, readReceiptsEnabled: true, replyEnabled: true,
                lastStatusChange: Date.now(), nextStatusChange: 1 + Math.random() * 7,
                fontSize: 16,
                bubbleStyle: 'standard',
                messageFontFamily: "'Noto Serif SC', serif",
                messageFontWeight: 400,
                messageLineHeight: 1.5,
                musicPlayerEnabled: false
            };
        }

        const loadData = () => {
            settings = getDefaultSettings();
            const savedSettings = safeGetItem(getStorageKey('chatSettings'));
            if (savedSettings) try { Object.assign(settings, JSON.parse(savedSettings)); } catch (e) { console.error("解析设置失败:", e); }
            
            const savedMessages = safeGetItem(getStorageKey('chatMessages'));
            if (savedMessages) try {
                messages = JSON.parse(savedMessages).map(m => ({ ...m, timestamp: new Date(m.timestamp) }));
            } catch (e) { console.error("解析消息失败:", e); messages = []; }
            
            // 加载自定义回复
            const savedCustomReplies = safeGetItem(getStorageKey('customReplies'));
            if (savedCustomReplies) try { customReplies = JSON.parse(savedCustomReplies); } catch (e) { console.error("解析自定义回复失败:", e); }
            
            // 加载纪念日
            const savedAnniversaries = safeGetItem(getStorageKey('anniversaries'));
            if (savedAnniversaries) try { anniversaries = JSON.parse(savedAnniversaries); } catch (e) { console.error("解析纪念日失败:", e); }
            
            updateAvatar(DOMElements.partner.avatar, safeGetItem(getStorageKey('partnerAvatar')));
            updateAvatar(DOMElements.me.avatar, safeGetItem(getStorageKey('myAvatar')));
            
            const savedBackground = safeGetItem(getStorageKey('chatBackground'));
            if (savedBackground) applyBackground(savedBackground);
    displayedMessageCount = HISTORY_BATCH_SIZE; 
            
            updateUI();
        };

        const saveData = () => {
            try {
                safeSetItem(getStorageKey('chatMessages'), JSON.stringify(messages));
                safeSetItem(getStorageKey('chatSettings'), JSON.stringify(settings));
                safeSetItem(getStorageKey('customReplies'), JSON.stringify(customReplies));
                safeSetItem(getStorageKey('anniversaries'), JSON.stringify(anniversaries));
                
                const partnerImg = DOMElements.partner.avatar.querySelector('img');
                if (partnerImg) safeSetItem(getStorageKey('partnerAvatar'), partnerImg.src); else safeRemoveItem(getStorageKey('partnerAvatar'));
                const myImg = DOMElements.me.avatar.querySelector('img');
                if (myImg) safeSetItem(getStorageKey('myAvatar'), myImg.src); else safeRemoveItem(getStorageKey('myAvatar'));
            } catch (e) {
                console.error("保存数据失败:", e);
                if (e.name === 'QuotaExceededError') {
                    showNotification('存储空间不足，将清除部分旧消息', 'error', 4000);
                    messages = messages.slice(-100);
                    setTimeout(() => safeSetItem(getStorageKey('chatMessages'), JSON.stringify(messages)), 500);
                }
            }
        };

        function initializeRandomUI() {
    const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    // 1. 随机设置 Header 格言 (保持不变)
    document.querySelector('.header-motto').textContent = getRandomItem(CONSTANTS.HEADER_MOTTOS);
    
    // 2. 随机空状态和输入框 (保持不变)
    DOMElements.emptyState.querySelector('p').innerHTML = getRandomItem(CONSTANTS.EMPTY_STATE_TEXTS);
    const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "..." : placeholder;

    // === 4.0 动画核心逻辑 ===
    
    // A. 生成星空背景
    const starsContainer = document.getElementById('stars-container');
    const starCount = 50; // 星星数量
    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const x = Math.random() * 100;
        const y = Math.random() * 100;
        const size = Math.random() * 2 + 1; // 1-3px
        const duration = Math.random() * 3 + 2; // 2-5s
        const delay = Math.random() * 5;
        
        star.style.left = `${x}%`;
        star.style.top = `${y}%`;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.setProperty('--duration', `${duration}s`);
        star.style.animationDelay = `${delay}s`;
        starsContainer.appendChild(star);
    }

    // B. 随机选择文案
    const welcomeAnim = getRandomItem(CONSTANTS.WELCOME_ANIMATIONS);
    const welcomeIcon = getRandomItem(CONSTANTS.WELCOME_ICONS);
    
    // 更新图标
    document.querySelector('.logo-icon-main').innerHTML = `<i class="${welcomeIcon}"></i>`;

    // C. 文字解密特效 (Scramble Text Effect)
    const titleEl = document.getElementById('welcome-title-glitch');
    const subEl = document.getElementById('welcome-subtitle-scramble');
    
    // 目标文字
    const targetTitle = welcomeAnim.line1; 
    const targetSub = welcomeAnim.line2; // 副标题

    // 解密函数
    const scrambleText = (element, finalText, duration = 1500) => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
        const length = finalText.length;
        let start = Date.now();
        
        const interval = setInterval(() => {
            const now = Date.now();
            const progress = (now - start) / duration;
            
            if (progress >= 1) {
                element.textContent = finalText;
                clearInterval(interval);
                return;
            }
            
            let result = '';
            // 计算当前有多少字符应该显示为最终字符
            const revealIndex = Math.floor(progress * length);
            
            for (let i = 0; i < length; i++) {
                if (i <= revealIndex) {
                    result += finalText[i];
                } else {
                    result += chars[Math.floor(Math.random() * chars.length)];
                }
            }
            element.textContent = result;
        }, 50); // 每50ms更新一次
    };

    // 启动文字动画 (稍微延迟一点)
    setTimeout(() => {
        scrambleText(titleEl, targetTitle, 1200);
        // 副标题稍微晚一点开始
        setTimeout(() => {
            scrambleText(subEl, targetSub, 2000);
        }, 500);
    }, 300);

    // D. 进度条模拟
    const loaderBar = document.getElementById('loader-tech-bar');
    // 模拟不均匀的加载速度，更真实
    setTimeout(() => loaderBar.style.width = '30%', 100);
    setTimeout(() => loaderBar.style.width = '55%', 800);
    setTimeout(() => loaderBar.style.width = '85%', 1800);
    setTimeout(() => loaderBar.style.width = '100%', 2600);
}

        const updateUI = () => {
            DOMElements.html.setAttribute('data-theme', settings.isDarkMode ? 'dark' : 'light');
            DOMElements.html.setAttribute('data-color-theme', settings.colorTheme);
            DOMElements.themeToggle.innerHTML = settings.isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            DOMElements.partner.name.textContent = settings.partnerName;
            DOMElements.me.name.textContent = settings.myName;
            DOMElements.partner.status.textContent = settings.partnerStatus;
            DOMElements.me.statusText.textContent = settings.myStatus;
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            document.documentElement.style.setProperty('--message-font-family', settings.messageFontFamily);
            document.documentElement.style.setProperty('--message-font-weight', settings.messageFontWeight);
            document.documentElement.style.setProperty('--message-line-height', settings.messageLineHeight);
            
            // 更新主题颜色按钮状态
            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
            });
            
            // 更新气泡样式
            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
            });
            
            renderMessages();
        };

        const updateAvatar = (element, src) => { if (src) element.innerHTML = `<img src="${src}" alt="avatar">`; else element.innerHTML = `<i class="fas fa-user"></i>`; };
        const applyBackground = (imageUrl) => { document.documentElement.style.setProperty('--chat-bg-image', `url(${imageUrl})`);
    document.body.classList.add('with-background'); 
};
        const removeBackground = () => { document.documentElement.style.removeProperty('--chat-bg-image');
    document.body.classList.remove('with-background'); 
    safeRemoveItem(getStorageKey('chatBackground')); 
    showNotification('背景图片已移除', 'success'); 
};
        // 【新增】沉浸式渲染函数
// 参数 preserveScroll: true 表示加载历史时保持位置，false 表示发新消息滚到底部
function renderMessages(preserveScroll = false) {
    const container = DOMElements.chatContainer;
    const totalMessages = messages.length;
    
    // 1. 计算要显示的消息范围：从最后面截取 displayedMessageCount 条
    // 如果总数少于要显示的条数，就从 0 开始显示所有
    const startIndex = Math.max(0, totalMessages - displayedMessageCount);
    const msgsToRender = messages.slice(startIndex);

    // 控制空状态（无消息时显示占位图）
    DOMElements.emptyState.style.display = totalMessages === 0 ? 'flex' : 'none';

    // 2. 【关键】记录渲染前的滚动高度和位置
    // 这是实现“无缝加载”的核心，必须在清空容器前记录
    const oldScrollHeight = container.scrollHeight;
    const oldScrollTop = container.scrollTop;

    // 3. 清空容器，准备重绘
    container.innerHTML = '';
    
    const fragment = new DocumentFragment();
    let currentDate = '';

    // 遍历要显示的消息
    msgsToRender.forEach((msg) => {
        // --- 日期分割线逻辑 (保持不变) ---
        const messageDate = new Date(msg.timestamp).toDateString();
        if (messageDate !== currentDate) {
            currentDate = messageDate;
            const dateDivider = document.createElement('div');
            dateDivider.className = 'date-divider';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            const displayDate = (messageDate === today) ? '今天' : (messageDate === yesterday) ? '昨天' : new Date(msg.timestamp).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            dateDivider.innerHTML = `<span>${displayDate}</span>`;
            fragment.appendChild(dateDivider);
        }

        // --- 系统消息逻辑 (保持不变) ---
        if (msg.type === 'system') {
             const systemMsgDiv = document.createElement('div');
             systemMsgDiv.className = 'system-message';
             systemMsgDiv.innerHTML = msg.text;
             fragment.appendChild(systemMsgDiv);
             return;
        }

        // --- 普通消息逻辑 ---
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent' : 'received'} ${isBatchFavoriteMode && msg.favorited ? 'selected' : ''}`;
        wrapper.dataset.id = msg.id;
        
        // 批量收藏模式下的复选框 (保持不变)
        if (isBatchFavoriteMode) {
            const checkbox = document.createElement('div');
            checkbox.className = `batch-favorite-checkbox ${msg.favorited ? 'checked' : ''}`;
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                const messageId = Number(wrapper.dataset.id);
                const index = selectedMessages.indexOf(messageId);
                
                if (index > -1) {
                    selectedMessages.splice(index, 1);
                    checkbox.classList.remove('checked');
                } else {
                    selectedMessages.push(messageId);
                    checkbox.classList.add('checked');
                }
                
                // 更新按钮文本
                const confirmBtn = document.getElementById('confirm-batch-favorite');
                if (confirmBtn) {
                    confirmBtn.textContent = `确认收藏 (${selectedMessages.length})`;
                }
            });
            wrapper.appendChild(checkbox);
        }
        
        // 构建消息内容
        let messageHTML = '';
        if (msg.replyTo) {
            const repliedText = msg.replyTo.text || '[图片]';
            messageHTML += `<div class="reply-indicator"><span style="opacity:0.9; overflow:hidden; text-overflow: ellipsis; white-space:nowrap;">${repliedText}</span></div>`;
        }
        
        let content = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>` : '';
        if (msg.image) content += `<img src="${msg.image}" class="message-image" alt="图片" style="max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="viewImage('${msg.image}')">`;
        messageHTML += content;
        
        if (msg.note) messageHTML += `<div class="message-note">${msg.note}</div>`;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${msg.sender === 'user' ? 'sent' : 'received'} ${settings.bubbleStyle}`;
        messageDiv.innerHTML = messageHTML;

        // 构建时间戳和图标
        let metaHTML = `<div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>`;
        metaHTML += `<button class="favorite-meta-btn ${msg.favorited ? 'favorited' : ''}" title="${msg.favorited ? '取消收藏' : '收藏'}"><i class="fas fa-star"></i></button>`;
        
        if (msg.sender === 'user' && settings.readReceiptsEnabled) {
            const statusIcon = msg.status === 'read' ? 'fa-check-double' : 'fa-check';
            metaHTML += `<div class="read-receipt ${msg.status === 'read' ? 'read' : ''}"><i class="fas ${statusIcon}"></i></div>`;
        }

        const metaDiv = document.createElement('div');
        metaDiv.className = 'message-meta';
        metaDiv.innerHTML = metaHTML;

        // 操作按钮
        let actionsHTML = '';
        if (settings.replyEnabled) actionsHTML += `<button class="meta-action-btn reply-btn" title="回复"><i class="fas fa-reply"></i></button>`;
        actionsHTML += `<button class="meta-action-btn note-btn" title="注释"><i class="fas fa-sticky-note"></i></button>`;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-meta-actions';
        actionsDiv.innerHTML = actionsHTML;
        
        wrapper.append(actionsDiv, messageDiv, metaDiv);
        fragment.appendChild(wrapper);
    });

    DOMElements.chatContainer.appendChild(fragment);
    
    // 4. 【关键】处理滚动位置
    if (preserveScroll) {
        // 场景 A：加载更多历史记录
        // 算出新内容增加了多少高度，把滚动条往下挤同样的高度，视觉上就感觉位置没变
        const newScrollHeight = container.scrollHeight;
        container.scrollTop = newScrollHeight - oldScrollHeight;
    } else {
        // 场景 B：发送新消息 或 刚进入页面
        // 直接滚到最底部，看最新消息
        requestAnimationFrame(() => {
            container.scrollTop = container.scrollHeight;
        });
    }
}
// 【补全】缺失的 addMessage 函数
const addMessage = (message) => { 
    if (!(message.timestamp instanceof Date)) message.timestamp = new Date(message.timestamp);
    messages.push(message); 
    
    // 发送新消息时，增加显示计数，确保它能显示出来
    displayedMessageCount++; 
    
    // 渲染并滚动到底部 (false 表示不保留旧位置，直接滚到底)
    renderMessages(false);
    throttledSaveData();
};

        function optimizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.size < 300 * 1024) {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function sendMessage(textOverride = null, type = 'normal') {
            const text = textOverride || DOMElements.messageInput.value.trim();
            const imageFile = DOMElements.imageInput.files[0];
            if (!text && !imageFile && type === 'normal') return;
            
            DOMElements.messageInput.value = '';
            DOMElements.messageInput.style.height = '46px';
            if (imageFile && imageFile.size > MAX_IMAGE_SIZE) { showNotification('图片大小不能超过5MB', 'error'); DOMElements.imageInput.value = ''; return; }
            
            const createMessage = (imgSrc = null) => {
                const messageData = { 
                    id: Date.now(), 
                    sender: 'user', 
                    text: text || '', 
                    timestamp: new Date(), 
                    image: imgSrc, 
                    status: 'sent', 
                    favorited: false, 
                    note: null, 
                    replyTo: currentReplyTo, 
                    type: type 
                };
                if (type === 'system') messageData.sender = null;
                
                addMessage(messageData);
                if(type !== 'system') playSound('send');
                currentReplyTo = null;
                updateReplyPreview();
                if (!isBatchMode && type === 'normal') setTimeout(simulateReply, 800 + Math.random() * 1200);
            };
            
            if (imageFile) { 
                showNotification('正在优化图片...', 'info', 1500);
                optimizeImage(imageFile).then(createMessage).catch(() => showNotification('图片处理失败', 'error'));
            } else { createMessage(); }
            DOMElements.imageInput.value = '';
        }

        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            DOMElements.batchBtn.classList.toggle('active', isBatchMode);
            DOMElements.batchBtn.title = isBatchMode ? "退出批量模式" : "批量发送模式";
            DOMElements.batchPreview.style.display = isBatchMode ? 'flex' : 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = isBatchMode ? "此刻，想说的有很多很多..." : (placeholder.length > 20 ? placeholder.substring(0, 20) + "..." : placeholder);
            if (isBatchMode) { batchMessages = []; updateBatchPreview(); }
        }

        function addToBatch() {
            const text = DOMElements.messageInput.value.trim();
            if (!text) return;
            batchMessages.push({ id: Date.now() + batchMessages.length, text });
            DOMElements.messageInput.value = ''; DOMElements.messageInput.style.height = '46px'; 
            updateBatchPreview();
        }

        function updateBatchPreview() {
            const previewContainer = DOMElements.batchPreview;
            let listHTML = '';
            if (batchMessages.length > 0) {
                listHTML = batchMessages.map((msg, index) => `
                    <div class="batch-preview-item" data-index="${index}">
                        <span class="batch-preview-text">${msg.text}</span>
                        <button class="batch-preview-remove"><i class="fas fa-times"></i></button>
                    </div>`).join('');
            } else {
                listHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 10px;">˚₊‧꒰𓆩 ♱ 𓆪꒱‧₊˚</div>';
            }

            previewContainer.innerHTML = `
                <div class="batch-preview-title">我有很多的话想说…！</div>
                <div class="batch-preview-list">${listHTML}</div>
                <div class="batch-actions">
                    <button class="batch-action-btn batch-cancel-btn">取消</button>
                    <button class="batch-action-btn batch-send-btn" ${batchMessages.length === 0 ? 'disabled' : ''}>发送全部 (${batchMessages.length})</button>
                </div>`;
        }

        function sendBatchMessages() {
            if (batchMessages.length === 0) return;
            showNotification(`正在发送 ${batchMessages.length} 条消息...`, 'info', 2000);
            batchMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage({ id: Date.now() + index, sender: 'user', text: msg.text, timestamp: new Date(), status: 'sent', favorited: false, type: 'normal' }); 
                    playSound('send');
                }, index * 300);
            });
            setTimeout(simulateReply, batchMessages.length * 300 + 1000 + Math.random() * 2000);
            isBatchMode = false; batchMessages = [];
            DOMElements.batchBtn.classList.remove('active'); DOMElements.batchPreview.style.display = 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "..." : placeholder;
        }

        function simulateReply() {
            let changed = false;
            messages.forEach(msg => { if (msg.sender === 'user' && msg.status !== 'read') { msg.status = 'read'; changed = true; } });
            if(changed) { renderMessages(false); throttledSaveData(); }
            if(settings.typingIndicatorEnabled) { DOMElements.typingIndicator.style.display = 'block'; DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight; }
            
            // 拍一拍逻辑
            if (Math.random() < 0.03) {
                const randomAction = getRandomItem(CONSTANTS.POKE_ACTIONS);
                const pokeTypes = [
                    { prefix: "💫", text: `${settings.partnerName} ${randomAction}` },
                    { prefix: "✨", text: `${settings.partnerName} ${randomAction}` },
                    { prefix: "🌟", text: `${settings.partnerName} ${randomAction}` },
                    { prefix: "🥰", text: `${settings.partnerName} ${randomAction}` },
                    { prefix: "💖", text: `${settings.partnerName} ${randomAction}` }
                ];
                
                const selectedPoke = getRandomItem(pokeTypes);
                addMessage({ 
                    id: Date.now(), 
                    text: `${selectedPoke.prefix} ${selectedPoke.text} ${selectedPoke.prefix}`, 
                    timestamp: new Date(), 
                    type: 'system' 
                });
                DOMElements.typingIndicator.style.display = 'none';
                return;
            }

            const replyCount = Math.random() < 0.75 ? 1 : (Math.random() < 0.95 ? 2 : 3);
            let delay = 0;
            for (let i = 0; i < replyCount; i++) {
                delay += 1500 + Math.random() * 2000;
                setTimeout(() => {
                    let text;
                    // 修复版逻辑：将自定义回复和默认回复混合在一起
                    // 1. 设定 15% 的概率发表情包 (你可以自己改这个 0.15)
                    if (Math.random() < 0.15) {
                        text = getRandomItem(CONSTANTS.REPLY_EMOJIS);
                    } else {
                        // 2. 将“默认回复”和“自定义回复”合并成一个大数组
                        // 这样每一条消息被抽中的概率就是公平的
                        const combinedMessages = [...CONSTANTS.REPLY_MESSAGES, ...customReplies];
                        text = getRandomItem(combinedMessages);
                    }
                    
                    let replyTo = null;
                    if (settings.replyEnabled && Math.random() < 0.1) {
                        const userMessages = messages.filter(m => m.sender === 'user').slice(-10);
                        if (userMessages.length > 0) {
                            const randomMessage = getRandomItem(userMessages);
                            replyTo = { id: randomMessage.id, sender: randomMessage.sender, text: randomMessage.text };
                        }
                    }
                    addMessage({ id: Date.now() + i, sender: 'partner', text, timestamp: new Date(), favorited: false, replyTo, type:'normal' });
                    playSound('message');
                    if (i === replyCount - 1) DOMElements.typingIndicator.style.display = 'none';
                }, delay);
            }
        }

        // 独立的抛硬币动画逻辑
        // 1. 核心动画逻辑：重置 -> 旋转 -> 显示结果
        function startCoinFlipAnimation() {
            const overlay = DOMElements.coinTossOverlay;
            const coin = DOMElements.animatedCoin;
            const resultText = DOMElements.coinResultText;
            
            // A. 重置状态 (移除 finished 类，按钮会瞬间消失)
            overlay.classList.remove('finished');
            coin.classList.remove('flipping-heads', 'flipping-tails');
            
            // B. 强制浏览器重绘 (Force Reflow)，这是“再来一次”能生效的关键！
            void coin.offsetWidth;
            
            // C. 设置初始文案
            resultText.textContent = '命运抉择中...';
            
            // D. 随机计算结果
            const isHeads = Math.random() < 0.5;
            const result = isHeads ? '是' : '否';
            const animationClass = isHeads ? 'flipping-heads' : 'flipping-tails';
            
            // E. 开始动画
            requestAnimationFrame(() => {
                coin.classList.add(animationClass);
            });

            // F. 监听动画结束
            const onAnimationEnd = () => {
                // 动画结束后更新文字
                const fancyText = isHeads ? "答案是 · 是" : "答案是 · 否";
                resultText.textContent = fancyText;
                
                // 记录结果
                lastCoinResult = result;
                
                // 添加 finished 类，触发 CSS 中的按钮浮现和文字变大
                overlay.classList.add('finished');
            };

            // 确保只触发一次事件
            coin.addEventListener('animationend', onAnimationEnd, { once: true });
        }

        // 2. 入口函数：打开遮罩 + 启动动画
        function handleCoinToss() {
            DOMElements.coinTossOverlay.classList.add('visible');
            startCoinFlipAnimation();
        }

        function updateReplyPreview() {
            const previewContainer = DOMElements.replyPreviewContainer;
            previewContainer.innerHTML = '';
            
            if (currentReplyTo) {
                const preview = document.createElement('div');
                preview.className = 'reply-preview';
                const repliedText = currentReplyTo.text || '[图片]';
                preview.innerHTML = `<div class="reply-preview-content">${repliedText}</div><button class="reply-preview-remove"><i class="fas fa-times"></i></button>`;
                preview.querySelector('.reply-preview-remove').addEventListener('click', () => { currentReplyTo = null; updateReplyPreview(); });
                previewContainer.appendChild(preview);
            }
        }

        function renderFavorites() {
            const list = DOMElements.favoritesModal.list;
            const favoritedMessages = messages.filter(m => m.favorited).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (favoritedMessages.length === 0) {
                list.innerHTML = '<div class="no-favorites"><i class="far fa-star"></i><p>还没有收藏的消息</p></div>';
                return;
            }
            list.innerHTML = favoritedMessages.map(msg => {
                let contentHTML = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>` : '';
                if (msg.image) contentHTML += `<img src="${msg.image}" alt="图片">`;
                return `
                    <div class="favorite-item">
                        <div class="favorite-item-meta">
                            <span class="favorite-item-sender">${msg.sender === 'user' ? settings.myName : settings.partnerName}</span>
                            <span>${new Date(msg.timestamp).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="favorite-item-content">${contentHTML}</div>
                    </div>`;
            }).join('');
        }

        function showModal(modalElement, focusElement = null) {
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                const content = modalElement.querySelector('.modal-content');
                content.style.opacity = '1';
                content.style.transform = 'translateY(0) scale(1)';
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 100);
                }
            });
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => { modalElement.style.display = 'none'; }, 300);
        }

        function viewImage(src) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content" style="max-width: 90%; max-height: 90%; background: transparent; box-shadow: none; padding: 0;"><img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;"></div>`;
            const closeModal = () => document.body.removeChild(modal);
            modal.addEventListener('click', closeModal);
            document.body.appendChild(modal);
        }

        function exportChatHistory() {
            try {
                const dataStr = JSON.stringify({ 
                    version: "3.0", 
                    exportDate: new Date().toISOString(), 
                    messages, 
                    settings,
                    customReplies,
                    anniversaries
                }, null, 2);
                
                // 改进的导出方法，支持移动端
                if (navigator.share && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {
                    // 移动端使用 Web Share API
                    const blob = new Blob([dataStr], {type: 'application/json;charset=utf-8'});
                    const file = new File([blob], `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`, { type: 'application/json' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: '聊天记录备份',
                            text: `聊天记录备份 - ${new Date().toLocaleDateString()}`
                        }).then(() => {
                            showNotification('分享成功', 'success');
                        }).catch((error) => {
                            console.error('分享失败:', error);
                            fallbackExport(dataStr);
                        });
                    } else {
                        fallbackExport(dataStr);
                    }
                } else {
                    // 桌面端使用传统方法
                    fallbackExport(dataStr);
                }
            } catch (error) { 
                console.error('导出失败:', error); 
                showNotification('导出失败，请重试', 'error'); 
            }
        }

        function fallbackExport(dataStr) {
            const dataBlob = new Blob([dataStr], {type: 'application/json;charset=utf-8'});
            const url = URL.createObjectURL(dataBlob);
            
            // 创建隐藏的下载链接
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 清理URL
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(`成功导出 ${messages.length} 条消息`, 'success');
        }

        function importChatHistory(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.messages || !Array.isArray(importedData.messages)) throw new Error('无效的聊天记录文件');
                    if (messages.length > 0 && !confirm('导入将覆盖当前会话的聊天记录，确定继续吗？')) return;
                    
                    messages = importedData.messages.map(m => ({ ...m, timestamp: new Date(m.timestamp) }));
                    if (importedData.settings) Object.assign(settings, importedData.settings);
                    if (importedData.customReplies) customReplies = importedData.customReplies;
                    if (importedData.anniversaries) anniversaries = importedData.anniversaries;
                    
                    saveData(); 
                    updateUI();
                    showNotification(`成功导入 ${messages.length} 条消息`, 'success');
                } catch (error) { 
                    console.error('导入失败:', error); 
                    showNotification('文件格式错误或已损坏', 'error'); 
                }
            };
            reader.onerror = () => showNotification('文件读取失败', 'error');
            reader.readAsText(file);
        }

        const checkStatusChange = () => {
            if ((Date.now() - settings.lastStatusChange) / 36e5 >= settings.nextStatusChange) {
                settings.partnerStatus = getRandomItem(CONSTANTS.PARTNER_STATUSES);
                settings.lastStatusChange = Date.now();
                settings.nextStatusChange = 1 + Math.random() * 7;
                DOMElements.partner.status.textContent = settings.partnerStatus; 
                throttledSaveData();
            }
        };

        // 渲染消息统计内容 - 进化版
function renderStatsContent() {
    const statsContent = DOMElements.statsModal.content;
    
    // 1. 数据准备：只统计“对方”发送的有效文本消息
    const partnerMessages = messages.filter(msg => 
        msg.sender === 'partner' && 
        msg.text && 
        msg.type !== 'system'
    );

    // 空状态处理
    if (partnerMessages.length === 0) {
        statsContent.innerHTML = `
            <div class="stats-empty-state">
                <div class="stats-empty-icon"><i class="fas fa-chart-pie"></i></div>
                <h3>暂无数据</h3>
                <p>等待对方发来第一条消息...</p>
            </div>`;
        return;
    }

    // 2. 计算常用回复频率
    const replyCount = {};
    partnerMessages.forEach(msg => {
        // 简单清洗：去除首尾空格，作为统计key
        const text = msg.text.trim();
        if(text) {
            replyCount[text] = (replyCount[text] || 0) + 1;
        }
    });

    // 转换为数组并排序，取 Top 5
    const topReplies = Object.entries(replyCount)
        .map(([text, count]) => ({ text, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

    // 获取最大值，用于计算进度条百分比
    const maxCount = topReplies.length > 0 ? topReplies[0].count : 0;

    // 3. 计算时间跨度
    const firstMsg = partnerMessages[0];
    const lastMsg = partnerMessages[partnerMessages.length - 1];
    
    const formatDate = (dateObj) => {
        return new Date(dateObj).toLocaleDateString('zh-CN', {
            month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit'
        });
    };

    // 4. 构建 HTML
    
    // 4.1 构建 Top 5 列表 HTML
    const rankListHTML = topReplies.map((item, index) => {
        const percent = (item.count / maxCount) * 100;
        return `
            <div class="rank-item">
                <div class="rank-progress-bg" style="width: ${percent}%"></div>
                <div class="rank-info">
                    <div class="rank-number">#${index + 1}</div>
                    <div class="rank-text" title="${item.text}">${item.text}</div>
                    <div class="rank-count">${item.count}次</div>
                </div>
            </div>
        `;
    }).join('');

    // 4.2 组合整体仪表盘
    statsContent.innerHTML = `
        <div class="stats-dashboard">
            
            <!-- 模块1: 核心数据概览 -->
            <div class="stats-overview-grid">
                <div class="overview-item">
                    <div class="overview-value">${partnerMessages.length}</div>
                    <div class="overview-label">总回复数</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value">${customReplies.length}</div>
                    <div class="overview-label">词库容量</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value">${formatDate(firstMsg.timestamp)}</div>
                    <div class="overview-label">初次相遇</div>
                </div>
                <div class="overview-item">
                    <div class="overview-value">${formatDate(lastMsg.timestamp)}</div>
                    <div class="overview-label">最近联络</div>
                </div>
            </div>

            <!-- 模块2: Top 5 排行榜 -->
            <div class="stats-card">
                <div class="stats-card-title">
                    <i class="fas fa-crown"></i> 高频回复 TOP 5
                </div>
                <div class="stats-rank-list">
                    ${rankListHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;">数据积累中...</div>'}
                </div>
            </div>

            
    `;
}

        function renderSessionList() {
            const listContainer = DOMElements.sessionModal.list;
            if(sessionList.length === 0) {
                listContainer.innerHTML = '<div class="stats-empty" style="padding: 20px 0;"><p>还没有会话</p></div>';
                return;
            }
            listContainer.innerHTML = sessionList.map(session => `
                <div class="session-item ${session.id === SESSION_ID ? 'active' : ''}" data-id="${session.id}">
                    <div class="session-info">
                        <div class="session-name">${session.name}</div>
                        <div class="session-meta">创建于 ${new Date(session.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div class="session-actions">
                        <button class="session-action-btn rename" title="重命名"><i class="fas fa-pen"></i></button>
                        <button class="session-action-btn delete" title="删除"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // 新增功能函数
        // 塔罗牌功能：本地存储 + 极简渲染
        function generateFortune() {
            const todayKey = new Date().toDateString(); // 获取今天的日期字符串 (e.g. "Sun Nov 23 2025")
            const storageKey = `${APP_PREFIX}daily_fortune`;
            
            let fortuneData = null;
            const savedData = safeGetItem(storageKey);

            if (savedData) {
                const parsed = JSON.parse(savedData);
                // 如果保存的日期是今天，则使用保存的数据
                if (parsed.date === todayKey) {
                    fortuneData = parsed;
                }
            }

            // 如果没有今天的数据，生成新的
            if (!fortuneData) {
                const cards = CONSTANTS.TAROT_CARDS;
                const randomIndex = Math.floor(Math.random() * cards.length);
                const isUpright = Math.random() > 0.5;
                
                fortuneData = {
                    date: todayKey,
                    cardIndex: randomIndex,
                    isUpright: isUpright
                };
                
                // 保存到本地存储
                safeSetItem(storageKey, JSON.stringify(fortuneData));
            }

            // 渲染界面
            renderFortuneCard(fortuneData);
        }

        // 独立的渲染函数
        function renderFortuneCard(data) {
            const card = CONSTANTS.TAROT_CARDS[data.cardIndex];
            const isUpright = data.isUpright;
            const fortuneContent = DOMElements.fortuneModal.content;
            
            // 极简风格 HTML 结构
            fortuneContent.innerHTML = `
                <div class="fortune-card tarot-style">
                    <div class="tarot-header">DAILY TAROT</div>
                    
                    <div class="tarot-visual ${isUpright ? '' : 'reversed'}">
                        <i class="fas ${card.icon} tarot-icon-vector"></i>
                    </div>

                    <div class="tarot-card-name">${card.name}</div>
                    <div class="tarot-position-badge ${isUpright ? 'upright' : 'reversed'}">
                        ${isUpright ? "正" : "逆"}
                    </div>

                    <div class="tarot-details">
                        <div class="tarot-divider"></div>
                        <div class="tarot-keyword">「${card.keyword}」</div>
                        <div class="fortune-desc">
                            ${card.meaning}
                        </div>
                        <div class="fortune-tip">
                            ${isUpright 
                                ? "保持当下的节奏，顺势而为" 
                                : "也许需要换个角度看待目前的处境"}
                        </div>
                    </div>
                </div>
            `;
            
            // 修改模态框标题
            const modalTitle = DOMElements.fortuneModal.modal.querySelector('.modal-title span');
            if(modalTitle) modalTitle.textContent = "今日指引";

            showModal(DOMElements.fortuneModal.modal);
        }

        function toggleBatchFavoriteMode() {
            isBatchFavoriteMode = !isBatchFavoriteMode;
            selectedMessages = [];
            
            if (isBatchFavoriteMode) {
                document.body.classList.add('batch-favorite-mode');
                showBatchFavoriteActions();
                showNotification('批量收藏模式已开启，点击消息进行选择', 'info');
            } else {
                document.body.classList.remove('batch-favorite-mode');
                hideBatchFavoriteActions();
                showNotification('批量收藏模式已关闭', 'info');
            }
            
            renderMessages(true);
        }

        function showBatchFavoriteActions() {
            const actions = document.createElement('div');
            actions.className = 'batch-favorite-actions';
            actions.innerHTML = `
                <button class="modal-btn modal-btn-primary" id="confirm-batch-favorite">确认收藏 (0)</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-batch-favorite">取消</button>
            `;
            document.body.appendChild(actions);
            
            document.getElementById('confirm-batch-favorite').addEventListener('click', confirmBatchFavorite);
            document.getElementById('cancel-batch-favorite').addEventListener('click', toggleBatchFavoriteMode);
        }

        function hideBatchFavoriteActions() {
            const actions = document.querySelector('.batch-favorite-actions');
            if (actions) {
                actions.remove();
            }
        }

        function confirmBatchFavorite() {
            selectedMessages.forEach(msgId => {
                const message = messages.find(m => m.id === msgId);
                if (message) {
                    message.favorited = true;
                }
            });
            
            throttledSaveData();
            toggleBatchFavoriteMode();
            showNotification(`已收藏 ${selectedMessages.length} 条消息`, 'success');
        }

        function renderCustomReplies() {
            const list = DOMElements.customRepliesModal.list;
            if (customReplies.length === 0) {
                list.innerHTML = '<div class="no-favorites"><i class="fas fa-comment-dots"></i><p>还没有自定义回复</p></div>';
                return;
            }
            
            list.innerHTML = customReplies.map((reply, index) => `
                <div class="custom-reply-item">
                    <span>${reply}</span>
                    <div class="custom-reply-actions">
                        <button class="session-action-btn" data-index="${index}" title="编辑"><i class="fas fa-edit"></i></button>
                        <button class="session-action-btn delete" data-index="${index}" title="删除"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function addCustomReply() {
            const reply = prompt('输入自定义回复内容:');
            if (reply && reply.trim()) {
                customReplies.push(reply.trim());
                throttledSaveData();
                renderCustomReplies();
                showNotification('自定义回复已添加', 'success');
            }
        }

        // 修复纪念日功能
        function renderAnniversaries() {
            const list = DOMElements.anniversaryModal.list;
            if (anniversaries.length === 0) {
                list.innerHTML = '<div class="no-favorites"><i class="fas fa-heart"></i><p>还没有纪念日</p></div>';
                return;
            }
            
            list.innerHTML = anniversaries.map(anniversary => {
                const startDate = new Date(anniversary.date);
                const now = new Date();
                let diffDays;
                let displayText;
                
                if (anniversary.type === 'countdown') {
                    // 倒数日：计算距离目标日期的天数
                    diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                    displayText = `距离 ${anniversary.name} 还有 ${diffDays} 天`;
                } else {
                    // 纪念日：计算已经过去的天数
                    diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                    displayText = `${anniversary.name} 已经 ${diffDays} 天`;
                }
                
                return `
                    <div class="anniversary-item" data-id="${anniversary.id}">
                        <div class="anniversary-name">${anniversary.name}</div>
                        <div class="anniversary-date">${startDate.toLocaleDateString()}</div>
                        <div class="anniversary-days">${displayText}</div>
                    </div>
                `;
            }).join('');
        }

        function addAnniversary() {
            const name = DOMElements.anniversaryModal.nameInput.value.trim();
            const date = DOMElements.anniversaryModal.dateInput.value;
            
            if (!name || !date) {
                showNotification('请填写纪念日名称和日期', 'error');
                return;
            }
            
            const newAnniversary = {
                id: Date.now(),
                name: name,
                date: date,
                type: currentAnniversaryType // 'anniversary' 或 'countdown'
            };
            
            anniversaries.push(newAnniversary);
            throttledSaveData();
            renderAnniversaries();
            
            DOMElements.anniversaryModal.nameInput.value = '';
            DOMElements.anniversaryModal.dateInput.value = '';
            
            showNotification('纪念日已添加', 'success');
        }

        function showAnniversaryAnimation(anniversary) {
            const startDate = new Date(anniversary.date);
            const now = new Date();
            let diffDays;
            let title, message;
            
            if (anniversary.type === 'countdown') {
                // 倒数日：计算距离目标日期的天数
                diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                title = "倒数日";
                message = `距离 ${anniversary.name} 还有`;
            } else {
                // 纪念日：计算已经过去的天数
                diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                title = "纪念日快乐！";
                message = `我们已经相伴了`;
            }
            
            DOMElements.anniversaryAnimation.title.textContent = title;
            DOMElements.anniversaryAnimation.days.textContent = diffDays;
            DOMElements.anniversaryAnimation.message.textContent = message;
            
            DOMElements.anniversaryAnimation.modal.classList.add('active');
        }

        function updateAnniversaryDisplay(dateString) {
            if (!dateString) return;
            
            const start = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            DOMElements.anniversaryModal.daysElement.textContent = diffDays;
            DOMElements.anniversaryModal.dateShowElement.textContent = `起始日：${start.toLocaleDateString()}`;
            DOMElements.anniversaryModal.displayArea.style.display = 'block';
        }

        function setupEventListeners() {
            initCoreListeners();
            initModalListeners();
            initChatActionListeners();
            initHeaderAndSettingsListeners();
            initDataManagementListeners();
            initNewFeatureListeners();
        }

        function initCoreListeners() {

// --- 沉浸式滚动监听开始 ---
    DOMElements.chatContainer.addEventListener('scroll', () => {
        const container = DOMElements.chatContainer;
        
        // 条件1: 滚动条距离顶部小于 50px (说明用户在往上拉)
        // 条件2: 没有正在加载 (防止重复触发)
        // 条件3: 还有更多历史消息没显示出来的
        if (container.scrollTop < 50 && !isLoadingHistory && messages.length > displayedMessageCount) {
            isLoadingHistory = true;
            
            // 1. 让顶部的转圈圈显示出来
            const loader = document.getElementById('history-loader');
            if(loader) loader.classList.add('visible');
            
            // 2. 模拟 0.6秒 的网络加载延迟，让动画转一会儿
            setTimeout(() => {
                // 增加显示的条数 (再多显示 20 条)
                displayedMessageCount += HISTORY_BATCH_SIZE;
                
                // 重新渲染，参数 true 表示保持当前的视觉位置，不要乱跳
                renderMessages(true);
                
                // 3. 隐藏转圈圈，重置状态
                if(loader) loader.classList.remove('visible');
                isLoadingHistory = false;
            }, 600);
        }
    });

            DOMElements.sendBtn.addEventListener('click', () => isBatchMode ? addToBatch() : sendMessage());
            DOMElements.messageInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); isBatchMode ? addToBatch() : sendMessage(); } });
            DOMElements.messageInput.addEventListener('input', () => { DOMElements.messageInput.style.height = 'auto'; DOMElements.messageInput.style.height = `${Math.min(DOMElements.messageInput.scrollHeight, 120)}px`; });
            
            // 修改附件按钮点击事件，修复模态框问题
            DOMElements.attachmentBtn.addEventListener('click', () => {
                // 创建图片上传模态框
                const modal = document.createElement('div');
                modal.className = 'modal image-upload-modal';
                modal.style.cssText = `
                    display: flex !important; 
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background-color: rgba(0, 0, 0, 0.7); 
                    z-index: 9999; 
                    align-items: center; 
                    justify-content: center; 
                    backdrop-filter: blur(8px);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                modal.innerHTML = `
                    <div class="modal-content" style="
                        z-index: 10000; 
                        position: relative; 
                        background-color: var(--secondary-bg);
                        border-radius: var(--radius);
                        padding: 24px;
                        width: 90%;
                        max-width: 400px;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        transform: translateY(20px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    ">
                        <div class="modal-title"><i class="fas fa-image"></i><span>发送图片</span></div>
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button class="modal-btn modal-btn-secondary upload-mode-btn active" id="upload-image-file-btn" style="flex: 1;">选择文件</button>
                                <button class="modal-btn modal-btn-secondary upload-mode-btn" id="paste-image-url-btn" style="flex: 1;">粘贴URL</button>
                            </div>
                            <input type="file" class="modal-input" id="image-file-input" accept="image/*">
                            <input type="text" class="modal-input" id="image-url-input" placeholder="输入图片URL地址" style="display: none;">
                            <div id="image-preview" style="text-align: center; margin-top: 10px; display: none;">
                                <img id="preview-chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-secondary" id="cancel-image">取消</button>
                            <button class="modal-btn modal-btn-primary" id="send-image" disabled>发送</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // 添加动画
                setTimeout(() => {
                    modal.style.opacity = '1';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);
                
                const fileInput = document.getElementById('image-file-input');
                const urlInput = document.getElementById('image-url-input');
                const uploadBtn = document.getElementById('upload-image-file-btn');
                const pasteUrlBtn = document.getElementById('paste-image-url-btn');
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-chat-image');
                const sendBtn = document.getElementById('send-image');
                const cancelBtn = document.getElementById('cancel-image');
                const uploadModeBtns = document.querySelectorAll('.upload-mode-btn');
                
                let currentImageData = null;
                
                // 切换上传模式
                function switchUploadMode(isFileMode) {
                    uploadModeBtns.forEach(btn => btn.classList.remove('active'));
                    if (isFileMode) {
                        uploadBtn.classList.add('active');
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        pasteUrlBtn.classList.add('active');
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                        urlInput.focus();
                    }
                    // 重置预览和发送按钮
                    previewDiv.style.display = 'none';
                    sendBtn.disabled = true;
                    currentImageData = null;
                }
                
                // 上传文件按钮点击事件
                uploadBtn.addEventListener('click', () => switchUploadMode(true));
                
                // 粘贴URL按钮点击事件
                pasteUrlBtn.addEventListener('click', () => switchUploadMode(false));
                
                // 文件选择事件
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_IMAGE_SIZE) {
                            showNotification('图片大小不能超过5MB', 'error');
                            return;
                        }
                        showNotification('正在优化图片...', 'info', 1500);
                        optimizeImage(file).then(optimizedData => {
                            currentImageData = optimizedData;
                            previewImg.src = currentImageData;
                            previewDiv.style.display = 'block';
                            sendBtn.disabled = false;
                        }).catch(() => {
                            showNotification('图片处理失败', 'error');
                        });
                    }
                });
                
                // URL输入事件
                urlInput.addEventListener('input', function() {
                    const url = urlInput.value.trim();
                    if (url) {
                        // 验证URL格式
                        if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|bmp))$/i.test(url)) {
                            previewImg.src = url;
                            previewDiv.style.display = 'block';
                            currentImageData = url;
                            sendBtn.disabled = false;
                            
                            // 预加载图片检查是否有效
                            const img = new Image();
                            img.onload = function() {
                                // 图片加载成功
                                previewImg.src = url;
                                showNotification('图片URL有效', 'success', 1000);
                            };
                            img.onerror = function() {
                                showNotification('图片URL无效或无法访问', 'error');
                                sendBtn.disabled = true;
                                previewDiv.style.display = 'none';
                            };
                            img.src = url;
                        } else {
                            sendBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    } else {
                        sendBtn.disabled = true;
                        previewDiv.style.display = 'none';
                    }
                });
                
                // 发送按钮点击事件
                sendBtn.addEventListener('click', () => {
                    if (currentImageData) {
                        // 直接发送图片消息
                        addMessage({ 
                            id: Date.now(), 
                            sender: 'user', 
                            text: '', 
                            timestamp: new Date(), 
                            image: currentImageData, 
                            status: 'sent', 
                            favorited: false, 
                            note: null, 
                            replyTo: currentReplyTo, 
                            type: 'normal' 
                        });
                        playSound('send');
                        currentReplyTo = null;
                        updateReplyPreview();
                        setTimeout(simulateReply, 800 + Math.random() * 1200);
                        
                        // 关闭模态框
                        closeModal();
                    }
                });
                
                // 取消按钮点击事件
                cancelBtn.addEventListener('click', closeModal);
                
                // 关闭模态框函数
                function closeModal() {
                    modal.style.opacity = '0';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    }, 300);
                }
                
                // 点击模态框背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // 阻止模态框内容点击时关闭
                modal.querySelector('.modal-content').addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // ESC键关闭模态框
                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);
                
                // 清理事件监听器
                modal.addEventListener('close', () => {
                    document.removeEventListener('keydown', handleEscKey);
                });
            });

            // 保留原有的文件输入作为备用
            DOMElements.imageInput.addEventListener('change', () => { 
                if (DOMElements.imageInput.files[0]) { 
                    if(isBatchMode) { 
                        showNotification('批量模式不支持图片', 'warning'); 
                        DOMElements.imageInput.value=''; 
                    } else { 
                        sendMessage(); 
                    } 
                } 
            });
                
            DOMElements.continueBtn.addEventListener('click', simulateReply);
            DOMElements.batchBtn.addEventListener('click', toggleBatchMode);
            DOMElements.pokeBtn.addEventListener('click', () => showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input));
        }

        function initChatActionListeners() {
            DOMElements.chatContainer.addEventListener('click', (e) => {
                // 处理批量收藏模式下的消息选择
                if (isBatchFavoriteMode) {
                    const wrapper = e.target.closest('.message-wrapper');
                    if (wrapper && !e.target.closest('.message-meta-actions')) {
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);
                        
                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            wrapper.classList.remove('selected');
                        } else {
                            selectedMessages.push(messageId);
                            wrapper.classList.add('selected');
                        }
                        
                        // 更新按钮文本
                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `确认收藏 (${selectedMessages.length})`;
                        }
                        return;
                    }
                }

                // 处理收藏按钮点击（在时间戳旁边）
                const favoriteBtn = e.target.closest('.favorite-meta-btn');
                if (favoriteBtn) {
                    const wrapper = e.target.closest('.message-wrapper');
                    const messageId = Number(wrapper.dataset.id);
                    const message = messages.find(m => m.id === messageId);
                    if (message) {
                        message.favorited = !message.favorited;
                        showNotification(message.favorited ? '已收藏' : '已取消收藏', 'success', 1500);
                        playSound('favorite');
                        throttledSaveData();
                        renderMessages(false);
                    }
                    return;
                }

                // 处理其他操作按钮
                const target = e.target.closest('.meta-action-btn');
                if (!target) return;
                const wrapper = e.target.closest('.message-wrapper');
                const messageId = Number(wrapper.dataset.id);
                const message = messages.find(m => m.id === messageId);
                if (!message) return;
                
                if (target.classList.contains('reply-btn')) {
                    currentReplyTo = { id: message.id, sender: message.sender, text: message.text };
                    updateReplyPreview();
                    DOMElements.messageInput.focus();
                    const targetMessageElement = DOMElements.chatContainer.querySelector(`[data-id="${message.id}"]`);
                    if(targetMessageElement) targetMessageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                } else if (target.classList.contains('note-btn')) {
                    currentNoteMessageId = messageId;
                    DOMElements.noteModal.input.value = message.note || '';
                    showModal(DOMElements.noteModal.modal, DOMElements.noteModal.input);
                    return;
                }
            
                throttledSaveData();
                renderMessages(true);
            });

            DOMElements.batchPreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.batch-preview-remove');
                if(removeBtn) {
                    const index = removeBtn.closest('.batch-preview-item').dataset.index;
                    batchMessages.splice(index, 1); updateBatchPreview();
                }
                const sendBtn = e.target.closest('.batch-send-btn');
                if(sendBtn && !sendBtn.disabled) sendBatchMessages();
                if(e.target.matches('.batch-cancel-btn')) { 
                    isBatchMode = false; DOMElements.batchBtn.classList.remove('active'); 
                    DOMElements.batchPreview.style.display = 'none'; 
                    const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
                    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "..." : placeholder;
                    batchMessages = []; 
                }
            });
        }

        function initModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const cancelBtn = modal.querySelector('.modal-btn-secondary');
                if (cancelBtn) cancelBtn.addEventListener('click', () => hideModal(modal));
            });

            DOMElements.editModal.input.addEventListener('input', () => { DOMElements.editModal.save.disabled = !DOMElements.editModal.input.value.trim(); });
            DOMElements.noteModal.save.addEventListener('click', () => {
                const message = messages.find(m => m.id === currentNoteMessageId);
                if (message) {
                    message.note = DOMElements.noteModal.input.value.trim() || null;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('注释已保存', 'success');
                }
                hideModal(DOMElements.noteModal.modal);
            });

            DOMElements.pokeModal.save.addEventListener('click', () => {
                let pokeText = DOMElements.pokeModal.input.value.trim() || `${settings.myName} 拍了拍 ${settings.partnerName}`;
                addMessage({ id: Date.now(), text: `✦ ${pokeText} ✦`, timestamp: new Date(), type: 'system' });
                hideModal(DOMElements.pokeModal.modal);
                DOMElements.pokeModal.input.value = '';
                setTimeout(simulateReply, 800 + Math.random() * 1200);
            });
            
            // 找到原来的这两行并修改
            // --- 抛硬币相关监听 (Updated) ---
            
            // 1. 取消按钮
            DOMElements.cancelCoinResult.addEventListener('click', () => { 
                DOMElements.coinTossOverlay.classList.remove('visible', 'finished'); 
                lastCoinResult = null; 
            });
            
            // 2. 发送结果按钮
            DOMElements.sendCoinResult.addEventListener('click', () => { 
                if (lastCoinResult) { 
                    sendMessage(`🎲 抛硬币结果：${lastCoinResult}`, 'normal'); 
                    DOMElements.coinTossOverlay.classList.remove('visible', 'finished'); 
                    lastCoinResult = null; 
                } 
            });

            // 3. 新增：再来一次按钮 (Retry)
            const retryBtn = document.getElementById('retry-coin-toss');
            // 使用 preventDefault 防止冒泡或其他副作用
            if (retryBtn) {
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    // 重新调用动画函数
                    startCoinFlipAnimation();
                });
            }
}

        function initHeaderAndSettingsListeners() {

            const openNameModal = (isPartner) => {
                const modal = DOMElements.editModal;
                showModal(modal.modal, modal.input);
                modal.title.textContent = `修改${isPartner ? (settings.partnerName || '对方') : '我'}的昵称`;
                modal.input.value = isPartner ? settings.partnerName : settings.myName;
                modal.save.disabled = !modal.input.value.trim();
                modal.save.onclick = () => {
                    const newName = modal.input.value.trim();
                    if(newName) { 
                        isPartner ? settings.partnerName = newName : settings.myName = newName; 
                        throttledSaveData(); 
                        updateUI(); 
                        showNotification('昵称已更新', 'success'); 
                    }
                    hideModal(modal.modal);
                };
            };
            
            const openAvatarModal = (isPartner) => {
                const modal = DOMElements.avatarModal;
                // 修改模态框内容，添加URL输入选项
                modal.modal.querySelector('.modal-content').innerHTML = `
                    <div class="modal-title"><i class="fas fa-portrait"></i><span>上传${isPartner ? '对方' : '我'}的头像</span></div>
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="modal-btn modal-btn-secondary" id="upload-file-btn" style="flex: 1;">选择文件</button>
                            <button class="modal-btn modal-btn-secondary" id="paste-url-btn" style="flex: 1;">粘贴URL</button>
                        </div>
                        <input type="file" class="modal-input" id="avatar-file-input" accept="image/*" style="display: none;">
                        <input type="text" class="modal-input" id="avatar-url-input" placeholder="输入图片URL地址" style="display: none;">
                        <div id="avatar-preview" style="text-align: center; margin-top: 10px; display: none;">
                            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--border-color);">
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-secondary" id="cancel-avatar">取消</button>
                        <button class="modal-btn modal-btn-primary" id="save-avatar" disabled>保存</button>
                    </div>
                `;
                
                showModal(modal.modal);
                
                const fileInput = document.getElementById('avatar-file-input');
                const urlInput = document.getElementById('avatar-url-input');
                const uploadBtn = document.getElementById('upload-file-btn');
                const pasteUrlBtn = document.getElementById('paste-url-btn');
                const previewDiv = document.getElementById('avatar-preview');
                const previewImg = document.getElementById('preview-image');
                const saveBtn = document.getElementById('save-avatar');
                const cancelBtn = document.getElementById('cancel-avatar');
                
                let currentAvatarData = null;
                
                // 上传文件按钮点击事件
                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                    urlInput.style.display = 'none';
                    uploadBtn.classList.add('active');
                    pasteUrlBtn.classList.remove('active');
                });
                
                // 粘贴URL按钮点击事件
                pasteUrlBtn.addEventListener('click', () => {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    pasteUrlBtn.classList.add('active');
                    uploadBtn.classList.remove('active');
                    urlInput.focus();
                });
                
                // 文件选择事件
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_AVATAR_SIZE) {
                            showNotification('头像图片不能超过2MB', 'error');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            currentAvatarData = e.target.result;
                            previewImg.src = currentAvatarData;
                            previewDiv.style.display = 'block';
                            saveBtn.disabled = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // URL输入事件
                urlInput.addEventListener('input', function() {
                    const url = urlInput.value.trim();
                    if (url) {
                        // 验证URL格式
                        if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i.test(url)) {
                            previewImg.src = url;
                            previewDiv.style.display = 'block';
                            currentAvatarData = url;
                            saveBtn.disabled = false;
                            
                            // 预加载图片检查是否有效
                            const img = new Image();
                            img.onload = function() {
                                // 图片加载成功
                                previewImg.src = url;
                            };
                            img.onerror = function() {
                                showNotification('图片URL无效或无法访问', 'error');
                                saveBtn.disabled = true;
                            };
                            img.src = url;
                        } else {
                            saveBtn.disabled = true;
                        }
                    } else {
                        saveBtn.disabled = true;
                        previewDiv.style.display = 'none';
                    }
                });
                
                // 保存按钮点击事件
                saveBtn.addEventListener('click', () => {
                    if (currentAvatarData) {
                        updateAvatar(isPartner ? DOMElements.partner.avatar : DOMElements.me.avatar, currentAvatarData);
                        throttledSaveData();
                        showNotification('头像已更新', 'success');
                        hideModal(modal.modal);
                    }
                });
                
                // 取消按钮点击事件
                cancelBtn.addEventListener('click', () => {
                    hideModal(modal.modal);
                });
            };
            
            DOMElements.partner.name.addEventListener('click', () => openNameModal(true));
            DOMElements.me.name.addEventListener('click', () => openNameModal(false));
            DOMElements.partner.avatar.addEventListener('click', () => openAvatarModal(true));
            DOMElements.me.avatar.addEventListener('click', () => openAvatarModal(false));

            DOMElements.me.statusContainer.addEventListener('click', () => {
                const statusTextElement = DOMElements.me.statusText; const statusContainer = DOMElements.me.statusContainer;
                if (statusContainer.querySelector('input')) return;
                const input = document.createElement('input'); input.type = 'text'; input.id = 'my-status-input'; input.value = statusTextElement.textContent;
                const saveStatus = () => { 
                    const newStatus = input.value.trim();
                    if (newStatus) { settings.myStatus = newStatus; showNotification('状态已更新', 'success'); }
                    else { settings.myStatus = "在线"; }
                    statusTextElement.textContent = settings.myStatus; 
                    statusContainer.innerHTML = ''; 
                    statusContainer.appendChild(statusTextElement); 
                    throttledSaveData(); 
                };
                input.addEventListener('blur', saveStatus);
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
                statusContainer.innerHTML = ''; statusContainer.appendChild(input); input.focus();
            });

            DOMElements.themeToggle.addEventListener('click', () => { settings.isDarkMode = !settings.isDarkMode; throttledSaveData(); updateUI(); showNotification(`已切换到${settings.isDarkMode ? '深色' : '浅色'}模式`, 'success'); });
            DOMElements.settingsModal.settingsBtn.addEventListener('click', () => { showModal(DOMElements.settingsModal.modal); });
            DOMElements.favoritesModal.favoritesBtn.addEventListener('click', () => { renderFavorites(); showModal(DOMElements.favoritesModal.modal); });

            // 设置面板卡片点击事件
            document.getElementById('appearance-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.appearanceModal.modal);
            });
            
            document.getElementById('chat-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.chatModal.modal);
            });
            
            document.getElementById('advanced-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.advancedModal.modal);
            });
            
            document.getElementById('data-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.dataModal.modal);
            });
            
            // 外观设置
            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    settings.colorTheme = btn.dataset.theme;
                    throttledSaveData();
                    updateUI();
                    showNotification(`主题颜色已切换`, 'success');
                });
            });
            
            // 气泡样式
            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click', () => {
                    settings.bubbleStyle = item.dataset.bubbleStyle;
                    throttledSaveData();
                    updateUI();
                    showNotification(`气泡样式已切换为${getBubbleStyleName(settings.bubbleStyle)}`, 'success');
                });
            });
            
            // 字体大小
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            
            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = `${settings.fontSize}px`;
            
            fontSizeSlider.addEventListener('input', (e) => {
                settings.fontSize = parseInt(e.target.value);
                document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
                fontSizeValue.textContent = `${settings.fontSize}px`;
            });
            
            fontSizeSlider.addEventListener('change', throttledSaveData);
            
            // 聊天设置
            const settingToggles = {
    '#reply-toggle': { prop: 'replyEnabled', name: '引用回复' }, 
    '#sound-toggle': { prop: 'soundEnabled', name: '消息音效' }, 
    '#read-receipts-toggle': { prop: 'readReceiptsEnabled', name: '已读回执' }, 
    '#typing-indicator-toggle': { prop: 'typingIndicatorEnabled', name: '正在输入' }
};

for(const [selector, { prop, name }] of Object.entries(settingToggles)) {
    const element = document.querySelector(selector);
    // 初始化显示状态文字
    if(element) {
        const span = element.querySelector('span');
        if(span) span.textContent = `${name}: ${settings[prop] ? '开启' : '关闭'}`;
    }

    element.addEventListener('click', () => {
        settings[prop] = !settings[prop]; 
        throttledSaveData(); 
        updateUI(); 
        
        // --- 修改核心：更新文字内容 ---
        const span = element.querySelector('span');
        if(span) {
            span.textContent = `${name}: ${settings[prop] ? '开启' : '关闭'}`;
            
        }
        // ---------------------------

        if(prop !== 'soundEnabled') renderMessages(true); 
        showNotification(`${name}已${settings[prop] ? '开启' : '关闭'}`, 'success');
    });
}
            
            // 背景设置
            document.getElementById('set-background').addEventListener('click', () => DOMElements.backgroundInput.click());
            document.getElementById('remove-background').addEventListener('click', () => { if (safeGetItem(getStorageKey('chatBackground'))) removeBackground(); else showNotification('当前没有设置背景图片', 'info'); });
            
            DOMElements.backgroundInput.addEventListener('change', (e) => { 
                const file = e.target.files[0]; if (!file) return; 
                if (file.size > MAX_IMAGE_SIZE) { showNotification('背景图片不能超过5MB', 'error'); return; } 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    try { safeSetItem(getStorageKey('chatBackground'), event.target.result); applyBackground(event.target.result); showNotification('背景图片已设置', 'success'); } 
                    catch (error) { showNotification('图片太大无法保存，请选择小于5MB的图片', 'error', 4000); removeBackground(); } 
                }; 
                reader.readAsDataURL(file); 
            });
        }

        

        function initNewFeatureListeners() {
            // 运势功能
            // 塔罗占卜功能 (确保代码是这样的)
            document.getElementById('fortune-function').addEventListener('click', () => {
                // 1. 关闭高级功能菜单
                hideModal(DOMElements.advancedModal.modal);
                
                // 2. 调用生成运势函数 (它会自动判断是用本地存储还是生成新的)
                generateFortune();
            });
            DOMElements.fortuneModal.shareBtn.addEventListener('click', () => {
                const fortuneText = document.querySelector('.fortune-desc').textContent;
                const shareText = `我的今日运势：${fortuneText}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: '今日运势',
                        text: shareText
                    });
                } else {
                    // 复制到剪贴板
                    navigator.clipboard.writeText(shareText).then(() => {
                        showNotification('运势已复制到剪贴板', 'success');
                    });
                }
            });
            
            // 批量收藏功能
            document.getElementById('batch-favorite-function').addEventListener('click', () => {
                hideModal(DOMElements.favoritesModal.modal);
                toggleBatchFavoriteMode();
            });
            
            // 自定义回复功能
            document.getElementById('custom-replies-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderCustomReplies();
                showModal(DOMElements.customRepliesModal.modal);
            });
            
            DOMElements.customRepliesModal.addBtn.addEventListener('click', addCustomReply);
            
            DOMElements.customRepliesModal.list.addEventListener('click', (e) => {
                if (e.target.closest('.delete')) {
                    const index = e.target.closest('.delete').dataset.index;
                    customReplies.splice(index, 1);
                    throttledSaveData();
                    renderCustomReplies();
                    showNotification('自定义回复已删除', 'success');
                } else if (e.target.closest('.fa-edit')) {
                    const index = e.target.closest('[data-index]').dataset.index;
                    const newReply = prompt('编辑回复内容:', customReplies[index]);
                    if (newReply && newReply.trim()) {
                        customReplies[index] = newReply.trim();
                        throttledSaveData();
                        renderCustomReplies();
                        showNotification('自定义回复已更新', 'success');
                    }
                }
            });
            
            // 纪念日功能 - 修复版
            document.getElementById('anniversary-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderAnniversaries();
                showModal(DOMElements.anniversaryModal.modal);
            });
            
            // 纪念日类型选择器
            document.querySelectorAll('.anniversary-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.anniversary-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentAnniversaryType = this.dataset.type;
                    
                    // 更新提示文本
                    const hintElement = DOMElements.anniversaryModal.typeHint;
                    if (currentAnniversaryType === 'countdown') {
                        hintElement.textContent = '倒数日：从今天到未来某天的天数';
                    } else {
                        hintElement.textContent = '纪念日：从过去某天到今天的天数';
                    }
                });
            });
            
            DOMElements.anniversaryModal.addBtn.addEventListener('click', addAnniversary);
            
            DOMElements.anniversaryModal.saveBtn.addEventListener('click', () => {
                const val = DOMElements.anniversaryModal.dateInput.value;
                if (val) {
                    // 保存主要纪念日
                    const mainAnniversary = {
                        id: 'main',
                        name: '相识纪念日',
                        date: val,
                        type: 'anniversary'
                    };
                    
                    // 检查是否已存在主要纪念日
                    const existingIndex = anniversaries.findIndex(a => a.id === 'main');
                    if (existingIndex > -1) {
                        anniversaries[existingIndex] = mainAnniversary;
                    } else {
                        anniversaries.push(mainAnniversary);
                    }
                    
                    throttledSaveData();
                    renderAnniversaries();
                    updateAnniversaryDisplay(val);
                    showNotification('纪念日已保存', 'success');
                }
            });
            
            // 纪念日点击事件
            DOMElements.anniversaryModal.list.addEventListener('click', (e) => {
                const anniversaryItem = e.target.closest('.anniversary-item');
                if (anniversaryItem) {
                    const anniversaryId = anniversaryItem.dataset.id;
                    const anniversary = anniversaries.find(a => a.id == anniversaryId);
                    if (anniversary) {
                        showAnniversaryAnimation(anniversary);
                    }
                }
            });
            
            DOMElements.anniversaryAnimation.closeBtn.addEventListener('click', () => {
                DOMElements.anniversaryAnimation.modal.classList.remove('active');
            });
            
            // 消息统计
            document.getElementById('stats-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderStatsContent();
                showModal(DOMElements.statsModal.modal);
            });
            
            // 抛硬币
            document.getElementById('coin-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                handleCoinToss();
            });
            const musicToggle = document.getElementById('music-player-toggle');
            musicToggle.addEventListener('click', () => {
                settings.musicPlayerEnabled = !settings.musicPlayerEnabled;
                throttledSaveData();
                
                const player = document.getElementById('player');
                if (settings.musicPlayerEnabled) {
                    player.classList.add('visible');
                    showNotification('音乐播放器已开启', 'success');
                } else {
                    player.classList.remove('visible');
                    document.getElementById('playlist').classList.remove('active'); // 关闭列表
                    const audio = document.getElementById('audio');
                    if(audio) audio.pause(); // 关闭时停止播放
                    showNotification('音乐播放器已关闭', 'info');
                }
                hideModal(DOMElements.advancedModal.modal);
            });
        }
        

        function getBubbleStyleName(style) {
            const names = {
                'standard': '标准',
                'rounded': '圆角',
                'rounded-large': '大圆角',
                'square': '方形'
            };
            return names[style] || '标准';
        }

        function initDataManagementListeners() {
            // 数据导出导入
            document.getElementById('export-chat').addEventListener('click', exportChatHistory);
            document.getElementById('import-chat').addEventListener('click', () => DOMElements.importInput.click());
            DOMElements.importInput.addEventListener('change', (e) => { if (e.target.files[0]) { importChatHistory(e.target.files[0]); e.target.value = ''; } });
            
            // 数据清理
            document.getElementById('clear-chat').addEventListener('click', () => { 
                if(confirm("确定要清空当前会话的所有聊天记录吗？此操作不可恢复")) { 
                    messages = []; 
                    throttledSaveData(); 
                    renderMessages(); 
                    hideModal(DOMElements.dataModal.modal); 
                    showNotification('聊天记录已清空', 'success'); 
                } 
            });
            document.getElementById('clear-storage').addEventListener('click', clearAllAppData);
    const creditsBtn = document.getElementById('open-credits-btn');
    if (creditsBtn) {
        creditsBtn.addEventListener('click', () => {
            // 1. 关闭当前的“数据管理”模态框
            hideModal(DOMElements.dataModal.modal);
            
            // 2. 打开“声明/致谢”模态框
            const disclaimerModal = document.getElementById('disclaimer-modal');
            
            // 如果你之前没定义 disclaimerModal 的 helper 对象，直接用 DOM 获取并显示
            if (disclaimerModal) {
                showModal(disclaimerModal);
            }
        });
    }
    
        }

            // 会话管理 - 修复版
            DOMElements.sessionModal.managerBtn.addEventListener('click', () => { renderSessionList(); showModal(DOMElements.sessionModal.modal); });
            DOMElements.sessionModal.createBtn.addEventListener('click', () => { 
                const newId = createNewSession(false);
                // 更新会话列表显示
                renderSessionList();
                showNotification('新会话已创建', 'success');
            });
            
            DOMElements.sessionModal.list.addEventListener('click', (e) => {
                const item = e.target.closest('.session-item');
                if (!item) return;
                const sessionId = item.dataset.id;
                
                if (e.target.closest('.rename')) {
                    const session = sessionList.find(s => s.id === sessionId);
                    const newName = prompt('输入新的会话名称:', session.name);
                    if (newName && newName.trim()) {
                        session.name = newName.trim();
                        safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));
                        renderSessionList();
                        showNotification('会话已重命名', 'success');
                    }
                } else if (e.target.closest('.delete')) {
                    if (sessionList.length <= 1) { 
                        showNotification('无法删除最后一个会话', 'warning'); 
                        return; 
                    }
                    if (confirm('确定要删除此会话及其所有聊天记录吗？此操作不可恢复')) {
                        // 先备份当前会话ID
                        const currentSessionId = SESSION_ID;
                        
                        sessionList = sessionList.filter(s => s.id !== sessionId);
                        safeSetItem(`${APP_PREFIX}sessionList`, JSON.stringify(sessionList));
                        
                        // 删除该会话的所有数据
                        Object.keys(localStorage).forEach(key => { 
                            if (key.startsWith(`${APP_PREFIX}${sessionId}_`)) safeRemoveItem(key); 
                        });
                        
                        if(sessionId === currentSessionId) {
                            // 如果删除的是当前会话，切换到第一个会话
                            const newCurrentId = sessionList[0].id;
                            safeSetItem(`${APP_PREFIX}lastSessionId`, newCurrentId);
                            window.location.hash = newCurrentId;
                            window.location.reload();
                        } else {
                            renderSessionList();
                            showNotification('会话已删除', 'success');
                        }
                    }
                } else { // Switch session
                    if(sessionId !== SESSION_ID) {
                        if(confirm('切换会话将刷新页面，确定要继续吗？')) {
                            window.location.hash = sessionId;
                            window.location.reload();
                        }
                    }
                }
            });
        
    const initMusicPlayer = () => {
        // 1. 修改歌曲列表初始化：尝试从本地读取，如果没有则使用默认列表
        let defaultSongs = [
            { title: "虚拟", sub: "你是我朝夕相伴触手可及的虚拟", url: "https://files.catbox.moe/6s65mp.mp3" },
            { title: "多远都要在一起", sub: "爱能克服远距离", url: "https://files.catbox.moe/06k9ra.mp3" },
            { title: "永不失联的爱", sub: "这一辈子都不想失联的爱", url: "https://files.catbox.moe/uvucav.mp3" },
            { title: "稳稳的幸福", sub: "这是我想要的幸福", url: "https://files.catbox.moe/inb22a.mp3" },
            { title: "有我呢", sub: "我会让你习惯 多一个人陪伴", url: "https://files.catbox.moe/hrazjt" },
            { title: "一千零一夜", sub: "梦里能到达的地方啊 有一天脚步也能到达", url: "https://files.catbox.moe/syfuon.mp3" },
            { title: "月亮与六便士", sub: "我的世界由你建立 因你崩塌", url: "https://files.catbox.moe/98quqc.mp3" },
            { title: "次元恋人", sub: "约好了隔着次元也吻住泪眼", url: "https://files.catbox.moe/5u5dy0.mp3" },
            { title: "阳光下的星星", sub: "如果爱上你只是一个梦境", url: "https://files.catbox.moe/dxgqsk.mp3" },
            { title: "周边", sub: "灵魂里空缺的那段", url: "https://files.catbox.moe/a7k5wd.mp3" },
            { title: "恋爱ing", sub: "让我重新认识L O V E", url: "https://files.catbox.moe/94slcd.mp3" },
            { title: "一点一滴", sub: "你让爱一点一滴汇成河", url: "https://files.catbox.moe/958qzg.mp3" },
            { title: "关键词", sub: "让我见识爱情可以慷慨又自私", url: "https://files.catbox.moe/9yl5ic.mp3" },
            { title: "想见你想见你想见你", sub: "穿越了千个万个时间线里人海里相依", url: "https://files.catbox.moe/co58d7.mp3" },
            { title: "stay crossing night", sub: "这里没有你", url: "https://files.catbox.moe/i3f86b.mp3" },
            { title: "sea temple", sub: "If we have each other", url: "https://files.catbox.moe/c57gxs.mp3" },
            { title: "我想要占据你", sub: "占据你的⼀切且无可厚非", url: "https://files.catbox.moe/1fp6eg.mp3" },
            { title: "特别的人", sub: "我们是对方特别的人", url: "https://files.catbox.moe/a0n0l7.mp3" },
            { title: "麦恩莉", sub: "在广阔寂寞漩涡解脱", url: "https://files.catbox.moe/2inae2.mp3" },
            { title: "会呼吸的痛", sub: "想念是会呼吸的痛", url: "https://files.catbox.moe/0uhmxr.mp3" },
            { title: "一生的爱", sub: "我只想要给你我一生的爱", url: "https://files.catbox.moe/f0e93c.mp3" },
            { title: "身骑白马", sub: "追赶要我爱的不保留", url: "https://files.catbox.moe/iywfe2.mp3" },
            { title: "爱情讯息", sub: "想念变成空气在叹息", url: "https://files.catbox.moe/4dl0t2.mp3" },
            { title: "你在 不在", sub: "你在我心里面 陪我失眠", url: "https://files.catbox.moe/fnwtf8.mp3" },
            { title: "你是我的风景", sub: "爱让悬崖变平地", url: "https://files.catbox.moe/fnwtf8.mp3" },
            { title: "life with u", sub: "Now I know that you're the one", url: "https://files.catbox.moe/zqfxvd.mp3" },
            { title: "勾指起誓", sub: "你是理所当然的奇迹", url: "https://files.catbox.moe/4spgo5.mp3" },
            { title: "牵一半", sub: "你的存在是我唯一依赖", url: "https://files.catbox.moe/bk21gu.mp3" },
            { title: "rove", sub: "Oh we are in the War of Love on Rove", url: "https://files.catbox.moe/sfwsuk.mp3" },
            { title: "唯一", sub: "我真的爱你 句句不轻易", url: "https://files.catbox.moe/69g4fe.mp3" },

        ];
        
        // 读取本地存储的自定义歌曲
        const savedSongs = safeGetItem(APP_PREFIX + 'customSongs');
        let songs = savedSongs ? JSON.parse(savedSongs) : defaultSongs;
        
        const player = document.getElementById('player');
        const miniView = document.getElementById('mini-view');
        const playlist = document.getElementById('playlist');
        const audio = document.getElementById('audio');
        const playBtn = document.getElementById('play-btn');
        const progressArea = document.getElementById('progress-area');
        
        // 获取新增的 DOM 元素
        const addSongModal = document.getElementById('add-song-modal');
        const newSongTitle = document.getElementById('new-song-title');
        const newSongSub = document.getElementById('new-song-sub');
        const newSongUrl = document.getElementById('new-song-url');
        const confirmAddSongBtn = document.getElementById('confirm-add-song');
        const cancelAddSongBtn = document.getElementById('cancel-add-song');
        
        let currentIndex = 0;
        let isPlaying = false;
        let isRandom = false;
        
        // 加载歌曲
        function loadSong(index) {
            // 防止索引越界
            if (index >= songs.length) index = 0;
            if (index < 0) index = songs.length - 1;
            
            const song = songs[index];
            document.getElementById('music-title').innerText = song.title;
            document.getElementById('music-subtitle').innerText = song.sub;
            audio.src = song.url;
            updatePlaylistHighlight();
        }

        // 播放/暂停控制
        function togglePlay() {
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                document.getElementById('icon-play').style.display = 'block';
                document.getElementById('icon-pause').style.display = 'none';
                player.classList.remove('playing');
            } else {
                audio.play().catch(e => showNotification('播放失败，链接可能无效', 'error'));
                isPlaying = true;
                document.getElementById('icon-play').style.display = 'none';
                document.getElementById('icon-pause').style.display = 'block';
                player.classList.add('playing');
            }
        }
        
        // 下一首/上一首
        function nextSong() {
            if (isRandom) currentIndex = Math.floor(Math.random() * songs.length);
            else currentIndex = (currentIndex + 1) % songs.length;
            loadSong(currentIndex);
            if(isPlaying) audio.play();
        }
        function prevSong() {
            currentIndex = (currentIndex - 1 + songs.length) % songs.length;
            loadSong(currentIndex);
            if(isPlaying) audio.play();
        }

        // 2. 修改渲染列表：在底部增加“添加歌曲”按钮
        function renderPlaylist() {
            playlist.innerHTML = '';
            songs.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = 'playlist-item';
                // 增加删除按钮（如果是默认歌曲则不显示删除，或者全部允许删除，这里简单处理）
                const deleteBtn = `<span class="delete-song" style="float:right; opacity:0.5; font-size:16px;" title="删除">&times;</span>`;
                
                div.innerHTML = `<span>${song.title} <small style="opacity:0.7; font-size:10px;">- ${song.sub}</small></span>${deleteBtn}`;
                
                // 点击播放
                div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentIndex = index;
                    loadSong(currentIndex);
                    if (!isPlaying) togglePlay();
                    else audio.play();
                });

                // 点击删除
                const delSpan = div.querySelector('.delete-song');
                delSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(confirm('确定移除这首歌吗？')) {
                        songs.splice(index, 1);
                        if(songs.length === 0) songs = [...defaultSongs]; // 如果删光了，恢复默认
                        safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
                        renderPlaylist();
                        if(index === currentIndex) {
                            currentIndex = 0;
                            loadSong(0);
                            if(isPlaying) audio.pause();
                            togglePlay(); 
                        }
                    }
                });

                playlist.appendChild(div);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'playlist-add-btn';
            addBtn.innerHTML = '<i class="fas fa-plus"></i> 添加歌曲';
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showModal(addSongModal);
                newSongTitle.focus();
            });
            playlist.appendChild(addBtn);

            updatePlaylistHighlight();
        }

        function updatePlaylistHighlight() {
            const items = playlist.querySelectorAll('.playlist-item');
            items.forEach((item, index) => {
                if (index === currentIndex) item.classList.add('playing');
                else item.classList.remove('playing');
            });
        }
        

        confirmAddSongBtn.addEventListener('click', () => {
            const title = newSongTitle.value.trim();
            const sub = newSongSub.value.trim();
            const url = newSongUrl.value.trim();
            
            if (!title || !url) {
                showNotification('歌名和链接不能为空', 'error');
                return;
            }
            
            const newSong = { title, sub: sub || '未知艺术家', url };
            songs.push(newSong);
            

            safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
            
            renderPlaylist();
            showNotification('歌曲已添加', 'success');

            newSongTitle.value = '';
            newSongSub.value = '';
            newSongUrl.value = '';
            hideModal(addSongModal);
        });

        cancelAddSongBtn.addEventListener('click', () => {
            hideModal(addSongModal);
        });
        
        function setupDrag() {
            let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
            const dragStart = (e) => {
                if (e.target.closest('.btn') || e.target.closest('.progress-wrapper') || e.target.closest('.playlist-popup')) return;
                const event = e.type === 'touchstart' ? e.touches[0] : e;
                isDragging = true; hasMoved = false;
                startX = event.clientX; startY = event.clientY;
                const rect = player.getBoundingClientRect();
                initialLeft = rect.left; initialTop = rect.top;
                player.style.transition = 'none';
                playlist.style.transition = 'none';
            };
            const dragMove = (e) => {
                if (!isDragging) return;
    if (e.cancelable) {
       e.preventDefault(); 
}
                const event = e.type === 'touchmove' ? e.touches[0] : e;
                const dx = event.clientX - startX;
                const dy = event.clientY - startY;
    if (Math.abs(dx) > 3 || Math.abs(dy) > 3) { hasMoved = true; }
                
                let newLeft = initialLeft + dx;
                let newTop = initialTop + dy;
                const maxLeft = window.innerWidth - player.offsetWidth;
                const maxTop = window.innerHeight - player.offsetHeight;
                player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
                player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
                const rect = player.getBoundingClientRect();
                playlist.style.left = rect.left + 'px';
                playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
            };
            const dragEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                player.style.transition = '';
                playlist.style.transition = '';
            };
            player.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            player.addEventListener('touchstart', dragStart, {passive: false});
            document.addEventListener('touchmove', dragMove, {passive: false});
            document.addEventListener('touchend', dragEnd);
            
            miniView.addEventListener('click', () => {
                if (!hasMoved && player.classList.contains('collapsed')) {
                    player.classList.remove('collapsed');
                    setTimeout(() => {
                        const rect = player.getBoundingClientRect();
                        playlist.style.top = (rect.top + 170) + 'px';
                    }, 300);
                }
            });
        }
        playBtn.addEventListener('click', togglePlay);
        document.getElementById('next-btn').addEventListener('click', nextSong);
        document.getElementById('prev-btn').addEventListener('click', prevSong);
        document.getElementById('minimize-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            player.classList.add('collapsed');
            playlist.classList.remove('active');
        });
        
        progressArea.addEventListener('click', (e) => {
            const width = progressArea.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            audio.currentTime = (clickX / width) * duration;
        });
        
        audio.addEventListener('timeupdate', (e) => {
            const { duration, currentTime } = e.target;
            if (duration) document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
        });
        audio.addEventListener('ended', nextSong);
        
        document.getElementById('mode-btn').addEventListener('click', () => {
            isRandom = !isRandom;
            document.getElementById('icon-loop').style.display = isRandom ? 'none' : 'block';
            document.getElementById('icon-shuffle').style.display = isRandom ? 'block' : 'none';
            showNotification(isRandom ? '随机播放' : '顺序播放', 'info', 1000);
        });
        
        const listBtn = document.getElementById('list-btn');
        listBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const rect = player.getBoundingClientRect();
            playlist.style.left = rect.left + 'px';
            playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
            playlist.classList.toggle('active');
        });
        
        document.addEventListener('click', (e) => {
            if (!playlist.contains(e.target) && !listBtn.contains(e.target) && !player.contains(e.target) && !e.target.closest('#add-song-modal')) {
                playlist.classList.remove('active');
            }
        });
        
        loadSong(0);
        renderPlaylist();
        setupDrag();
        
        if(settings.musicPlayerEnabled) {
            player.classList.add('visible');
        }
    };

        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];

        document.addEventListener('DOMContentLoaded', () => {
            initializeSession();
            loadData();
            initializeRandomUI();
            setupEventListeners();
            initMusicPlayer();
            setInterval(checkStatusChange, 60000);
            
    setTimeout(() => { 
        const anim = document.getElementById('welcome-animation');
        if (anim) {
            anim.classList.add('hidden');
            setTimeout(() => { 
                anim.style.display = 'none'; 
            }, 800); 
        }
    }, 3500);
            const disclaimerModal = document.getElementById('disclaimer-modal');
            const acceptDisclaimerBtn = document.getElementById('accept-disclaimer');
            const disclaimerShown = safeGetItem(APP_PREFIX + 'disclaimerShown');

            if (!disclaimerShown) {
                showModal(disclaimerModal);
            }

            acceptDisclaimerBtn.addEventListener('click', () => {
                hideModal(disclaimerModal);
                safeSetItem(APP_PREFIX + 'disclaimerShown', 'true');
            });
        });
    </script>
</body>
</html>